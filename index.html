<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0B0F1A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>FinFlow – Money Tracker</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
/* ══════════════════════════════════════════════
   FINFLOW VAULT  ·  Premium Finance OS
   Palette: Midnight Navy · Sapphire · Emerald · Rose
   Concept: Clean banking dashboard — trusted, precise
══════════════════════════════════════════════ */

/* ══════════════════════════════════════════════════════════════
   FINFLOW — 6 PREMIUM THEMES
   3 Dark: Midnight (default) · Obsidian · Forest
   3 Light: Ivory · Arctic · Rose Gold
══════════════════════════════════════════════════════════════ */

/* ── SHARED constants ── */
:root {
  --radius:    14px;
  --radius-sm: 10px;
  --radius-xs: 7px;
  --font:      'Inter', sans-serif;
  --mono:      'IBM Plex Mono', monospace;
  --ease:      cubic-bezier(0.4, 0, 0.2, 1);

  /* Semantic colors stay consistent across themes */
  --income:    var(--emerald);
  --expense:   var(--rose);
  --transfer:  var(--violet);
  --planned:   var(--amber);
  --overdue:   var(--rose);
  --danger:    var(--rose);
  --accent2:   var(--emerald);
  --accent3:   var(--amber);
  --accent4:   var(--rose);
  --accent:    var(--blue);
}

/* ══ THEME 1 ── MIDNIGHT (Dark Navy) [DEFAULT] ══
   Palette: Trust Blue · Growth Green · Alert Rose
   Psychology: Security + Wealth + Clear alerts */
html, html[data-theme="midnight"] {
  --bg:         #0D1117;
  --bg2:        #161B22;
  --bg3:        #1C2230;
  --card:       #1F2937;
  --card2:      #243347;
  --glass:      rgba(22,27,34,0.96);
  --text:       #F1F5F9;
  --text2:      #94A3B8;
  --text3:      #475569;
  --border:     rgba(255,255,255,0.07);
  --border2:    rgba(255,255,255,0.13);
  --shadow:     0 8px 40px rgba(0,0,0,0.7);
  --shadow-sm:  0 2px 12px rgba(0,0,0,0.45);

  /* PRIMARY: Trust Blue — security, professionalism (PayPal, major banks) */
  /* Trust Blue — security, professionalism (PayPal, major banks) */
  --blue:       #3B82F6;
  --blue-l:     #60A5FA;
  --blue-d:     #1D4ED8;
  --blue-bg:    rgba(59,130,246,0.12);
  --blue-glow:  rgba(59,130,246,0.30);

  /* Growth Green — wealth, success, positive reinforcement */
  --emerald:    #10B981;
  --emerald-l:  #34D399;
  --emerald-bg: rgba(16,185,129,0.12);

  /* Rose Red — non-alarming expense alert (scannable, not stressful) */
  --rose:       #E11D48;
  --rose-l:     #F43F5E;
  --rose-bg:    rgba(225,29,72,0.12);

  /* Amber — budget limit warnings, approaching threshold */
  --amber:      #F59E0B;
  --amber-bg:   rgba(245,158,11,0.12);

  /* Teal — transfers, category breakdowns, colorblind-safe */
  --violet:     #14B8A6;
  --violet-bg:  rgba(20,184,166,0.12);

  --hero-grad:  linear-gradient(140deg, #1E3A8A 0%, #0F2040 55%, #070D1E 100%);
  --hero-border: rgba(59,130,246,0.30);
  --nav-bg:     rgba(13,17,23,0.98);
  color-scheme: dark;
}

/* ══ THEME 2 ── OBSIDIAN (Dark Charcoal) ══ */
html[data-theme="obsidian"] {
  --bg:         #0F0F0F;
  --bg2:        #161616;
  --bg3:        #1C1C1C;
  --card:       #222222;
  --card2:      #272727;
  --glass:      rgba(22,22,22,0.95);
  --text:       #F0EDE8;
  --text2:      #7A7570;
  --text3:      #454240;
  --border:     rgba(255,255,255,0.06);
  --border2:    rgba(255,255,255,0.11);
  --shadow:     0 8px 40px rgba(0,0,0,0.7);
  --shadow-sm:  0 2px 12px rgba(0,0,0,0.5);

  --blue:       #E8A835;
  --blue-l:     #F0C060;
  --blue-d:     #B8820A;
  --blue-bg:    rgba(232,168,53,0.10);
  --blue-glow:  rgba(232,168,53,0.22);

  --emerald:    #5CB85C;
  --emerald-l:  #7DD47D;
  --emerald-bg: rgba(92,184,92,0.10);

  --rose:       #E85454;
  --rose-l:     #F07A7A;
  --rose-bg:    rgba(232,84,84,0.10);

  --amber:      #E8A835;
  --amber-bg:   rgba(232,168,53,0.10);

  --violet:     #CC88EE;
  --violet-bg:  rgba(204,136,238,0.10);

  --hero-grad:  linear-gradient(140deg, #2A2010 0%, #1A1408 55%, #0E0C06 100%);
  --hero-border: rgba(232,168,53,0.25);
  --nav-bg:     rgba(15,15,15,0.97);
  color-scheme: dark;
}

/* ══ THEME 3 ── FOREST (Dark Green) ══ */
html[data-theme="forest"] {
  --bg:         #0A110D;
  --bg2:        #0F1912;
  --bg3:        #152018;
  --card:       #1A2820;
  --card2:      #1E2D24;
  --glass:      rgba(15,25,18,0.95);
  --text:       #E2EFEA;
  --text2:      #6E9080;
  --text3:      #3A5045;
  --border:     rgba(255,255,255,0.06);
  --border2:    rgba(255,255,255,0.11);
  --shadow:     0 8px 40px rgba(0,0,0,0.6);
  --shadow-sm:  0 2px 12px rgba(0,0,0,0.4);

  --blue:       #3DD68C;
  --blue-l:     #66E4A8;
  --blue-d:     #20A860;
  --blue-bg:    rgba(61,214,140,0.10);
  --blue-glow:  rgba(61,214,140,0.22);

  --emerald:    #3DD68C;
  --emerald-l:  #66E4A8;
  --emerald-bg: rgba(61,214,140,0.10);

  --rose:       #FF6B6B;
  --rose-l:     #FF9090;
  --rose-bg:    rgba(255,107,107,0.10);

  --amber:      #FFD166;
  --amber-bg:   rgba(255,209,102,0.10);

  --violet:     #A9C4FF;
  --violet-bg:  rgba(169,196,255,0.10);

  --hero-grad:  linear-gradient(140deg, #0D3020 0%, #071A10 55%, #030D07 100%);
  --hero-border: rgba(61,214,140,0.25);
  --nav-bg:     rgba(10,17,13,0.97);
  color-scheme: dark;
}

/* ══ THEME 4 ── IVORY (Light Clean) ══
   Palette: Classic fintech — Blue trust, Green wealth, Rose alerts
   Excellent contrast ratios (>4.5:1) for accessibility */
html[data-theme="ivory"] {
  --bg:         #F8FAFC;
  --bg2:        #FFFFFF;
  --bg3:        #EEF2F7;
  --card:       #FFFFFF;
  --card2:      #F1F5FB;
  --glass:      rgba(255,255,255,0.97);
  --text:       #0F172A;
  --text2:      #475569;
  --text3:      #94A3B8;
  --border:     rgba(15,23,42,0.08);
  --border2:    rgba(15,23,42,0.14);
  --shadow:     0 4px 24px rgba(15,23,42,0.08);
  --shadow-sm:  0 2px 8px rgba(15,23,42,0.06);

  /* Trust Blue — same psychology, light-mode contrast */
  --blue:       #1D4ED8;
  --blue-l:     #3B82F6;
  --blue-d:     #1E3A8A;
  --blue-bg:    rgba(29,78,216,0.07);
  --blue-glow:  rgba(29,78,216,0.16);

  /* Growth Green */
  --emerald:    #059669;
  --emerald-l:  #10B981;
  --emerald-bg: rgba(5,150,105,0.07);

  /* Rose Red — non-alarming expense indicator */
  /* Rose Red — non-alarming expense, accessibility contrast >4.5:1 */
  --rose:       #E11D48;
  --rose-l:     #F43F5E;
  --rose-bg:    rgba(225,29,72,0.08);

  /* Amber alerts */
  --amber:      #D97706;
  --amber-bg:   rgba(217,119,6,0.07);

  /* Category Teal */
  --violet:     #0D9488;
  --violet-bg:  rgba(13,148,136,0.07);

  --hero-grad:  linear-gradient(140deg, #1E3A8A 0%, #1D4ED8 55%, #2563EB 100%);
  --hero-border: rgba(29,78,216,0.25);
  --nav-bg:     rgba(248,250,252,0.98);
  color-scheme: light;
}

/* ══ THEME 5 ── ARCTIC (Light Blue-Gray) ══ */
html[data-theme="arctic"] {
  --bg:         #EFF3FA;
  --bg2:        #FFFFFF;
  --bg3:        #E3E9F5;
  --card:       #FFFFFF;
  --card2:      #F0F4FC;
  --glass:      rgba(255,255,255,0.97);
  --text:       #0D1830;
  --text2:      #3D5278;
  --text3:      #8FA0C0;
  --border:     rgba(61,82,120,0.10);
  --border2:    rgba(61,82,120,0.16);
  --shadow:     0 4px 24px rgba(13,24,48,0.10);
  --shadow-sm:  0 2px 8px rgba(13,24,48,0.07);

  --blue:       #0070F3;
  --blue-l:     #3388FF;
  --blue-d:     #004EC4;
  --blue-bg:    rgba(0,112,243,0.08);
  --blue-glow:  rgba(0,112,243,0.18);

  --emerald:    #00A86B;
  --emerald-l:  #00C880;
  --emerald-bg: rgba(0,168,107,0.08);

  --rose:       #E0174E;
  --rose-l:     #F54A72;
  --rose-bg:    rgba(224,23,78,0.08);

  --amber:      #E07B00;
  --amber-bg:   rgba(224,123,0,0.08);

  --violet:     #6B3FCC;
  --violet-bg:  rgba(107,63,204,0.08);

  --hero-grad:  linear-gradient(140deg, #0044AA 0%, #002266 55%, #00133D 100%);
  --hero-border: rgba(0,112,243,0.22);
  --nav-bg:     rgba(239,243,250,0.98);
  color-scheme: light;
}

/* ══ THEME 6 ── ROSE GOLD (Light Warm) ══ */
html[data-theme="rose-gold"] {
  --bg:         #FAF5F5;
  --bg2:        #FFFFFF;
  --bg3:        #F5EDED;
  --card:       #FFFFFF;
  --card2:      #FDF8F8;
  --glass:      rgba(255,255,255,0.97);
  --text:       #1A0A0A;
  --text2:      #664444;
  --text3:      #B89090;
  --border:     rgba(180,80,80,0.09);
  --border2:    rgba(180,80,80,0.15);
  --shadow:     0 4px 24px rgba(80,20,20,0.10);
  --shadow-sm:  0 2px 8px rgba(80,20,20,0.07);

  --blue:       #C0604A;
  --blue-l:     #D97A65;
  --blue-d:     #9A3C2A;
  --blue-bg:    rgba(192,96,74,0.08);
  --blue-glow:  rgba(192,96,74,0.18);

  --emerald:    #2E8B5A;
  --emerald-l:  #3DAA72;
  --emerald-bg: rgba(46,139,90,0.08);

  --rose:       #C0182A;
  --rose-l:     #E03244;
  --rose-bg:    rgba(192,24,42,0.08);

  --amber:      #B86B20;
  --amber-bg:   rgba(184,107,32,0.08);

  --violet:     #8855AA;
  --violet-bg:  rgba(136,85,170,0.08);

  --hero-grad:  linear-gradient(140deg, #8B3030 0%, #5A1A1A 55%, #300808 100%);
  --hero-border: rgba(192,96,74,0.25);
  --nav-bg:     rgba(250,245,245,0.98);
  color-scheme: light;
}

/* ── Adapt nav/header for light themes ── */
html[data-theme="ivory"] .app-nav,
html[data-theme="arctic"] .app-nav,
html[data-theme="rose-gold"] .app-nav { background: var(--nav-bg); border-top: 1px solid var(--border2); }
html[data-theme="ivory"] .header,
html[data-theme="arctic"] .header,
html[data-theme="rose-gold"] .header { background: var(--bg); }

/* ── Hero card uses theme gradient ── */
.home-balance-card,
.home-card { background: var(--hero-grad) !important; border-color: var(--hero-border) !important; }
.cf-header { background: var(--hero-grad) !important; border-color: var(--hero-border) !important; }

/* ── Light-mode chart axes readability ── */
html[data-theme="ivory"] .tx-group-date,
html[data-theme="arctic"] .tx-group-date,
html[data-theme="rose-gold"] .tx-group-date { background: var(--bg); }

/* ── light-mode modal ── */
html[data-theme="ivory"] .modal,
html[data-theme="arctic"] .modal,
html[data-theme="rose-gold"] .modal { background: var(--bg2); }

/* ── form-input light ── */
html[data-theme="ivory"] .form-input,
html[data-theme="arctic"] .form-input,
html[data-theme="rose-gold"] .form-input { background: var(--bg3); color: var(--text); }

/* backward compat: html.light maps to ivory */
html.light {
  --bg:    #F8FAFC; --bg2: #FFFFFF; --bg3: #EEF2F7;
  --card:  #FFFFFF; --card2: #F1F5FB;
  --text:  #0F172A; --text2: #475569; --text3: #94A3B8;
  --border: rgba(15,23,42,0.08); --border2: rgba(15,23,42,0.14);
  --blue:  #1D4ED8; --blue-l: #3B82F6; --blue-d: #1E3A8A;
  --blue-bg: rgba(29,78,216,0.07); --blue-glow: rgba(29,78,216,0.16);
  --emerald: #059669; --emerald-l: #10B981; --emerald-bg: rgba(5,150,105,0.07);
  --rose: #E11D48; --rose-l: #F43F5E; --rose-bg: rgba(225,29,72,0.08);
  --amber: #D97706; --amber-bg: rgba(217,119,6,0.07);
  --violet: #0D9488; --violet-bg: rgba(13,148,136,0.07);
  --shadow: 0 4px 24px rgba(15,23,42,0.08); --shadow-sm: 0 2px 8px rgba(15,23,42,0.06);
  --hero-grad: linear-gradient(140deg,#1E3A8A 0%,#1D4ED8 55%,#2563EB 100%);
  --hero-border: rgba(29,78,216,0.25); --nav-bg: rgba(248,250,252,0.98);
  color-scheme: light;
}
html.light .app-nav { background: var(--nav-bg); border-top: 1px solid var(--border2); }
html.light .header { background: var(--bg); }
html.light .modal { background: var(--bg2); }
html.light .form-input { background: var(--bg3); color: var(--text); }
html.light .tx-group-date { background: var(--bg); }

/* ── Reset ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { transition: background .3s, color .3s; }
html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font); -webkit-font-smoothing: antialiased; font-size: 14px; }
.card, .settings-card, .modal, .app-nav, .header { transition: background .3s, border-color .3s; }

/* ══════════════════════════════
   LAYOUT SHELL
══════════════════════════════ */
#app {
  display: flex; flex-direction: column; height: 100dvh;
  max-width: 430px; margin: 0 auto;
  position: relative; background: var(--bg); overflow: hidden;
}

.screen { display: none; flex-direction: column; flex: 1; overflow: hidden; }
.screen.active { display: flex; animation: fadeUp .2s var(--ease); }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }

.scroll-area { flex: 1; overflow-y: auto; padding-bottom: 86px; scrollbar-width: none; }
.scroll-area::-webkit-scrollbar { display: none; }

/* ══════════════════════════════
   TOP BAR (non-home screens)
══════════════════════════════ */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px 12px;
  background: var(--bg); border-bottom: 1px solid var(--border);
  flex-shrink: 0; position: sticky; top: 0; z-index: 50;
  backdrop-filter: blur(20px);
}
.header h1 { font-size: 17px; font-weight: 700; letter-spacing: -0.4px; color: var(--text); }
.header-actions { display: flex; gap: 6px; align-items: center; }

/* ── Icon button ── */
.icon-btn {
  width: 34px; height: 34px; border-radius: 9px;
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--text2); display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 14px; transition: all .15s var(--ease);
}
.icon-btn:active { transform: scale(.9); background: var(--card); }

/* ── Header add button ── */
.hdr-add-btn {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--blue); border: none; border-radius: 9px;
  padding: 7px 13px; color: #fff; font-family: var(--font);
  font-size: 12px; font-weight: 600; cursor: pointer;
  -webkit-appearance: none; transition: all .15s var(--ease);
  box-shadow: 0 2px 10px var(--blue-glow);
}
.hdr-add-btn:active { transform: scale(.96); }

/* ══════════════════════════════
   BOTTOM NAVIGATION — new pill nav
══════════════════════════════ */
.app-nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 430px;
  background: var(--nav-bg, rgba(11,15,26,0.97));
  backdrop-filter: blur(28px) saturate(180%);
  -webkit-backdrop-filter: blur(28px) saturate(180%);
  border-top: 1px solid var(--border2);
  display: grid; grid-template-columns: repeat(6, 1fr);
  padding: 6px 4px calc(6px + env(safe-area-inset-bottom));
  z-index: 100; gap: 2px;
  transition: background .3s;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center;
  padding: 7px 2px 5px; cursor: pointer; border-radius: 11px;
  transition: all .18s var(--ease); gap: 3px; position: relative;
}
.nav-item:active { transform: scale(.91); }
.nav-item.active { background: var(--blue-bg); }
.nav-icon { font-size: 19px; line-height: 1; transition: transform .2s var(--ease); display:flex; align-items:center; justify-content:center; }
.nav-label { font-size: 8.5px; color: var(--text3); font-weight: 600; letter-spacing: .2px; white-space: nowrap; }
.nav-item.active .nav-icon { transform: scale(1.12); }
.nav-item.active .nav-label { color: var(--blue); }
.nav-badge {
  position: absolute; top: 3px; right: calc(50% - 20px);
  background: var(--rose); color: #fff; font-size: 8px; font-weight: 700;
  min-width: 14px; height: 14px; border-radius: 99px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 3px; border: 1.5px solid var(--bg);
}

/* ══════════════════════════════
   HOME SCREEN
══════════════════════════════ */
.home-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 18px 12px; flex-shrink: 0;
}
.home-logo {
  font-size: 16px; font-weight: 800; letter-spacing: -0.5px;
  color: var(--text);
}
.home-logo em { font-style: normal; color: var(--blue); }
.home-header-actions { display: flex; gap: 8px; align-items: center; }

/* ── Hero balance card ── */
.home-card {
  margin: 0 16px 14px;
  background: var(--hero-grad, linear-gradient(140deg, #1C3A9E 0%, #0D1E60 60%, #080F30 100%));
  border-radius: 20px; padding: 22px 20px 18px;
  border: 1px solid var(--hero-border, rgba(61,126,255,0.22));
  position: relative; overflow: hidden;
  box-shadow: 0 12px 48px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
  transition: background .4s, border-color .4s;
}
.home-card::before {
  content: ''; position: absolute; top: -50px; right: -50px;
  width: 220px; height: 220px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,.08) 0%, transparent 65%);
  pointer-events: none;
}
.home-card::after {
  content: ''; position: absolute; bottom: -60px; left: -30px;
  width: 180px; height: 180px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,.04) 0%, transparent 65%);
  pointer-events: none;
}
/* backward-compat aliases */
.home-balance-card { margin: 0 16px 14px; background: var(--hero-grad, linear-gradient(140deg, #1C3A9E 0%, #0D1E60 60%, #080F30 100%)); border-radius: 20px; padding: 22px 20px 18px; border: 1px solid var(--hero-border, rgba(61,126,255,0.22)); position: relative; overflow: hidden; box-shadow: 0 12px 48px rgba(0,0,0,.5); transition: background .4s, border-color .4s; }
.hbc-label { font-size: 10px; font-weight: 600; color: rgba(255,255,255,.45); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 7px; }
.hbc-amount { font-family: var(--mono); font-size: 38px; font-weight: 600; color: #fff; letter-spacing: -1.5px; position: relative; z-index: 1; }
.hbc-amount.negative { color: var(--rose-l); }
.hbc-date { font-size: 11px; color: rgba(255,255,255,.3); margin: 4px 0 16px; position: relative; z-index: 1; }
.hbc-divider { border: none; border-top: 1px solid rgba(255,255,255,.08); margin-bottom: 14px; }
.hbc-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; position: relative; z-index: 1; }
.hbc-stat-label { font-size: 10px; color: rgba(255,255,255,.38); letter-spacing: .5px; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
.hbc-stat-val { font-family: var(--mono); font-size: 16px; font-weight: 600; }
.hbc-stat-val.inc { color: var(--emerald-l); }
.hbc-stat-val.exp { color: var(--rose-l); }
.hbc-period-row { display: flex; gap: 5px; position: relative; z-index: 1; }
.hbc-period-btn { flex: 1; padding: 6px 4px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); border-radius: 8px; color: rgba(255,255,255,.4); font-family: var(--font); font-size: 10px; font-weight: 600; cursor: pointer; transition: all .15s; }
.hbc-period-btn.active { background: var(--blue); border-color: var(--blue); color: #fff; box-shadow: 0 2px 8px var(--blue-glow); }

/* ── Section header ── */
.sh { display: flex; justify-content: space-between; align-items: center; padding: 16px 18px 10px; }
.sh-label { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; }
.sh-link { font-size: 11px; font-weight: 600; color: var(--blue-l); cursor: pointer; }

/* ── Quick action grid ── */
.quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 0 16px 4px; }
.qa-btn {
  display: flex; flex-direction: column; align-items: center; gap: 7px;
  background: var(--card); border: 1px solid var(--border); border-radius: 13px;
  padding: 13px 4px 11px; cursor: pointer; transition: all .15s; -webkit-appearance: none;
}
.qa-btn:active { transform: scale(.93); background: var(--card2); }
.qa-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
.qa-label { font-size: 9px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: .4px; }

/* ── Add tx CTA ── */
.add-tx-cta {
  margin: 0 16px 14px;
  background: linear-gradient(135deg, var(--blue) 0%, var(--blue-d) 100%);
  border: none; border-radius: 15px; padding: 15px 18px;
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; -webkit-appearance: none; transition: all .15s;
  box-shadow: 0 4px 20px var(--blue-glow);
}
.add-tx-cta:active { transform: scale(.97); }
.add-tx-cta-left { display: flex; align-items: center; gap: 12px; }
.add-tx-cta-icon { width: 40px; height: 40px; border-radius: 11px; background: rgba(255,255,255,.15); display: flex; align-items: center; justify-content: center; font-size: 20px; }
.add-tx-cta-title { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: -.2px; }
.add-tx-cta-sub { font-size: 10px; color: rgba(255,255,255,.6); font-weight: 500; margin-top: 2px; }
.add-tx-cta-arrow { font-size: 20px; color: rgba(255,255,255,.4); }

/* ── Account chips row ── */
.accs-scroll { display: flex; gap: 9px; overflow-x: auto; scrollbar-width: none; padding: 0 16px 4px; }
.accs-scroll::-webkit-scrollbar { display: none; }
.acc-chip {
  min-width: 148px; background: var(--card); border: 1px solid var(--border);
  border-radius: 14px; padding: 13px 13px; flex-shrink: 0; cursor: pointer; transition: all .15s;
}
.acc-chip:active { transform: scale(.96); border-color: var(--border2); }
.acc-chip-icon { font-size: 20px; margin-bottom: 9px; }
.acc-chip-name { font-size: 12px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
.acc-chip-type { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600; }
.acc-chip-bal { font-family: var(--mono); font-size: 15px; font-weight: 600; }

/* ── Voice AI Settings ───────────────────────────── */
.vai-field-row{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:11px 12px;margin-bottom:8px;transition:border-color .2s}
.vai-field-row.enabled{border-color:rgba(16,185,129,.35)}
.vai-kw-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:6px 9px;font-size:11px;color:var(--text);outline:none;margin-top:5px}
.vai-kw-input:focus{border-color:var(--blue)}
.vai-tab-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.vai-tab-btn{padding:5px 11px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text3);font-size:10px;font-weight:700;cursor:pointer;transition:all .15s}
.vai-tab-btn.active{background:var(--blue-bg);border-color:var(--blue);color:var(--blue)}
.vai-confirm-field{display:flex;align-items:center;justify-content:space-between;padding:11px 13px;border-radius:10px;border:1px solid var(--border);background:var(--bg3);transition:all .2s;gap:8px}
.vai-confirm-field.filled{background:var(--card);border-color:rgba(16,185,129,.3);box-shadow:0 2px 8px rgba(16,185,129,.07)}
.vai-confirm-field.empty{background:var(--bg3);border-color:rgba(245,158,11,.2);opacity:.75}
.vai-quick-bar{position:fixed;bottom:72px;left:0;right:0;z-index:900;padding:0 12px 6px;pointer-events:none;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}
.vai-quick-bar.show{pointer-events:auto;opacity:1;transform:translateY(0)}
.vai-quick-inner{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px;box-shadow:0 4px 24px rgba(0,0,0,.28)}
.vai-quick-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:13px;color:var(--text);outline:none}
.vai-quick-input:focus{border-color:var(--violet)}
.vai-mic-btn{width:38px;height:38px;border-radius:10px;background:var(--violet-bg);border:1px solid var(--violet);color:var(--violet);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.vai-mic-btn.listening{background:var(--rose-bg);border-color:var(--rose);color:var(--rose);animation:pulse-ring 1.2s infinite}
.vai-parse-btn{background:var(--violet);color:#fff;border:none;border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:opacity .15s}
.vai-parse-btn:active{opacity:.8}
.vai-conf-bar-wrap{background:var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:12px}
.vai-conf-bar-track{background:var(--bg);border-radius:99px;height:5px;overflow:hidden;margin-top:6px}
.vai-conf-bar-fill{height:100%;border-radius:99px;background:var(--emerald);transition:width .4s}

/* ── Form VAI Smart Input (embedded in forms) ── */
.form-vai-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:16px}
.form-vai-header{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.form-vai-badge{font-size:9px;font-weight:700;padding:1px 6px;border-radius:99px;background:var(--violet-bg);color:var(--violet);text-transform:uppercase}
.form-vai-bar{display:flex;gap:6px;align-items:center}
.form-vai-input{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:9px 12px;font-size:12.5px;color:var(--text);outline:none;transition:border-color .15s}
.form-vai-input:focus{border-color:var(--violet)}
.form-vai-input::placeholder{color:var(--text3)}
.form-vai-mic{width:36px;height:36px;border-radius:9px;background:var(--violet-bg);border:1px solid var(--violet);color:var(--violet);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.form-vai-mic.listening{background:var(--rose-bg);border-color:var(--rose);color:var(--rose);animation:pulse-ring 1.2s infinite}
.form-vai-result{background:var(--card);border:1px solid rgba(16,185,129,.3);border-radius:10px;padding:10px 12px;margin-top:8px;display:none}
.form-vai-result.show{display:block}
.form-vai-result-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.form-vai-result-lbl{font-size:10px;font-weight:700;color:var(--emerald);display:flex;align-items:center;gap:5px}
.form-vai-conf-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;background:var(--emerald-bg);color:var(--emerald)}
.form-vai-conf-badge.mid{background:var(--amber-bg);color:var(--amber)}
.form-vai-conf-badge.low{background:var(--rose-bg);color:var(--rose)}
.form-vai-dismiss{background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:0;line-height:1}
.form-vai-fields{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.form-vai-field{background:var(--bg3);border-radius:7px;padding:6px 8px}
.form-vai-field-lbl{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:2px}
.form-vai-field-val{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.form-vai-field-val.empty{color:var(--text3);font-style:italic}
.form-vai-meter{height:3px;background:var(--bg);border-radius:99px;overflow:hidden;margin-bottom:8px}
.form-vai-meter-fill{height:100%;border-radius:99px;background:var(--emerald);transition:width .35s}
.form-vai-actions{display:flex;gap:6px}
.form-vai-apply{flex:1;background:var(--emerald);color:#fff;border:none;border-radius:8px;padding:9px;font-size:12px;font-weight:700;cursor:pointer;transition:opacity .15s}
.form-vai-apply:active{opacity:.8}
.form-vai-edit{background:var(--bg3);color:var(--text2);border:1px solid var(--border);border-radius:8px;padding:9px 14px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
.form-vai-hint{font-size:10px;color:var(--text3);margin-top:6px;min-height:14px}


.mini-report-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 8px; }
.mrc { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px 10px; text-align: center; }
.mrc-val { font-family: var(--mono); font-size: 13px; font-weight: 600; }
.mrc-lbl { font-size: 9px; color: var(--text3); margin-top: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }

/* ── Recent tx feed ── */
.tx-feed-wrap { padding: 0 16px; }
.tx-feed-item { display: flex; align-items: center; gap: 11px; padding: 11px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: opacity .15s; }
.tx-feed-item:last-child { border-bottom: none; }
.tx-feed-item:active { opacity: .65; }
.tx-feed-icon { width: 38px; height: 38px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; }
.tx-feed-icon.expense { background: var(--rose-bg); }
.tx-feed-icon.income { background: var(--emerald-bg); }
.tx-feed-icon.transfer { background: var(--violet-bg); }
.tx-feed-info { flex: 1; min-width: 0; }
.tx-feed-cat { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tx-feed-meta { font-size: 10px; color: var(--text3); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tx-feed-right { text-align: right; flex-shrink: 0; }
.tx-feed-amt { font-family: var(--mono); font-size: 13px; font-weight: 600; }
.tx-feed-amt.expense { color: var(--rose); }
.tx-feed-amt.income { color: var(--emerald); }
.tx-feed-amt.transfer { color: var(--violet); }
.tx-feed-date { font-size: 10px; color: var(--text3); margin-top: 2px; }

/* ══════════════════════════════
   TRANSACTIONS SCREEN
══════════════════════════════ */
.tx-item { display: flex; align-items: center; gap: 11px; padding: 13px 18px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .15s; }
.tx-item:last-child { border-bottom: none; }
.tx-item:active { background: var(--bg3); }
.tx-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
.tx-icon.expense { background: var(--rose-bg); }
.tx-icon.income { background: var(--emerald-bg); }
.tx-icon.transfer { background: var(--violet-bg); }
.tx-info { flex: 1; min-width: 0; }
.tx-cat { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tx-desc { font-size: 11px; color: var(--text3); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tx-ref { font-size: 10px; color: var(--text3); margin-top: 1px; }
.tx-right { text-align: right; flex-shrink: 0; }
.tx-amount { font-family: var(--mono); font-size: 14px; font-weight: 600; }
.tx-amount.expense { color: var(--rose); }
.tx-amount.income { color: var(--emerald); }
.tx-amount.transfer { color: var(--violet); }
.tx-date { font-size: 10px; color: var(--text3); margin-top: 2px; }
.tx-group-date { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1.2px; padding: 14px 18px 6px; background: var(--bg); position: sticky; top: 0; z-index: 2; }

/* ══════════════════════════════
   CARDS / COMMON
══════════════════════════════ */
.card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 10px; }
.card-sm { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; }
.chart-wrap { position: relative; height: 180px; }
.section-title { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
.net-info-box { background: var(--violet-bg); border: 1px solid rgba(155,127,255,.18); border-radius: 10px; padding: 10px 13px; font-size: 11px; color: var(--text2); margin-bottom: 14px; line-height: 1.5; }

/* ── Period tabs ── */
.period-tabs { display: flex; background: var(--bg3); border-radius: 10px; padding: 3px; gap: 2px; margin-bottom: 14px; border: 1px solid var(--border); }
.period-tab { flex: 1; padding: 7px; border: none; background: none; color: var(--text3); font-family: var(--font); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all .15s; }
.period-tab.active { background: var(--blue); color: #fff; box-shadow: 0 2px 8px var(--blue-glow); }

/* ── Screen tabs (underline style) ── */
.screen-tabs { display: flex; overflow-x: auto; scrollbar-width: none; padding: 0 16px; gap: 0; flex-shrink: 0; border-bottom: 1px solid var(--border); }
.screen-tabs::-webkit-scrollbar { display: none; }
.screen-tab { padding: 12px 14px 11px; border: none; background: none; color: var(--text3); font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all .15s; flex-shrink: 0; }
.screen-tab.active { color: var(--blue); border-bottom-color: var(--blue); }

/* ══════════════════════════════
   MODALS
══════════════════════════════ */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.72); z-index: 200; display: none; align-items: flex-end; backdrop-filter: blur(6px); }
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg2); border-radius: 22px 22px 0 0; width: 100%; max-width: 430px;
  margin: 0 auto; padding: 20px 20px 28px; max-height: 92vh; overflow-y: auto;
  border-top: 1px solid var(--border2); animation: slideUp .26s cubic-bezier(.34,1.1,.64,1);
}
@keyframes slideUp { from { transform: translateY(100%); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
.modal-handle { width: 38px; height: 4px; background: var(--border2); border-radius: 99px; margin: 0 auto 18px; }
.modal-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; text-align: center; letter-spacing: -.3px; }

/* ── Forms ── */
.form-group { margin-bottom: 13px; }
.form-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 6px; display: block; font-weight: 700; }
.form-input {
  width: 100%; background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text); font-family: var(--font);
  font-size: 14px; padding: 11px 13px; outline: none;
  transition: border-color .15s, box-shadow .15s; -webkit-appearance: none; appearance: none;
}
.form-input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px var(--blue-bg); }
.form-input::placeholder { color: var(--text3); }
.balance-warning { background: var(--rose-bg); border: 1px solid rgba(255,77,106,.3); border-radius: 8px; padding: 7px 11px; font-size: 11px; color: var(--rose); margin-top: 5px; display: none; }

/* ── Type tabs ── */
.type-tabs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 13px; }
.type-tab { padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg3); color: var(--text3); font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; transition: all .15s; }
.type-tab.active.expense { background: var(--rose-bg); border-color: rgba(255,77,106,.4); color: var(--rose); }
.type-tab.active.income { background: var(--emerald-bg); border-color: rgba(0,200,150,.4); color: var(--emerald); }
.type-tab.active.transfer { background: var(--violet-bg); border-color: rgba(155,127,255,.4); color: var(--violet); }

/* ── Buttons ── */
.btn-primary {
  width: 100%; padding: 13px; background: var(--blue);
  border: none; border-radius: 11px; color: #fff;
  font-family: var(--font); font-size: 14px; font-weight: 700;
  cursor: pointer; margin-top: 8px; transition: all .15s;
  -webkit-appearance: none; box-shadow: 0 3px 14px var(--blue-glow);
}
.btn-primary:active { transform: scale(.97); }
.btn-danger { background: var(--rose) !important; box-shadow: 0 3px 14px rgba(255,77,106,.3) !important; }
.btn-success { background: var(--emerald) !important; color: #040f0b !important; box-shadow: 0 3px 14px rgba(0,200,150,.3) !important; }
.btn-warn { background: var(--amber) !important; color: #1a1208 !important; }
.btn-secondary { background: var(--bg3) !important; color: var(--text) !important; border: 1px solid var(--border) !important; box-shadow: none !important; }
.btn-ghost { background: var(--bg3) !important; color: var(--text) !important; border: 1px solid var(--border2) !important; box-shadow: none !important; }

/* ── Toast ── */
.toast {
  position: fixed; top: 18px; left: 50%; transform: translateX(-50%) translateY(-14px);
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 11px; padding: 11px 18px; font-size: 13px; font-weight: 600;
  z-index: 1000; opacity: 0; transition: all .25s var(--ease);
  pointer-events: none; white-space: normal; max-width: min(88vw, 360px);
  text-align: center; line-height: 1.45;
  backdrop-filter: blur(20px); box-shadow: var(--shadow);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--emerald); color: var(--emerald); }
.toast.error { border-color: var(--rose); color: var(--rose); }
.toast.warn { border-color: var(--amber); color: var(--amber); }
.toast.info { border-color: var(--blue); color: var(--blue-l); }

/* ══════════════════════════════
   ACCOUNTS SCREEN
══════════════════════════════ */
.card-swiper-wrap { position: relative; overflow: hidden; margin: 0 0 6px; user-select: none; }
.card-swiper { display: flex; transition: transform .35s cubic-bezier(.25,.46,.45,.94); will-change: transform; }
.vcard { min-width: 100%; padding: 0 16px; flex-shrink: 0; }
.vcard-inner { position: relative; border-radius: 18px; padding: 22px 20px 18px; overflow: hidden; min-height: 162px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 8px 28px rgba(0,0,0,.4); }
.vcard-inner::before { content: ''; position: absolute; top: -30px; right: -30px; width: 130px; height: 130px; border-radius: 50%; background: rgba(255,255,255,.06); }
.vcard-inner::after { content: ''; position: absolute; bottom: -40px; left: -20px; width: 160px; height: 160px; border-radius: 50%; background: rgba(255,255,255,.03); }
.vcard-top { display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1; }
.vcard-type-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; opacity: .6; }
.vcard-icon { font-size: 22px; }
.vcard-middle { position: relative; z-index: 1; }
.vcard-balance-label { font-size: 9px; opacity: .55; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
.vcard-balance { font-family: var(--mono); font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
.vcard-bottom { display: flex; justify-content: space-between; align-items: flex-end; position: relative; z-index: 1; }
.vcard-name { font-size: 11px; font-weight: 700; letter-spacing: .5px; text-transform: uppercase; }
.vcard-number { font-family: var(--mono); font-size: 11px; opacity: .55; letter-spacing: 2px; }
.swiper-dots { display: flex; justify-content: center; gap: 5px; margin: 8px 0 2px; }
.swiper-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--border2); transition: all .2s; }
.swiper-dot.active { width: 16px; border-radius: 3px; background: var(--blue); }
.swiper-hint { text-align: center; font-size: 10px; color: var(--text3); margin-bottom: 8px; }
.account-card { background: var(--card); border: 1px solid var(--border); border-radius: 13px; padding: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all .15s; }
.account-card:active { transform: scale(.98); }
.account-card-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 19px; flex-shrink: 0; }
.account-card-info { flex: 1; min-width: 0; }
.account-card-name { font-size: 13px; font-weight: 700; margin-bottom: 1px; }
.account-card-num { font-family: var(--mono); font-size: 10px; color: var(--text3); }
.account-card-bal { font-family: var(--mono); font-size: 15px; font-weight: 600; text-align: right; }
.accounts-scroll { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
.accounts-scroll::-webkit-scrollbar { display: none; }
.account-chip { min-width: 130px; background: var(--card); border: 1px solid var(--border); border-radius: 13px; padding: 12px; flex-shrink: 0; cursor: pointer; transition: all .15s; }
.account-chip:active { transform: scale(.96); }
.account-chip .chip-type { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight: 600; }
.account-chip .chip-name { font-size: 13px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.account-chip .chip-bal { font-family: var(--mono); font-size: 14px; font-weight: 600; }

/* ══════════════════════════════
   REPORTS
══════════════════════════════ */
.report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.report-stat { text-align: center; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px 10px 14px; min-width: 0; overflow: hidden; }
.report-stat .rs-val { font-family: var(--mono); font-size: 17px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.report-stat .rs-label { font-size: 9px; color: var(--text3); margin-top: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; white-space: nowrap; }
#recording-banner { position:fixed; top:0; left:0; right:0; z-index:9999; background:var(--rose); color:#fff; padding:8px 16px; display:none; align-items:center; gap:8px; font-size:12px; font-weight:700; justify-content:center; }
#recording-banner.show { display:flex; }
.rec-pulse { width:10px; height:10px; border-radius:50%; background:#fff; animation:pulse-ring 1.2s infinite; flex-shrink:0; }
/* FEATURE 1: Recording active banner — see #recording-banner above */
.cat-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.cat-item:last-child { border-bottom: none; }
.cat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.cat-name { flex: 1; font-size: 12px; font-weight: 500; }
.cat-bar-wrap { width: 60px; height: 3px; background: var(--bg3); border-radius: 99px; }
.cat-bar { height: 100%; border-radius: 99px; }
.cat-amount { font-family: var(--mono); font-size: 12px; color: var(--text2); min-width: 70px; text-align: right; }

/* ══════════════════════════════
   GOALS
══════════════════════════════ */
.goal-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 10px; transition: all .15s; cursor: pointer; }
.goal-card:active { transform: scale(.98); }
.goal-card.achieved { border-color: rgba(0,200,150,.22); }
.goal-hdr { display: flex; align-items: center; gap: 12px; margin-bottom: 13px; }
.goal-emoji-wrap { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
.goal-info { flex: 1; min-width: 0; }
.goal-name { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.goal-deadline { font-size: 11px; color: var(--text3); margin-top: 2px; }
.goal-pct-badge { font-family: var(--mono); font-size: 11px; font-weight: 600; padding: 3px 9px; border-radius: 7px; flex-shrink: 0; }
.goal-bar-wrap { background: var(--bg3); border-radius: 99px; height: 5px; margin-bottom: 12px; overflow: hidden; }
.goal-bar { height: 100%; border-radius: 99px; transition: width .6s; }
.goal-stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 7px; margin-bottom: 11px; }
.goal-stat-box { background: var(--bg3); border-radius: 9px; padding: 8px 4px; text-align: center; }
.goal-stat-val { font-family: var(--mono); font-size: 11px; font-weight: 600; }
.goal-stat-lbl { font-size: 9px; color: var(--text3); margin-top: 2px; font-weight: 600; }
.goal-actions { display: flex; gap: 7px; }
.goal-action-btn { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg3); color: var(--text3); font-family: var(--font); font-size: 11px; font-weight: 600; cursor: pointer; -webkit-appearance: none; transition: all .15s; }
.goal-action-btn.add { background: var(--emerald-bg); border-color: rgba(0,200,150,.3); color: var(--emerald); }
.goal-action-btn.edit { background: var(--violet-bg); border-color: rgba(155,127,255,.3); color: var(--violet); }
.goal-action-btn.achieved-btn { background: var(--blue-bg); border-color: rgba(61,126,255,.3); color: var(--blue); }

/* ══════════════════════════════
   PLANNED
══════════════════════════════ */
.planned-item { background: var(--card); border: 1px solid var(--border); border-radius: 13px; padding: 13px; margin-bottom: 9px; }
.planned-item.overdue { border-color: rgba(255,77,106,.3); background: rgba(255,77,106,.03); }
.planned-item.today { border-color: rgba(255,176,32,.3); background: rgba(255,176,32,.03); }
.planned-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.planned-cat { font-size: 13px; font-weight: 700; }
.planned-amount { font-family: var(--mono); font-size: 14px; font-weight: 600; }
.planned-meta { display: flex; align-items: center; gap: 7px; font-size: 11px; color: var(--text3); flex-wrap: wrap; }
.planned-badge { display: inline-block; padding: 2px 7px; border-radius: 99px; font-size: 9px; font-weight: 700; }
.planned-badge.overdue { background: var(--rose-bg); color: var(--rose); }
.planned-badge.today { background: var(--amber-bg); color: var(--amber); }
.planned-badge.upcoming { background: var(--blue-bg); color: var(--blue); }
.planned-badge.done { background: var(--emerald-bg); color: var(--emerald); }
.planned-badge.skipped { background: rgba(90,98,130,.2); color: var(--text3); }
.planned-actions { display: flex; gap: 7px; margin-top: 10px; }
.planned-btn { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg3); color: var(--text2); font-family: var(--font); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; transition: all .15s; -webkit-appearance: none; }
.planned-btn.confirm { background: var(--emerald-bg); border-color: rgba(0,200,150,.3); color: var(--emerald); }
.planned-btn.skip { background: rgba(90,98,130,.1); border-color: var(--text3); color: var(--text3); }
.planned-btn.edit-btn { background: var(--violet-bg); border-color: rgba(155,127,255,.3); color: var(--violet); }

/* ══════════════════════════════
   PAYABLES
══════════════════════════════ */
.payable-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 15px; margin-bottom: 9px; cursor: pointer; transition: all .15s; }
.payable-card:active { transform: scale(.99); }
.payable-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
.payable-name { font-size: 15px; font-weight: 700; letter-spacing: -.2px; }
.payable-type-badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 9px; font-weight: 700; margin-top: 4px; }
.payable-type-badge.loan { background: var(--violet-bg); color: var(--violet); }
.payable-type-badge.credit { background: var(--rose-bg); color: var(--rose); }
.payable-type-badge.spl { background: var(--amber-bg); color: var(--amber); }
.payable-type-badge.other { background: var(--bg3); color: var(--text3); }
.payable-progress-wrap { background: var(--bg3); border-radius: 99px; height: 5px; overflow: hidden; margin: 7px 0 5px; }
.payable-progress-bar { height: 100%; border-radius: 99px; transition: width .6s; }
.payable-actions { display: flex; gap: 6px; margin-top: 10px; }
.payable-btn { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg3); color: var(--text2); font-family: var(--font); font-size: 10px; font-weight: 700; cursor: pointer; text-align: center; transition: all .15s; -webkit-appearance: none; }
.payable-btn:active { transform: scale(.95); }
.payable-btn.pay { background: var(--emerald-bg); border-color: rgba(0,200,150,.3); color: var(--emerald); }
.payable-btn.schedule { background: var(--amber-bg); border-color: rgba(255,176,32,.3); color: var(--amber); }
.payable-btn.edit { background: var(--violet-bg); border-color: rgba(155,127,255,.3); color: var(--violet); }
.payable-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-bottom: 13px; }
.payable-sum-card { background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; padding: 13px; text-align: center; }
.psv { font-family: var(--mono); font-size: 16px; font-weight: 600; }
.psl { font-size: 9px; color: var(--text3); margin-top: 3px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
.payable-pie-wrap { position: relative; height: 160px; margin: 10px 0; }

/* ══════════════════════════════
   RECURRING
══════════════════════════════ */
.recur-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 13px; margin-bottom: 9px; transition: all .15s; cursor: pointer; }
.recur-card.paused { opacity: .5; }
.recur-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.recur-left { display: flex; align-items: center; gap: 10px; }
.recur-icon { width: 38px; height: 38px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; }
.recur-name { font-size: 13px; font-weight: 700; }
.recur-cat { font-size: 11px; color: var(--text3); margin-top: 1px; }
.recur-amount { font-family: var(--mono); font-size: 14px; font-weight: 600; text-align: right; }
.recur-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 9px; }
.recur-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; border-radius: 99px; font-size: 9px; font-weight: 700; }
.recur-badge.expense { background: var(--rose-bg); color: var(--rose); }
.recur-badge.income { background: var(--emerald-bg); color: var(--emerald); }
.recur-badge.freq { background: var(--violet-bg); color: var(--violet); }
.recur-badge.next { background: var(--amber-bg); color: var(--amber); }
.recur-actions { display: flex; gap: 6px; }
.recur-btn { flex: 1; padding: 7px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); font-family: var(--font); font-size: 10px; font-weight: 700; cursor: pointer; -webkit-appearance: none; transition: all .15s; }
.recur-btn.apply { background: var(--emerald-bg); border-color: rgba(0,200,150,.3); color: var(--emerald); }
.recur-btn.pause { background: var(--amber-bg); border-color: rgba(255,176,32,.3); color: var(--amber); }
.recur-btn.del { background: var(--rose-bg); border-color: rgba(255,77,106,.3); color: var(--rose); }
.recur-btn.sched { background: var(--blue-bg); border-color: rgba(59,130,246,.3); color: var(--blue); }

/* ══════════════════════════════
   REPAYMENT / RECURRING SCHEDULE TABLE
══════════════════════════════ */
.schedule-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
.schedule-table { width: 100%; border-collapse: collapse; min-width: 320px; }
.schedule-table thead tr { background: var(--bg3); }
.schedule-table th { padding: 8px 10px; text-align: left; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; color: var(--text3); white-space: nowrap; }
.schedule-table td { padding: 9px 10px; border-top: 1px solid var(--border); font-size: 11px; vertical-align: middle; }
.schedule-table tr.sched-paid td { opacity: .6; }
.schedule-table tr.sched-current td { background: rgba(245,158,11,.07); }
.schedule-table tr.sched-overdue td { background: rgba(225,29,72,.05); }
.sched-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; border-radius: 99px; font-size: 9px; font-weight: 700; white-space: nowrap; }
.sched-badge.paid     { background: var(--emerald-bg); color: var(--emerald); }
.sched-badge.applied  { background: var(--emerald-bg); color: var(--emerald); }
.sched-badge.upcoming { background: var(--blue-bg); color: var(--blue); }
.sched-badge.current  { background: var(--amber-bg); color: var(--amber); }
.sched-badge.overdue  { background: var(--rose-bg); color: var(--rose); }
.sched-badge.missed   { background: var(--rose-bg); color: var(--rose); }
.sched-badge.paused   { background: var(--bg3); color: var(--text3); }
.sched-summary { background: var(--bg3); border-radius: 12px; padding: 12px 14px; display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; text-align: center; margin-bottom: 12px; }
.sched-sum-val { font-family: var(--mono); font-size: 13px; font-weight: 700; }
.sched-sum-lbl { font-size: 9px; color: var(--text3); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: .4px; }
.sched-progress-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.sched-progress-bar-wrap { flex: 1; background: var(--bg3); border-radius: 99px; height: 6px; overflow: hidden; }
.sched-progress-bar { height: 100%; border-radius: 99px; transition: width .5s; }

/* ══════════════════════════════
   BUDGET
══════════════════════════════ */
.budget-bar-wrap { background: var(--bg3); border-radius: 99px; height: 5px; margin: 5px 0 2px; overflow: hidden; }
.budget-main-tab { background: transparent; color: var(--text3); }
.active-budget-tab { background: var(--card); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,.18); }
.budget-bar { height: 100%; border-radius: 99px; transition: width .5s; }
.budget-item { padding: 11px 0; border-bottom: 1px solid var(--border); }
.budget-item:last-child { border-bottom: none; }
.budget-item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
.budget-cat { font-size: 13px; font-weight: 600; }
.budget-pct { font-family: var(--mono); font-size: 11px; font-weight: 600; }
.budget-amounts { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); margin-top: 2px; }
.budget-over { color: var(--rose) !important; }
.budget-warn { color: var(--amber) !important; }
.budget-widget { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 14px; margin: 0 16px 14px; }
.bw-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.bw-title { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; }
.bw-link { font-size: 11px; color: var(--blue-l); cursor: pointer; font-weight: 600; }
.bw-item { padding: 8px 0; border-bottom: 1px solid var(--border); }
.bw-item:last-child { border-bottom: none; }
.bw-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.bw-cat { font-size: 12px; font-weight: 600; }
.bw-pct { font-family: var(--mono); font-size: 10px; font-weight: 600; }
.bw-bar-wrap { background: var(--bg3); border-radius: 99px; height: 4px; overflow: hidden; }
.bw-bar { height: 100%; border-radius: 99px; transition: width .5s; }

/* ══════════════════════════════
   SETTINGS
══════════════════════════════ */
.settings-item { display: flex; align-items: center; justify-content: space-between; padding: 13px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: opacity .15s; }
.settings-item:last-child { border-bottom: none; }
.settings-item:active { opacity: .7; }
.settings-label { font-size: 14px; font-weight: 600; }
.settings-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }
.settings-arrow { font-size: 18px; color: var(--text3); }
.privacy-toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
.privacy-toggle-row:last-child { border-bottom: none; }
.ptl { font-size: 13px; font-weight: 600; }
.pts { font-size: 11px; color: var(--text3); margin-top: 2px; }
.toggle-switch { position: relative; display: inline-block; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-track { width: 44px; height: 24px; background: var(--bg3); border: 1px solid var(--border2); border-radius: 99px; display: block; cursor: pointer; transition: all .2s; position: relative; }
.toggle-track::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: var(--text3); border-radius: 50%; transition: all .2s; }
.toggle-switch input:checked + .toggle-track { background: var(--blue); border-color: var(--blue); }
.toggle-switch input:checked + .toggle-track::after { transform: translateX(20px); background: #fff; }
.theme-toggle { display: flex; align-items: center; gap: 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text); width: 100%; -webkit-appearance: none; transition: all .15s; }

/* ══════════════════════════════
   SMART ALERTS
══════════════════════════════ */
/* ══ FINFLOW v5 CLASSIC — NEW HOME LAYOUT ══ */

/* Lucide icon helpers */
/* Old-style home screen overrides — when data-style="old" */
#screen-home[data-style="old"] .v5-topbar { display: none; }
#screen-home[data-style="old"] .v5-networth-section { display: none; }
#screen-home[data-style="old"] .v5-cards-scroll { display: none; }
#screen-home[data-style="old"] .v5-quick-actions { display: none; }
#screen-home[data-style="old"] .v5-time-filter { display: none; }
#screen-home[data-style="old"] .v5-section-header:not(.keep-old) { display: none; }
#screen-home[data-style="old"] #old-home-header { display: flex !important; }
#screen-home[data-style="old"] #old-balance-card { display: block !important; }
#screen-home[data-style="old"] #old-add-cta { display: flex !important; }
#screen-home[data-style="old"] #old-quick-actions { display: grid !important; }
#screen-home[data-style="old"] #old-accounts-chips { display: flex !important; }
#screen-home[data-style="old"] #widget-cashflow,
#screen-home[data-style="old"] #widget-miniReport,
#screen-home[data-style="old"] #widget-calendar,
#screen-home[data-style="old"] #widget-budgetPanel { display: block !important; }
/* Classic style (default) hides old elements */
#old-home-header { display: none; }
#old-balance-card { display: none; }
#old-add-cta { display: none; }
#old-quick-actions { display: none; }
#old-accounts-chips { display: none; }
/* Home widget section in old-style */
#home-widget-settings { transition: opacity .2s; }
/* Inline SVG icon helpers */
.hico { display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; }
.hico svg { display:block; }
/* Nav icon coloring - stroke on SVG */
.nav-item .nav-icon .hico svg { stroke: var(--text3); fill: none; }
.nav-item.active .nav-icon .hico svg { stroke: var(--blue); fill: none; }
/* Topbar icon coloring */
.v5-topbar-btn .hico svg { stroke: var(--text2); fill: none; }

/* Top bar */
.v5-topbar {
  display: flex; align-items: center; padding: 12px 12px 8px; flex-shrink: 0; gap: 4px;
}
.v5-topbar-btn {
  background: none; border: none; border-radius: 10px;
  width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text); transition: background .15s; position: relative;
  -webkit-appearance: none;
}
.v5-topbar-btn:active { background: var(--bg3); }

/* Home scroll */
.v5-home-scroll { padding-top: 0 !important; }

/* Net Worth — plain text on white, matches mockup */
.v5-networth-section {
  padding: 8px 20px 16px;
}
.v5-nw-label {
  font-size: 14px; font-weight: 600; color: var(--text2); margin-bottom: 4px;
}
.v5-nw-amount {
  font-size: 40px; font-weight: 800; color: var(--text); letter-spacing: -1.5px; margin-bottom: 16px; line-height: 1;
}
.v5-nw-amount.negative { color: var(--rose); }

/* Income / Expenses stat cards */
.v5-stat-cards {
  display: flex; gap: 12px;
}
.v5-stat-card {
  flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 16px;
  padding: 14px 16px;
}
.v5-stat-card-top {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;
}
.v5-stat-card-label {
  font-size: 12px; font-weight: 600; color: var(--text2);
}
.v5-stat-arrow {
  width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.v5-arrow-up { background: rgba(16,185,129,0.12); color: #10B981; }
.v5-arrow-down { background: rgba(225,29,72,0.12); color: #E11D48; }
.v5-stat-card-val {
  font-size: 18px; font-weight: 800; letter-spacing: -0.5px;
}
.v5-stat-card-val.inc { color: var(--emerald); }
.v5-stat-card-val.exp { color: var(--rose); }

/* Section headers */
.v5-section-header { display: flex; align-items: center; justify-content: space-between; padding: 0 20px; margin-bottom: 10px; }
.v5-section-title { font-size: 14px; font-weight: 700; color: var(--text); }
.v5-section-link { background: none; border: none; color: var(--blue); font-size: 12px; font-weight: 600; cursor: pointer; padding: 0; }

/* Account Cards Scroll */
.v5-cards-scroll {
  display: flex; gap: 12px; padding: 0 20px 18px;
  overflow-x: auto; scroll-snap-type: x mandatory;
  scrollbar-width: none; -webkit-overflow-scrolling: touch;
}
.v5-cards-scroll::-webkit-scrollbar { display: none; }

/* Account Card */
.v5-acc-card {
  flex-shrink: 0; width: 185px; min-height: 110px; border-radius: 20px;
  padding: 16px 15px; cursor: pointer; position: relative; overflow: hidden;
  scroll-snap-align: start;
  box-shadow: 0 6px 24px rgba(0,0,0,0.15);
  transition: transform .2s, box-shadow .2s;
  display: flex; flex-direction: column; justify-content: space-between;
}
.v5-acc-card:active { transform: scale(0.96); }
.v5-acc-card-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
.v5-acc-logo {
  width: 38px; height: 38px; border-radius: 10px; object-fit: contain;
  background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;
  font-size: 20px; overflow: hidden; flex-shrink: 0;
}
.v5-acc-logo img { width: 100%; height: 100%; object-fit: contain; }
.v5-acc-name { font-size: 13px; font-weight: 700; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.v5-acc-type-badge { font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; }
.v5-acc-balance { font-size: 19px; font-weight: 800; color: #fff; letter-spacing: -0.5px; text-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.v5-acc-number { font-size: 10px; color: rgba(255,255,255,0.65); font-family: var(--mono); margin-top: 2px; }
.v5-acc-add {
  width: 100px; min-height: 110px; border-radius: 20px; border: 2px dashed var(--border2);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 6px; cursor: pointer; scroll-snap-align: start; flex-shrink: 0; transition: all .2s; color: var(--text3);
}
.v5-acc-add:active { background: var(--bg3); }

/* Quick Actions */
.v5-quick-actions { display: flex; gap: 8px; padding: 0 20px 18px; }
.v5-qa-btn { flex: 1; background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 7px; padding: 0; }
.v5-qa-icon { width: 52px; height: 52px; border-radius: 18px; display: flex; align-items: center; justify-content: center; }
.v5-qa-label { font-size: 10px; font-weight: 600; color: var(--text2); }

/* Time filter */
.v5-time-filter { display: flex; gap: 6px; padding: 0 20px 18px; }
.v5-tf-btn {
  flex: 1; padding: 8px 0; border: 1px solid var(--border); border-radius: 12px;
  background: var(--bg2); color: var(--text2); font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all .15s; font-family: var(--font);
}
.v5-tf-btn.active { background: var(--blue); color: #fff; border-color: var(--blue); box-shadow: 0 2px 8px var(--blue-glow); }

/* Bottom Nav */
.app-nav { padding-bottom: max(12px, env(safe-area-inset-bottom, 0px)); }
.nav-add-center { flex: 0 0 auto !important; }
.nav-add-pill {
  width: 54px; height: 54px; background: var(--blue); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 16px var(--blue-glow);
  margin-top: -22px;
  transition: transform .15s;
}
.nav-add-center:active .nav-add-pill { transform: scale(0.9); }

/* More drawer */
.more-drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 290; display: none; }
.more-drawer-overlay.open { display: block; }
.more-drawer {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(110%);
  width: 100%; max-width: 430px; background: var(--bg2);
  border-radius: 24px 24px 0 0; border-top: 1px solid var(--border2);
  z-index: 300; padding: 12px 0 32px; transition: transform .3s var(--ease);
  box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
}
.more-drawer.open { transform: translateX(-50%) translateY(0); }
.more-drawer-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 99px; margin: 0 auto 12px; }
.more-drawer-title { font-size: 16px; font-weight: 700; color: var(--text); padding: 0 20px 14px; }
.more-drawer-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; padding: 0 16px; }
.more-drawer-item {
  background: var(--bg3); border: 1px solid var(--border); border-radius: 16px;
  padding: 14px 8px; display: flex; flex-direction: column; align-items: center; gap: 8px;
  cursor: pointer; transition: all .15s; -webkit-appearance: none;
}
.more-drawer-item:active { background: var(--card2); transform: scale(0.96); }
.more-drawer-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
.more-drawer-label { font-size: 11px; font-weight: 600; color: var(--text2); text-align: center; }

/* Contacts sheet */
.v5-contacts-sheet {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(110%);
  width: 100%; max-width: 430px; background: var(--bg2);
  border-radius: 24px 24px 0 0; border-top: 1px solid var(--border2);
  z-index: 300; max-height: 70vh; overflow-y: auto;
  transition: transform .3s var(--ease);
  box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
}
.v5-contacts-sheet.open { transform: translateX(-50%) translateY(0); }
.v5-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 290; display: none; }
.v5-sheet-overlay.open { display: block; }
.v5-sheet-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 99px; margin: 12px auto 8px; }
.v5-sheet-hdr { display: flex; align-items: center; justify-content: space-between; padding: 4px 16px 12px; }
.v5-sheet-title { font-size: 16px; font-weight: 700; color: var(--text); }

/* Logo upload */
.logo-upload-wrap {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  width: 80px; height: 80px; border-radius: 16px; border: 2px dashed var(--border2);
  cursor: pointer; background: var(--bg3); gap: 2px; transition: all .15s;
}
.logo-upload-wrap:active { background: var(--card2); }
.style-option-btn {
  background: var(--bg3); border: 2px solid var(--border); border-radius: 14px;
  padding: 14px 8px; cursor: pointer; transition: all .15s; text-align: center;
  color: var(--text); font-family: var(--font);
}
.style-option-btn.active { border-color: var(--blue); background: var(--blue-bg); }
.style-option-btn:active { transform: scale(0.96); }

.bell-btn { position: relative; background: var(--bg3); border: 1px solid var(--border); border-radius: 9px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 15px; transition: all .15s; -webkit-appearance: none; }
.bell-badge { position: absolute; top: -3px; right: -3px; background: var(--rose); color: #fff; font-size: 8px; font-weight: 700; min-width: 14px; height: 14px; border-radius: 99px; display: flex; align-items: center; justify-content: center; padding: 0 2px; }
.alerts-sheet { position: fixed; top: 0; left: 50%; transform: translateX(-50%) translateY(-110%); width: 100%; max-width: 430px; background: var(--bg2); border-bottom: 1px solid var(--border); z-index: 250; padding: 16px 16px; max-height: 55vh; overflow-y: auto; box-shadow: var(--shadow); transition: transform .28s var(--ease); }
.alerts-sheet.open { transform: translateX(-50%) translateY(0); }
.alerts-sheet-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.alerts-sheet-title { font-size: 14px; font-weight: 700; }
.alerts-sheet-close { background: var(--bg3); border: none; border-radius: 7px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; color: var(--text2); }
.smart-alert-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.smart-alert-item:last-child { border-bottom: none; }
.sa-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.sa-text { flex: 1; font-size: 12px; color: var(--text2); line-height: 1.5; }
.sa-dismiss-btn { background: none; border: none; color: var(--text3); font-size: 13px; cursor: pointer; padding: 2px; }
.smart-alert { display: flex; align-items: flex-start; gap: 10px; background: var(--card); border-left: 3px solid var(--amber); border-radius: 11px; padding: 11px 13px; margin-bottom: 8px; font-size: 12px; line-height: 1.5; position: relative; }
.smart-alert.danger { border-left-color: var(--rose); background: var(--rose-bg); }
.smart-alert.success { border-left-color: var(--emerald); background: var(--emerald-bg); }
.smart-alert.info { border-left-color: var(--blue); background: var(--blue-bg); }
.smart-alert .sa-icon { font-size: 16px; flex-shrink: 0; }
.smart-alert .sa-text { flex: 1; color: var(--text2); }
.smart-alert .sa-dismiss { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--text3); font-size: 13px; cursor: pointer; padding: 2px 5px; }

/* ══════════════════════════════
   CASH FLOW WIDGET
══════════════════════════════ */
.cf-widget { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
.cf-header { background: linear-gradient(140deg,#1C3A9E 0%,#0D1E60 60%,#080F30 100%); padding: 16px 16px 14px; border-bottom: 1px solid rgba(61,126,255,.18); position: relative; overflow: hidden; }
.cf-header::before { content: ''; position: absolute; top: -40px; right: -40px; width: 150px; height: 150px; border-radius: 50%; background: radial-gradient(circle,rgba(61,126,255,.14) 0%,transparent 65%); }
.cf-header::after { content: ''; position: absolute; bottom: -40px; left: -30px; width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle,rgba(0,200,150,.07) 0%,transparent 65%); }
.cf-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; position: relative; z-index: 1; }
.cf-title { font-size: 10px; font-weight: 700; color: rgba(255,255,255,.45); text-transform: uppercase; letter-spacing: 1.5px; }
.cf-period-tabs { display: flex; gap: 3px; background: rgba(0,0,0,.3); border-radius: 8px; padding: 2px; }
.cf-period-tab { padding: 4px 9px; border: none; background: none; color: rgba(255,255,255,.4); font-family: var(--font); font-size: 9px; font-weight: 700; cursor: pointer; border-radius: 6px; transition: all .15s; text-transform: uppercase; }
.cf-period-tab.active { background: var(--blue); color: #fff; }
.cf-balance-row { display: flex; align-items: flex-end; gap: 12px; position: relative; z-index: 1; }
.cf-projected { flex: 1; }
.cf-proj-label { font-size: 10px; color: rgba(255,255,255,.38); margin-bottom: 4px; }
.cf-proj-amount { font-family: var(--mono); font-size: 24px; font-weight: 600; color: #fff; letter-spacing: -0.5px; }
.cf-proj-amount.danger { color: var(--rose-l); }
.cf-proj-amount.warn { color: var(--amber); }
.cf-proj-amount.good { color: var(--emerald-l); }
.cf-delta { text-align: right; flex-shrink: 0; }
.cf-delta-val { font-family: var(--mono); font-size: 12px; font-weight: 600; padding: 3px 9px; border-radius: 7px; }
.cf-delta-val.positive { background: rgba(0,200,150,.14); color: var(--emerald); }
.cf-delta-val.negative { background: rgba(255,77,106,.14); color: var(--rose); }
.cf-delta-label { font-size: 9px; color: rgba(255,255,255,.3); margin-top: 3px; text-align: right; }
.cf-chart-area { padding: 12px 14px 8px; }
.cf-chart-wrap { position: relative; height: 130px; }
.cf-body { padding: 0 14px 14px; }
.cf-section-title { font-size: 9px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; margin: 12px 0 8px; }
.cf-event { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.cf-event:last-child { border-bottom: none; }
.cf-event-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.cf-event-info { flex: 1; min-width: 0; }
.cf-event-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cf-event-date { font-size: 10px; color: var(--text3); margin-top: 1px; }
.cf-event-amt { font-family: var(--mono); font-size: 12px; font-weight: 600; text-align: right; flex-shrink: 0; }
.cf-event-amt.income { color: var(--emerald); }
.cf-event-amt.expense { color: var(--rose); }
.cf-alert-bar { background: rgba(255,77,106,.07); border: 1px solid rgba(255,77,106,.22); border-radius: 11px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.cf-alert-bar.warn { background: rgba(255,176,32,.07); border-color: rgba(255,176,32,.22); }
.cf-alert-bar.safe { background: rgba(0,200,150,.06); border-color: rgba(0,200,150,.18); }
.cf-alert-icon { font-size: 16px; flex-shrink: 0; }
.cf-alert-text { font-size: 11px; color: var(--text2); line-height: 1.5; flex: 1; }
.cf-insight-row { display: flex; gap: 6px; padding: 10px 0 0; flex-wrap: wrap; }
.cf-insight-chip { display: flex; align-items: center; gap: 4px; padding: 4px 9px; border-radius: 99px; font-size: 9px; font-weight: 700; flex-shrink: 0; }
.cf-insight-chip.danger { background: var(--rose-bg); color: var(--rose); border: 1px solid rgba(255,77,106,.2); }
.cf-insight-chip.good { background: var(--emerald-bg); color: var(--emerald); border: 1px solid rgba(0,200,150,.2); }
.cf-insight-chip.info { background: var(--blue-bg); color: var(--blue); border: 1px solid rgba(61,126,255,.2); }
.cf-insight-chip.warn { background: var(--amber-bg); color: var(--amber); border: 1px solid rgba(255,176,32,.2); }

/* ══════════════════════════════
   MISC / SHARED
══════════════════════════════ */
.empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 52px 24px; text-align: center; }
/* Smooth transitions for all surface elements */
.acc-chip, .account-card, .tx-item, .tx-feed-item, .goal-card, .planned-item,
.payable-card, .recur-card, .budget-widget, .qr-item,
.form-input, .btn-primary, .nav-item, .screen-tab, .type-tab {
  transition: background .2s var(--ease), border-color .2s var(--ease), color .2s var(--ease), transform .15s var(--ease), box-shadow .2s var(--ease);
}
.empty-icon { font-size: 48px; margin-bottom: 14px; opacity: .45; }
.empty p { font-size: 13px; color: var(--text3); line-height: 1.7; }
.hidden-amount { letter-spacing: 3px; }
.confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }
.color-grid { display: flex; flex-wrap: wrap; gap: 8px; }
.color-swatch { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; transition: all .15s; border: 2px solid transparent; }
.color-swatch.selected { transform: scale(1.18); border-color: #fff; box-shadow: 0 0 0 2px var(--blue); }
.qr-item { background: var(--card); border: 1px solid var(--border); border-radius: 13px; padding: 13px; margin-bottom: 9px; display: flex; align-items: center; gap: 12px; }
.qr-thumb { width: 56px; height: 56px; border-radius: 10px; object-fit: cover; background: white; flex-shrink: 0; }
.qr-info { flex: 1; min-width: 0; }
.qr-name { font-size: 13px; font-weight: 700; }
.qr-type { font-size: 10px; color: var(--text3); margin-top: 2px; }

/* ── QR CARD (Received tab) ── */
.qr-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 12px; overflow: hidden; transition: border-color .2s var(--ease), box-shadow .2s var(--ease); }
.qr-card:active { transform: scale(.99); }
.qr-header { display: flex; align-items: center; gap: 12px; padding: 14px 15px 12px; }
.qr-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.qr-info { flex: 1; min-width: 0; }
.qr-name { font-size: 14px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.qr-sub { font-size: 11px; color: var(--text3); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.qr-img-wrap { display: flex; justify-content: center; padding: 8px 20px 16px; }
.qr-img-wrap img { width: 180px; height: 180px; object-fit: contain; border-radius: 12px; background: #fff; padding: 8px; box-shadow: 0 2px 12px rgba(0,0,0,.3); }
.qr-actions { display: flex; gap: 8px; padding: 0 14px 14px; }
.qr-btn { flex: 1; padding: 9px 6px; border: none; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: var(--font); transition: all .15s; }
.qr-btn.present  { background: var(--blue-bg); color: var(--blue-l); border: 1px solid rgba(59,130,246,.25); }
.qr-btn.download { background: var(--emerald-bg); color: var(--emerald-l); border: 1px solid rgba(16,185,129,.25); }
.qr-btn.delete   { background: var(--bg3); color: var(--text2); border: 1px solid var(--border); }
.qr-btn:active { transform: scale(.96); opacity: .85; }

/* ── QR CONTACT CARD (Contacts tab) ── */
.qrc-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 12px; overflow: hidden; transition: border-color .2s; }
.qrc-header { display: flex; align-items: center; gap: 12px; padding: 14px 15px 12px; }
.qrc-avatar { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; font-weight: 700; overflow: hidden; }
.qrc-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
/* Profile image upload circle in modal */
.profile-img-upload { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 16px; }
.profile-img-circle { width: 72px; height: 72px; border-radius: 50%; background: var(--bg3); border: 2px dashed var(--border2); display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; overflow: hidden; position: relative; transition: border-color .15s; flex-shrink: 0; }
.profile-img-circle img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; }
.profile-img-circle input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.profile-img-circle.has-img { border-color: var(--blue); border-style: solid; }
.profile-img-label { font-size: 11px; color: var(--text3); text-align: center; }
.profile-img-remove { font-size: 11px; color: var(--rose); background: none; border: none; cursor: pointer; font-family: var(--font); padding: 0; display: none; }
.qrc-info { flex: 1; min-width: 0; }
.qrc-name { font-size: 14px; font-weight: 700; color: var(--text); }
.qrc-type { font-size: 11px; color: var(--text3); margin-top: 2px; }
.qrc-img-wrap { display: flex; justify-content: center; padding: 4px 20px 14px; }
.qrc-img-wrap img { width: 160px; height: 160px; object-fit: contain; border-radius: 12px; background: #fff; padding: 8px; box-shadow: 0 2px 12px rgba(0,0,0,.3); }
.qrc-actions { display: flex; gap: 8px; padding: 0 14px 14px; }

/* ── QR Sub-tabs ── */
.qr-subtabs { display: flex; gap: 8px; padding: 0 16px 12px; }
.qr-subtab { flex: 1; padding: 9px 0; border-radius: 10px; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); font-size: 13px; font-weight: 600; font-family: var(--font); cursor: pointer; transition: all .15s; }
.qr-subtab.active { background: var(--blue-bg); border-color: rgba(59,130,246,.4); color: var(--blue-l); }

/* ── QR FULLSCREEN PRESENTER ── */
.qr-fullscreen { position: fixed; inset: 0; z-index: 9000; background: #000; display: none; flex-direction: column; align-items: center; justify-content: space-between; padding: 0; }
.qr-fullscreen.open { display: flex; }
.qr-fs-top { display: flex; flex-direction: column; align-items: center; padding: 36px 24px 0; flex-shrink: 0; }
.qr-fs-name { font-size: 20px; font-weight: 800; color: #fff; text-align: center; }
.qr-fs-sub  { font-size: 12px; color: rgba(255,255,255,.5); margin-top: 4px; text-align: center; }
.qr-fs-img-wrap { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; width: 100%; position: relative; }
.qr-fs-img  { position: relative; display: flex; align-items: center; justify-content: center; }
.qr-fs-img img { width: min(72vw, 300px); height: min(72vw, 300px); object-fit: contain; border-radius: 18px; background: #fff; padding: 12px; box-shadow: 0 0 60px rgba(255,255,255,.15); transition: transform .25s cubic-bezier(0.4,0,0.2,1); transform-origin: center; display: block; }
.qr-fs-zoom-overlay { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 14px; background: rgba(0,0,0,.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.15); border-radius: 40px; padding: 6px 14px; }
.qr-fs-zoom-btn { width: 38px; height: 38px; border-radius: 50%; background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.2); color: #fff; font-size: 20px; line-height: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background .15s; flex-shrink: 0; }
.qr-fs-zoom-btn:active { background: rgba(255,255,255,.3); }
.qr-fs-zoom-label { font-size: 12px; font-weight: 700; color: rgba(255,255,255,.8); min-width: 40px; text-align: center; font-family: var(--mono); }
.qr-fs-bottom { display: flex; gap: 10px; padding: 20px 24px 32px; flex-shrink: 0; width: 100%; max-width: 360px; }
.qr-fs-dl    { flex: 1; padding: 14px 0; background: rgba(255,255,255,.14); border: 1px solid rgba(255,255,255,.22); border-radius: 14px; color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; font-family: var(--font); transition: background .15s; }
.qr-fs-close { flex: 1; padding: 14px 0; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.1); border-radius: 14px; color: rgba(255,255,255,.65); font-size: 14px; font-weight: 600; cursor: pointer; font-family: var(--font); transition: background .15s; }
.qr-fs-dl:active { background: rgba(255,255,255,.25); }
.qr-fs-close:active { background: rgba(255,255,255,.12); }
.voice-btn { width: 42px; height: 42px; background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; flex-shrink: 0; transition: all .15s; }
.voice-btn.listening { background: var(--rose-bg); border-color: var(--rose); animation: pulse-ring 1.2s infinite; }
@keyframes pulse-ring { 0%{transform:scale(1);opacity:1} 70%{transform:scale(1.15);opacity:.4} 100%{transform:scale(1);opacity:0} }
.voice-status { font-size: 11px; color: var(--blue-l); text-align: center; padding: 6px 0; display: none; }
.file-zone { border: 2px dashed var(--border2); border-radius: 11px; text-align: center; transition: all .15s; position: relative; background: var(--bg3); overflow: hidden; }
.file-zone.has-file { border-color: var(--blue); border-style: solid; background: var(--blue-bg); }
.file-zone-label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 22px 16px; cursor: pointer; gap: 6px; }
.file-zone-label input[type="file"] { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
.fz-icon { font-size: 32px; line-height: 1; }
.fz-text { font-size: 13px; font-weight: 600; color: var(--text); }
.fz-hint { font-size: 11px; color: var(--text3); }
.fz-preview { max-height: 140px; border-radius: 8px; object-fit: contain; max-width: 100%; display: block; margin: 0 auto; }
.fz-fname { font-size: 12px; color: var(--text2); padding: 8px 0 4px; }
.fz-remove { background: none; border: none; border-top: 1px solid var(--border); color: var(--rose); font-size: 12px; cursor: pointer; padding: 10px; width: 100%; font-family: var(--font); display: block; }
.export-row { display: flex; align-items: center; gap: 13px; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: opacity .15s; }
.export-row:last-child { border-bottom: none; }
.export-row:active { opacity: .7; }
.export-icon-box { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.export-title { font-size: 14px; font-weight: 700; }
.export-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }
.log-item { padding: 11px 0; border-bottom: 1px solid var(--border); }
.log-item:last-child { border-bottom: none; }
.log-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
.log-title { font-size: 13px; font-weight: 600; }
.log-time { font-size: 10px; color: var(--text3); }
.log-detail { font-size: 11px; color: var(--text2); line-height: 1.5; }
.log-type { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; margin-right: 4px; }
.log-type.created { background: var(--emerald-bg); color: var(--emerald); }
.log-type.edited { background: var(--violet-bg); color: var(--violet); }
.log-type.confirmed { background: var(--emerald-bg); color: var(--emerald); }
.log-type.skipped { background: rgba(90,98,130,.2); color: var(--text3); }
.log-type.deleted { background: var(--rose-bg); color: var(--rose); }
.log-type.date-changed { background: var(--amber-bg); color: var(--amber); }
/* old class compat */
.balance-hero { background: linear-gradient(140deg,#1C3A9E 0%,#0D1E60 100%); border: 1px solid rgba(61,126,255,.2); border-radius: 18px; padding: 22px 20px; text-align: center; position: relative; overflow: hidden; }

/* ══════════════════════════════
   AI AUTO-CATEGORIZATION UI
══════════════════════════════ */
/* Smart input strip — sits above the amount field */
.smart-input-bar {
  display: flex; gap: 8px; align-items: center;
  background: var(--bg3); border: 1.5px solid var(--border2);
  border-radius: 12px; padding: 9px 12px; margin-bottom: 13px;
  transition: border-color .2s, box-shadow .2s;
}
.smart-input-bar.active {
  border-color: var(--blue); box-shadow: 0 0 0 3px var(--blue-bg);
}
.smart-input-bar.listening {
  border-color: var(--rose); box-shadow: 0 0 0 3px var(--rose-bg);
  animation: pulse-border 1.2s ease-in-out infinite;
}
@keyframes pulse-border {
  0%,100% { box-shadow: 0 0 0 3px var(--rose-bg); }
  50%      { box-shadow: 0 0 0 6px rgba(225,29,72,0.06); }
}
.smart-input-field {
  flex: 1; background: none; border: none; outline: none;
  font-family: var(--font); font-size: 14px; color: var(--text);
  caret-color: var(--blue);
}
.smart-input-field::placeholder { color: var(--text3); }
.smart-voice-btn {
  width: 36px; height: 36px; border-radius: 10px; border: none;
  background: var(--blue-bg); color: var(--blue);
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; cursor: pointer; flex-shrink: 0;
  transition: all .15s; -webkit-appearance: none;
}
.smart-voice-btn:active { transform: scale(.9); }
.smart-voice-btn.listening {
  background: var(--rose-bg); color: var(--rose);
  animation: pulse-ring 1.2s infinite;
}

/* AI Result card — shown after detection */
.ai-result-card {
  background: linear-gradient(135deg, var(--blue-bg), var(--emerald-bg));
  border: 1px solid var(--blue-glow);
  border-radius: 12px; padding: 11px 13px; margin-bottom: 12px;
  display: none; position: relative; overflow: hidden;
}
.ai-result-card.show { display: block; animation: slideDown .25s var(--ease); }
@keyframes slideDown { from { opacity:0; transform:translateY(-6px) } to { opacity:1; transform:translateY(0) } }
.ai-result-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
.ai-result-label {
  font-size: 9px; font-weight: 800; color: var(--blue-l);
  text-transform: uppercase; letter-spacing: 1.5px;
  display: flex; align-items: center; gap: 5px;
}
.ai-conf-badge {
  font-size: 9px; font-weight: 700; padding: 2px 8px;
  border-radius: 99px; font-family: var(--mono);
}
.ai-conf-badge.high   { background: var(--emerald-bg); color: var(--emerald); }
.ai-conf-badge.medium { background: var(--amber-bg);   color: var(--amber); }
.ai-conf-badge.low    { background: var(--rose-bg);    color: var(--rose); }
.ai-result-fields {
  display: grid; grid-template-columns: 1fr 1fr; gap: 7px;
}
.ai-result-field {
  background: var(--card); border-radius: 8px;
  padding: 7px 10px; border: 1px solid var(--border);
}
.ai-field-label { font-size: 8px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
.ai-field-value { font-size: 12px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ai-result-actions { display: flex; gap: 6px; margin-top: 9px; }
.ai-apply-btn {
  flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer;
  font-family: var(--font); font-size: 11px; font-weight: 700;
  transition: all .15s; -webkit-appearance: none;
}
.ai-apply-btn.accept {
  background: var(--blue); color: #fff;
  box-shadow: 0 2px 8px var(--blue-glow);
}
.ai-apply-btn.edit {
  background: var(--bg3); color: var(--text2);
  border: 1px solid var(--border2);
}
.ai-apply-btn:active { transform: scale(.95); }
.ai-dismiss-btn {
  width: 30px; height: 30px; border-radius: 8px; border: none;
  background: var(--rose-bg); color: var(--rose);
  font-size: 14px; cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all .15s;
}
.ai-dismiss-btn:active { transform: scale(.9); }

/* Smart suggestions — low confidence category chips */
.ai-suggestions {
  display: flex; gap: 6px; flex-wrap: wrap;
  margin-bottom: 10px;
}
.ai-suggestion-chip {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 10px; border-radius: 99px; cursor: pointer;
  border: 1px solid var(--border2); background: var(--bg3);
  font-size: 11px; font-weight: 600; color: var(--text2);
  transition: all .15s; -webkit-appearance: none;
}
.ai-suggestion-chip:hover, .ai-suggestion-chip:active {
  background: var(--blue-bg); border-color: var(--blue);
  color: var(--blue); transform: scale(.97);
}

/* Learning feedback toast */
.ai-learn-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 600; color: var(--violet);
  background: var(--violet-bg); border-radius: 6px; padding: 2px 7px;
  margin-left: 6px;
}

/* Voice status bar */
.voice-status-bar {
  display: none; align-items: center; gap: 8px;
  padding: 8px 12px; background: var(--rose-bg);
  border-radius: 10px; margin-bottom: 8px; font-size: 11px;
  color: var(--rose); font-weight: 600;
}
.voice-status-bar.show { display: flex; }
.voice-wave { display: flex; gap: 2px; align-items: center; }
.voice-wave span {
  width: 3px; background: var(--rose); border-radius: 99px;
  animation: wave 0.8s ease-in-out infinite;
}
.voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
.voice-wave span:nth-child(2) { height: 14px; animation-delay: 0.15s; }
.voice-wave span:nth-child(3) { height: 10px; animation-delay: 0.30s; }
.voice-wave span:nth-child(4) { height: 16px; animation-delay: 0.45s; }
.voice-wave span:nth-child(5) { height: 8px; animation-delay: 0.60s; }
@keyframes wave { 0%,100% { transform: scaleY(1) } 50% { transform: scaleY(0.4) } }

/* Confidence indicator bar */
.conf-meter { height: 3px; border-radius: 99px; background: var(--border2); margin-top: 8px; overflow: hidden; }
.conf-meter-fill { height: 100%; border-radius: 99px; transition: width .4s var(--ease); }

.balance-label { font-size: 11px; color: rgba(255,255,255,.45); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
.balance-amount { font-family: var(--mono); font-size: 30px; font-weight: 600; }
.balance-amount.positive { color: var(--emerald); }
.balance-amount.negative { color: var(--rose); }
.balance-date { font-size: 11px; color: var(--text3); margin-top: 6px; }
.summary-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 13px; }
.summary-card .s-label { font-size: 11px; color: var(--text2); margin-bottom: 4px; }
.summary-card .s-amount { font-family: var(--mono); font-size: 14px; font-weight: 600; }
.summary-card.income .s-amount { color: var(--emerald); }
.summary-card.expense .s-amount { color: var(--rose); }
.mini-cal-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 13px; }
.mini-cal-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.mini-cal-month { font-size: 13px; font-weight: 700; }
.mini-cal-nav { background: var(--bg3); border: 1px solid var(--border); border-radius: 7px; width: 27px; height: 27px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; color: var(--text2); transition: all .15s; -webkit-appearance: none; }
.mini-cal-nav:active { background: var(--blue-bg); color: var(--blue); }
.mini-cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; }
.mini-cal-day-label { font-size: 8px; font-weight: 700; text-align: center; color: var(--text3); text-transform: uppercase; letter-spacing: .5px; padding-bottom: 4px; }
.mini-cal-legend { display: flex; gap: 10px; margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border); flex-wrap: wrap; }
.mini-cal-legend span { display: flex; align-items: center; gap: 4px; font-size: 9px; color: var(--text3); }
.payable-history-item { display: flex; align-items: center; gap: 12px; padding: 11px 0; border-bottom: 1px solid var(--border); }
.payable-history-item:last-child { border-bottom: none; }
/* pill-tabs compat */
.pill-tabs { display: flex; background: var(--bg3); border-radius: 11px; padding: 3px; gap: 2px; border: 1px solid var(--border); }
.pill-tab { flex: 1; padding: 8px 4px; border: none; background: none; color: var(--text3); font-family: var(--font); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 9px; transition: all .15s; white-space: nowrap; }
.pill-tab.active { background: var(--blue); color: #fff; box-shadow: 0 2px 8px var(--blue-glow); }
/* settings section labels */
.settings-section-lbl { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; padding: 0 16px; }
/* inner padding helper */
.inner-pad { padding: 14px 16px; }

/* ══════════════════════════════
   THEME PICKER
══════════════════════════════ */
.theme-picker-wrap { margin-bottom: 8px; }
.theme-mode-toggle {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 8px; margin-bottom: 16px;
}
.theme-mode-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 11px 14px; border-radius: 12px;
  border: 2px solid var(--border2); background: var(--bg3);
  color: var(--text2); font-family: var(--font);
  font-size: 13px; font-weight: 700; cursor: pointer;
  transition: all .2s var(--ease); -webkit-appearance: none;
}
.theme-mode-btn:active { transform: scale(.96); }
.theme-mode-btn.active { border-color: var(--blue); background: var(--blue-bg); color: var(--blue); }

.theme-palette-section { margin-bottom: 14px; }
.theme-palette-label {
  font-size: 10px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.theme-cards-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.theme-card {
  border-radius: 12px; overflow: hidden; cursor: pointer;
  border: 2.5px solid transparent; transition: all .2s var(--ease);
  position: relative;
}
.theme-card:active { transform: scale(.95); }
.theme-card.selected { border-color: var(--blue); box-shadow: 0 0 0 3px var(--blue-bg); }
.theme-card-preview {
  height: 52px; display: flex; flex-direction: column;
  justify-content: space-between; padding: 7px 8px 6px;
  position: relative; overflow: hidden;
}
.theme-card-preview::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(180deg, transparent 40%, rgba(0,0,0,.18) 100%);
}
.theme-preview-dots { display: flex; gap: 3px; position: relative; z-index: 1; }
.theme-preview-dot { width: 5px; height: 5px; border-radius: 50%; }
.theme-preview-bar { height: 3px; border-radius: 99px; position: relative; z-index: 1; opacity: .7; }
.theme-card-label {
  font-size: 10px; font-weight: 700; text-align: center;
  padding: 6px 4px 7px; letter-spacing: .3px;
}
.theme-card .check-badge {
  position: absolute; top: 4px; right: 4px;
  background: var(--blue); color: #fff;
  width: 16px; height: 16px; border-radius: 50%;
  font-size: 9px; display: none; align-items: center; justify-content: center;
  z-index: 2; font-weight: 700;
}
.theme-card.selected .check-badge { display: flex; }

/* ══════════════════════════════
   PLANNED CALENDAR (previously missing)
══════════════════════════════ */
.cal-nav { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.cal-nav button { background:var(--bg3); border:1px solid var(--border); border-radius:8px; width:30px; height:30px; color:var(--text); font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1; }
.cal-nav button:active { background:var(--blue-bg); color:var(--blue); }
.cal-month { font-size:14px; font-weight:700; color:var(--text); }
.cal-day-labels { display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:4px; }
.cal-dl { text-align:center; font-size:9px; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:.5px; padding:3px 0; }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
.cal-cell { display:flex; flex-direction:column; align-items:center; border-radius:7px; padding:3px 2px; min-height:50px; cursor:pointer; border:1px solid transparent; transition:background .1s; }
.cal-cell:active { background:var(--blue-bg) !important; }
.cal-cell.today { background:rgba(124,131,253,.10); border-color:rgba(124,131,253,.4); }
.cal-cell.selected { background:var(--blue-bg); border-color:var(--blue); }
.cal-cell.empty { pointer-events:none; }
.cal-cell.empty-day { opacity:.4; }
.cal-num { font-size:11px; font-weight:700; line-height:22px; width:22px; height:22px; text-align:center; display:flex; align-items:center; justify-content:center; flex-shrink:0; border-radius:50%; }
.cal-cell.today .cal-num { background:var(--blue); color:#fff; }
.cal-exp { font-size:8px; font-weight:700; color:var(--rose); line-height:1.2; text-align:center; }
.cal-inc { font-size:8px; font-weight:700; color:var(--emerald); line-height:1.2; text-align:center; }
.cal-dot { width:5px; height:5px; border-radius:50%; margin:1px 1px 0; display:inline-block; }
.cal-dot.overdue { background:var(--rose); }
.cal-dot.planned { background:var(--amber); }
.day-detail-panel { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:10px; }
.day-detail-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid var(--border); }
.day-detail-close { background:var(--bg3); border:1px solid var(--border); border-radius:8px; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px; color:var(--text2); }
.day-detail-close:active { background:var(--blue-bg); color:var(--blue); }

/* ══ UPGRADED SETTINGS SCREEN ══ */
.settings-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 16px; margin-bottom: 14px; overflow: hidden;
}
.settings-card-header {
  padding: 14px 16px 12px; display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid var(--border);
}
.settings-card-icon {
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;
}
.settings-card-title { font-size: 14px; font-weight: 700; }
.settings-card-sub { font-size: 11px; color: var(--text3); margin-top: 1px; }
.settings-card-body { padding: 14px 16px; }

.settings-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: opacity .15s;
}
.settings-row:last-child { border-bottom: none; }
.settings-row:active { opacity: .65; }
.settings-row-icon {
  width: 34px; height: 34px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0;
}
.settings-row-info { flex: 1; min-width: 0; }
.settings-row-label { font-size: 13px; font-weight: 600; }
.settings-row-sub { font-size: 11px; color: var(--text3); margin-top: 1px; }
.settings-row-action { font-size: 18px; color: var(--text3); flex-shrink: 0; }

.privacy-row {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 0; border-bottom: 1px solid var(--border);
}
.privacy-row:last-child { border-bottom: none; }
.privacy-row-info { flex: 1; }
.privacy-row-label { font-size: 13px; font-weight: 600; }
.privacy-row-sub { font-size: 11px; color: var(--text3); margin-top: 1px; }
</style>
</head>
<body>
<!-- FEATURE 1: Active recording banner - shows while mic is live -->
<div id="recording-banner" role="status" aria-live="polite">
  <span class="rec-pulse"></span>
  <span>🎙️ Recording… speak clearly</span>
  <span id="rec-live-text" style="font-weight:400;opacity:.85;margin-left:4px"></span>
  <button onclick="_stopAllVoice()" style="margin-left:auto;background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:6px;padding:3px 10px;font-size:11px;font-weight:700;cursor:pointer">■ Stop</button>
</div>
<div id="app">

<!-- ▸ HOME ─────────────────────────────────────────────────── -->
<div id="screen-home" class="screen active">

  <!-- v5 Top Bar: back-arrow left | bell + gear right -->
  <div class="v5-topbar">
    <button class="v5-topbar-btn" onclick="history.back()" title="Back" id="v5-back-btn">
      <span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"/></svg></span>
    </button>
    <div style="flex:1"></div>
    <button class="v5-topbar-btn" style="position:relative" onclick="toggleAlertsSheet()" title="Alerts">
      <span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"/></svg></span>
      <span class="bell-badge" id="bell-badge" style="display:none;position:absolute;top:-2px;right:-2px;background:var(--rose);color:#fff;font-size:7px;font-weight:700;min-width:14px;height:14px;border-radius:99px;align-items:center;justify-content:center;padding:0 3px;border:1.5px solid var(--bg)"></span>
    </button>
    <button class="v5-topbar-btn" onclick="showScreen('settings')" title="Settings">
      <span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
    </button>
    <button class="v5-topbar-btn" id="global-eye-btn" onclick="toggleGlobalPrivacy()" title="Toggle visibility">
      <span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
    </button>
  </div>

  <div class="scroll-area v5-home-scroll">

    <!-- ═══════════ OLD STYLE ELEMENTS (hidden in classic, visible in old) ═══════════ -->
    <!-- Old header: logo left, bell+eye right -->
    <div class="home-header" id="old-home-header">
      <div class="home-logo" style="display:flex;align-items:center;gap:6px"><span style="font-size:18px">💸</span>Fin<em>Flow</em></div>
      <div class="home-header-actions">
        <button class="icon-btn" style="position:relative" onclick="toggleAlertsSheet()" title="Smart Alerts">🔔<span class="bell-badge" style="display:none"></span></button>
        <button class="icon-btn" onclick="toggleGlobalPrivacy()" title="Toggle visibility">👁️</button>
      </div>
    </div>

    <!-- Old balance hero card -->
    <div class="home-balance-card" id="old-balance-card" style="margin:0 16px 14px">
      <div class="hbc-label">Total Balance</div>
      <div class="hbc-amount" id="old-hero-balance">₱0.00</div>
      <div class="hbc-date" id="old-hero-date"></div>
      <hr class="hbc-divider">
      <div class="hbc-stats">
        <div class="hbc-stat"><div class="hbc-stat-label">↑ Income</div><div class="hbc-stat-val inc" id="old-hbc-income">₱0</div></div>
        <div class="hbc-stat"><div class="hbc-stat-label">↓ Expenses</div><div class="hbc-stat-val exp" id="old-hbc-expense">₱0</div></div>
      </div>
      <div class="hbc-period-row">
        <button class="hbc-period-btn active" onclick="setHomePeriod('daily',this)">Today</button>
        <button class="hbc-period-btn" onclick="setHomePeriod('weekly',this)">Week</button>
        <button class="hbc-period-btn" onclick="setHomePeriod('monthly',this)">Month</button>
        <button class="hbc-period-btn" onclick="setHomePeriod('yearly',this)">Year</button>
      </div>
    </div>

    <!-- Old Add TX CTA -->
    <button class="add-tx-cta" id="old-add-cta" onclick="openAddTransaction()"
      onmousedown="this.style.transform='scale(.97)'" onmouseup="this.style.transform=''"
      ontouchstart="this.style.transform='scale(.97)'" ontouchend="this.style.transform=''">
      <div class="add-tx-cta-left">
        <div class="add-tx-cta-icon">＋</div>
        <div><div class="add-tx-cta-title">Add Transaction</div><div class="add-tx-cta-sub">Expense · Income · Transfer</div></div>
      </div>
      <div class="add-tx-cta-arrow">›</div>
    </button>

    <!-- Old Quick Actions (Goals, Budget, Payables, Export) -->
    <div class="quick-actions" id="old-quick-actions" style="margin-bottom:16px">
      <button class="qa-btn" onclick="showScreen('goals')"><div class="qa-icon" style="background:var(--emerald-bg)">🎯</div><div class="qa-label">Goals</div></button>
      <button class="qa-btn" onclick="showScreen('budget')"><div class="qa-icon" style="background:var(--amber-bg)">📊</div><div class="qa-label">Budget</div></button>
      <button class="qa-btn" onclick="showScreen('payables')"><div class="qa-icon" style="background:var(--rose-bg)">💳</div><div class="qa-label">Payables</div></button>
      <button class="qa-btn" onclick="openExportModal()"><div class="qa-icon" style="background:var(--blue-bg)">📤</div><div class="qa-label">Export</div></button>
    </div>

    <!-- Old Accounts Chips -->
    <div class="sh" id="old-accounts-header" style="display:none"><span class="sh-label">Accounts</span><span class="sh-link" onclick="showScreen('accounts')">Manage →</span></div>
    <div class="accs-scroll" id="old-accounts-chips" style="margin-bottom:16px"></div>
    <!-- ═══════════ END OLD STYLE ELEMENTS ═══════════ -->
    <div class="v5-networth-section">
      <div class="v5-nw-label">Net Worth</div>
      <div class="v5-nw-amount" id="hero-balance">₱0</div>
      <div class="v5-stat-cards">
        <div class="v5-stat-card">
          <div class="v5-stat-card-top">
            <span class="v5-stat-card-label">Income</span>
            <span class="v5-stat-arrow v5-arrow-up"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18"/></svg></span>
          </div>
          <div class="v5-stat-card-val inc" id="hbc-income">₱0</div>
        </div>
        <div class="v5-stat-card">
          <div class="v5-stat-card-top">
            <span class="v5-stat-card-label">Expenses</span>
            <span class="v5-stat-arrow v5-arrow-down"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3"/></svg></span>
          </div>
          <div class="v5-stat-card-val exp" id="hbc-expense">₱0</div>
        </div>
      </div>
    </div>

    <!-- ACCOUNT CARDS — gradient horizontal scroll -->
    <div class="v5-cards-scroll" id="accounts-chips"></div>

    <!-- QUICK ACTIONS — Request, Pay, Contacts (no Scan/Send) -->
    <div class="v5-quick-actions">
      <button class="v5-qa-btn" onclick="openQARequest()">
        <div class="v5-qa-icon" style="background:#EEF2FF"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#6366F1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75H6.912a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H15M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859M12 3v8.25m0 0-3-3m3 3 3-3"/></svg></div>
        <div class="v5-qa-label">Request</div>
      </button>
      <button class="v5-qa-btn" onclick="openQAPay()">
        <div class="v5-qa-icon" style="background:#F0FDF4"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#22C55E"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg></div>
        <div class="v5-qa-label">Pay</div>
      </button>
      <button class="v5-qa-btn" onclick="openContactsSheet()">
        <div class="v5-qa-icon" style="background:#FFF7ED"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#F97316"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/></svg></div>
        <div class="v5-qa-label">Contacts</div>
      </button>
      <button class="v5-qa-btn" onclick="showScreen('budget')">
        <div class="v5-qa-icon" style="background:#FEF3C7"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#D97706"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z"/></svg></div>
        <div class="v5-qa-label">Budget</div>
      </button>
    </div>

    <!-- TIME FILTER -->
    <div class="v5-time-filter">
      <button class="v5-tf-btn active" onclick="setHomePeriod('daily',this)">Today</button>
      <button class="v5-tf-btn" onclick="setHomePeriod('weekly',this)">Week</button>
      <button class="v5-tf-btn" onclick="setHomePeriod('monthly',this)">Month</button>
      <button class="v5-tf-btn" onclick="setHomePeriod('yearly',this)">Year</button>
    </div>

    <!-- WIDGETS — each wrapped in a visibility-controlled div -->
    <div id="widget-budgetPanel"><div id="budget-home-panel"></div></div>
    <div id="home-payable-alert" style="display:none;margin:0 20px 12px;background:var(--rose-bg);border:1px solid rgba(225,29,72,.3);border-radius:13px;padding:12px 14px;font-size:12px;color:var(--rose);line-height:1.5"></div>
    <div id="widget-cashflow"><div id="cashflow-widget"></div></div>
    <div id="widget-miniReport"><div id="home-mini-report"></div></div>
    <div id="widget-calendar">
      <div class="v5-section-header"><span class="v5-section-title">📅 Calendar</span><button class="v5-section-link" onclick="showScreen('goals');setTimeout(()=>showGoalsTab('planned',document.querySelectorAll('#screen-goals .screen-tab')[3]),50)">Full View →</button></div>
      <div style="padding:0 20px;margin-bottom:16px"><div id="home-mini-cal"></div></div>
    </div>

    <!-- RECENT TRANSACTIONS — always visible -->
    <div class="v5-section-header">
      <span class="v5-section-title">Recent Transactions</span>
      <button class="v5-section-link" onclick="showScreen('transactions')">See all →</button>
    </div>
    <div class="tx-feed-wrap" id="recent-tx-list">
      <div class="empty"><div class="empty-icon">📭</div><p>No transactions yet.<br>Tap + to add one!</p></div>
    </div>

    <div style="height:28px"></div>
  </div>
</div>

<!-- ▸ CONTACTS SHEET -->
<div class="v5-contacts-sheet" id="v5-contacts-sheet">
  <div class="v5-sheet-handle"></div>
  <div class="v5-sheet-hdr">
    <span class="v5-sheet-title">Contacts</span>
    <button onclick="closeContactsSheet()" class="v5-topbar-btn"><span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg></span></button>
  </div>
  <div id="v5-contacts-list" style="padding:8px 16px 24px"></div>
</div>
<div class="v5-sheet-overlay" id="v5-sheet-overlay" onclick="closeContactsSheet()"></div>

<!-- ▸ ALERTS SHEET ──────────────────────────────────────────── -->
<div class="alerts-sheet" id="alerts-sheet">
  <div class="alerts-sheet-hdr">
    <span class="alerts-sheet-title">🔔 Smart Alerts</span>
    <button class="alerts-sheet-close" onclick="toggleAlertsSheet()">✕</button>
  </div>
  <div id="alerts-sheet-content">
    <div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">All clear! No alerts right now ✓</div>
  </div>
</div>

<!-- ▸ TRANSACTIONS ──────────────────────────────────────────── -->
<div id="screen-transactions" class="screen">
  <div class="header">
    <h1>Transactions</h1>
    <div class="header-actions">
      <button class="hdr-add-btn" onclick="openAddTransaction()">＋ Add New</button>
    </div>
  </div>
  <div style="padding:10px 16px 0;flex-shrink:0">
    <div class="period-tabs" id="tx-period-tabs">
      <button class="period-tab active" onclick="setTxPeriod('daily',this)">Daily</button>
      <button class="period-tab" onclick="setTxPeriod('weekly',this)">Weekly</button>
      <button class="period-tab" onclick="setTxPeriod('monthly',this)">Monthly</button>
      <button class="period-tab" onclick="setTxPeriod('yearly',this)">Yearly</button>
    </div>
  </div>
  <div class="scroll-area" id="tx-list-area">
    <div class="empty"><div class="empty-icon">📭</div><p>No transactions yet.</p></div>
  </div>
</div>

<!-- ▸ ACCOUNTS ──────────────────────────────────────────────── -->
<div id="screen-accounts" class="screen">
  <div class="header">
    <h1>Accounts</h1>
    <div class="header-actions">
      <button class="icon-btn" onclick="currentAccountsTab==='qr'?(currentQRSubTab==='contacts'?openAddQRContact():openAddQR()):openAddAccount()">＋</button>
    </div>
  </div>
  <div class="screen-tabs">
    <button class="screen-tab active" onclick="showAccountsTab('accounts',this)">🏦 Accounts</button>
    <button class="screen-tab" onclick="showAccountsTab('qr',this)">📲 QR Payments</button>
  </div>
  <div class="scroll-area" id="accounts-list-screen"></div>
</div>

<!-- ▸ GOALS & PLANS ─────────────────────────────────────────── -->
<div id="screen-goals" class="screen">
  <div class="header">
    <h1>Goals & Plans</h1>
    <div class="header-actions">
      <button class="icon-btn" id="goals-add-btn" onclick="handleGoalsAdd()">＋</button>
    </div>
  </div>
  <div class="screen-tabs">
    <button class="screen-tab active" onclick="showGoalsTab('active',this)">🎯 Goals</button>
    <button class="screen-tab" onclick="showGoalsTab('achieved',this)">🏆 Achieved</button>
    <button class="screen-tab" onclick="showGoalsTab('recurring',this)">🔄 Recurring</button>
    <button class="screen-tab" onclick="showGoalsTab('planned',this)">📅 Planned</button>
  </div>
  <div class="scroll-area" id="goals-content"></div>
</div>
<canvas id="confetti-canvas" class="confetti-canvas" style="display:none"></canvas>

<!-- ▸ BUDGET ─────────────────────────────────────────────────── -->
<div id="screen-budget" class="screen">
  <div class="header">
    <h1>💰 Budget</h1>
    <div class="header-actions">
      <button class="icon-btn" id="budget-header-add-btn" onclick="budgetHeaderAdd()">＋</button>
    </div>
  </div>

  <!-- Tab bar -->
  <div style="padding:10px 16px 0;flex-shrink:0">
    <div style="display:flex;background:var(--bg3);border-radius:12px;padding:3px;gap:2px">
      <button id="budget-tab-monthly" class="budget-main-tab active-budget-tab"
        onclick="switchBudgetMainTab('monthly')"
        style="flex:1;padding:9px 0;border-radius:9px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s">
        📅 Monthly Budget
      </button>
      <button id="budget-tab-default" class="budget-main-tab"
        onclick="switchBudgetMainTab('default')"
        style="flex:1;padding:9px 0;border-radius:9px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s">
        🗂 Default Template
      </button>
    </div>
  </div>

  <!-- Monthly Budget Panel -->
  <div id="budget-panel-monthly" style="display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0">
    <div style="padding:10px 16px 0;flex-shrink:0">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:4px">
        <button onclick="navBudgetMonth(-1)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);width:32px;height:32px;border-radius:9px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0">‹</button>
        <div id="budget-screen-month-label" style="flex:1;text-align:center;font-size:15px;font-weight:700;color:var(--text)"></div>
        <button onclick="navBudgetMonth(1)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);width:32px;height:32px;border-radius:9px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0">›</button>
      </div>
      <div id="budget-screen-month-tabs" style="display:flex;overflow-x:auto;scrollbar-width:none;gap:6px;padding:6px 0 4px"></div>
    </div>
    <div class="scroll-area" id="budget-screen-content"></div>
  </div>

  <!-- Default Budget Panel -->
  <div id="budget-panel-default" style="display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0">
    <div class="scroll-area" id="budget-default-content"></div>
  </div>
</div>

<!-- ▸ PAYABLES ──────────────────────────────────────────────── -->
<div id="screen-payables" class="screen">
  <div class="header">
    <h1>Payables</h1>
    <div class="header-actions">
      <button class="icon-btn" onclick="openAddPayable()">＋</button>
    </div>
  </div>
  <div class="screen-tabs">
    <button class="screen-tab active" onclick="showPayablesTab('active',this)">🔴 Active</button>
    <button class="screen-tab" onclick="showPayablesTab('summary',this)">📊 Summary</button>
    <button class="screen-tab" onclick="showPayablesTab('history',this)">📜 History</button>
    <button class="screen-tab" onclick="showPayablesTab('paid',this)">✅ Paid Off</button>
  </div>
  <div id="payables-alert-banner" style="display:none;margin:8px 16px 0;background:var(--rose-bg);border:1px solid rgba(255,77,106,.3);border-radius:11px;padding:11px 13px;font-size:12px;color:var(--rose);flex-shrink:0"></div>
  <div class="scroll-area" id="payables-content"></div>
</div>

<!-- ▸ REPORTS ───────────────────────────────────────────────── -->
<div id="screen-reports" class="screen">
  <div class="header"><h1>Reports</h1></div>
  <div class="screen-tabs">
    <button class="screen-tab active" onclick="showReportsTab('overview',this)">💸 Expenses</button>
    <button class="screen-tab" onclick="showReportsTab('income',this)">💰 Income</button>
    <button class="screen-tab" onclick="showReportsTab('budget',this)">🎯 Budget</button>
  </div>
  <div style="padding:8px 16px 0;flex-shrink:0;display:none" id="budget-period-tabs-wrap">
    <div class="period-tabs" id="budget-report-period-tabs">
      <button class="period-tab active" onclick="setBudgetReportPeriod('monthly',this)">Monthly</button>
      <button class="period-tab" onclick="setBudgetReportPeriod('yearly',this)">Yearly</button>
    </div>
  </div>
  <div style="padding:8px 16px 0;flex-shrink:0;display:none" id="income-period-tabs-wrap">
    <div class="period-tabs" id="income-report-period-tabs">
      <button class="period-tab active" onclick="setIncomeReportPeriod('monthly',this)">Monthly</button>
      <button class="period-tab" onclick="setIncomeReportPeriod('yearly',this)">Yearly</button>
    </div>
  </div>
  <div class="scroll-area" id="reports-content">
    <div id="reports-overview-panel" style="padding:14px 16px">
      <div class="period-tabs" id="report-period-tabs">
        <button class="period-tab active" onclick="setReportPeriod('monthly',this)">Monthly</button>
        <button class="period-tab" onclick="setReportPeriod('yearly',this)">Yearly</button>
      </div>
      <div class="net-info-box">ℹ️ <strong>Net</strong> = Total Income − Total Expenses for the selected period. Transfers are excluded.</div>
      <div class="report-grid" id="report-stats"></div>
      <div class="card" style="margin-bottom:10px"><div class="section-title">Income vs Expenses</div><div class="chart-wrap"><canvas id="bar-chart"></canvas></div></div>
      <div class="card" style="margin-bottom:10px"><div class="section-title">Expense Categories</div><div class="chart-wrap"><canvas id="pie-chart"></canvas></div></div>
      <div class="card"><div class="section-title">Category Breakdown</div><div id="cat-breakdown"></div></div>
    </div>
    <div id="reports-income-panel" style="display:none"></div>
    <div id="reports-budget-panel" style="display:none"></div>
  </div>
</div>

<!-- ▸ SETTINGS ──────────────────────────────────────────────── -->
<div id="screen-settings" class="screen">
  <div class="header"><h1>Settings</h1></div>
  <div class="scroll-area" style="padding:14px 16px">

    <!-- ── WHAT'S NEW (top) ── -->
    <div class="settings-card" style="margin-bottom:16px" id="whats-new-card">
      <div class="settings-card-header" onclick="openPatchNotes()" style="cursor:pointer">
        <div class="settings-card-icon" style="background:var(--emerald-bg)">🆕</div>
        <div style="flex:1">
          <div class="settings-card-title">What's New</div>
          <div class="settings-card-sub" id="patch-version-label">v5 Classic — New Dashboard, Account Cards &amp; More</div>
        </div>
        <div id="patch-new-dot" style="width:10px;height:10px;border-radius:50%;background:var(--rose);flex-shrink:0;display:none"></div>
        <div style="font-size:18px;color:var(--text3);margin-left:4px">›</div>
      </div>
    </div>

    <!-- ── GENERAL ── -->
    <div class="settings-section-lbl">General</div>
    <div class="settings-card" style="margin-bottom:16px">
      <div class="settings-card-body" style="padding-bottom:4px;padding-top:4px">
        <div class="settings-row" onclick="openCurrencySettings()">
          <div class="settings-row-icon" style="background:var(--emerald-bg)">💱</div>
          <div class="settings-row-info"><div class="settings-row-label">Currency</div><div class="settings-row-sub" id="currency-display">Philippine Peso (₱)</div></div>
          <div class="settings-row-action">›</div>
        </div>
        <div class="settings-row" onclick="showScreen('budget')">
          <div class="settings-row-icon" style="background:var(--amber-bg)">📊</div>
          <div class="settings-row-info"><div class="settings-row-label">Budget</div><div class="settings-row-sub">Set default &amp; monthly budgets</div></div>
          <div class="settings-row-action">›</div>
        </div>
        <div class="settings-row" onclick="openExportModal()">
          <div class="settings-row-icon" style="background:var(--violet-bg)">📤</div>
          <div class="settings-row-info"><div class="settings-row-label">Export Report</div><div class="settings-row-sub">PDF · Excel · CSV</div></div>
          <div class="settings-row-action">›</div>
        </div>
        <div class="settings-row" onclick="exportData()">
          <div class="settings-row-icon" style="background:var(--amber-bg)">💾</div>
          <div class="settings-row-info"><div class="settings-row-label">Backup Data</div><div class="settings-row-sub">Save full JSON backup</div></div>
          <div class="settings-row-action">›</div>
        </div>
        <div class="settings-row" onclick="document.getElementById('import-file').click()">
          <div class="settings-row-icon" style="background:var(--blue-bg)">📥</div>
          <div class="settings-row-info"><div class="settings-row-label">Import Data</div><div class="settings-row-sub">Restore from backup</div></div>
          <div class="settings-row-action">›</div>
        </div>
        <div class="settings-row" onclick="confirmClearData()">
          <div class="settings-row-icon" style="background:var(--rose-bg)">🗑️</div>
          <div class="settings-row-info"><div class="settings-row-label" style="color:var(--rose)">Clear All Data</div><div class="settings-row-sub">Delete everything permanently</div></div>
          <div class="settings-row-action" style="color:var(--rose)">›</div>
        </div>
      </div>
    </div>

    <!-- ── DISPLAY / THEMES ── -->
    <!-- ── APP STYLE ── -->
    <div class="settings-section-lbl">App Style</div>
    <div class="settings-card" style="margin-bottom:16px">
      <div class="settings-card-header">
        <div class="settings-card-icon" style="background:var(--violet-bg)">✨</div>
        <div>
          <div class="settings-card-title">UI Style</div>
          <div class="settings-card-sub" id="app-style-label">Classic Style</div>
        </div>
      </div>
      <div class="settings-card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <button class="style-option-btn active" id="style-btn-classic" onclick="setAppStyle('classic',this)">
            <div style="font-size:20px;margin-bottom:4px">🃏</div>
            <div style="font-size:12px;font-weight:700">Classic Style</div>
            <div style="font-size:10px;color:var(--text3)">New v5 layout</div>
          </button>
          <button class="style-option-btn" id="style-btn-old" onclick="setAppStyle('old',this)">
            <div style="font-size:20px;margin-bottom:4px">📱</div>
            <div style="font-size:12px;font-weight:700">Old Style</div>
            <div style="font-size:10px;color:var(--text3)">Legacy layout</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Home Widgets — only relevant for Classic Style -->
    <div id="home-widget-settings">
      <div class="settings-section-lbl">Home Widgets</div>
      <div class="settings-card" style="margin-bottom:16px">
        <div class="settings-card-header">
          <div class="settings-card-icon" style="background:var(--blue-bg)">🧩</div>
          <div><div class="settings-card-title">Visible on Home</div><div class="settings-card-sub">Toggle widgets shown in Classic layout</div></div>
        </div>
        <div class="settings-card-body" style="padding-top:0">
          <div class="settings-row" onclick="setHomeWidget('showBudgetPanel',!getHomeWidgets().showBudgetPanel)">
            <div class="settings-row-icon" style="background:var(--amber-bg)">📊</div>
            <div class="settings-row-info"><div class="settings-row-label">Budget Panel</div><div class="settings-row-sub">Current budget progress</div></div>
            <div class="settings-row-action" id="hwt-budgetPanel" style="display:flex;align-items:center"></div>
          </div>
          <div class="settings-row" onclick="setHomeWidget('showCashflow',!getHomeWidgets().showCashflow)">
            <div class="settings-row-icon" style="background:var(--blue-bg)">📈</div>
            <div class="settings-row-info"><div class="settings-row-label">Cash Flow</div><div class="settings-row-sub">Income vs spend prediction</div></div>
            <div class="settings-row-action" id="hwt-cashflow" style="display:flex;align-items:center"></div>
          </div>
          <div class="settings-row" onclick="setHomeWidget('showMiniReport',!getHomeWidgets().showMiniReport)">
            <div class="settings-row-icon" style="background:var(--violet-bg)">📋</div>
            <div class="settings-row-info"><div class="settings-row-label">Monthly Summary</div><div class="settings-row-sub">Quick financial overview</div></div>
            <div class="settings-row-action" id="hwt-miniReport" style="display:flex;align-items:center"></div>
          </div>
          <div class="settings-row" onclick="setHomeWidget('showCalendar',!getHomeWidgets().showCalendar)">
            <div class="settings-row-icon" style="background:var(--emerald-bg)">📅</div>
            <div class="settings-row-info"><div class="settings-row-label">Mini Calendar</div><div class="settings-row-sub">Upcoming planned activities</div></div>
            <div class="settings-row-action" id="hwt-calendar" style="display:flex;align-items:center"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="settings-section-lbl">Display</div>
    <div class="settings-card" style="margin-bottom:16px">
      <div class="settings-card-header">
        <div class="settings-card-icon" style="background:var(--blue-bg)">🎨</div>
        <div>
          <div class="settings-card-title">Appearance</div>
          <div class="settings-card-sub" id="current-theme-label">Midnight Dark</div>
        </div>
      </div>
      <div class="settings-card-body">

        <!-- Mode toggle -->
        <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">Mode</div>
        <div class="theme-mode-toggle">
          <button class="theme-mode-btn active" id="mode-dark-btn" onclick="setThemeMode('dark')">🌙 Dark</button>
          <button class="theme-mode-btn" id="mode-light-btn" onclick="setThemeMode('light')">☀️ Light</button>
        </div>

        <!-- Dark themes -->
        <div class="theme-palette-section" id="dark-themes-section">
          <div class="theme-palette-label">🌑 Dark Themes</div>
          <div class="theme-cards-grid">

            <div class="theme-card" id="theme-card-midnight" onclick="applyThemeByKey('midnight')">
              <div class="check-badge">✓</div>
              <div class="theme-card-preview" style="background:linear-gradient(140deg,#1C3A9E,#0B0F1A)">
                <div class="theme-preview-dots">
                  <div class="theme-preview-dot" style="background:#4D8EFF"></div>
                  <div class="theme-preview-dot" style="background:#00D4A0"></div>
                  <div class="theme-preview-dot" style="background:#FF4D6A"></div>
                </div>
                <div class="theme-preview-bar" style="background:#4D8EFF;width:65%"></div>
              </div>
              <div class="theme-card-label" style="background:#111520;color:#E8EDF8">Midnight</div>
            </div>

            <div class="theme-card" id="theme-card-obsidian" onclick="applyThemeByKey('obsidian')">
              <div class="check-badge">✓</div>
              <div class="theme-card-preview" style="background:linear-gradient(140deg,#2A2010,#0F0F0F)">
                <div class="theme-preview-dots">
                  <div class="theme-preview-dot" style="background:#E8A835"></div>
                  <div class="theme-preview-dot" style="background:#5CB85C"></div>
                  <div class="theme-preview-dot" style="background:#E85454"></div>
                </div>
                <div class="theme-preview-bar" style="background:#E8A835;width:55%"></div>
              </div>
              <div class="theme-card-label" style="background:#161616;color:#F0EDE8">Obsidian</div>
            </div>

            <div class="theme-card" id="theme-card-forest" onclick="applyThemeByKey('forest')">
              <div class="check-badge">✓</div>
              <div class="theme-card-preview" style="background:linear-gradient(140deg,#0D3020,#0A110D)">
                <div class="theme-preview-dots">
                  <div class="theme-preview-dot" style="background:#3DD68C"></div>
                  <div class="theme-preview-dot" style="background:#66E4A8"></div>
                  <div class="theme-preview-dot" style="background:#FF6B6B"></div>
                </div>
                <div class="theme-preview-bar" style="background:#3DD68C;width:70%"></div>
              </div>
              <div class="theme-card-label" style="background:#0F1912;color:#E2EFEA">Forest</div>
            </div>

          </div>
        </div>

        <!-- Light themes -->
        <div class="theme-palette-section" id="light-themes-section" style="display:none">
          <div class="theme-palette-label">🌤 Light Themes</div>
          <div class="theme-cards-grid">

            <div class="theme-card" id="theme-card-ivory" onclick="applyThemeByKey('ivory')">
              <div class="check-badge">✓</div>
              <div class="theme-card-preview" style="background:linear-gradient(140deg,#1D3A8A,#F5F6FA)">
                <div class="theme-preview-dots">
                  <div class="theme-preview-dot" style="background:#2563EB"></div>
                  <div class="theme-preview-dot" style="background:#059669"></div>
                  <div class="theme-preview-dot" style="background:#DC2626"></div>
                </div>
                <div class="theme-preview-bar" style="background:#2563EB;width:60%"></div>
              </div>
              <div class="theme-card-label" style="background:#FFFFFF;color:#0D1226;border-top:1px solid #e8eaf0">Ivory</div>
            </div>

            <div class="theme-card" id="theme-card-arctic" onclick="applyThemeByKey('arctic')">
              <div class="check-badge">✓</div>
              <div class="theme-card-preview" style="background:linear-gradient(140deg,#0044AA,#EFF3FA)">
                <div class="theme-preview-dots">
                  <div class="theme-preview-dot" style="background:#0070F3"></div>
                  <div class="theme-preview-dot" style="background:#00A86B"></div>
                  <div class="theme-preview-dot" style="background:#E0174E"></div>
                </div>
                <div class="theme-preview-bar" style="background:#0070F3;width:72%"></div>
              </div>
              <div class="theme-card-label" style="background:#FFFFFF;color:#0D1830;border-top:1px solid #dde5f0">Arctic</div>
            </div>

            <div class="theme-card" id="theme-card-rose-gold" onclick="applyThemeByKey('rose-gold')">
              <div class="check-badge">✓</div>
              <div class="theme-card-preview" style="background:linear-gradient(140deg,#8B3030,#FAF5F5)">
                <div class="theme-preview-dots">
                  <div class="theme-preview-dot" style="background:#C0604A"></div>
                  <div class="theme-preview-dot" style="background:#2E8B5A"></div>
                  <div class="theme-preview-dot" style="background:#C0182A"></div>
                </div>
                <div class="theme-preview-bar" style="background:#C0604A;width:58%"></div>
              </div>
              <div class="theme-card-label" style="background:#FFFFFF;color:#1A0A0A;border-top:1px solid #f0e0e0">Rose Gold</div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- ── BUDGET LIMITS ── MOVED TO BUDGET SCREEN -->

    <!-- ── PRIVACY ── -->
    <div class="settings-section-lbl">Privacy</div>
    <div class="settings-card" style="margin-bottom:16px">
      <div class="settings-card-header">
        <div class="settings-card-icon" style="background:var(--violet-bg)">🔒</div>
        <div>
          <div class="settings-card-title">Privacy</div>
          <div class="settings-card-sub">Hide sensitive amounts</div>
        </div>
      </div>
      <div class="settings-card-body" style="padding-bottom:4px">
        <div class="privacy-row">
          <div class="privacy-row-info"><div class="privacy-row-label">🏠 Home — Net Worth</div><div class="privacy-row-sub">Total balance on home screen</div></div>
          <label class="toggle-switch"><input type="checkbox" id="priv-home-total" onchange="savePrivacySettings()"><div class="toggle-track"></div></label>
        </div>
        <div class="privacy-row">
          <div class="privacy-row-info"><div class="privacy-row-label">📊 Income &amp; Expenses</div><div class="privacy-row-sub">Period summary amounts</div></div>
          <label class="toggle-switch"><input type="checkbox" id="priv-home-summary" onchange="savePrivacySettings()"><div class="toggle-track"></div></label>
        </div>
        <div class="privacy-row">
          <div class="privacy-row-info"><div class="privacy-row-label">🏦 Account Chips</div><div class="privacy-row-sub">Balance on home account cards</div></div>
          <label class="toggle-switch"><input type="checkbox" id="priv-chips" onchange="savePrivacySettings()"><div class="toggle-track"></div></label>
        </div>
        <div class="privacy-row">
          <div class="privacy-row-info"><div class="privacy-row-label">💳 Virtual Cards</div><div class="privacy-row-sub">Balance on swipeable cards</div></div>
          <label class="toggle-switch"><input type="checkbox" id="priv-cards" onchange="savePrivacySettings()"><div class="toggle-track"></div></label>
        </div>
        <div class="privacy-row">
          <div class="privacy-row-info"><div class="privacy-row-label">🏦 Accounts Screen</div><div class="privacy-row-sub">All balances in accounts list</div></div>
          <label class="toggle-switch"><input type="checkbox" id="priv-accounts" onchange="savePrivacySettings()"><div class="toggle-track"></div></label>
        </div>
        <div class="privacy-row" style="border-bottom:none">
          <div class="privacy-row-info"><div class="privacy-row-label">📋 Transaction Amounts</div><div class="privacy-row-sub">Amounts in transaction list</div></div>
          <label class="toggle-switch"><input type="checkbox" id="priv-transactions" onchange="savePrivacySettings()"><div class="toggle-track"></div></label>
        </div>
      </div>
    </div>

    <!-- ── GENERAL (moved to top) ── -->

    <!-- ── VOICE AI ── -->
    <div class="settings-section-lbl">Voice AI</div>
    <div class="settings-card" style="margin-bottom:16px">
      <div class="settings-card-header">
        <div class="settings-card-icon" style="background:var(--violet-bg)">🎙️</div>
        <div>
          <div class="settings-card-title">Voice AI — Record Settings</div>
          <div class="settings-card-sub">Configure smart voice fields per record type</div>
        </div>
      </div>
      <div class="settings-card-body" style="padding-bottom:8px">
        <!-- Mic On/Off Toggle -->
        <div class="privacy-row" style="margin-bottom:10px">
          <div class="privacy-row-info">
            <div class="privacy-row-label">🎤 Microphone Access</div>
            <div class="privacy-row-sub" id="mic-toggle-sub">Enable voice input for Smart AI</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="mic-enabled-toggle" onchange="setMicEnabled(this.checked)">
            <div class="toggle-track"></div>
          </label>
        </div>
        <div style="font-size:11px;color:var(--text3);line-height:1.6;margin-bottom:12px">
          Choose which fields voice AI recognises when adding Payables, Goals, Recurring Rules, Planned Events, and Accounts.
          Assign keywords per field so the parser knows exactly what you mean.
        </div>
        <div id="vai-settings-summary"></div>
        <button class="btn-primary btn-secondary" style="width:100%;margin-top:10px" onclick="openVAISettings()">⚙️ Configure Voice AI Fields</button>
      </div>
    </div>

    <!-- ── DEMO DATA ── -->
    <div class="settings-section-lbl">Testing</div>
    <div class="settings-card" style="margin-bottom:16px">
      <div class="settings-card-header">
        <div class="settings-card-icon" style="background:var(--emerald-bg)">🧪</div>
        <div>
          <div class="settings-card-title">Demo / Sample Data</div>
          <div class="settings-card-sub" id="demo-data-status">For QA, UI/UX review &amp; feature testing</div>
        </div>
      </div>
      <div class="settings-card-body">
        <div style="font-size:11px;color:var(--text3);line-height:1.6;margin-bottom:12px">
          Load pre-built sample data covering all features: accounts, transactions, payables, goals, recurring rules, budgets and planned events. Your real data is safely preserved and restored when demo mode is turned off.
        </div>
        <div id="demo-mode-indicator" style="display:none;background:var(--amber-bg);border:1px solid var(--amber);border-radius:10px;padding:10px 12px;margin-bottom:12px;font-size:11px;color:var(--amber);font-weight:600;text-align:center">
          🧪 DEMO MODE ACTIVE — All data shown is sample data
        </div>
        <div style="display:flex;gap:8px">
          <button id="demo-on-btn" class="btn-primary" style="flex:1;background:var(--emerald)" onclick="enableDemoMode()">🚀 Load Demo Data</button>
          <button id="demo-off-btn" class="btn-primary btn-secondary" style="flex:1;display:none" onclick="disableDemoMode()">↩ Restore My Data</button>
        </div>
      </div>
    </div>

    <!-- ── ABOUT ── -->
    <div class="settings-card" style="margin-bottom:24px">
      <div style="padding:22px;text-align:center">
        <div style="width:56px;height:56px;background:var(--blue-bg);border:1px solid var(--blue-glow);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 12px">💸</div>
        <div style="font-size:16px;font-weight:800;color:var(--text);letter-spacing:-.4px">FinFlow</div>
        <div style="font-size:12px;font-weight:600;color:var(--blue-l);margin-top:2px">v5.0 · Premium Finance OS</div>
        <div style="font-size:11px;color:var(--text3);margin-top:10px;line-height:1.6">All data stored locally on your device.<br>🔒 Your data never leaves your phone.</div>
      </div>
    </div>

  </div>
</div>

<!-- ▸ BOTTOM NAVIGATION ─────────────────────────────────────── -->
<nav class="app-nav">
  <div class="nav-item active" onclick="showScreen('home')" id="nav-home">
    <div class="nav-icon"><span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg></span></div>
    <div class="nav-label">Home</div>
  </div>
  <div class="nav-item" onclick="showScreen('transactions')" id="nav-transactions">
    <div class="nav-icon"><span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/></svg></span></div>
    <div class="nav-label">Records</div>
  </div>
  <div class="nav-item nav-add-center" onclick="openAddTransaction()">
    <div class="nav-add-pill"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#fff"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg></div>
  </div>
  <div class="nav-item" onclick="showScreen('reports')" id="nav-reports">
    <div class="nav-icon"><span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/></svg></span></div>
    <div class="nav-label">Reports</div>
  </div>
  <div class="nav-item" onclick="openMoreDrawer()" id="nav-more">
    <div class="nav-icon"><span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg></span></div>
    <div class="nav-label">More</div>
    <div class="nav-badge" id="patch-badge" style="display:none">1</div>
  </div>
</nav>

<!-- More Drawer -->
<div class="more-drawer" id="more-drawer">
  <div class="more-drawer-handle"></div>
  <div class="more-drawer-title">More</div>
  <div class="more-drawer-grid">
    <button class="more-drawer-item" onclick="closeMoreDrawer();showScreen('accounts')">
      <div class="more-drawer-icon" style="background:#EFF6FF"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#3B82F6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z"/></svg></div>
      <div class="more-drawer-label">Accounts</div>
    </button>
    <button class="more-drawer-item" onclick="closeMoreDrawer();showScreen('goals')">
      <div class="more-drawer-icon" style="background:#F0FDF4"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#22C55E"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/><circle cx="12" cy="12" r="1" fill="#22C55E"/></svg></div>
      <div class="more-drawer-label">Goals</div>
    </button>
    <button class="more-drawer-item" onclick="closeMoreDrawer();showScreen('payables')">
      <div class="more-drawer-icon" style="background:#FFF1F2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#F43F5E"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"/></svg></div>
      <div class="more-drawer-label">Payables</div>
    </button>
    <button class="more-drawer-item" onclick="closeMoreDrawer();showScreen('budget')">
      <div class="more-drawer-icon" style="background:#FFFBEB"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#F59E0B"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z"/></svg></div>
      <div class="more-drawer-label">Budget</div>
    </button>
    <button class="more-drawer-item" onclick="closeMoreDrawer();openExportModal()">
      <div class="more-drawer-icon" style="background:#F5F3FF"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#8B5CF6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/></svg></div>
      <div class="more-drawer-label">Export</div>
    </button>
    <button class="more-drawer-item" onclick="closeMoreDrawer();showScreen('settings')">
      <div class="more-drawer-icon" style="background:#F8FAFC"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="#64748B"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></div>
      <div class="more-drawer-label">Settings</div>
    </button>
  </div>
</div>
<div class="more-drawer-overlay" id="more-drawer-overlay" onclick="closeMoreDrawer()"></div>

</div><!-- #app -->


<!-- ======== MODALS ======== -->

<!-- ADD TRANSACTION -->
<div class="modal-overlay" id="modal-tx">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-tx-title">Add Transaction</div>
    <div class="type-tabs">
      <button class="type-tab active expense" onclick="setTxType('expense',this)">💸 Expense</button>
      <button class="type-tab income" onclick="setTxType('income',this)">💰 Income</button>
      <button class="type-tab transfer" onclick="setTxType('transfer',this)">🔄 Transfer</button>
    </div>

    <!-- ── AI Smart Input Bar ── -->
    <div class="form-group" style="margin-bottom:10px">
      <label class="form-label" style="display:flex;align-items:center;gap:6px">
        🤖 Smart Input
        <span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:99px;background:var(--blue-bg);color:var(--blue-l)">AI</span>
      </label>
      <div class="smart-input-bar" id="smart-input-bar">
        <input type="text" class="smart-input-field" id="smart-input-field"
          placeholder='Type or say: "Jollibee 150" or "salary 15000"…'
          oninput="onSmartInput(this.value)"
          onkeydown="if(event.key==='Enter')applySmartResult()">
        <button class="smart-voice-btn" id="smart-voice-btn"
          onclick="toggleSmartVoice()" title="Voice input">🎤</button>
      </div>
      <!-- Voice waveform indicator -->
      <div class="voice-status-bar" id="smart-voice-status">
        <div class="voice-wave">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
        <span id="smart-voice-text">Listening… speak clearly</span>
        <button onclick="stopSmartVoice()" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <!-- AI Result Card -->
      <div class="ai-result-card" id="ai-result-card">
        <div class="ai-result-header">
          <div class="ai-result-label">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="ai-conf-badge high" id="ai-conf-badge">96%</span>
            <button class="ai-dismiss-btn" onclick="dismissAiResult()">✕</button>
          </div>
        </div>
        <div class="ai-result-fields" id="ai-result-fields">
          <!-- dynamically filled -->
        </div>
        <div class="conf-meter"><div class="conf-meter-fill" id="ai-conf-meter" style="width:0%;background:var(--emerald)"></div></div>
        <div class="ai-result-actions">
          <button class="ai-apply-btn accept" onclick="applySmartResult()">✓ Apply to Form</button>
          <button class="ai-apply-btn edit" onclick="focusSmartInput()">✏️ Edit</button>
        </div>
      </div>
      <!-- Low-confidence suggestions -->
      <div class="ai-suggestions" id="ai-suggestions" style="display:none"></div>
    </div>

    <div class="form-group">
      <label class="form-label">Amount *</label>
      <div style="display:flex;gap:8px;align-items:flex-start">
        <div style="flex:1">
          <input type="number" class="form-input" id="tx-amount" placeholder="0.00" min="0" step="0.01" oninput="checkBalanceWarning()">
          <div id="balance-warning" class="balance-warning">⚠️ Insufficient balance! Available: <span id="warning-available"></span></div>
        </div>
        <button type="button" class="voice-btn" id="voice-btn" onclick="toggleVoiceInput()" title="Classic voice input" style="display:none">🎤</button>
      </div>
      <div class="voice-status" id="voice-status" style="display:none">🎙️ Listening...</div>
    </div>
    <div class="form-group">
      <label class="form-label">Category *</label>
      <select class="form-input" id="tx-category" onchange="onCategoryManualChange()"></select>
    </div>
    <div class="form-group" id="tx-account-group">
      <label class="form-label">Account *</label>
      <select class="form-input" id="tx-account" onchange="checkBalanceWarning()"></select>
    </div>
    <div class="form-group" id="tx-from-group" style="display:none">
      <label class="form-label">From Account *</label>
      <select class="form-input" id="tx-from-account" onchange="checkBalanceWarning()"></select>
    </div>
    <div class="form-group" id="tx-to-group" style="display:none">
      <label class="form-label">To Account *</label>
      <select class="form-input" id="tx-to"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Date *</label>
      <input type="date" class="form-input" id="tx-date">
    </div>
    <div class="form-group">
      <label class="form-label">Merchant / Reference</label>
      <input type="text" class="form-input" id="tx-ref" placeholder="e.g. Jollibee, REF-12345">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input type="text" class="form-input" id="tx-desc" placeholder="What was this for?">
    </div>
    <div class="form-group">
      <label class="form-label">📷 Receipt / Attachment</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <label style="display:flex;align-items:center;justify-content:center;gap:6px;padding:11px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text2);transition:all 0.2s" onclick="triggerCamera()">
          <span style="font-size:18px">📷</span> Camera
          <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="handleReceiptWithOCR(event)">
        </label>
        <label style="display:flex;align-items:center;justify-content:center;gap:6px;padding:11px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text2);transition:all 0.2s">
          <span style="font-size:18px">📎</span> Gallery
          <input type="file" id="receipt-input" accept="image/*,application/pdf" style="display:none" onchange="handleReceipt(event)">
        </label>
      </div>
      <div class="file-zone" id="receipt-zone" style="display:none">
        <div id="receipt-preview-wrap" style="padding:12px 12px 0">
          <img id="rz-preview" class="fz-preview" style="display:none" alt="">
          <div id="rz-fname" class="fz-fname"></div>
        </div>
        <button type="button" class="fz-remove" id="rz-remove-btn" onclick="removeReceipt()">✕ Remove attachment</button>
      </div>
      <div id="ocr-loading" style="display:none;text-align:center;padding:12px;font-size:12px;color:var(--accent)">🔍 Reading receipt... auto-filling fields...</div>
      <div id="ocr-result-banner" style="display:none;background:rgba(86,200,160,0.1);border:1px solid var(--accent2);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--accent2);margin-top:6px"></div>
    </div>
    <button class="btn-primary" id="tx-save-btn" onclick="saveTx()">Save Transaction</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-tx')">Cancel</button>
    <button class="btn-primary btn-danger" id="tx-delete-btn" style="display:none;margin-top:8px" onclick="deleteTx()">Delete</button>
  </div>
</div>

<!-- ACCOUNT DETAIL MODAL -->
<!-- ▸ VOICE AI SETTINGS MODAL ──────────────────────────── -->
<div class="modal-overlay" id="modal-vai-settings">
  <div class="modal">
    <div class="modal-title">🎙️ Voice AI Field Settings</div>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin:-10px 0 14px;line-height:1.6">
      Pick which fields voice recognises per record type.<br>
      Set keywords so the AI maps what you say to each field.
    </div>

    <!-- FEATURE 1: Privacy notice in settings -->
    <div style="background:var(--blue-bg);border:1px solid var(--blue);border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:10px;color:var(--text2);line-height:1.5">
      🔒 <strong>Privacy:</strong> Mic access is <em>temporary only</em> — the stream is destroyed the moment you stop speaking. No audio ever leaves your device.
    </div>

    <!-- FEATURE 4: 2s silence delay toggle -->
    <div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:12px">
      <div>
        <div style="font-size:12px;font-weight:700">⏱ Keep listening for 2s after pause</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">Waits 2 seconds of silence before finalising (better for longer sentences)</div>
      </div>
      <label style="position:relative;display:inline-block;width:38px;height:22px;flex-shrink:0;margin-left:12px">
        <input type="checkbox" id="vai-silence-toggle" checked
          onchange="db.settings.vaiSilenceDelay=this.checked?2000:500;saveDB();_voiceEngine.silenceDelay=db.settings.vaiSilenceDelay;_updateToggleStyle(this.checked);"
          style="opacity:0;width:0;height:0">
        <span style="position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:22px;transition:.3s" id="vai-silence-track"></span>
        <span style="position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s" id="vai-silence-thumb"></span>
      </label>
    </div>

    <!-- Record-type tab bar -->
    <div class="vai-tab-bar" id="vai-type-tabs">
      <button class="vai-tab-btn" onclick="switchVAITab('payable',this)">💳 Payable</button>
      <button class="vai-tab-btn" onclick="switchVAITab('goal',this)">🎯 Goal</button>
      <button class="vai-tab-btn" onclick="switchVAITab('recurring',this)">🔄 Recurring</button>
      <button class="vai-tab-btn" onclick="switchVAITab('planned',this)">📅 Event</button>
      <button class="vai-tab-btn" onclick="switchVAITab('account',this)">🏦 Account</button>
      <button class="vai-tab-btn" onclick="switchVAITab('budget',this)">📊 Budget</button>
    </div>

    <div id="vai-fields-panel" style="max-height:50vh;overflow-y:auto"></div>

    <button class="btn-primary" style="margin-top:14px" onclick="saveVAISettings()">💾 Save Settings</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-vai-settings')">Cancel</button>
  </div>
</div>

<!-- ▸ VOICE AI CONFIRM MODAL ────────────────────────────── -->
<div class="modal-overlay" id="modal-vai-confirm">
  <div class="modal">
    <div class="modal-title" id="vai-confirm-title">🎙️ Voice AI — Confirm</div>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin:-10px 0 14px;line-height:1.5">
      Review what the AI parsed from your voice input,<br>then confirm to pre-fill the form.
    </div>

    <!-- Confidence -->
    <div class="vai-conf-bar-wrap">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px">AI Confidence</span>
        <span id="vai-conf-pct" style="font-size:12px;font-weight:800">—</span>
      </div>
      <div class="vai-conf-bar-track">
        <div class="vai-conf-bar-fill" id="vai-conf-bar" style="width:0%"></div>
      </div>
      <div id="vai-raw-text" style="font-size:9px;color:var(--text3);margin-top:6px;font-style:italic;word-break:break-word"></div>
    </div>

    <!-- Parsed fields list -->
    <div id="vai-confirm-fields" style="display:flex;flex-direction:column;gap:7px;margin-bottom:12px"></div>

    <!-- Unrecognised words hint -->
    <div id="vai-unrecognised" style="display:none;background:var(--amber-bg);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:8px 10px;font-size:10px;color:var(--amber);margin-bottom:10px;line-height:1.5"></div>

    <button class="btn-primary btn-success" onclick="executeVAIConfirm()">✅ Confirm &amp; Open Form</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-vai-confirm')">✕ Dismiss</button>
  </div>
</div>

<!-- ▸ VOICE AI FLOATING QUICK-BAR ──────────────────────── -->
<div class="vai-quick-bar" id="vai-quick-bar">
  <div class="vai-quick-inner">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="vai-mic-btn" id="vai-mic-btn" onclick="toggleVAIVoice()" title="Voice input">🎤</button>
      <input class="vai-quick-input" id="vai-quick-input" type="text"
        placeholder="Speak or type…"
        oninput="onVAITextInput(this.value)"
        onkeydown="if(event.key==='Enter'){parseAndConfirmVAI(this.value,'manual')}">
      <button class="vai-parse-btn" onclick="parseAndConfirmVAI(document.getElementById('vai-quick-input').value,'manual')">Parse ›</button>
    </div>
    <div id="vai-bar-hint" style="font-size:9.5px;color:var(--text3);margin-top:5px;min-height:14px"></div>
  </div>
</div>


<!-- ACCOUNT DETAIL MODAL -->
<div class="modal-overlay" id="modal-account-detail">
  <div class="modal" style="padding-bottom:24px">
    <div class="modal-handle"></div>
    <div id="account-detail-content"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px">
      <button class="btn-primary btn-secondary" id="account-detail-edit-btn">✏️ Edit Account</button>
      <button class="btn-primary btn-secondary" onclick="closeModal('modal-account-detail')">Close</button>
    </div>
    <button class="btn-primary btn-danger" id="account-detail-delete-btn" style="margin-top:8px">🗑 Delete Account</button>
  </div>
</div>

<!-- ADD ACCOUNT -->
<div class="modal-overlay" id="modal-account">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-account-title">Add Account</div>
    <!-- Form VAI Smart Input -->
    <div class="form-vai-wrap" id="account-vai-wrap">
      <div class="form-vai-header">🎙️ Smart Input <span class="form-vai-badge">AI</span></div>
      <div class="form-vai-bar">
        <input type="text" class="form-vai-input" id="account-vai-input"
          placeholder='e.g. "GCash wallet balance 5000" or "BDO savings 20000"'
          oninput="onFormVAI('account',this.value)"
          onkeydown="if(event.key==='Enter')applyFormVAI('account')">
        <button class="form-vai-mic" id="account-vai-mic" onclick="toggleFormVAIVoice('account')" title="Voice input">🎤</button>
      </div>
      <div class="voice-status-bar" id="account-vai-voice-status">
        <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
        <span>Listening… speak clearly</span>
        <button onclick="stopFormVAIVoice('account')" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <div class="form-vai-result" id="account-vai-result">
        <div class="form-vai-result-hdr">
          <div class="form-vai-result-lbl">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="form-vai-conf-badge" id="account-vai-conf">--</span>
            <button class="form-vai-dismiss" onclick="dismissFormVAI('account')">✕</button>
          </div>
        </div>
        <div class="form-vai-fields" id="account-vai-fields"></div>
        <div class="form-vai-meter"><div class="form-vai-meter-fill" id="account-vai-meter" style="width:0%"></div></div>
        <div class="form-vai-actions">
          <button class="form-vai-apply" onclick="applyFormVAI('account')">✓ Apply to Form</button>
          <button class="form-vai-edit" onclick="document.getElementById('account-vai-input').focus()">✏️ Edit</button>
        </div>
      </div>
      <div class="form-vai-hint" id="account-vai-hint">🏦 Account — speak or type to pre-fill the form</div>
    </div>
    <div class="form-group">
      <label class="form-label">🖼️ Bank / Wallet Logo <span style="font-size:11px;color:var(--text3);font-weight:400">(Optional)</span></label>
      <div class="logo-upload-wrap" id="logo-upload-wrap" onclick="document.getElementById('acc-logo-input').click()">
        <img id="acc-logo-preview" src="" alt="" style="display:none;width:48px;height:48px;border-radius:12px;object-fit:contain">
        <span id="acc-logo-placeholder" style="font-size:28px">🏦</span>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Tap to upload logo</div>
      </div>
      <input type="file" id="acc-logo-input" accept="image/*" style="display:none" onchange="handleLogoUpload(this)">
    </div>
    <div class="form-group">
      <label class="form-label">Account Name *</label>
      <input type="text" class="form-input" id="acc-name" placeholder="e.g. BDO Savings, GCash, Cash Wallet">
    </div>
    <div class="form-group">
      <label class="form-label">Account Type *</label>
      <select class="form-input" id="acc-type" onchange="toggleAccFields()">
        <option value="bank">🏦 Bank</option>
        <option value="ewallet">📱 E-Wallet</option>
        <option value="cash">💵 Cash on Hand</option>
      </select>
    </div>
    <div id="acc-num-group" class="form-group">
      <label class="form-label">Account Number</label>
      <input type="text" class="form-input" id="acc-number" placeholder="e.g. **** 1234 or 09XX XXX XXXX">
    </div>
    <div id="acc-holder-group" class="form-group">
      <label class="form-label">Account Holder Name</label>
      <input type="text" class="form-input" id="acc-holder" placeholder="e.g. Juan Dela Cruz">
    </div>
    <div class="form-group">
      <label class="form-label">Opening Balance</label>
      <input type="number" class="form-input" id="acc-balance" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">🛡️ Savings Reserve <span style="font-size:11px;color:var(--text3);font-weight:400">(Optional — protected amount)</span></label>
      <input type="number" class="form-input" id="acc-savings" placeholder="0.00 — e.g. keep ₱5,000 as savings" min="0" step="0.01">
      <div style="font-size:11px;color:var(--text3);margin-top:5px">⚠️ You will be alerted if an expense would dip below this reserve amount.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Card Color</label>
      <div class="color-grid" id="color-grid"></div>
    </div>
    <button class="btn-primary" id="acc-save-btn" onclick="saveAccount()">Save Account</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-account')">Cancel</button>
    <button class="btn-primary btn-danger" id="acc-delete-btn" style="display:none;margin-top:8px" onclick="deleteAccount()">Delete Account</button>
  </div>
</div>

<!-- ADD PLANNED -->
<div class="modal-overlay" id="modal-planned">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-planned-title">Add Planned Activity</div>
    <!-- Form VAI Smart Input -->
    <div class="form-vai-wrap" id="planned-vai-wrap">
      <div class="form-vai-header">🎙️ Smart Input <span class="form-vai-badge">AI</span></div>
      <div class="form-vai-bar">
        <input type="text" class="form-vai-input" id="planned-vai-input"
          placeholder='e.g. "plan transport 500 March 18" or "bill food 150 for next week"'
          oninput="onFormVAI('planned',this.value)"
          onkeydown="if(event.key==='Enter')applyFormVAI('planned')">
        <button class="form-vai-mic" id="planned-vai-mic" onclick="toggleFormVAIVoice('planned')" title="Voice input">🎤</button>
      </div>
      <div class="voice-status-bar" id="planned-vai-voice-status">
        <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
        <span>Listening… speak clearly</span>
        <button onclick="stopFormVAIVoice('planned')" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <div class="form-vai-result" id="planned-vai-result">
        <div class="form-vai-result-hdr">
          <div class="form-vai-result-lbl">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="form-vai-conf-badge" id="planned-vai-conf">--</span>
            <button class="form-vai-dismiss" onclick="dismissFormVAI('planned')">✕</button>
          </div>
        </div>
        <div class="form-vai-fields" id="planned-vai-fields"></div>
        <div class="form-vai-meter"><div class="form-vai-meter-fill" id="planned-vai-meter" style="width:0%"></div></div>
        <div class="form-vai-actions">
          <button class="form-vai-apply" onclick="applyFormVAI('planned')">✓ Apply to Form</button>
          <button class="form-vai-edit" onclick="document.getElementById('planned-vai-input').focus()">✏️ Edit</button>
        </div>
      </div>
      <div class="form-vai-hint" id="planned-vai-hint">📅 Upcoming Event — speak or type to pre-fill the form</div>
    </div>
    <div class="type-tabs">
      <button class="type-tab active expense" onclick="setPlannedType('expense',this)">💸 Expense</button>
      <button class="type-tab income" onclick="setPlannedType('income',this)">💰 Income</button>
      <button class="type-tab transfer" onclick="setPlannedType('transfer',this)">🔄 Transfer</button>
    </div>
    <div class="form-group">
      <label class="form-label">Amount *</label>
      <input type="number" class="form-input" id="pl-amount" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Category *</label>
      <select class="form-input" id="pl-category"></select>
    </div>
    <div class="form-group" id="pl-account-group">
      <label class="form-label">Account *</label>
      <select class="form-input" id="pl-account"></select>
    </div>
    <div class="form-group" id="pl-from-group" style="display:none">
      <label class="form-label">From Account *</label>
      <select class="form-input" id="pl-from-account"></select>
    </div>
    <div class="form-group" id="pl-to-group" style="display:none">
      <label class="form-label">To Account *</label>
      <select class="form-input" id="pl-to"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Planned Date *</label>
      <input type="date" class="form-input" id="pl-date">
    </div>
    <div style="display:flex;gap:6px;margin:-6px 0 12px;flex-wrap:wrap">
      <button type="button" onclick="setQuickDate(0)" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:11px;cursor:pointer">Today</button>
      <button type="button" onclick="setQuickDate(1)" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:11px;cursor:pointer">Tomorrow</button>
      <button type="button" onclick="setQuickDate(7)" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:11px;cursor:pointer">+7 Days</button>
      <button type="button" onclick="setQuickDate(30)" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:11px;cursor:pointer">+30 Days</button>
    </div>
    <div class="form-group">
      <label class="form-label">Reference No.</label>
      <input type="text" class="form-input" id="pl-ref" placeholder="Optional">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input type="text" class="form-input" id="pl-desc" placeholder="What is this for?">
    </div>
    <button class="btn-primary" id="pl-save-btn" onclick="savePlanned()">Save Planned Activity</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-planned')">Cancel</button>
    <button class="btn-primary btn-danger" id="pl-delete-btn" style="display:none;margin-top:8px" onclick="deletePlanned()">Delete</button>
  </div>
</div>

<!-- CONFIRM PLANNED -->
<div class="modal-overlay" id="modal-confirm-planned">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">✅ Confirm Activity</div>
    <p style="text-align:center;color:var(--text2);font-size:13px;margin-bottom:16px">Did this activity happen? Confirming will update your account balances.</p>
    <div id="confirm-planned-detail" style="margin-bottom:16px"></div>
    <div class="form-group">
      <label class="form-label">Actual Effective Date</label>
      <input type="date" class="form-input" id="confirm-actual-date">
      <div style="font-size:11px;color:var(--text3);margin-top:4px">If different from the planned date, the original date will be saved in change logs.</div>
    </div>
    <div id="confirm-balance-warning" class="balance-warning" style="margin-bottom:10px"></div>
    <div class="form-group">
      <label class="form-label">Transaction Fee <span style="font-size:10px;color:var(--text3);font-weight:400">(Optional)</span></label>
      <input type="number" class="form-input" id="confirm-tx-fee" placeholder="0.00" min="0" step="0.01">
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Fee recorded as a separate expense transaction.</div>
    </div>
    <button class="btn-primary btn-success" onclick="executeConfirmPlanned()">✅ Yes, It Happened</button>
    <button class="btn-primary btn-warn" style="margin-top:8px" onclick="executeSkipPlanned()">⏭️ Skip / Did Not Happen</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-confirm-planned')">Cancel</button>
  </div>
</div>

<!-- VIEW TRANSACTION -->
<div class="modal-overlay" id="modal-view-tx">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Transaction Details</div>
    <div id="view-tx-content"></div>
    <button class="btn-primary" id="view-tx-edit-btn" style="margin-top:16px">Edit Transaction</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-view-tx')">Close</button>
  </div>
</div>

<!-- CURRENCY -->
<div class="modal-overlay" id="modal-currency">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Select Currency</div>
    <div class="form-group">
      <select class="form-input" id="currency-select">
        <option value="₱|PHP">Philippine Peso (₱)</option>
        <option value="$|USD">US Dollar ($)</option>
        <option value="€|EUR">Euro (€)</option>
        <option value="£|GBP">British Pound (£)</option>
        <option value="¥|JPY">Japanese Yen (¥)</option>
        <option value="₩|KRW">Korean Won (₩)</option>
        <option value="₹|INR">Indian Rupee (₹)</option>
        <option value="RM|MYR">Malaysian Ringgit (RM)</option>
        <option value="S$|SGD">Singapore Dollar (S$)</option>
        <option value="฿|THB">Thai Baht (฿)</option>
      </select>
    </div>
    <button class="btn-primary" onclick="saveCurrency()">Save</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-currency')">Cancel</button>
  </div>
</div>

<!-- CONFIRM GENERIC -->
<div class="modal-overlay" id="modal-confirm">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="confirm-title">Are you sure?</div>
    <p id="confirm-msg" style="text-align:center;color:var(--text2);font-size:13px;margin-bottom:20px"></p>
    <button class="btn-primary btn-danger" id="confirm-ok-btn">Confirm</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-confirm')">Cancel</button>
  </div>
</div>

<!-- FEATURE 1: Mic Permission Modal -->
<div class="modal-overlay" id="modal-mic-permission" role="dialog" aria-modal="true" aria-labelledby="mic-perm-title">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="mic-perm-title">🎤 Microphone Access Required</div>
    <div style="background:var(--blue-bg);border:1px solid var(--blue);border-radius:12px;padding:14px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--text);line-height:1.7">
        <div style="margin-bottom:8px">FinFlow Voice AI needs <strong>temporary</strong> microphone access to listen to your voice.</div>
        <div style="margin-bottom:6px">✅ Access is granted <strong>ONLY while recording</strong> and is automatically revoked the moment you stop speaking.</div>
        <div style="margin-bottom:6px">🔒 Your voice is processed <strong>100% locally</strong> on your device and <strong>never leaves</strong> your phone or browser.</div>
        <div>🚫 No audio data is stored, transmitted, or shared anywhere.</div>
      </div>
    </div>
    <div style="background:var(--emerald-bg);border:1px solid var(--emerald);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:10px;color:var(--emerald);font-weight:600">
      🛡️ Privacy-first: Mic stream is immediately destroyed after each recording session
    </div>
    <button class="btn-primary btn-success" id="mic-allow-btn" onclick="_onMicAllow()">🎤 Allow Microphone Access</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="_onMicDeny()">Cancel</button>
  </div>
</div>

<!-- FEATURE 3: Secure Clear All Data Modal -->
<div class="modal-overlay" id="modal-clear-data" role="dialog" aria-modal="true" aria-labelledby="clear-data-title">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="clear-data-title" style="color:var(--rose)">⚠️ Permanent Data Deletion</div>
    <div style="background:var(--rose-bg);border:1px solid var(--rose);border-radius:12px;padding:14px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--text);line-height:1.7">
        <div style="margin-bottom:8px;font-weight:700;color:var(--rose)">This action CANNOT be undone.</div>
        <div>ALL your transactions, goals, payables, budgets, accounts, recurring rules and history will be <strong>permanently deleted</strong> from this device.</div>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:14px">
      <label class="form-label" style="color:var(--rose)">Type <strong>DELETE</strong> to confirm</label>
      <input type="text" class="form-input" id="clear-data-input"
        placeholder="Type DELETE to confirm"
        oninput="onClearDataInput(this.value)"
        onkeydown="if(event.key==='Enter'&&!document.getElementById('clear-data-confirm-btn').disabled)executeClearData()"
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
        style="border-color:var(--rose-bg)">
      <div id="clear-data-hint" style="font-size:10px;color:var(--text3);margin-top:4px">Enter exactly: DELETE (case-sensitive)</div>
    </div>
    <button class="btn-primary btn-danger" id="clear-data-confirm-btn" onclick="executeClearData()" disabled style="opacity:0.4;cursor:not-allowed">🗑️ Delete Everything</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-clear-data');document.getElementById('clear-data-input').value='';onClearDataInput('')">Cancel</button>
  </div>
</div>

<!-- QR FULLSCREEN PRESENTER -->
<div class="qr-fullscreen" id="qr-fullscreen">
  <div class="qr-fs-top">
    <div class="qr-fs-name" id="qr-fs-name"></div>
    <div class="qr-fs-sub" id="qr-fs-sub"></div>
  </div>
  <div class="qr-fs-img-wrap">
    <div class="qr-fs-img">
      <img id="qr-fs-img" src="" alt="QR Code">
    </div>
    <div class="qr-fs-zoom-overlay">
      <button class="qr-fs-zoom-btn" onclick="qrZoom(-1)" title="Zoom Out">−</button>
      <span class="qr-fs-zoom-label" id="qr-fs-zoom-label">100%</span>
      <button class="qr-fs-zoom-btn" onclick="qrZoom(+1)" title="Zoom In">＋</button>
    </div>
  </div>
  <div class="qr-fs-bottom">
    <button class="qr-fs-dl" onclick="downloadQRFullscreen()">⬇️ Download</button>
    <button class="qr-fs-close" onclick="closeQRFullscreen()">✕ Close</button>
  </div>
</div>

<!-- ADD PAYABLE MODAL -->
<div class="modal-overlay" id="modal-payable">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-payable-title">Add Payable</div>
    <!-- Form VAI Smart Input -->
    <div class="form-vai-wrap" id="payable-vai-wrap">
      <div class="form-vai-header">🎙️ Smart Input <span class="form-vai-badge">AI</span></div>
      <div class="form-vai-bar">
        <input type="text" class="form-vai-input" id="payable-vai-input"
          placeholder='e.g. "BDO loan total 15000 monthly 3000 due 5"'
          oninput="onFormVAI('payable',this.value)"
          onkeydown="if(event.key==='Enter')applyFormVAI('payable')">
        <button class="form-vai-mic" id="payable-vai-mic" onclick="toggleFormVAIVoice('payable')" title="Voice input">🎤</button>
      </div>
      <div class="voice-status-bar" id="payable-vai-voice-status">
        <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
        <span>Listening… speak clearly</span>
        <button onclick="stopFormVAIVoice('payable')" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <div class="form-vai-result" id="payable-vai-result">
        <div class="form-vai-result-hdr">
          <div class="form-vai-result-lbl">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="form-vai-conf-badge" id="payable-vai-conf">--</span>
            <button class="form-vai-dismiss" onclick="dismissFormVAI('payable')">✕</button>
          </div>
        </div>
        <div class="form-vai-fields" id="payable-vai-fields"></div>
        <div class="form-vai-meter"><div class="form-vai-meter-fill" id="payable-vai-meter" style="width:0%"></div></div>
        <div class="form-vai-actions">
          <button class="form-vai-apply" onclick="applyFormVAI('payable')">✓ Apply to Form</button>
          <button class="form-vai-edit" onclick="document.getElementById('payable-vai-input').focus()">✏️ Edit</button>
        </div>
      </div>
      <div class="form-vai-hint" id="payable-vai-hint">💳 Payable / Loan — speak or type to pre-fill the form</div>
    </div>
    <div class="form-group">
      <label class="form-label">Payable Name *</label>
      <input type="text" class="form-input" id="py-name" placeholder="e.g. BDO Credit Card, SSS Loan">
    </div>
    <div class="form-group">
      <label class="form-label">Type *</label>
      <select class="form-input" id="py-type">
        <option value="loan">🏦 Personal / Bank Loan</option>
        <option value="credit">💳 Credit Card</option>
        <option value="spl">📱 BuyNow PayLater / BNPL</option>
        <option value="other">📋 Other Payable</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Total Amount / Credit Limit *</label>
      <input type="number" class="form-input" id="py-total" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Amount Already Paid (Balance Paid)</label>
      <input type="number" class="form-input" id="py-paid" placeholder="0.00" min="0" step="0.01">
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Enter how much has been paid so far if this is an existing loan.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Monthly Payment / Minimum Due</label>
      <input type="number" class="form-input" id="py-monthly" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Variable Monthly Amount <span style="font-size:10px;color:var(--text3);font-weight:400">(e.g. BNPL, SPayLater)</span></label>
      <select class="form-input" id="py-single-month">
        <option value="no">🔄 Allow advance multi-month payments</option>
        <option value="yes">1️⃣ Single month only — amount changes each month</option>
      </select>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Choose "Single month only" for BNPL/instalment plans where the due amount may vary each month.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Interest Rate (% per year)</label>
      <input type="number" class="form-input" id="py-interest" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Due Date (Day of Month)</label>
      <input type="number" class="form-input" id="py-due-day" placeholder="e.g. 15" min="1" max="31">
    </div>
    <div class="form-group">
      <label class="form-label">Allow Overpayment?</label>
      <select class="form-input" id="py-overpay">
        <option value="no">❌ No — Block payments exceeding balance</option>
        <option value="yes">✅ Yes — Allow overpayment (credit card cashback etc.)</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Linked Account (for payments)</label>
      <select class="form-input" id="py-account"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="form-input" id="py-notes" placeholder="Additional details...">
    </div>
    <button class="btn-primary" id="py-save-btn" onclick="savePayable()">Save Payable</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-payable')">Cancel</button>
    <button class="btn-primary btn-danger" id="py-delete-btn" style="display:none;margin-top:8px" onclick="deletePayable()">Delete Payable</button>
  </div>
</div>

<!-- PAYABLE PAYMENT HISTORY MODAL -->
<div class="modal-overlay" id="modal-payable-history">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="payable-history-title">Payment History</div>
    <div id="payable-history-detail" style="margin-bottom:16px"></div>
    <div id="payable-history-list"></div>
    <button class="btn-primary btn-secondary" style="margin-top:12px" onclick="closeModal('modal-payable-history')">Close</button>
  </div>
</div>

<!-- RECORD PAYMENT MODAL -->
<div class="modal-overlay" id="modal-pay-payable">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Record Payment</div>
    <div id="pay-payable-detail" style="margin-bottom:16px"></div>
    <div class="form-group">
      <label class="form-label">Number of Months to Pay</label>
      <div style="display:flex;gap:6px;margin-bottom:8px">
        <button type="button" class="planned-btn" style="flex:1;padding:8px 4px;font-size:12px" onclick="setPayMonths(1,this)">1 Month</button>
        <button type="button" class="planned-btn" style="flex:1;padding:8px 4px;font-size:12px" onclick="setPayMonths(2,this)">2 Months</button>
        <button type="button" class="planned-btn" style="flex:1;padding:8px 4px;font-size:12px" onclick="setPayMonths(3,this)">3 Months</button>
        <button type="button" class="planned-btn" style="flex:1;padding:8px 4px;font-size:12px" onclick="setPayMonths(6,this)">6 Months</button>
      </div>
      <div id="pay-months-note" style="font-size:11px;color:var(--text3);margin-bottom:8px;background:var(--blue-bg);border-radius:8px;padding:8px 10px;display:none"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Payment Amount *</label>
      <input type="number" class="form-input" id="pay-amount" placeholder="0.00" min="0" step="0.01" oninput="checkPayableWarning()">
      <input type="hidden" id="pay-months" value="1">
      <div id="pay-balance-warning" class="balance-warning" style="margin-top:6px"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Pay From Account *</label>
      <select class="form-input" id="pay-from-account" onchange="checkPayableWarning()"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Payment Date</label>
      <input type="date" class="form-input" id="pay-date">
    </div>
    <div class="form-group">
      <label class="form-label">Reference / Notes</label>
      <input type="text" class="form-input" id="pay-ref" placeholder="Optional">
    </div>
    <div class="form-group">
      <label class="form-label">Transaction Fee <span style="font-size:10px;color:var(--text3);font-weight:400">(Optional — e.g. processing fee)</span></label>
      <input type="number" class="form-input" id="pay-tx-fee" placeholder="0.00" min="0" step="0.01">
      <div style="font-size:11px;color:var(--text3);margin-top:4px">⚠️ Fee will be recorded as a separate expense transaction.</div>
    </div>
    <button class="btn-primary btn-success" onclick="executePayPayable()">✅ Record Payment</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-pay-payable')">Cancel</button>
  </div>
</div>

<!-- SCHEDULE PAYABLE MODAL -->
<div class="modal-overlay" id="modal-schedule-payable">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">📅 Schedule Payment</div>
    <p style="text-align:center;font-size:13px;color:var(--text2);margin-bottom:16px">This will add a planned activity to your calendar and notify you if balance is insufficient.</p>
    <div id="schedule-payable-detail" style="margin-bottom:16px"></div>
    <div class="form-group">
      <label class="form-label">Scheduled Date *</label>
      <input type="date" class="form-input" id="sched-date">
    </div>
    <div class="form-group">
      <label class="form-label">Amount</label>
      <input type="number" class="form-input" id="sched-amount" placeholder="0.00" oninput="checkSchedBalance()">
    </div>
    <div class="form-group">
      <label class="form-label">Pay From Account</label>
      <select class="form-input" id="sched-account" onchange="checkSchedBalance()"></select>
    </div>
    <div id="sched-balance-warning" class="balance-warning" style="margin-bottom:8px"></div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="form-input" id="sched-notes" placeholder="Optional">
    </div>
    <button class="btn-primary btn-success" onclick="executeSchedulePayable()">📅 Add to Calendar</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-schedule-payable')">Cancel</button>
  </div>
</div>

<!-- ADD QR CODE MODAL -->
<div class="modal-overlay" id="modal-qr">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-qr-title">Add QR Code</div>
    <div class="form-group">
      <label class="form-label">Label *</label>
      <input type="text" class="form-input" id="qr-label" placeholder="e.g. GCash, Maya, BDO QR">
    </div>
    <div class="form-group">
      <label class="form-label">Account (Optional)</label>
      <select class="form-input" id="qr-account">
        <option value="">-- Not linked to account --</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Account Name / Number shown on QR</label>
      <input type="text" class="form-input" id="qr-owner" placeholder="e.g. Juan D. / 09XX XXX XXXX">
    </div>
    <div class="form-group">
      <label class="form-label">QR Code Image *</label>
      <div class="file-zone" id="qr-upload-zone">
        <label class="file-zone-label" id="qr-upload-label-default">
          <input type="file" id="qr-file-input" accept="image/*" onchange="handleQRUpload(event)">
          <div class="fz-icon">📲</div>
          <div class="fz-text">Tap to upload QR code image</div>
          <div class="fz-hint">JPG, PNG, GIF — max 5MB</div>
        </label>
        <div id="qr-upload-preview" style="display:none;padding:14px 14px 8px">
          <img id="qr-preview-img" class="fz-preview" style="display:block" alt="">
          <div id="qr-preview-fname" class="fz-fname"></div>
        </div>
        <button type="button" class="fz-remove" id="qr-remove-btn" style="display:none" onclick="removeQRUpload()">✕ Remove QR image</button>
      </div>
    </div>
    <button class="btn-primary" id="qr-save-btn" onclick="saveQR()">Save QR Code</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-qr')">Cancel</button>
    <button class="btn-primary btn-danger" id="qr-delete-btn" style="display:none;margin-top:8px" onclick="deleteQR()">Delete QR Code</button>
  </div>
</div>

<!-- ADD QR CONTACT MODAL -->
<div class="modal-overlay" id="modal-qr-contact">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-qrc-title">Add QR Contact</div>

    <!-- Profile photo -->
    <div class="profile-img-upload">
      <div class="profile-img-circle" id="qrc-profile-circle">
        <span id="qrc-profile-placeholder">👤</span>
        <img id="qrc-profile-img" src="" alt="" style="display:none">
        <input type="file" id="qrc-profile-file" accept="image/*" onchange="handleQRCProfileUpload(event)">
      </div>
      <div class="profile-img-label" id="qrc-profile-lbl">Tap to add photo</div>
      <button class="profile-img-remove" id="qrc-profile-remove" onclick="removeQRCProfile()">✕ Remove photo</button>
    </div>

    <div class="form-group">
      <label class="form-label">Name *</label>
      <input type="text" class="form-input" id="qrc-name" placeholder="e.g. Juan dela Cruz, SM Supermarket">
    </div>
    <div class="form-group">
      <label class="form-label">Type</label>
      <select class="form-input" id="qrc-type">
        <option value="person">👤 Person</option>
        <option value="merchant">🏪 Merchant / Store</option>
        <option value="business">🏢 Business</option>
        <option value="other">📋 Other</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Account / Number (Optional)</label>
      <input type="text" class="form-input" id="qrc-account-info" placeholder="e.g. GCash 09XX XXX XXXX, BPI Savings">
    </div>
    <div class="form-group">
      <label class="form-label">Their QR Code Image *</label>
      <div class="file-zone" id="qrc-upload-zone">
        <label class="file-zone-label" id="qrc-upload-label-default">
          <input type="file" id="qrc-file-input" accept="image/*" onchange="handleQRContactUpload(event)">
          <div class="fz-icon">📲</div>
          <div class="fz-text">Tap to upload their QR code</div>
          <div class="fz-hint">GCash, Maya, Bank QR, etc.</div>
        </label>
        <div id="qrc-upload-preview" style="display:none;padding:14px 14px 8px">
          <img id="qrc-preview-img" class="fz-preview" style="display:block" alt="">
          <div id="qrc-preview-fname" class="fz-fname"></div>
        </div>
        <button type="button" class="fz-remove" id="qrc-remove-btn" style="display:none" onclick="removeQRContactUpload()">✕ Remove QR image</button>
      </div>
    </div>
    <button class="btn-primary" id="qrc-save-btn" onclick="saveQRContact()">Save Contact</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-qr-contact')">Cancel</button>
    <button class="btn-primary btn-danger" id="qrc-delete-btn" style="display:none;margin-top:8px" onclick="deleteQRContact()">Delete Contact</button>
  </div>
</div>


<div class="modal-overlay" id="modal-budget">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-budget-title">Add Budget Limit</div>
    <!-- Form VAI Smart Input -->
    <div class="form-vai-wrap" id="budget-vai-wrap">
      <div class="form-vai-header">🎙️ Smart Input <span class="form-vai-badge">AI</span></div>
      <div class="form-vai-bar">
        <input type="text" class="form-vai-input" id="budget-vai-input"
          placeholder='e.g. "budget food 5000 monthly" or "set limit 3000"'
          oninput="onFormVAI('budget',this.value)"
          onkeydown="if(event.key==='Enter')applyFormVAI('budget')">
        <button class="form-vai-mic" id="budget-vai-mic" onclick="toggleFormVAIVoice('budget')" title="Voice input">🎤</button>
      </div>
      <div class="voice-status-bar" id="budget-vai-voice-status">
        <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
        <span>Listening… speak clearly</span>
        <button onclick="stopFormVAIVoice('budget')" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <div class="form-vai-result" id="budget-vai-result">
        <div class="form-vai-result-hdr">
          <div class="form-vai-result-lbl">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="form-vai-conf-badge" id="budget-vai-conf">--</span>
            <button class="form-vai-dismiss" onclick="dismissFormVAI('budget')">✕</button>
          </div>
        </div>
        <div class="form-vai-fields" id="budget-vai-fields"></div>
        <div class="form-vai-meter"><div class="form-vai-meter-fill" id="budget-vai-meter" style="width:0%"></div></div>
        <div class="form-vai-actions">
          <button class="form-vai-apply" onclick="applyFormVAI('budget')">✓ Apply to Form</button>
          <button class="form-vai-edit" onclick="document.getElementById('budget-vai-input').focus()">✏️ Edit</button>
        </div>
      </div>
      <div class="form-vai-hint" id="budget-vai-hint">📊 Budget — speak or type to pre-fill the form</div>
    </div>
    <div class="form-group">
      <label class="form-label">Category *</label>
      <select class="form-input" id="budget-category"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Budget Period *</label>
      <select class="form-input" id="budget-period" onchange="toggleBudgetMonthSelector()">
        <option value="monthly">📅 Monthly</option>
        <option value="yearly">📆 Yearly</option>
      </select>
    </div>
    <div class="form-group" id="budget-month-selector-group" style="display:none">
      <label class="form-label">Apply To Month (leave blank for recurring each month)</label>
      <select class="form-input" id="budget-target-month">
        <option value="">— All months (default) —</option>
      </select>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Select a specific month to set a budget in advance for that month only.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Spending Limit *</label>
      <input type="number" class="form-input" id="budget-limit" placeholder="e.g. 5000" min="1" step="0.01">
    </div>
    <div id="budget-current-spend" style="background:var(--bg3);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--text2);margin-bottom:8px;display:none"></div>
    <button class="btn-primary" id="budget-save-btn" onclick="saveBudget()">Save Budget</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-budget')">Cancel</button>
    <button class="btn-primary btn-danger" id="budget-delete-btn" style="display:none;margin-top:8px" onclick="deleteBudget()">Remove Budget</button>
  </div>
</div>

<!-- GOALS MODAL -->
<div class="modal-overlay" id="modal-goal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-goal-title">New Savings Goal</div>
    <!-- Form VAI Smart Input -->
    <div class="form-vai-wrap" id="goal-vai-wrap">
      <div class="form-vai-header">🎙️ Smart Input <span class="form-vai-badge">AI</span></div>
      <div class="form-vai-bar">
        <input type="text" class="form-vai-input" id="goal-vai-input"
          placeholder='e.g. "goal vacation 50000" or "save for new phone 25000"'
          oninput="onFormVAI('goal',this.value)"
          onkeydown="if(event.key==='Enter')applyFormVAI('goal')">
        <button class="form-vai-mic" id="goal-vai-mic" onclick="toggleFormVAIVoice('goal')" title="Voice input">🎤</button>
      </div>
      <div class="voice-status-bar" id="goal-vai-voice-status">
        <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
        <span>Listening… speak clearly</span>
        <button onclick="stopFormVAIVoice('goal')" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <div class="form-vai-result" id="goal-vai-result">
        <div class="form-vai-result-hdr">
          <div class="form-vai-result-lbl">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="form-vai-conf-badge" id="goal-vai-conf">--</span>
            <button class="form-vai-dismiss" onclick="dismissFormVAI('goal')">✕</button>
          </div>
        </div>
        <div class="form-vai-fields" id="goal-vai-fields"></div>
        <div class="form-vai-meter"><div class="form-vai-meter-fill" id="goal-vai-meter" style="width:0%"></div></div>
        <div class="form-vai-actions">
          <button class="form-vai-apply" onclick="applyFormVAI('goal')">✓ Apply to Form</button>
          <button class="form-vai-edit" onclick="document.getElementById('goal-vai-input').focus()">✏️ Edit</button>
        </div>
      </div>
      <div class="form-vai-hint" id="goal-vai-hint">🎯 Savings Goal — speak or type to pre-fill the form</div>
    </div>
    <div class="form-group">
      <label class="form-label">Goal Name *</label>
      <input type="text" class="form-input" id="goal-name" placeholder="e.g. Vacation, New Phone, Emergency Fund">
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <input type="hidden" id="goal-emoji" value="🎯">
      <div id="goal-icon-picker" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:10px">
      </div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px">Tap to select an icon for your goal</div>
    </div>
    <div class="form-group">
      <label class="form-label">Target Amount *</label>
      <input type="number" class="form-input" id="goal-target" placeholder="e.g. 50000" min="1" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Amount Already Saved</label>
      <input type="number" class="form-input" id="goal-saved" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Target Date</label>
      <input type="date" class="form-input" id="goal-date">
    </div>
    <div class="form-group">
      <label class="form-label">🏦 Linked Account <span style="font-size:10px;color:var(--text3);font-weight:400">(Where savings will be stored)</span></label>
      <select class="form-input" id="goal-linked-account">
        <option value="">— No linked account —</option>
      </select>
      <div style="font-size:11px;color:var(--text3);margin-top:5px">⚠️ If linked, the saved target amount in this account will be protected from expenses. You'll also get alerts when balance is near the goal target.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes (optional)</label>
      <input type="text" class="form-input" id="goal-notes" placeholder="What's this goal for?">
    </div>
    <button class="btn-primary" id="goal-save-btn" onclick="saveGoal()">Save Goal</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-goal')">Cancel</button>
    <button class="btn-primary btn-danger" id="goal-delete-btn" style="display:none;margin-top:8px" onclick="deleteGoal()">Delete Goal</button>
  </div>
</div>

<!-- ADD FUNDS TO GOAL MODAL -->
<div class="modal-overlay" id="modal-goal-funds">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">💰 Add Funds to Goal</div>
    <div id="goal-funds-info" style="background:var(--bg3);border-radius:12px;padding:12px 14px;margin-bottom:16px;font-size:13px;line-height:1.6;color:var(--text2)"></div>
    <!-- Fund type: income or transfer -->
    <div class="form-group">
      <label class="form-label">Funding Type *</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px" id="goal-fund-type-grid">
        <button type="button" class="type-tab active income" id="gft-income" onclick="setGoalFundType('income',this)">💰 Add Income</button>
        <button type="button" class="type-tab transfer" id="gft-transfer" onclick="setGoalFundType('transfer',this)">🔄 Transfer In</button>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px" id="goal-fund-type-hint">This will record a new income transaction to the goal account.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Amount to Save *</label>
      <input type="number" class="form-input" id="goal-funds-amount" placeholder="0.00" min="1" step="0.01">
    </div>
    <div class="form-group" id="goal-funds-from-group" style="display:none">
      <label class="form-label">Transfer From Account *</label>
      <select class="form-input" id="goal-funds-from-account"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Destination Account *</label>
      <select class="form-input" id="goal-funds-account"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input type="date" class="form-input" id="goal-funds-date">
    </div>
    <div id="goal-funds-balance-warn" class="balance-warning"></div>
    <button class="btn-primary btn-success" onclick="confirmAddFundsToGoal()">Preview & Confirm 💰</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-goal-funds')">Cancel</button>
  </div>
</div>

<!-- GOAL FUNDS CONFIRM MODAL -->
<div class="modal-overlay" id="modal-goal-funds-confirm">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">✅ Confirm Goal Funding</div>
    <div id="goal-funds-confirm-detail" style="margin-bottom:16px"></div>
    <button class="btn-primary btn-success" onclick="executeAddFundsToGoal()">✅ Confirm & Save</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-goal-funds-confirm')">Cancel</button>
  </div>
</div>

<!-- RECURRING MODAL -->
<div class="modal-overlay" id="modal-recur">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-recur-title">New Recurring Transaction</div>
    <!-- Form VAI Smart Input -->
    <div class="form-vai-wrap" id="recurring-vai-wrap">
      <div class="form-vai-header">🎙️ Smart Input <span class="form-vai-badge">AI</span></div>
      <div class="form-vai-bar">
        <input type="text" class="form-vai-input" id="recurring-vai-input"
          placeholder='e.g. "Netflix subscription 299 monthly" or "rent 8000 every 5th"'
          oninput="onFormVAI('recurring',this.value)"
          onkeydown="if(event.key==='Enter')applyFormVAI('recurring')">
        <button class="form-vai-mic" id="recurring-vai-mic" onclick="toggleFormVAIVoice('recurring')" title="Voice input">🎤</button>
      </div>
      <div class="voice-status-bar" id="recurring-vai-voice-status">
        <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
        <span>Listening… speak clearly</span>
        <button onclick="stopFormVAIVoice('recurring')" style="margin-left:auto;background:none;border:none;color:var(--rose);cursor:pointer;font-size:13px">✕</button>
      </div>
      <div class="form-vai-result" id="recurring-vai-result">
        <div class="form-vai-result-hdr">
          <div class="form-vai-result-lbl">✨ AI Detected</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="form-vai-conf-badge" id="recurring-vai-conf">--</span>
            <button class="form-vai-dismiss" onclick="dismissFormVAI('recurring')">✕</button>
          </div>
        </div>
        <div class="form-vai-fields" id="recurring-vai-fields"></div>
        <div class="form-vai-meter"><div class="form-vai-meter-fill" id="recurring-vai-meter" style="width:0%"></div></div>
        <div class="form-vai-actions">
          <button class="form-vai-apply" onclick="applyFormVAI('recurring')">✓ Apply to Form</button>
          <button class="form-vai-edit" onclick="document.getElementById('recurring-vai-input').focus()">✏️ Edit</button>
        </div>
      </div>
      <div class="form-vai-hint" id="recurring-vai-hint">🔄 Recurring Rule — speak or type to pre-fill the form</div>
    </div>
    <div class="type-tabs">
      <button class="type-tab active expense" onclick="setRecurType('expense',this)">💸 Expense</button>
      <button class="type-tab income" onclick="setRecurType('income',this)">💰 Income</button>
    </div>
    <div class="form-group">
      <label class="form-label">Name / Description *</label>
      <input type="text" class="form-input" id="recur-name" placeholder="e.g. Netflix, Salary, Rent">
    </div>
    <div class="form-group">
      <label class="form-label">Amount *</label>
      <input type="number" class="form-input" id="recur-amount" placeholder="0.00" min="0.01" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Category *</label>
      <select class="form-input" id="recur-category"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Account *</label>
      <select class="form-input" id="recur-account"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Frequency *</label>
      <select class="form-input" id="recur-freq" onchange="onRecurFreqChange()">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly" selected>Monthly</option>
        <option value="semimonthly">Semi-Monthly (twice a month)</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <!-- Semi-monthly date pickers -->
    <div class="form-group" id="recur-semimonthly-group" style="display:none">
      <label class="form-label">Semi-Monthly Dates <span style="font-size:10px;color:var(--text3);font-weight:400">(Day of month for each cutoff)</span></label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px;font-weight:600">1ST CUTOFF</div>
          <input type="number" class="form-input" id="recur-semi-day1" placeholder="e.g. 15" min="1" max="31" value="15">
        </div>
        <div>
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px;font-weight:600">2ND CUTOFF</div>
          <input type="number" class="form-input" id="recur-semi-day2" placeholder="e.g. 30" min="1" max="31" value="30">
        </div>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:6px;line-height:1.6">💡 If the date exceeds the month's last day (e.g. 31 in February), it auto-adjusts to the last day of that month.</div>
    </div>
    <div class="form-group">
      <label class="form-label">Start Date *</label>
      <input type="date" class="form-input" id="recur-start">
    </div>
    <div class="form-group" id="recur-due-day-group">
      <label class="form-label">Due Day of Month <span style="font-size:10px;color:var(--text3);font-weight:400">(Monthly only — leave blank to use start date day)</span></label>
      <input type="number" class="form-input" id="recur-due-day" placeholder="e.g. 25" min="1" max="31">
    </div>
    <div class="form-group">
      <label class="form-label">End Date (optional)</label>
      <input type="date" class="form-input" id="recur-end" placeholder="Leave blank for no end">
    </div>
    <button class="btn-primary" id="recur-save-btn" onclick="saveRecurring()">Save Rule</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-recur')">Cancel</button>
    <button class="btn-primary btn-danger" id="recur-delete-btn" style="display:none;margin-top:8px" onclick="deleteRecurring()">Delete Rule</button>
  </div>
</div>

<!-- PAYABLE REPAYMENT SCHEDULE MODAL -->
<div class="modal-overlay" id="modal-payable-schedule">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="payable-schedule-title">📅 Repayment Schedule</div>
    <div id="payable-schedule-summary"></div>
    <div id="payable-schedule-progress" style="margin-bottom:12px"></div>
    <div id="payable-schedule-table"></div>
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn-primary btn-success" id="payable-schedule-pay-btn" onclick="" style="flex:1">💰 Pay Now</button>
      <button class="btn-primary btn-secondary" style="flex:1" onclick="closeModal('modal-payable-schedule')">Close</button>
    </div>
    <button class="btn-primary btn-secondary" id="payable-schedule-edit-btn" style="margin-top:8px" onclick="">✏️ Edit Payable</button>
  </div>
</div>

<!-- RECURRING SCHEDULE MODAL -->
<div class="modal-overlay" id="modal-recur-schedule">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="recur-schedule-title">📅 Recurring Schedule</div>
    <div id="recur-schedule-summary"></div>
    <div id="recur-schedule-table"></div>
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn-primary btn-success" id="recur-schedule-apply-btn" onclick="" style="flex:1">💰 Pay Now</button>
      <button class="btn-primary btn-secondary" style="flex:1" onclick="closeModal('modal-recur-schedule')">Close</button>
    </div>
    <button class="btn-primary btn-secondary" id="recur-schedule-pause-btn" style="margin-top:8px" onclick="">⏸ Pause Rule</button>
    <button class="btn-primary btn-secondary" id="recur-schedule-edit-btn" style="margin-top:8px" onclick="">✏️ Edit Rule</button>
  </div>
</div>

<!-- RECURRING PAY NOW MODAL (Expense) -->
<div class="modal-overlay" id="modal-recur-pay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="recur-pay-title">💰 Pay Recurring</div>
    <div id="recur-pay-detail" style="margin-bottom:14px"></div>
    <!-- Occurrences to pay -->
    <div class="form-group">
      <label class="form-label">Occurrences to Pay</label>
      <div id="recur-pay-occurrences" style="display:flex;flex-direction:column;gap:6px;margin-bottom:4px"></div>
      <div id="recur-pay-selection-note" style="font-size:11px;color:var(--text3);background:var(--blue-bg);border-radius:8px;padding:8px 10px;margin-top:4px;display:none"></div>
    </div>
    <!-- Payment Amount -->
    <div class="form-group">
      <label class="form-label">Payment Amount *</label>
      <input type="number" class="form-input" id="recur-pay-amount" placeholder="0.00" min="0" step="0.01" oninput="checkRecurPayWarning()">
      <div id="recur-pay-balance-warning" class="balance-warning" style="margin-top:6px;display:none"></div>
    </div>
    <!-- Pay From Account -->
    <div class="form-group">
      <label class="form-label">Pay From Account *</label>
      <select class="form-input" id="recur-pay-account" onchange="checkRecurPayWarning()"></select>
    </div>
    <!-- Payment Date -->
    <div class="form-group">
      <label class="form-label">Payment Date</label>
      <input type="date" class="form-input" id="recur-pay-date">
    </div>
    <!-- Transaction Fee -->
    <div class="form-group">
      <label class="form-label">Transaction Fee <span style="font-size:10px;color:var(--text3);font-weight:400">(Optional — e.g. GCash, bank fee)</span></label>
      <input type="number" class="form-input" id="recur-pay-tx-fee" placeholder="0.00" min="0" step="0.01" oninput="checkRecurPayWarning()">
      <div style="font-size:11px;color:var(--text3);margin-top:4px">⚠️ Recorded as a separate expense transaction.</div>
    </div>
    <!-- Late Fee -->
    <div class="form-group">
      <label class="form-label">Late / Penalty Fee <span style="font-size:10px;color:var(--text3);font-weight:400">(Optional)</span></label>
      <input type="number" class="form-input" id="recur-pay-late-fee" placeholder="0.00" min="0" step="0.01" oninput="checkRecurPayWarning()">
      <div style="font-size:11px;color:var(--text3);margin-top:4px">⚠️ Recorded as a separate Fees expense.</div>
    </div>
    <!-- Reference / Notes -->
    <div class="form-group">
      <label class="form-label">Reference / Notes</label>
      <input type="text" class="form-input" id="recur-pay-ref" placeholder="Optional — e.g. GCash ref, receipt no.">
    </div>
    <button class="btn-primary btn-success" onclick="executeRecurPay()">✅ Record Payment</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-recur-pay')">Cancel</button>
  </div>
</div>

<!-- RECURRING RECEIVED MODAL (Income) -->
<div class="modal-overlay" id="modal-recur-receive">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="recur-receive-title">✅ Mark as Received</div>
    <div id="recur-receive-detail" style="margin-bottom:14px"></div>
    <!-- Which occurrence -->
    <div class="form-group">
      <label class="form-label">Which Occurrence?</label>
      <div id="recur-receive-occurrences" style="display:flex;flex-direction:column;gap:6px;margin-bottom:4px"></div>
    </div>
    <!-- Amount Received -->
    <div class="form-group">
      <label class="form-label">Amount Received *</label>
      <input type="number" class="form-input" id="recur-receive-amount" placeholder="0.00" min="0" step="0.01">
    </div>
    <!-- Receive Into Account -->
    <div class="form-group">
      <label class="form-label">Receive Into Account *</label>
      <select class="form-input" id="recur-receive-account"></select>
    </div>
    <!-- Date Received -->
    <div class="form-group">
      <label class="form-label">Date Received</label>
      <input type="date" class="form-input" id="recur-receive-date">
    </div>
    <!-- Notes -->
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="form-input" id="recur-receive-ref" placeholder="Optional — e.g. payroll ref, sender">
    </div>
    <button class="btn-primary btn-success" onclick="executeRecurReceive()">✅ Mark as Received</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-recur-receive')">Cancel</button>
  </div>
</div>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="modal-export">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Export Data 📤</div>
    <div class="form-group">
      <label class="form-label">Period</label>
      <select class="form-input" id="export-period">
        <option value="month">This Month</option>
        <option value="lastmonth">Last Month</option>
        <option value="year">This Year</option>
        <option value="all">All Time</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Filter by Type</label>
      <select class="form-input" id="export-type">
        <option value="all">All Transactions</option>
        <option value="expense">Expenses Only</option>
        <option value="income">Income Only</option>
      </select>
    </div>
    <div id="export-preview" style="background:var(--bg3);border-radius:12px;padding:12px 14px;font-size:12px;color:var(--text2);margin-bottom:8px;line-height:1.7"></div>
    <div class="export-row" onclick="doExport('csv')">
      <div class="export-icon-box" style="background:rgba(86,200,160,0.12)">📄</div>
      <div><div class="export-title">CSV File</div><div class="export-sub">Opens in Excel, Numbers, Google Sheets</div></div>
    </div>
    <div class="export-row" onclick="doExport('xlsx')">
      <div class="export-icon-box" style="background:rgba(124,131,253,0.12)">📊</div>
      <div><div class="export-title">Excel / XLSX</div><div class="export-sub">Formatted spreadsheet with auto-columns</div></div>
    </div>
    <div class="export-row" onclick="doExport('pdf')">
      <div class="export-icon-box" style="background:rgba(240,98,146,0.12)">📑</div>
      <div><div class="export-title">PDF Report</div><div class="export-sub">Beautiful report with totals & category summary</div></div>
    </div>
    <div style="border-top:1px solid var(--border);margin:12px 0;padding-top:12px">
      <div style="font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px">📦 Export All Records</div>
      <div class="export-row" style="padding:10px 0" onclick="doFullExport('xlsx')">
        <div class="export-icon-box" style="background:rgba(86,200,160,0.12);width:40px;height:40px;border-radius:10px;font-size:18px">📦</div>
        <div><div class="export-title">Full Data XLSX</div><div class="export-sub">Transactions, Accounts, Payables, Goals — all sheets</div></div>
      </div>
      <div class="export-row" style="padding:10px 0" onclick="doFullExport('csv')">
        <div class="export-icon-box" style="background:rgba(244,169,90,0.12);width:40px;height:40px;border-radius:10px;font-size:18px">🗂️</div>
        <div><div class="export-title">All Data CSV (ZIP)</div><div class="export-sub">Separate CSV files per data type</div></div>
      </div>
    </div>
    <button class="btn-primary btn-secondary" style="margin-top:12px" onclick="closeModal('modal-export')">Close</button>
  </div>
</div>

<!-- CATCH-UP / OVERDUE PAYMENT MODAL -->
<div class="modal-overlay" id="modal-catchup-payable">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" style="color:var(--rose)">🔴 Catch-up Payment</div>
    <div id="catchup-payable-detail" style="margin-bottom:12px"></div>
    <div id="catchup-overdue-info" style="background:var(--rose-bg);border:1px solid rgba(225,29,72,.3);border-radius:10px;padding:10px 13px;font-size:12px;color:var(--rose);margin-bottom:14px;line-height:1.7;word-break:break-word;overflow-wrap:break-word"></div>
    <div class="form-group">
      <label class="form-label">Catch-up Amount * <span style="font-size:10px;color:var(--text3);font-weight:400">(principal only)</span></label>
      <input type="number" class="form-input" id="catchup-amount" placeholder="0.00" min="0" step="0.01" oninput="updateCatchupPreview()">
    </div>
    <div class="form-group">
      <label class="form-label">Late Fee <span style="font-size:10px;color:var(--text3);font-weight:400">(added to total, default 0)</span></label>
      <input type="number" class="form-input" id="catchup-late-fee" placeholder="0.00" min="0" step="0.01" value="0" oninput="updateCatchupPreview()">
    </div>
    <div class="form-group">
      <label class="form-label">Pay From Account *</label>
      <select class="form-input" id="catchup-from-account"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Payment Date</label>
      <input type="date" class="form-input" id="catchup-date">
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="form-input" id="catchup-notes" placeholder="Optional">
    </div>
    <div id="catchup-preview" style="background:var(--emerald-bg);border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:10px 13px;font-size:12px;color:var(--emerald);margin-bottom:14px;display:none"></div>
    <button class="btn-primary btn-danger" onclick="executeCatchupPayment()">🔴 Record Catch-up Payment</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-catchup-payable')">Cancel</button>
  </div>
</div>

<!-- PATCH NOTES FULL-SCREEN MODAL -->
<div id="modal-patch-notes" style="
  display:none; position:fixed; inset:0; z-index:500;
  background:var(--bg); flex-direction:column; overflow:hidden;
  animation:fadeUp .22s cubic-bezier(0.4,0,0.2,1);
">
  <!-- Header -->
  <div style="
    display:flex; align-items:center; justify-content:space-between;
    padding:18px 18px 14px; border-bottom:1px solid var(--border);
    background:var(--bg); flex-shrink:0;
  ">
    <div>
      <div style="font-size:18px;font-weight:800;letter-spacing:-.4px">🆕 What's New</div>
      <div style="font-size:11px;color:var(--text3);margin-top:2px">FinFlow update notes</div>
    </div>
    <button onclick="closePatchNotes()" style="
      width:34px;height:34px;border-radius:10px;border:1px solid var(--border);
      background:var(--bg3);color:var(--text2);font-size:18px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    ">✕</button>
  </div>
  <!-- Scrollable content -->
  <div id="patch-notes-content" style="flex:1;overflow-y:auto;padding:16px 18px 40px;scrollbar-width:none"></div>
</div>

<!-- SAVINGS GUARD MODAL -->
<div class="modal-overlay" id="modal-savings-guard">
  <div class="modal" style="text-align:center">
    <div class="modal-handle"></div>
    <div style="font-size:40px;margin-bottom:8px">🛡️</div>
    <div class="modal-title" style="color:var(--planned)">Savings Reserve Alert</div>
    <div id="savings-guard-msg" style="font-size:13px;color:var(--text2);line-height:1.7;margin:12px 0 20px;padding:0 4px"></div>
    <button class="btn-primary btn-danger" id="savings-guard-proceed" onclick="executeSavingsGuardedTx()">Continue Anyway</button>
    <button class="btn-primary btn-secondary" style="margin-top:8px" onclick="closeModal('modal-savings-guard')">Cancel Transaction</button>
  </div>
</div>

<!-- CF DETAIL MODAL -->
<div class="modal-overlay" id="modal-cf-detail">
  <div class="modal" style="max-height:88vh">
    <div class="modal-handle"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
      <div class="modal-title" style="margin-bottom:0;text-align:left;font-size:16px">📋 Upcoming Cash Events</div>
    </div>
    <div id="cf-modal-period" style="font-size:11px;color:var(--text3);margin-bottom:16px;text-align:center"></div>
    <div id="cf-modal-events" style="overflow-y:auto;max-height:60vh;margin:0 -20px;padding:0 20px"></div>
    <button class="btn-primary btn-secondary" style="margin-top:14px" onclick="closeModal('modal-cf-detail')">Close</button>
  </div>
</div>

<!-- DAY DETAIL MODAL -->
<div class="modal-overlay" id="modal-day-detail">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="day-detail-modal-content"></div>
    <button class="btn-primary btn-secondary" style="margin-top:12px" onclick="closeModal('modal-day-detail')">Close</button>
  </div>
</div>

<!-- ONBOARDING POPUP -->
<div class="modal-overlay" id="modal-onboarding" style="align-items:center;padding:20px">
  <div class="modal" style="border-radius:24px;max-width:420px;width:100%;padding:28px 24px;text-align:center">
    <div style="font-size:48px;margin-bottom:12px">💸</div>
    <div style="font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px">Welcome to FinFlow!</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:22px;line-height:1.7">Your personal money tracker — all data stays on your device. Here are some quick tips to get started:</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;text-align:left">
      <div style="background:var(--bg3);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px">
        <span style="font-size:22px">➕</span>
        <div><div style="font-size:12px;font-weight:700">Add Transactions</div><div style="font-size:11px;color:var(--text3)">Tap the + button to log expenses, income, or transfers</div></div>
      </div>
      <div style="background:var(--bg3);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px">
        <span style="font-size:22px">🏦</span>
        <div><div style="font-size:12px;font-weight:700">Set Up Accounts</div><div style="font-size:11px;color:var(--text3)">Add your bank, e-wallet (GCash/Maya), or cash wallet first</div></div>
      </div>
      <div style="background:var(--bg3);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px">
        <span style="font-size:22px">💳</span>
        <div><div style="font-size:12px;font-weight:700">Track Payables</div><div style="font-size:11px;color:var(--text3)">Log loans & credit cards — get notified before due dates</div></div>
      </div>
      <div style="background:var(--bg3);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px">
        <span style="font-size:22px">📅</span>
        <div><div style="font-size:12px;font-weight:700">Plan Ahead</div><div style="font-size:11px;color:var(--text3)">Schedule future expenses & income in the Planned tab</div></div>
      </div>
    </div>
    <button class="btn-primary" onclick="closeOnboarding()" style="margin-top:0">Got it, let's go! 🚀</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">

<script>
// ══════════════════════════════════════════════
// HEROICONS INLINE SVG — outline style, 24px viewBox
// ══════════════════════════════════════════════
const ICONS = {
  home:         `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>`,
  home_solid:   `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z"/><path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z"/></svg>`,
  list:         `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/></svg>`,
  chart:        `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/></svg>`,
  menu:         `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>`,
  chevron_left: `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"/></svg>`,
  bell:         `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"/></svg>`,
  gear:         `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>`,
  arrow_up:     `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18"/></svg>`,
  arrow_down:   `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3"/></svg>`,
  inbox:        `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75H6.912a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H15M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859M12 3v8.25m0 0-3-3m3 3 3-3"/></svg>`,
  send:         `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/></svg>`,
  users:        `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/></svg>`,
  pie_chart:    `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z"/></svg>`,
  landmark:     `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z"/></svg>`,
  target:       `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke="currentColor"/><circle cx="12" cy="12" r="5" stroke="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>`,
  credit_card:  `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"/></svg>`,
  upload:       `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/></svg>`,
  x_mark:       `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>`,
  eye:          `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>`,
  plus:         `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>`,
  calendar:     `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>`,
  toggle_on:    `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="22" viewBox="0 0 36 22"><rect width="36" height="22" rx="11" fill="var(--blue)"/><circle cx="25" cy="11" r="8" fill="white"/></svg>`,
  toggle_off:   `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="22" viewBox="0 0 36 22"><rect width="36" height="22" rx="11" fill="var(--border2)"/><circle cx="11" cy="11" r="8" fill="white"/></svg>`,
};
function ico(name, extraStyle='') {
  const svg = ICONS[name];
  if(!svg) return `<span class="hico" style="${extraStyle}">?</span>`;
  return `<span class="hico" style="${extraStyle}">${svg}</span>`;
}

// ══════════════════════════════════════════════
// HOME WIDGET VISIBILITY SETTINGS
// Defaults: classic hides cashflow/report/cal/budget, old shows all
// ══════════════════════════════════════════════
const HOME_WIDGET_DEFAULTS = {
  showCashflow:   false,
  showMiniReport: false,
  showCalendar:   false,
  showBudgetPanel: false,
};
function getHomeWidgets() {
  const s = db.settings.homeWidgets || {};
  return { ...HOME_WIDGET_DEFAULTS, ...s };
}
function setHomeWidget(key, val) {
  if(!db.settings.homeWidgets) db.settings.homeWidgets = {};
  db.settings.homeWidgets[key] = val;
  saveDB();
  renderHome();
  _renderHomeWidgetToggles();
}
function _renderHomeWidgetToggles() {
  const w = getHomeWidgets();
  ['cashflow','miniReport','calendar','budgetPanel'].forEach(k => {
    const el = document.getElementById('hwt-'+k);
    if(!el) return;
    const key = 'show'+k.charAt(0).toUpperCase()+k.slice(1);
    el.innerHTML = w[key] ? ICONS.toggle_on : ICONS.toggle_off;
  });
}

// ── Theme-aware chart color helper ────────────────────────
function getThemeColors() {
  const s = getComputedStyle(document.documentElement);
  const g = p => s.getPropertyValue(p).trim();
  return {
    text3:   g('--text3')   || '#5a6282',
    text2:   g('--text2')   || '#7B85A4',
    border:  g('--border')  || 'rgba(46,53,85,0.5)',
    blue:    g('--blue')    || '#4D8EFF',
    emerald: g('--emerald') || '#00D4A0',
    rose:    g('--rose')    || '#FF4D6A',
    amber:   g('--amber')   || '#FFB84D',
    violet:  g('--violet')  || '#A78BFF',
    bg3:     g('--bg3')     || '#171C2C',
    card:    g('--card')    || '#1B2032',
  };
}

// ===== DATA =====
const DB_KEY='finflow_v3';
let db={accounts:[],transactions:[],planned:[],logs:[],settings:{currency:'₱|PHP'},payables:[],qrCodes:[],qrContacts:[],budgets:[],goals:[],recurring:[],aiPatterns:{}};

// Default privacy settings — all off (amounts visible)
const PRIV_DEFAULTS={homeTotal:false,homeSummary:false,chips:false,cards:false,accounts:false,transactions:false};
let priv={...PRIV_DEFAULTS}; // runtime privacy state
let currentTxType='expense', currentPlannedType='expense';
let editingTxId=null, editingAccId=null, editingPlannedId=null, confirmingPlannedId=null;
let selectedAccColor='#7c83fd';
let currentPeriod='daily', currentTxPeriod='daily', currentReportPeriod='monthly', currentPlannedTab='calendar';
let currentReportsTab='overview', currentGoalsTab='active', currentRecurType='expense';
let calYear, calMonth, calSelectedDate=null;
let trendChart=null, barChart=null, pieChart=null;
let receiptData=null;
// Swiper state
let swiperIdx=0, swiperStartX=0, swiperDragging=false;
// Voice state
let voiceRecognition=null, voiceListening=false;
// Budget / Goals / Recurring state
let editingBudgetId=null, editingGoalId=null, addingFundsGoalId=null, editingRecurId=null;
let pendingSavingsTx=null; // staged tx awaiting savings guard confirmation
// Smart alerts dismissed set
let dismissedAlerts=new Set();
try{const da=localStorage.getItem('finflow_dismissed_alerts');if(da)dismissedAlerts=new Set(JSON.parse(da));}catch(e){}

const EXPENSE_CATS=['🍔 Food','🚌 Transport','🏠 Rent/Utilities','💊 Health','👕 Shopping','🎮 Entertainment','📚 Education','💼 Work','💇 Personal Care','🎁 Gifts','💰 Bills','🐾 Pets','✈️ Travel','🔧 Repairs','📱 Subscriptions','🏦 Bank Fee','📦 Others'];
const INCOME_CATS=['💼 Salary','💸 Freelance / Side Hustle','🎁 Gift / Allowance','📈 Investment Returns','🏪 Business Revenue','🔄 Refund / Reimbursement','🏠 Rental Income','💹 Stock / Crypto Gains','🏆 Bonus / Commission','🎓 Scholarship / Grant','🤝 Government Benefit','💳 Cashback / Rewards','🏦 Interest Earned','📦 Sold Items','🎵 Royalties / Passive','💰 Other Income'];
const TRANSFER_CATS=['🔄 Transfer'];
const ACC_ICONS={bank:'🏦',ewallet:'📱',cash:'💵'};
const COLOR_PALETTE=['#3B82F6','#10B981','#F59E0B','#E11D48','#14B8A6','#8B5CF6','#06B6D4','#84CC16','#F97316','#6366F1','#EC4899','#A855F7','#22C55E','#0EA5E9','#D946EF','#FB923C','#FBBF24','#34D399'];

// Card gradient themes keyed by color
function getCardGradient(color) {
  const map={
    '#7c83fd':'135deg,#2d2f6b,#1a1f45',
    '#56c8a0':'135deg,#1a4034,#0d2820',
    '#f4a95a':'135deg,#4a2f0d,#2d1c08',
    '#f06292':'135deg,#4a1528,#2d0c18',
    '#4fc3f7':'135deg,#0d3548,#061e2d',
    '#aed581':'135deg,#2a3d12,#17230a',
    '#ce93d8':'135deg,#3d1a48,#220d2b',
    '#80cbc4':'135deg,#0d3840,#061f24',
    '#ffb74d':'135deg,#472600,#291500',
    '#ef9a9a':'135deg,#4a1515,#2d0b0b',
    '#90caf9':'135deg,#0d2a4a,#06172d',
    '#a5d6a7':'135deg,#1a3d1c,#0d2210',
    '#fff176':'135deg,#3d3800,#221f00',
    '#ffcc02':'135deg,#3d3000,#221a00',
    '#ff7043':'135deg,#4a1a0d,#2d0e08',
    '#26c6da':'135deg,#0d3840,#061f24',
    '#ab47bc':'135deg,#2d0f38,#18081f',
    '#66bb6a':'135deg,#1a3d1c,#0d2210'
  };
  return map[color]||'135deg,#1a2040,#0f1930';
}

function loadDB(){
  try{const d=localStorage.getItem(DB_KEY);if(d){const p=JSON.parse(d);db={...db,...p};if(!db.planned)db.planned=[];if(!db.logs)db.logs=[];if(!db.settings)db.settings={currency:'₱|PHP'};if(!db.payables)db.payables=[];if(!db.qrCodes)db.qrCodes=[];if(!db.qrContacts)db.qrContacts=[];if(!db.budgets)db.budgets=[];if(!db.goals)db.goals=[];if(!db.recurring)db.recurring=[];if(!db.aiPatterns)db.aiPatterns={};}
  // Migrate from v2 key
  const old=localStorage.getItem('finflow_v2');
  if(old&&!db.accounts.length){try{const o=JSON.parse(old);db={...db,accounts:o.accounts||[],transactions:o.transactions||[],planned:o.planned||[],logs:o.logs||[],settings:o.settings||db.settings};}catch(e){}}
  }catch(e){}
  // Load privacy settings
  try{const ps=localStorage.getItem('finflow_priv');if(ps)priv={...PRIV_DEFAULTS,...JSON.parse(ps)};}catch(e){}
}
function saveDB(){
  try{localStorage.setItem(DB_KEY,JSON.stringify(db));}
  catch(e){showToast('⚠️ Storage full! Try deleting large receipts.','error');}
}
function savePrivacySettings(){
  priv.homeTotal=document.getElementById('priv-home-total').checked;
  priv.homeSummary=document.getElementById('priv-home-summary').checked;
  priv.chips=document.getElementById('priv-chips').checked;
  priv.cards=document.getElementById('priv-cards').checked;
  priv.accounts=document.getElementById('priv-accounts').checked;
  priv.transactions=document.getElementById('priv-transactions').checked;
  localStorage.setItem('finflow_priv',JSON.stringify(priv));
  // Re-render affected screens
  renderHome();
  const accScreen=document.getElementById('screen-accounts');
  if(accScreen.classList.contains('active'))renderAccountsScreen();
  const txScreen=document.getElementById('screen-transactions');
  if(txScreen.classList.contains('active'))renderTransactions();
}
function loadPrivacyToggles(){
  document.getElementById('priv-home-total').checked=priv.homeTotal;
  document.getElementById('priv-home-summary').checked=priv.homeSummary;
  document.getElementById('priv-chips').checked=priv.chips;
  document.getElementById('priv-cards').checked=priv.cards;
  document.getElementById('priv-accounts').checked=priv.accounts;
  document.getElementById('priv-transactions').checked=priv.transactions;
}
// Quick global toggle (eye button on home) — flips ALL sections at once
function toggleGlobalPrivacy(){
  const allHidden=priv.homeTotal&&priv.homeSummary&&priv.chips&&priv.cards&&priv.accounts&&priv.transactions;
  const val=!allHidden;
  priv={homeTotal:val,homeSummary:val,chips:val,cards:val,accounts:val,transactions:val};
  localStorage.setItem('finflow_priv',JSON.stringify(priv));
  loadPrivacyToggles();
  updateEyeBtn();
  renderHome();
  const accScreen=document.getElementById('screen-accounts');
  if(accScreen.classList.contains('active'))renderAccountsScreen();
  const txScreen=document.getElementById('screen-transactions');
  if(txScreen.classList.contains('active'))renderTransactions();
  showToast(val?'Amounts hidden 🙈':'Amounts visible 👁️','success');
}
// mask() — returns **** if hidden, otherwise formatted amount
function mask(n,isHidden){
  if(isHidden)return'••••';
  return fmt(n);
}
// maskAmt() — returns styled span
function maskSpan(n,isHidden,extraStyle=''){
  if(isHidden)return`<span class="hidden-amount" style="${extraStyle}">••••</span>`;
  return`<span style="${extraStyle}">${fmt(n)}</span>`;
}
function getCurrency(){return(db.settings.currency||'₱|PHP').split('|')[0];}
function fmt(n){const s=getCurrency();return s+Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function today(){return new Date().toISOString().split('T')[0];}
// localDate: convert a Date to YYYY-MM-DD using LOCAL timezone (avoids UTC shift for UTC+8 etc.)
function localDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function localMonthEnd(year,month){return localDate(new Date(year,month+1,0));} // last day of given month
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}
function fmtDate(d){return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function fmtShort(d){return new Date(d+'T00:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});}

// ===== PERIOD =====
function getDateRange(period){
  const d=new Date();let start,end;
  if(period==='daily'){start=end=d.toISOString().split('T')[0];}
  else if(period==='weekly'){const day=d.getDay();const s=new Date(d);s.setDate(d.getDate()-day);const e=new Date(s);e.setDate(s.getDate()+6);start=s.toISOString().split('T')[0];end=e.toISOString().split('T')[0];}
  else if(period==='monthly'){const y=d.getFullYear(),m=d.getMonth();start=new Date(y,m,1).toISOString().split('T')[0];end=localMonthEnd(y,m);}
  else{const y=d.getFullYear();start=`${y}-01-01`;end=`${y}-12-31`;}
  return{start,end};
}
function filterByPeriod(arr,period){const{start,end}=getDateRange(period);return arr.filter(t=>t.date>=start&&t.date<=end);}

// ===== NAVIGATION =====
let currentAccountsTab='accounts';
let currentPayablesTab='active';
let editingPayableId=null, payingPayableId=null, schedulingPayableId=null;
let payingRecurId=null; // for the recurring pay/receive modal
let editingQRId=null, qrUploadData=null, qrFSData=null;
let editingQRContactId=null, qrcUploadData=null, qrcProfileData=null;
let currentQRSubTab='received'; // 'received' | 'contacts'

function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  // close sheets/drawers if open
  const as=document.getElementById('alerts-sheet');if(as)as.classList.remove('open');
  const md=document.getElementById('more-drawer');if(md)md.classList.remove('open');
  const mdo=document.getElementById('more-drawer-overlay');if(mdo)mdo.classList.remove('open');
  document.getElementById('screen-'+name).classList.add('active');
  const nav=document.getElementById('nav-'+name);if(nav)nav.classList.add('active');
  if(name==='home')renderHome();
  else if(name==='transactions')renderTransactions();
  else if(name==='accounts')renderAccountsScreen();
  else if(name==='planned')renderPlanned();
  else if(name==='goals')renderGoalsScreen();
  else if(name==='reports'){renderReports();showReportsTab(currentReportsTab,document.querySelector('#screen-reports .screen-tab'));}
  else if(name==='payables'){renderPayables();updatePayablesBadge();}
  else if(name==='budget'){maybeAutoGenerateBudgetForCurrentMonth();renderBudgetScreen();if(budgetMainTab==='default')renderDefaultBudget();}
  else if(name==='settings'){loadPrivacyToggles();updateThemeUI();checkPatchBadge();updateMicToggleUI();_initSettingsAppStyle();}
  if(typeof _vaiOnScreenChange==='function') _vaiOnScreenChange(name);
  // Re-render Lucide icons after screen change
  setTimeout(()=>{ if(typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
}
function showReportsTab(tab,btn){
  currentReportsTab=tab;
  document.querySelectorAll('#screen-reports .screen-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('reports-overview-panel').style.display=tab==='overview'?'':'none';
  document.getElementById('reports-income-panel').style.display=tab==='income'?'':'none';
  document.getElementById('reports-budget-panel').style.display=tab==='budget'?'':'none';
  const bpw=document.getElementById('budget-period-tabs-wrap');
  if(bpw)bpw.style.display=tab==='budget'?'':'none';
  const ipw=document.getElementById('income-period-tabs-wrap');
  if(ipw)ipw.style.display=tab==='income'?'':'none';
  if(tab==='budget')renderBudgetReport();
  if(tab==='income')renderIncomeReport();
}
function showAccountsTab(tab,btn){
  currentAccountsTab=tab;
  document.querySelectorAll('#screen-accounts .screen-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderAccountsScreen();
}
function showPayablesTab(tab,btn){
  currentPayablesTab=tab;
  document.querySelectorAll('#screen-payables .screen-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderPayables();
}

// ===== TOAST =====
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast show '+type;
  // longer messages stay a bit longer
  const dur=msg.length>60?4500:3000;
  clearTimeout(t._toastTimer);
  t._toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ===== MODALS =====
function closeModal(id){document.getElementById(id).classList.remove('open');}
function openModal(id){document.getElementById(id).classList.add('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{
  // Don't close mic permission modal on backdrop click — user must make explicit choice
  if(m.id==='modal-mic-permission')return;
  if(e.target===m)m.classList.remove('open');
}));
// Escape key closes topmost open modal (except mic permission — requires explicit choice)
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    const open=[...document.querySelectorAll('.modal-overlay.open')].filter(m=>m.id!=='modal-mic-permission');
    if(open.length){ open[open.length-1].classList.remove('open'); e.preventDefault(); }
  }
});

function triggerCamera(){document.getElementById('camera-input').click();}
function handleReceipt(e){
  const file=e.target.files[0];
  if(!file)return;
  if(file.size>5*1024*1024){showToast('❌ File too large! Max 5MB.','error');e.target.value='';return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    receiptData=ev.target.result;
    document.getElementById('receipt-zone').style.display='';
    document.getElementById('receipt-zone').classList.add('has-file');
    const img=document.getElementById('rz-preview');
    if(file.type.startsWith('image/')){img.src=receiptData;img.style.display='block';}
    else img.style.display='none';
    document.getElementById('rz-fname').textContent='📄 '+file.name+' ('+formatFileSize(file.size)+')';
    document.getElementById('rz-remove-btn').style.display='block';
  };
  reader.readAsDataURL(file);
}
async function handleReceiptWithOCR(e){
  const file=e.target.files[0];
  if(!file)return;
  if(file.size>5*1024*1024){showToast('❌ File too large! Max 5MB.','error');e.target.value='';return;}
  const reader=new FileReader();
  reader.onload=async ev=>{
    receiptData=ev.target.result;
    document.getElementById('receipt-zone').style.display='';
    document.getElementById('receipt-zone').classList.add('has-file');
    const img=document.getElementById('rz-preview');
    img.src=receiptData;img.style.display='block';
    document.getElementById('rz-fname').textContent='📷 '+file.name+' ('+formatFileSize(file.size)+')';
    document.getElementById('rz-remove-btn').style.display='block';
    // OCR via Anthropic API
    document.getElementById('ocr-loading').style.display='block';
    document.getElementById('ocr-result-banner').style.display='none';
    try{
      const base64=receiptData.split(',')[1];
      const mediaType=file.type||'image/jpeg';
      const resp=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',
          max_tokens:300,
          messages:[{role:'user',content:[
            {type:'image',source:{type:'base64',media_type:mediaType,data:base64}},
            {type:'text',text:'Extract from this receipt: total amount (number only), date (YYYY-MM-DD), store/vendor name, and best expense category from this list: Food, Transport, Shopping, Health, Entertainment, Education, Bills, Personal Care, Others. Respond ONLY with JSON: {"amount":0,"date":"","store":"","category":""}'}
          ]}]
        })
      });
      document.getElementById('ocr-loading').style.display='none';
      if(resp.ok){
        const data=await resp.json();
        const text=data.content.map(i=>i.text||'').join('');
        const clean=text.replace(/```json|```/g,'').trim();
        const parsed=JSON.parse(clean);
        let filled=[];
        if(parsed.amount>0){document.getElementById('tx-amount').value=parsed.amount;filled.push('Amount: '+fmt(parsed.amount));}
        if(parsed.date&&parsed.date.match(/^\d{4}-\d{2}-\d{2}$/)){document.getElementById('tx-date').value=parsed.date;filled.push('Date: '+fmtDate(parsed.date));}
        if(parsed.store){document.getElementById('tx-desc').value=parsed.store;filled.push('Store: '+parsed.store);}
        if(parsed.category){
          const cats=document.getElementById('tx-category');
          for(let opt of cats.options){if(opt.value.toLowerCase().includes(parsed.category.toLowerCase())){cats.value=opt.value;filled.push('Category: '+opt.value);break;}}
        }
        if(filled.length){
          document.getElementById('ocr-result-banner').style.display='block';
          document.getElementById('ocr-result-banner').textContent='✅ Auto-filled: '+filled.join(' • ');
          checkBalanceWarning();
        }else{document.getElementById('ocr-result-banner').style.display='block';document.getElementById('ocr-result-banner').textContent='📷 Receipt captured! Please fill in the details manually.';}
      }else{document.getElementById('ocr-loading').style.display='none';showToast('Could not read receipt. Please fill manually.','warn');}
    }catch(err){document.getElementById('ocr-loading').style.display='none';console.error('OCR error:',err);showToast('Receipt captured! Fill details manually.','warn');}
  };
  reader.readAsDataURL(file);
}
function removeReceipt(){
  receiptData=null;
  document.getElementById('receipt-input').value='';
  const ci=document.getElementById('camera-input');if(ci)ci.value='';
  const zone=document.getElementById('receipt-zone');
  zone.style.display='none';zone.classList.remove('has-file');
  document.getElementById('rz-preview').style.display='none';
  document.getElementById('rz-preview').src='';
  document.getElementById('rz-fname').textContent='';
  document.getElementById('rz-remove-btn').style.display='none';
  document.getElementById('ocr-result-banner').style.display='none';
  document.getElementById('ocr-loading').style.display='none';
}
function resetReceipt(){
  receiptData=null;
  const inp=document.getElementById('receipt-input');if(inp)inp.value='';
  const ci=document.getElementById('camera-input');if(ci)ci.value='';
  const zone=document.getElementById('receipt-zone');if(zone){zone.style.display='none';zone.classList.remove('has-file');}
  const img=document.getElementById('rz-preview');if(img){img.style.display='none';img.src='';}
  const fname=document.getElementById('rz-fname');if(fname)fname.textContent='';
  const rb=document.getElementById('rz-remove-btn');if(rb)rb.style.display='none';
  const ob=document.getElementById('ocr-result-banner');if(ob)ob.style.display='none';
  const ol=document.getElementById('ocr-loading');if(ol)ol.style.display='none';
}
function formatFileSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}

// ===== BALANCE WARNING =====
function checkBalanceWarning(){
  const w=document.getElementById('balance-warning'),wa=document.getElementById('warning-available');
  if(currentTxType!=='expense'&&currentTxType!=='transfer'){w.style.display='none';return;}
  const amt=parseFloat(document.getElementById('tx-amount').value)||0;
  if(!amt){w.style.display='none';return;}
  const accId=currentTxType==='transfer'?document.getElementById('tx-from-account').value:document.getElementById('tx-account').value;
  if(!accId){w.style.display='none';return;}
  const acc=db.accounts.find(a=>a.id===accId);if(!acc){w.style.display='none';return;}
  let avail=acc.balance;
  if(editingTxId){const old=db.transactions.find(t=>t.id===editingTxId);if(old&&(old.type==='expense'||(old.type==='transfer'&&old.accountId===accId)))avail+=old.amount;}
  const goalProtected=getGoalProtectedAmount(accId);
  const spendable=avail-goalProtected;
  if(amt>avail){w.style.display='block';wa.textContent=fmt(avail);}
  else if(goalProtected>0&&amt>spendable&&!editingTxId){
    w.style.display='block';
    wa.textContent=`${fmt(spendable)} (${fmt(goalProtected)} protected for goals)`;
  }
  else{w.style.display='none';}
}

// ===== ADD TRANSACTION =====
function openAddTransaction(){
  editingTxId=null;resetReceipt();
  document.getElementById('modal-tx-title').textContent='Add Transaction';
  document.getElementById('tx-amount').value='';
  document.getElementById('tx-ref').value='';
  document.getElementById('tx-desc').value='';
  document.getElementById('tx-date').value=today();
  document.getElementById('tx-delete-btn').style.display='none';
  document.getElementById('tx-save-btn').textContent='Save Transaction';
  document.getElementById('balance-warning').style.display='none';
  setTxType('expense',document.querySelector('#modal-tx .type-tab.expense'));
  fillAccDropdowns();openModal('modal-tx');
  // Reset & focus smart AI input
  setTimeout(()=>{resetSmartInput();const f=document.getElementById('smart-input-field');if(f)f.focus();},200);
}
function setTxType(type,btn){
  currentTxType=type;
  document.querySelectorAll('#modal-tx .type-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const cats=type==='expense'?EXPENSE_CATS:type==='income'?INCOME_CATS:TRANSFER_CATS;
  document.getElementById('tx-category').innerHTML=cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  const ag=document.getElementById('tx-account-group'),fg=document.getElementById('tx-from-group'),tg=document.getElementById('tx-to-group');
  if(type==='transfer'){ag.style.display='none';fg.style.display='';tg.style.display='';}
  else{ag.style.display='';fg.style.display='none';tg.style.display='none';}
  document.getElementById('balance-warning').style.display='none';
  fillAccDropdowns();
}
function fillAccDropdowns(){
  const opts=db.accounts.map(a=>`<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('')||'<option value="">No accounts yet</option>';
  ['tx-account','tx-from-account','tx-to','pl-account','pl-from-account','pl-to'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=opts;});
}
function saveTx(){
  const amount=parseFloat(document.getElementById('tx-amount').value);
  const category=document.getElementById('tx-category').value;
  const date=document.getElementById('tx-date').value;
  const ref=document.getElementById('tx-ref').value.trim();
  const desc=document.getElementById('tx-desc').value.trim();
  if(!amount||amount<=0){showToast('Please enter a valid amount','error');return;}
  if(!date){showToast('Please select a date','error');return;}
  if(!db.accounts.length){showToast('Please add an account first','error');return;}
  let accountId,toAccountId;
  if(currentTxType==='transfer'){
    accountId=document.getElementById('tx-from-account').value;
    toAccountId=document.getElementById('tx-to').value;
    if(accountId===toAccountId){showToast('Cannot transfer to same account','error');return;}
  }else{accountId=document.getElementById('tx-account').value;}
  // Balance validation
  if(currentTxType==='expense'||currentTxType==='transfer'){
    const acc=db.accounts.find(a=>a.id===accountId);
    if(acc){
      let avail=acc.balance;
      if(editingTxId){const old=db.transactions.find(t=>t.id===editingTxId);if(old&&(old.type==='expense'||(old.type==='transfer'&&old.accountId===accountId)))avail+=old.amount;}
      if(amount>avail){showToast(`❌ Insufficient balance! ${acc.name} only has ${fmt(avail)}`,'error');return;}
      // Savings reserve guard
      const reserve=acc.savingsReserve||0;
      if(reserve>0&&(avail-amount)<reserve&&!editingTxId){
        // Stage the transaction data and show the confirmation modal
        pendingSavingsTx={amount,category:document.getElementById('tx-category').value,date:document.getElementById('tx-date').value,ref:document.getElementById('tx-ref').value.trim(),desc:document.getElementById('tx-desc').value.trim(),accountId,toAccountId,type:currentTxType};
        const shortfall=reserve-(avail-amount);
        document.getElementById('savings-guard-msg').innerHTML=`<div style="background:rgba(244,169,90,0.12);border:1px solid var(--planned);border-radius:12px;padding:14px;margin-bottom:12px">
          <div style="font-size:24px;margin-bottom:6px">⚠️</div>
          <div style="font-size:13px;font-weight:700;color:var(--planned);margin-bottom:4px">This touches your savings reserve!</div>
          <div style="font-size:12px;color:var(--text2)"><b>${acc.name}</b> has a savings reserve of <b>${fmt(reserve)}</b>.</div>
          <div style="font-size:12px;color:var(--text2);margin-top:4px">After this <b>${fmt(amount)}</b> transaction, your balance will be <b style="color:var(--danger)">${fmt(avail-amount)}</b> — <b>${fmt(shortfall)}</b> below your reserve.</div>
        </div>
        <div style="font-size:12px;color:var(--text3)">Do you want to proceed and dip into your savings reserve?</div>`;
        openModal('modal-savings-guard');
        return;
      }
      // Goal protection guard
      if(reserve<=0||((avail-amount)>=reserve)){
        const goalProtection=getGoalProtectedAmount(accountId);
        if(goalProtection>0&&(avail-amount)<goalProtection&&!editingTxId){
          const linkedGoals=db.goals.filter(g=>g.linkedAccountId===accountId&&g.status!=='achieved');
          const goalNames=linkedGoals.map(g=>g.name).join(', ');
          showToast(`🎯 Blocked! ${fmt(goalProtection)} is protected for goals: ${goalNames}`,'error');
          return;
        }
      }
    }
  }
  if(editingTxId){
    const old=db.transactions.find(t=>t.id===editingTxId);
    if(old){addLog('edited',`Edited ${old.type}: ${old.category} ${fmt(old.amount)} → ${fmt(amount)}`,editingTxId);reverseTransaction(old);}
    db.transactions=db.transactions.filter(t=>t.id!==editingTxId);
  }
  const tx={id:editingTxId||uid(),type:currentTxType,amount,category,accountId,toAccountId,date,ref,desc,receipt:receiptData,createdAt:Date.now()};
  db.transactions.unshift(tx);applyTransaction(tx);
  if(!editingTxId)addLog('created',`New ${tx.type}: ${tx.category} ${fmt(amount)} on ${date}`,tx.id);
  saveDB();closeModal('modal-tx');
  showToast(editingTxId?'Transaction updated! ✅':'Transaction saved! ✅');
  editingTxId=null;renderHome();renderTransactions();
  // Budget check after saving expense
  if(currentTxType==='expense'||tx.type==='expense')setTimeout(()=>checkBudgetAfterTx(tx),400);
}
function getGoalProtectedAmount(accountId){
  // Sum of saved amounts for active goals linked to this account
  return db.goals.filter(g=>g.linkedAccountId===accountId&&g.status!=='achieved'&&(g.saved||0)>0).reduce((s,g)=>s+(g.saved||0),0);
}

function applyTransaction(tx){
  const acc=db.accounts.find(a=>a.id===tx.accountId);
  if(tx.type==='expense'&&acc)acc.balance-=tx.amount;
  else if(tx.type==='income'&&acc)acc.balance+=tx.amount;
  else if(tx.type==='transfer'){if(acc)acc.balance-=tx.amount;const ta=db.accounts.find(a=>a.id===tx.toAccountId);if(ta)ta.balance+=tx.amount;}
}
function reverseTransaction(tx){
  const acc=db.accounts.find(a=>a.id===tx.accountId);
  if(tx.type==='expense'&&acc)acc.balance+=tx.amount;
  else if(tx.type==='income'&&acc)acc.balance-=tx.amount;
  else if(tx.type==='transfer'){if(acc)acc.balance+=tx.amount;const ta=db.accounts.find(a=>a.id===tx.toAccountId);if(ta)ta.balance-=tx.amount;}
}
function openEditTx(id){
  const tx=db.transactions.find(t=>t.id===id);if(!tx)return;
  resetSmartInput();
  editingTxId=id;receiptData=tx.receipt||null;
  document.getElementById('modal-tx-title').textContent='Edit Transaction';
  document.getElementById('tx-delete-btn').style.display='';
  document.getElementById('tx-save-btn').textContent='Update Transaction';
  const typeBtn=document.querySelector(`#modal-tx .type-tab.${tx.type}`);
  setTxType(tx.type,typeBtn);
  document.getElementById('tx-amount').value=tx.amount;
  document.getElementById('tx-date').value=tx.date;
  document.getElementById('tx-ref').value=tx.ref||'';
  document.getElementById('tx-desc').value=tx.desc||'';
  const cats=tx.type==='expense'?EXPENSE_CATS:tx.type==='income'?INCOME_CATS:TRANSFER_CATS;
  document.getElementById('tx-category').innerHTML=cats.map(c=>`<option value="${c}"${c===tx.category?' selected':''}>${c}</option>`).join('');
  if(tx.type==='transfer'){document.getElementById('tx-from-account').value=tx.accountId;document.getElementById('tx-to').value=tx.toAccountId;}
  else document.getElementById('tx-account').value=tx.accountId;
  // Receipt
  resetReceipt();
  if(tx.receipt){
    receiptData=tx.receipt;
    document.getElementById('receipt-zone').style.display='';
    document.getElementById('receipt-zone').classList.add('has-file');
    document.getElementById('rz-remove-btn').style.display='block';
    if(tx.receipt.startsWith('data:image/')){const p=document.getElementById('rz-preview');p.src=tx.receipt;p.style.display='block';}
    document.getElementById('rz-fname').textContent='📎 Attachment saved';
  }
  checkBalanceWarning();
  closeModal('modal-view-tx');openModal('modal-tx');
}
function deleteTx(){
  showConfirm('Delete Transaction?','This cannot be undone.',()=>{
    const tx=db.transactions.find(t=>t.id===editingTxId);
    if(tx){reverseTransaction(tx);addLog('deleted',`Deleted ${tx.type}: ${tx.category} ${fmt(tx.amount)}`,editingTxId);}
    db.transactions=db.transactions.filter(t=>t.id!==editingTxId);
    saveDB();closeModal('modal-tx');showToast('Transaction deleted','error');
    editingTxId=null;renderHome();renderTransactions();
  });
}
function viewTx(id){
  const tx=db.transactions.find(t=>t.id===id);if(!tx)return;
  const acc=db.accounts.find(a=>a.id===tx.accountId);
  const toAcc=tx.toAccountId?db.accounts.find(a=>a.id===tx.toAccountId):null;
  const tc=tx.type==='expense'?'var(--expense)':tx.type==='income'?'var(--income)':'var(--transfer)';
  const sign=tx.type==='expense'?'-':tx.type==='income'?'+':'⇄';
  const amtDisplay=priv.transactions?`<span class="hidden-amount" style="font-size:26px;font-weight:700">••••</span>`:`<span style="font-family:'Space Mono',monospace;font-size:26px;font-weight:700;color:${tc}">${sign} ${fmt(tx.amount)}</span>`;
  let receiptHtml='';
  if(tx.receipt){
    if(tx.receipt.startsWith('data:image/'))receiptHtml=`<div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:6px">RECEIPT</div><img src="${tx.receipt}" style="width:100%;border-radius:8px;max-height:220px;object-fit:cover"></div>`;
    else receiptHtml=`<div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">ATTACHMENT</div><div style="font-size:13px;color:var(--accent)">📎 File attached</div></div>`;
  }

  // Payable multi-month badge
  let payableHtml='';
  if(tx.payableId){
    const py=db.payables.find(p=>p.id===tx.payableId);
    if(py){
      // Find the payment record for this transaction
      const payRec=(py.payments||[]).find(p=>p.id&&tx.desc&&tx.desc.includes(py.name)&&p.date===tx.date)||
                   (py.payments||[]).slice().reverse().find(p=>p.date===tx.date);
      const months=payRec?payRec.months||1:
        (tx.desc&&tx.desc.match(/\((\d+) months?\)/)?parseInt(tx.desc.match(/\((\d+) months?\)/)[1]):1);
      const ordinal=n=>n===1?'st':n===2?'nd':n===3?'rd':'th';
      const remainAfter=fmt(py.remaining||0);
      payableHtml=`<div class="card-sm" style="background:var(--violet-bg);border-color:rgba(20,184,166,.25)">
        <div style="font-size:10px;color:var(--text3);margin-bottom:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">💳 Payable Payment</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <div style="font-size:13px;font-weight:700">${py.name}</div>
          ${months>1?`<span style="font-size:10px;font-weight:700;background:var(--amber-bg);color:var(--amber);border-radius:6px;padding:2px 8px">${months} Months Advance</span>`:'<span style="font-size:10px;font-weight:700;background:var(--emerald-bg);color:var(--emerald);border-radius:6px;padding:2px 8px">1 Month</span>'}
        </div>
        ${months>1?`<div style="font-size:11px;color:var(--text2);margin-bottom:2px">⏩ Advance payment covering <strong>${months} billing cycle${months>1?'s':''}</strong></div>`:''}
        <div style="font-size:11px;color:var(--text3)">Remaining balance after payment: <strong style="color:${py.remaining>0?'var(--expense)':'var(--emerald)'}">${remainAfter}</strong></div>
        ${py.remaining<=0?`<div style="font-size:11px;font-weight:700;color:var(--emerald);margin-top:4px">🎉 Fully Paid Off!</div>`:''}
      </div>`;
    }
  }

  document.getElementById('view-tx-content').innerHTML=`
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:36px;margin-bottom:8px">${tx.category.split(' ')[0]}</div>
      <div>${amtDisplay}</div>
      <div style="margin-top:6px"><span class="pill ${tx.type}">${tx.type.toUpperCase()}</span></div>
    </div>
    <div style="display:grid;gap:8px">
      <div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:2px">CATEGORY</div><div>${tx.category}</div></div>
      <div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:2px">ACCOUNT</div><div>${acc?acc.name:'Unknown'}${toAcc?' → '+toAcc.name:''}</div></div>
      <div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:2px">DATE</div><div>${fmtDate(tx.date)}</div></div>
      ${tx.ref?`<div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:2px">REFERENCE</div><div>${tx.ref}</div></div>`:''}
      ${tx.desc?`<div class="card-sm"><div style="font-size:10px;color:var(--text3);margin-bottom:2px">DESCRIPTION</div><div>${tx.desc}</div></div>`:''}
      ${payableHtml}
      ${receiptHtml}
    </div>
  `;
  document.getElementById('view-tx-edit-btn').onclick=()=>openEditTx(id);
  openModal('modal-view-tx');
}

// ===== ACCOUNTS =====
function toggleAccFields(){
  const type=document.getElementById('acc-type').value;
  const show=type==='bank'||type==='ewallet';
  document.getElementById('acc-num-group').style.display=show?'':'none';
  document.getElementById('acc-holder-group').style.display=show?'':'none';
}
function buildColorGrid(selected){
  document.getElementById('color-grid').innerHTML=COLOR_PALETTE.map(c=>`<div class="color-swatch${c===selected?' selected':''}" style="background:${c}" onclick="selectColor('${c}',this)"></div>`).join('');
}
function selectColor(c,el){selectedAccColor=c;document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));el.classList.add('selected');}
// ===== V5 MORE DRAWER =====
function openMoreDrawer(){
  document.getElementById('more-drawer').classList.add('open');
  document.getElementById('more-drawer-overlay').classList.add('open');
}
function closeMoreDrawer(){
  document.getElementById('more-drawer').classList.remove('open');
  document.getElementById('more-drawer-overlay').classList.remove('open');
}
// ===== V5 CONTACTS SHEET =====
function openContactsSheet(){
  const sheet=document.getElementById('v5-contacts-sheet');
  const overlay=document.getElementById('v5-sheet-overlay');
  const list=document.getElementById('v5-contacts-list');
  if(!db.qrContacts||!db.qrContacts.length){
    list.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">No contacts yet.<br>Add contacts in Accounts → QR Payments → Contacts</div>';
  } else {
    list.innerHTML=db.qrContacts.map(c=>`
      <div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;background:var(--bg3);margin-bottom:8px;cursor:pointer" onclick="closeContactsSheet();showScreen('accounts');currentAccountsTab='qr';currentQRSubTab='contacts';renderAccountsScreen()">
        <div style="width:40px;height:40px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:18px;overflow:hidden;flex-shrink:0">${c.profileImage?`<img src="${c.profileImage}" style="width:100%;height:100%;object-fit:cover">`:c.name.charAt(0).toUpperCase()}</div>
        <div><div style="font-size:13px;font-weight:600;color:var(--text)">${c.name}</div><div style="font-size:11px;color:var(--text3)">${c.type||'Contact'}</div></div>
      </div>`).join('');
  }
  sheet.classList.add('open');
  overlay.classList.add('open');
}
function closeContactsSheet(){
  document.getElementById('v5-contacts-sheet').classList.remove('open');
  document.getElementById('v5-sheet-overlay').classList.remove('open');
}
// ===== V5 QUICK ACTIONS =====
function openQARequest(){ showToast('Feature: Share your QR code to request payment','info'); showScreen('accounts'); currentAccountsTab='qr'; renderAccountsScreen(); }
function openQAPay(){ showToast('Select a contact to pay via QR','info'); openContactsSheet(); }
// ===== LOGO UPLOAD =====
let selectedLogoData=null;
function handleLogoUpload(input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    selectedLogoData=e.target.result;
    const preview=document.getElementById('acc-logo-preview');
    const placeholder=document.getElementById('acc-logo-placeholder');
    preview.src=selectedLogoData; preview.style.display='block';
    if(placeholder)placeholder.style.display='none';
  };
  reader.readAsDataURL(file);
}
function openAddAccount(){
  editingAccId=null;selectedAccColor='#7c83fd';selectedLogoData=null;
  document.getElementById('modal-account-title').textContent='Add Account';
  document.getElementById('acc-name').value='';
  document.getElementById('acc-type').value='bank';
  document.getElementById('acc-number').value='';
  document.getElementById('acc-holder').value='';
  document.getElementById('acc-balance').value='';
  document.getElementById('acc-savings').value='';
  document.getElementById('acc-delete-btn').style.display='none';
  document.getElementById('acc-save-btn').textContent='Save Account';
  // reset logo
  const prev=document.getElementById('acc-logo-preview');const ph=document.getElementById('acc-logo-placeholder');
  if(prev){prev.style.display='none';prev.src='';}if(ph)ph.style.display='';
  dismissFormVAI('account');
  const vInp=document.getElementById('account-vai-input');if(vInp)vInp.value='';
  toggleAccFields();buildColorGrid('#7c83fd');openModal('modal-account');
}
function openEditAccount(id){
  const acc=db.accounts.find(a=>a.id===id);if(!acc)return;
  editingAccId=id;selectedAccColor=acc.color||'#7c83fd';selectedLogoData=null;
  document.getElementById('modal-account-title').textContent='Edit Account';
  document.getElementById('acc-name').value=acc.name;
  document.getElementById('acc-type').value=acc.type;
  document.getElementById('acc-number').value=acc.accountNumber||'';
  document.getElementById('acc-holder').value=acc.holderName||'';
  document.getElementById('acc-balance').value=acc.balance;
  document.getElementById('acc-savings').value=acc.savingsReserve||'';
  document.getElementById('acc-delete-btn').style.display='';
  document.getElementById('acc-save-btn').textContent='Update Account';
  // show existing logo
  const prev=document.getElementById('acc-logo-preview');const ph=document.getElementById('acc-logo-placeholder');
  if(acc.logo&&prev){prev.src=acc.logo;prev.style.display='block';if(ph)ph.style.display='none';}
  else{if(prev){prev.style.display='none';prev.src='';}if(ph)ph.style.display='';}
  toggleAccFields();buildColorGrid(acc.color||'#7c83fd');openModal('modal-account');
}
function saveAccount(){
  const name=document.getElementById('acc-name').value.trim();
  const type=document.getElementById('acc-type').value;
  const balance=parseFloat(document.getElementById('acc-balance').value)||0;
  const accountNumber=document.getElementById('acc-number').value.trim();
  const holderName=document.getElementById('acc-holder').value.trim();
  const savingsReserve=parseFloat(document.getElementById('acc-savings').value)||0;
  if(!name){showToast('Please enter an account name','error');return;}
  if(editingAccId){
    const acc=db.accounts.find(a=>a.id===editingAccId);
    if(acc){acc.name=name;acc.type=type;acc.balance=balance;acc.color=selectedAccColor;acc.accountNumber=accountNumber;acc.holderName=holderName;acc.savingsReserve=savingsReserve;if(selectedLogoData)acc.logo=selectedLogoData;}
  }else{
    db.accounts.push({id:uid(),name,type,balance,color:selectedAccColor,openingBalance:balance,accountNumber,holderName,savingsReserve,logo:selectedLogoData||null});
  }
  selectedLogoData=null;
  saveDB();closeModal('modal-account');
  showToast(editingAccId?'Account updated!':'Account added!');
  editingAccId=null;renderAccountsScreen();renderHome();
}
function deleteAccount(){
  showConfirm('Delete Account?','Transactions will be preserved.',()=>{
    db.accounts=db.accounts.filter(a=>a.id!==editingAccId);
    saveDB();closeModal('modal-account');showToast('Account deleted','error');
    editingAccId=null;renderAccountsScreen();renderHome();
  });
}

// ===== VIRTUAL CARD SWIPER =====
function renderAccountsScreen(){
  if(currentAccountsTab==='qr'){renderQRScreen();return;}
  const screen=document.getElementById('accounts-list-screen');
  if(!db.accounts.length){screen.innerHTML=`<div class="empty"><div class="empty-icon">🏦</div><p>No accounts yet.<br>Tap + to add your bank,<br>e-wallet, or cash.</p></div>`;return;}

  // Virtual cards (only bank and ewallet get cards)
  const cardAccs=db.accounts.filter(a=>a.type==='bank'||a.type==='ewallet');
  const cashAccs=db.accounts.filter(a=>a.type==='cash');
  let swiperHtml='';
  if(cardAccs.length>0){
    const cards=cardAccs.map((a,i)=>{
      const grad=getCardGradient(a.color||'#7c83fd');
      const numDisplay=a.accountNumber?maskNumber(a.accountNumber):'•••• ••••';
      const holderDisplay=a.holderName||a.name;
      const balDisplay=priv.cards?`<span class="hidden-amount" style="font-size:24px;font-weight:700">••••</span>`:`<div class="vcard-balance" style="color:${a.balance<0?'#ff6b6b':'#fff'}">${fmt(a.balance)}</div>`;
      return `<div class="vcard">
        <div class="vcard-inner" style="background:linear-gradient(${grad});color:#fff">
          <div class="vcard-top">
            <div>
              <div class="vcard-type-badge">${a.type==='bank'?'🏦 Bank':'📱 E-Wallet'}</div>
              <div style="font-size:13px;font-weight:700;margin-top:4px">${a.name}</div>
            </div>
            <div class="vcard-icon" style="color:${a.color||'#7c83fd'}">${ACC_ICONS[a.type]}</div>
          </div>
          <div class="vcard-middle">
            <div class="vcard-balance-label">Available Balance</div>
            ${balDisplay}
          </div>
          <div class="vcard-bottom">
            <div>
              <div style="font-size:9px;opacity:0.6;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">Account Holder</div>
              <div class="vcard-name">${holderDisplay.substring(0,22)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:9px;opacity:0.6;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">${a.type==='bank'?'Account No.':'Mobile/ID'}</div>
              <div class="vcard-number">${numDisplay}</div>
            </div>
          </div>
          <div style="position:absolute;top:0;right:0;bottom:0;left:0;cursor:pointer;z-index:4" onclick="openAccountDetail('${a.id}')"></div>
        </div>
      </div>`;
    }).join('');
    swiperHtml=`<div class="card-swiper-wrap" id="card-swiper-wrap">
      <div class="card-swiper" id="card-swiper">${cards}</div>
    </div>
    <div class="swiper-dots" id="swiper-dots">${cardAccs.map((_,i)=>`<div class="swiper-dot${i===0?' active':''}"></div>`).join('')}</div>
    ${cardAccs.length>1?'<div class="swiper-hint">← Swipe to switch cards →</div>':''}`;
  }

  // Total balance
  const total=db.accounts.reduce((s,a)=>s+a.balance,0);
  const totalDisplay=priv.accounts?'<span class="hidden-amount" style="font-size:26px;font-weight:700">••••</span>':`<div style="font-family:'Space Mono',monospace;font-size:26px;font-weight:700;color:${total>=0?'var(--accent2)':'var(--danger)'}">${fmt(total)}</div>`;

  // All accounts list
  let listHtml=`<div style="margin-top:8px">`;
  ['bank','ewallet','cash'].forEach(type=>{
    const accs=db.accounts.filter(a=>a.type===type);
    if(!accs.length)return;
    const typeTotal=accs.reduce((s,a)=>s+a.balance,0);
    const typeTotalDisplay=priv.accounts?'<span class="hidden-amount">••••</span>':fmt(typeTotal);
    const typeName=type==='bank'?'Bank Accounts':type==='ewallet'?'E-Wallets':'Cash on Hand';
    listHtml+=`<div class="section-title">${ACC_ICONS[type]} ${typeName} <span style="font-weight:400;font-size:12px;color:var(--text2)">${typeTotalDisplay}</span></div>`;
    accs.forEach(a=>{
      const numStr=a.accountNumber?`<div class="account-card-num">${maskNumber(a.accountNumber)}</div>`:'';
      const balDisplay=priv.accounts?'<span class="hidden-amount">••••</span>':fmt(a.balance);
      const balColor=(!priv.accounts&&a.balance<0)?'var(--danger)':a.color||'var(--accent2)';
      listHtml+=`<div class="account-card" onclick="openAccountDetail('${a.id}')">
        <div class="account-card-icon" style="background:${a.color||'#7c83fd'}22;font-size:20px">${ACC_ICONS[a.type]}</div>
        <div class="account-card-info">
          <div class="account-card-name">${a.name}</div>
          ${numStr}
          <div class="account-card-num">Opening: ${priv.accounts?'••••':fmt(a.openingBalance||0)}</div>
        </div>
        <div class="account-card-bal" style="color:${balColor}">${balDisplay}</div>
      </div>`;
    });
  });
  listHtml+='</div>';

  screen.innerHTML=`
    <div class="card" style="margin-bottom:4px;text-align:center;padding:14px">
      <div style="font-size:11px;color:var(--text2);margin-bottom:4px">TOTAL NET BALANCE</div>
      ${totalDisplay}
    </div>
    ${swiperHtml}
    ${listHtml}
  `;

  // Init swiper after render
  if(cardAccs.length>1) initSwiper(cardAccs.length);
}

function openAccountDetail(id){
  const acc=db.accounts.find(a=>a.id===id);if(!acc)return;
  const cur=getCurrency();
  const txs=db.transactions.filter(t=>t.accountId===id||t.toAccountId===id).slice(0,50);
  const incomeTotal=db.transactions.filter(t=>t.accountId===id&&t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expenseTotal=db.transactions.filter(t=>t.accountId===id&&t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const transferIn=db.transactions.filter(t=>t.toAccountId===id&&t.type==='transfer').reduce((s,t)=>s+t.amount,0);
  const transferOut=db.transactions.filter(t=>t.accountId===id&&t.type==='transfer').reduce((s,t)=>s+t.amount,0);
  const balColor=acc.balance<0?'var(--rose)':acc.color||'var(--emerald)';
  const numStr=acc.accountNumber?`<div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${maskNumber(acc.accountNumber)}</div>`:'';
  // Goals linked to this account
  const linkedGoals=db.goals.filter(g=>g.linkedAccountId===id&&g.status!=='achieved');
  const goalsProtected=linkedGoals.reduce((s,g)=>s+g.saved,0);
  const goalsHtml=linkedGoals.length?`<div style="background:var(--emerald-bg);border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:9px 13px;font-size:12px;color:var(--emerald);margin-bottom:12px">🎯 ${linkedGoals.length} goal${linkedGoals.length>1?'s':''} linked — ${fmt(goalsProtected)} protected (not spendable)</div>`:'';
  // Summary grid
  const summaryHtml=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
    <div class="card-sm" style="text-align:center"><div style="font-size:10px;color:var(--text3);margin-bottom:3px">INCOME</div><div style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--emerald)">+${fmt(incomeTotal)}</div></div>
    <div class="card-sm" style="text-align:center"><div style="font-size:10px;color:var(--text3);margin-bottom:3px">EXPENSES</div><div style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--rose)">-${fmt(expenseTotal)}</div></div>
    <div class="card-sm" style="text-align:center"><div style="font-size:10px;color:var(--text3);margin-bottom:3px">TRANSFER IN</div><div style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--violet)">+${fmt(transferIn)}</div></div>
    <div class="card-sm" style="text-align:center"><div style="font-size:10px;color:var(--text3);margin-bottom:3px">TRANSFER OUT</div><div style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--violet)">-${fmt(transferOut)}</div></div>
  </div>`;
  // Transaction list
  let txHtml='';
  if(!txs.length){txHtml='<div style="text-align:center;padding:20px;color:var(--text3);font-size:12px">No transactions yet for this account.</div>';}
  else{
    txHtml=`<div class="section-title" style="margin-bottom:8px">Recent Transactions</div>`;
    let lastDate='';
    txs.forEach(tx=>{
      if(tx.date!==lastDate){lastDate=tx.date;txHtml+=`<div class="tx-group-date" style="position:relative;top:0">${fmtDate(tx.date)}</div>`;}
      const isFrom=tx.accountId===id;
      let sign,amtClass;
      if(tx.type==='income'){sign='+';amtClass='income';}
      else if(tx.type==='expense'){sign='-';amtClass='expense';}
      else{sign=isFrom?'→':'←';amtClass='transfer';}
      const otherAcc=tx.type==='transfer'?(isFrom?db.accounts.find(a=>a.id===tx.toAccountId):db.accounts.find(a=>a.id===tx.accountId)):null;
      txHtml+=`<div class="tx-item" onclick="viewTx('${tx.id}');closeModal('modal-account-detail')">
        <div class="tx-icon ${tx.type}">${tx.category.split(' ')[0]}</div>
        <div class="tx-info">
          <div class="tx-cat">${tx.category.replace(/^\S+\s/,'')}</div>
          <div class="tx-desc">${otherAcc?'→ '+otherAcc.name:''}${tx.desc?' · '+tx.desc:''}</div>
        </div>
        <div class="tx-right">
          <div class="tx-amount ${amtClass}">${sign}${fmt(tx.amount)}</div>
          <div class="tx-date">${tx.date}</div>
        </div>
      </div>`;
    });
    if(db.transactions.filter(t=>t.accountId===id||t.toAccountId===id).length>50){txHtml+=`<div style="text-align:center;padding:10px;font-size:11px;color:var(--text3)">Showing last 50 transactions</div>`;}
  }
  document.getElementById('account-detail-content').innerHTML=`
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:36px;margin-bottom:6px">${ACC_ICONS[acc.type]}</div>
      <div style="font-size:18px;font-weight:800">${acc.name}</div>
      ${numStr}
      <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin:4px 0">${acc.type}</div>
      <div style="font-family:var(--mono);font-size:28px;font-weight:700;color:${balColor};margin-top:8px">${fmt(acc.balance)}</div>
    </div>
    ${goalsHtml}
    ${summaryHtml}
    ${txHtml}
  `;
  document.getElementById('account-detail-edit-btn').onclick=()=>{closeModal('modal-account-detail');openEditAccount(id);};
  const delBtn=document.getElementById('account-detail-delete-btn');
  if(delBtn)delBtn.onclick=()=>{closeModal('modal-account-detail');editingAccId=id;deleteAccount();};
  openModal('modal-account-detail');
}

function maskNumber(num){
  if(!num)return'•••• ••••';
  const s=num.replace(/\s/g,'');
  if(s.length<=4)return s;
  return '•••• '+s.slice(-4);
}

function initSwiper(count){
  swiperIdx=0;
  const wrap=document.getElementById('card-swiper');
  const outer=document.getElementById('card-swiper-wrap');
  if(!wrap||!outer)return;
  // Touch events
  outer.addEventListener('touchstart',e=>{swiperStartX=e.touches[0].clientX;swiperDragging=true;},{passive:true});
  outer.addEventListener('touchend',e=>{
    if(!swiperDragging)return;swiperDragging=false;
    const dx=e.changedTouches[0].clientX-swiperStartX;
    if(dx<-40&&swiperIdx<count-1)swiperIdx++;
    else if(dx>40&&swiperIdx>0)swiperIdx--;
    updateSwiper(count);
  },{passive:true});
}
function updateSwiper(count){
  const wrap=document.getElementById('card-swiper');
  if(!wrap)return;
  wrap.style.transform=`translateX(-${swiperIdx*100}%)`;
  document.querySelectorAll('.swiper-dot').forEach((d,i)=>{d.className='swiper-dot'+(i===swiperIdx?' active':'');});
}

// ===== RENDER HOME =====
function renderHome(){
  const style = db.settings.appStyle || 'classic';
  const homeEl = document.getElementById('screen-home');
  if(homeEl) homeEl.setAttribute('data-style', style);

  const total=db.accounts.reduce((s,a)=>s+a.balance,0);
  const pTxs=filterByPeriod(db.transactions,currentPeriod);
  const income=pTxs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=pTxs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);

  if(style === 'old'){
    // ── OLD STYLE ──
    const heroEl=document.getElementById('old-hero-balance');
    if(heroEl){
      if(priv.homeTotal){heroEl.innerHTML='<span class="hidden-amount" style="font-size:34px">••••</span>';heroEl.className='hbc-amount';}
      else{heroEl.textContent=fmt(total);heroEl.className='hbc-amount'+(total<0?' negative':'');}
    }
    const dateEl=document.getElementById('old-hero-date');
    if(dateEl)dateEl.textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    const incEl=document.getElementById('old-hbc-income');const expEl=document.getElementById('old-hbc-expense');
    if(incEl)incEl.innerHTML=priv.homeSummary?'<span class="hidden-amount">••••</span>':fmt(income);
    if(expEl)expEl.innerHTML=priv.homeSummary?'<span class="hidden-amount">••••</span>':fmt(expense);
    // Show old accounts header
    const oldAccHdr=document.getElementById('old-accounts-header');if(oldAccHdr)oldAccHdr.style.display='';
    // Old chips
    const oldChips=document.getElementById('old-accounts-chips');
    if(oldChips){
      if(!db.accounts.length){
        oldChips.innerHTML=`<div class="acc-chip" onclick="openAddAccount()" style="border-style:dashed;text-align:center;min-width:120px;justify-content:center;display:flex;flex-direction:column;align-items:center"><div style="font-size:24px;margin-bottom:6px">➕</div><div class="acc-chip-name">Add Account</div></div>`;
      }else{
        oldChips.innerHTML=db.accounts.map(a=>{
          const balDisplay=priv.chips?'<span class="hidden-amount">••••</span>':fmt(a.balance);
          const balColor=(!priv.chips&&a.balance<0)?'var(--danger)':a.color||'var(--accent2)';
          return`<div class="acc-chip" onclick="openAccountDetail('${a.id}')"><div class="acc-chip-icon">${ACC_ICONS[a.type]}</div><div class="acc-chip-name">${a.name}</div><div class="acc-chip-type">${a.type}</div><div class="acc-chip-bal" style="color:${balColor}">${balDisplay}</div></div>`;
        }).join('');
      }
    }
    // Sync old period buttons
    document.querySelectorAll('.hbc-period-btn').forEach(b=>b.classList.remove('active'));
    const periodMap2={daily:0,weekly:1,monthly:2,yearly:3};
    const oldBtns=document.querySelectorAll('.hbc-period-btn');
    if(oldBtns[periodMap2[currentPeriod]??2])oldBtns[periodMap2[currentPeriod]??2].classList.add('active');
  } else {
    // ── CLASSIC STYLE ──
    const heroEl=document.getElementById('hero-balance');
    if(heroEl){
      if(priv.homeTotal){heroEl.innerHTML='<span class="hidden-amount" style="font-size:34px">••••</span>';heroEl.className='v5-nw-amount';}
      else{heroEl.textContent=fmt(total);heroEl.className='v5-nw-amount'+(total<0?' negative':'');}
    }
    const incEl2=document.getElementById('hbc-income');const expEl2=document.getElementById('hbc-expense');
    if(incEl2)incEl2.innerHTML=priv.homeSummary?'<span class="hidden-amount">••••</span>':fmt(income);
    if(expEl2)expEl2.innerHTML=priv.homeSummary?'<span class="hidden-amount">••••</span>':fmt(expense);
    // v5 account gradient cards
    const chips=document.getElementById('accounts-chips');
    if(chips){
      if(!db.accounts.length){
        chips.innerHTML=`<div class="v5-acc-add" onclick="openAddAccount()"><div style="font-size:28px">➕</div><div style="font-size:11px;font-weight:600">Add Account</div></div>`;
      }else{
        chips.innerHTML=db.accounts.map(a=>{
          const balDisplay=priv.chips?'<span class="hidden-amount">••••</span>':fmt(a.balance);
          const grad=getCardGradient(a.color||'#7c83fd');
          const maskedNum=a.accountNumber?'••••'+a.accountNumber.replace(/\s/g,'').slice(-4):'';
          const logoHtml=a.logo?`<div class="v5-acc-logo"><img src="${a.logo}" alt="${a.name}"></div>`:`<div class="v5-acc-logo">${ACC_ICONS[a.type]||'🏦'}</div>`;
          return`<div class="v5-acc-card" style="background:linear-gradient(${grad})" onclick="openAccountDetail('${a.id}')"><div class="v5-acc-card-top">${logoHtml}<div style="text-align:right"><div class="v5-acc-name">${a.name}</div><div class="v5-acc-type-badge">${a.type}</div></div></div><div><div class="v5-acc-balance">${balDisplay}</div>${maskedNum?`<div class="v5-acc-number">${maskedNum}</div>`:''}</div></div>`;
        }).join('')+`<div class="v5-acc-add" onclick="openAddAccount()"><div style="font-size:22px">➕</div><div style="font-size:10px;font-weight:600">Add</div></div>`;
      }
    }
    // Sync v5 time filter
    document.querySelectorAll('.v5-tf-btn').forEach(b=>b.classList.remove('active'));
    const periodMap={daily:0,weekly:1,monthly:2,yearly:3};
    const tfBtns=document.querySelectorAll('.v5-tf-btn');
    if(tfBtns[periodMap[currentPeriod]??2])tfBtns[periodMap[currentPeriod]??2].classList.add('active');
  }

  // Recent transactions — always rendered
  const recentEl=document.getElementById('recent-tx-list');
  if(recentEl){
    const recent=db.transactions.slice(0,7);
    if(!recent.length){
      recentEl.innerHTML='<div class="empty"><div class="empty-icon">📭</div><p>No transactions yet.<br>Tap ➕ to add one!</p></div>';
    }else{
      recentEl.innerHTML=recent.map(tx=>{
        const acc=db.accounts.find(a=>a.id===tx.accountId);
        const sign=tx.type==='expense'?'-':tx.type==='income'?'+':'⇄';
        const amtDisplay=priv.transactions?'<span class="hidden-amount">••••</span>':`${sign}${fmt(tx.amount)}`;
        const recurIcon=tx.recurringId?'🔄 ':'';
        const catIcon=tx.category.split(' ')[0];
        const catName=tx.category.replace(/^\S+\s/,'');
        return`<div class="tx-feed-item" onclick="viewTx('${tx.id}')"><div class="tx-feed-icon ${tx.type}">${catIcon}</div><div class="tx-feed-info"><div class="tx-feed-cat">${recurIcon}${tx.desc||catName}</div><div class="tx-feed-meta">${catName}${acc?' · '+acc.name:''}</div></div><div class="tx-feed-right"><div class="tx-feed-amt ${tx.type}">${amtDisplay}</div><div class="tx-feed-date">${tx.date}</div></div></div>`;
      }).join('');
    }
  }

  updateEyeBtn();
  renderBudgetHomePanel();
  renderHomePayableAlerts();
  renderSmartAlerts();
  renderCashFlow();
  renderHomeMiniReport();
  renderHomeMiniCal();
  _applyHomeWidgetVisibility();
}

function renderHomePayableAlerts(){
  const banner=document.getElementById('home-payable-alert');if(!banner)return;
  const now=new Date();
  const alerts=[];
  db.payables.filter(p=>p.status==='active'&&p.dueDay).forEach(py=>{
    let dueDate=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
    if(dueDate<now)dueDate=new Date(now.getFullYear(),now.getMonth()+1,py.dueDay);
    const daysUntil=Math.ceil((dueDate-now)/(1000*60*60*24));
    if(daysUntil<=7){
      const needed=py.monthlyPayment||0;
      if(needed>0){
        const acc=py.linkedAccount?db.accounts.find(a=>a.id===py.linkedAccount):null;
        if(acc&&acc.balance<needed){
          const ds=dueDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});
          alerts.push(`⚠️ <strong>${py.name}</strong> payment of ${fmt(needed)} due ${ds} — ${acc.name} only has ${fmt(acc.balance)}.`);
        } else if(!py.linkedAccount){
          // no account linked — subtle reminder
        }
      }
    }
  });
  if(alerts.length){
    banner.style.display='block';
    banner.innerHTML=`<div style="font-size:11px;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">💳 Payable Due Soon — Insufficient Balance</div>`+alerts.map(a=>`<div style="margin-bottom:4px">${a}</div>`).join('')+`<div style="margin-top:8px"><button onclick="showScreen('payables')" style="background:var(--rose);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;font-weight:700;cursor:pointer">View Payables →</button></div>`;
  } else {
    banner.style.display='none';
  }
}

function setHomePeriod(p,btn){
  currentPeriod=p;
  document.querySelectorAll('.hbc-period-btn,.v5-tf-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderHome();
}


// ============================================================
// ===== CASH FLOW PREDICTION ENGINE =========================
// ============================================================

let cfPeriod = '30d';          // '7d' | '14d' | '30d' | 'eom'
let cfChart = null;            // Chart.js instance

function setCfPeriod(p) {
  cfPeriod = p;
  // sync tab buttons if rendered
  document.querySelectorAll('.cf-period-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.period === p);
  });
  renderCashFlow();
}

// ── Returns end-date string for the selected period ─────────
function cfEndDate() {
  const now = new Date();
  if (cfPeriod === '7d')  { const d = new Date(now); d.setDate(d.getDate() + 7);  return d.toISOString().split('T')[0]; }
  if (cfPeriod === '14d') { const d = new Date(now); d.setDate(d.getDate() + 14); return d.toISOString().split('T')[0]; }
  if (cfPeriod === '30d') { const d = new Date(now); d.setDate(d.getDate() + 30); return d.toISOString().split('T')[0]; }
  // end of month
  return new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
}

// ── Collect all upcoming cash-flow events ──────────────────
function cfCollectEvents(endDate) {
  const todayStr = today();
  const events = [];

  // 1. Pending planned transactions (income + expense, not transfer)
  db.planned.filter(p => p.status === 'pending' && p.date > todayStr && p.date <= endDate && p.type !== 'transfer')
    .forEach(p => {
      events.push({
        date: p.date,
        type: p.type,
        amount: p.amount,
        label: p.category.replace(/^\S+\s/, '') + (p.desc ? ' — ' + p.desc : ''),
        source: 'planned',
        id: p.id
      });
    });

  // 2. Active recurring transactions (project occurrences into the window)
  db.recurring.filter(r => r.status === 'active' && r.type !== 'transfer').forEach(r => {
    if (r.endDate && r.endDate < todayStr) return;

    // Build set of months where this recurring was already applied (has matching transaction)
    const appliedTxDates = new Set(
      db.transactions.filter(tx => tx.recurringId === r.id).map(tx => tx.date)
    );
    // Also track month-keys of applied transactions to skip whole months
    const appliedMonthKeys = new Set(
      db.transactions.filter(tx => tx.recurringId === r.id).map(tx => tx.date.substring(0, 7))
    );

    const start = new Date(Math.max(new Date(todayStr + 'T00:00:00'), new Date(r.startDate ? r.startDate + 'T00:00:00' : todayStr + 'T00:00:00')));
    const end = new Date(endDate + 'T23:59:59');
    let cur = new Date(start);
    // advance to the first occurrence AFTER today
    if (r.frequency === 'daily')   cur.setDate(cur.getDate() + 1);
    else if (r.frequency === 'weekly') cur.setDate(cur.getDate() + 7);
    else if (r.frequency === 'monthly') {
      // next occurrence: correct due day of month (use dueDay or startDate day)
      const startDay = r.dueDay || new Date(r.startDate + 'T00:00:00').getDate();
      cur = new Date(start.getFullYear(), start.getMonth(), startDay);
      if (cur <= start) cur = new Date(cur.getFullYear(), cur.getMonth() + 1, startDay);
    }
    else if (r.frequency === 'semimonthly') {
      const d1=r.semiDay1||15, d2=r.semiDay2||30;
      const nowD=new Date(todayStr+'T00:00:00');
      for(let mo=0;mo<6;mo++){
        const yr=nowD.getFullYear()+Math.floor((nowD.getMonth()+mo)/12);
        const mt=(nowD.getMonth()+mo)%12;
        for(const d of [d1,d2].sort((a,b)=>a-b)){
          const lastDay=new Date(yr,mt+1,0).getDate();
          const actualD=Math.min(d,lastDay);
          const ds2=`${yr}-${String(mt+1).padStart(2,'0')}-${String(actualD).padStart(2,'0')}`;
          if(ds2>todayStr&&ds2<=endDate&&ds2>=r.startDate&&!appliedTxDates.has(ds2)){
            events.push({date:ds2,type:r.type,amount:r.amount,label:r.name+' (semi-monthly)',source:'recurring',id:r.id+'-'+ds2});
          }
        }
      }
      return;
    }
    else if (r.frequency === 'yearly') { cur.setFullYear(cur.getFullYear() + 1); }

    let safety = 0;
    while (cur <= end && safety++ < 60) {
      // Use local date string to avoid timezone offset shifting the date
      const ds = localDate(cur);
      if (ds > todayStr && ds <= endDate) {
        // Skip if a transaction with this recurringId already exists for this month (already paid)
        const monthKey = ds.substring(0, 7);
        const alreadyPaid = appliedMonthKeys.has(monthKey) ||
          (r.frequency === 'monthly' && appliedTxDates.has(ds));
        if (!alreadyPaid) {
          events.push({
            date: ds,
            type: r.type,
            amount: r.amount,
            label: r.name + ' (recurring)',
            source: 'recurring',
            id: r.id + '-' + ds
          });
        }
      }
      if (r.frequency === 'daily')   cur.setDate(cur.getDate() + 1);
      else if (r.frequency === 'weekly')  cur.setDate(cur.getDate() + 7);
      else if (r.frequency === 'monthly') {
        const dueDay = r.dueDay || new Date(r.startDate + 'T00:00:00').getDate();
        cur = new Date(cur.getFullYear(), cur.getMonth() + 1, dueDay);
      }
      else if (r.frequency === 'yearly')  cur.setFullYear(cur.getFullYear() + 1);
    }
  });

  // 3. Active payables due within window
  db.payables.filter(p => p.status === 'active' && p.dueDay && p.monthlyPayment > 0).forEach(py => {
    const now = new Date();
    for (let m = 0; m < 3; m++) {
      const dueDate = new Date(now.getFullYear(), now.getMonth() + m, py.dueDay);
      const ds = dueDate.getFullYear()+'-'+String(dueDate.getMonth()+1).padStart(2,'0')+'-'+String(dueDate.getDate()).padStart(2,'0');
      if (ds > todayStr && ds <= endDate) {
        // avoid double-counting with planned items that already exist for this payable
        const alreadyPlanned = events.some(e => e.source === 'planned' && e.date === ds && e.label.includes(py.name));
        if (!alreadyPlanned) {
          events.push({
            date: ds,
            type: 'expense',
            amount: py.monthlyPayment,
            label: py.name + ' (payable due)',
            source: 'payable',
            id: py.id + '-' + ds
          });
        }
      }
    }
  });

  // Sort chronologically
  events.sort((a, b) => a.date.localeCompare(b.date));
  return events;
}

// ── Build a day-by-day timeline ─────────────────────────────
function cfBuildTimeline(currentBalance, events, endDate) {
  const todayStr = today();
  const start = new Date(todayStr + 'T00:00:00');
  const end   = new Date(endDate + 'T00:00:00');
  const timeline = [];  // [{date, balance, income, expense, events[]}]
  let runningBalance = currentBalance;

  // group events by date
  const byDate = {};
  events.forEach(e => {
    if (!byDate[e.date]) byDate[e.date] = [];
    byDate[e.date].push(e);
  });

  let cur = new Date(start);
  cur.setDate(cur.getDate() + 1); // start from tomorrow
  while (cur <= end) {
    const ds = cur.toISOString().split('T')[0];
    const dayEvents = byDate[ds] || [];
    const dayIncome  = dayEvents.filter(e => e.type === 'income').reduce((s, e) => s + e.amount, 0);
    const dayExpense = dayEvents.filter(e => e.type === 'expense').reduce((s, e) => s + e.amount, 0);
    runningBalance += dayIncome - dayExpense;
    timeline.push({
      date: ds,
      balance: runningBalance,
      income: dayIncome,
      expense: dayExpense,
      events: dayEvents
    });
    cur.setDate(cur.getDate() + 1);
  }
  return timeline;
}

// ── Smart insights ──────────────────────────────────────────
function cfGenerateInsights(currentBalance, timeline, events) {
  const insights = [];
  const LOW_THRESHOLD = 2000;

  // Negative balance detected
  const goesNegative = timeline.find(d => d.balance < 0);
  if (goesNegative) {
    insights.push({ type: 'danger', icon: '🔴', text: 'Balance goes negative on ' + fmtDate(goesNegative.date) });
  }

  // Low balance warning
  const goesLow = timeline.find(d => d.balance < LOW_THRESHOLD && d.balance >= 0);
  if (goesLow && !goesNegative) {
    insights.push({ type: 'warn', icon: '⚠️', text: 'Balance dips below ' + fmt(LOW_THRESHOLD) + ' on ' + fmtDate(goesLow.date) });
  }

  // Income covers expenses?
  const totalInc  = events.filter(e => e.type === 'income').reduce((s, e) => s + e.amount, 0);
  const totalExp  = events.filter(e => e.type === 'expense').reduce((s, e) => s + e.amount, 0);
  if (totalInc > 0 && totalInc >= totalExp) {
    insights.push({ type: 'good', icon: '✅', text: 'Upcoming income (' + fmt(totalInc) + ') covers expenses (' + fmt(totalExp) + ')' });
  } else if (totalExp > totalInc && totalExp > 0) {
    insights.push({ type: 'warn', icon: '📉', text: 'Expenses (' + fmt(totalExp) + ') exceed income (' + fmt(totalInc) + ') this period' });
  }

  // Largest single expense
  const bigExp = events.filter(e => e.type === 'expense').sort((a, b) => b.amount - a.amount)[0];
  if (bigExp && bigExp.amount >= 5000) {
    insights.push({ type: 'info', icon: '💡', text: 'Largest upcoming payment: ' + fmt(bigExp.amount) + ' for ' + bigExp.label });
  }

  // Savings reserve warning
  db.accounts.filter(a => (a.savingsReserve || 0) > 0).forEach(acc => {
    const minBal = timeline.reduce((min, d) => d.balance < min ? d.balance : min, currentBalance);
    if (minBal < acc.savingsReserve) {
      insights.push({ type: 'danger', icon: '🛡️', text: acc.name + ' savings reserve (' + fmt(acc.savingsReserve) + ') may be breached' });
    }
  });

  return insights.slice(0, 4); // max 4 insights
}

// ── Main render ─────────────────────────────────────────────
function renderCashFlow() {
  const el = document.getElementById('cashflow-widget');
  if (!el) return;

  const currentBalance = db.accounts.reduce((s, a) => s + a.balance, 0);
  const endDate = cfEndDate();
  const events  = cfCollectEvents(endDate);
  const timeline = cfBuildTimeline(currentBalance, events, endDate);
  const projectedBalance = timeline.length ? timeline[timeline.length - 1].balance : currentBalance;
  const delta = projectedBalance - currentBalance;
  const insights = cfGenerateInsights(currentBalance, timeline, events);

  const periodLabels = { '7d': '7 Days', '14d': '14 Days', '30d': '30 Days', 'eom': 'End of Month' };
  const balClass = projectedBalance < 0 ? 'danger' : projectedBalance < 2000 ? 'warn' : 'good';
  const deltaSign = delta >= 0 ? '+' : '';
  const deltaClass = delta >= 0 ? 'positive' : 'negative';

  // Top 5 upcoming events for the list
  const topEvents = events.slice(0, 6);

  // Low balance alert bar
  let alertBarHtml = '';
  const goesNegative = timeline.find(d => d.balance < 0);
  const goesLow = timeline.find(d => d.balance < 2000 && d.balance >= 0);
  if (goesNegative) {
    alertBarHtml = `<div class="cf-alert-bar">
      <div class="cf-alert-icon">🔴</div>
      <div class="cf-alert-text"><strong>Negative balance risk!</strong> Your balance may drop to ${fmt(goesNegative.balance)} on ${fmtDate(goesNegative.date)}. Review your upcoming expenses.</div>
    </div>`;
  } else if (goesLow) {
    alertBarHtml = `<div class="cf-alert-bar warn">
      <div class="cf-alert-icon">⚠️</div>
      <div class="cf-alert-text"><strong>Low balance warning.</strong> Balance may drop below ${fmt(2000)} on ${fmtDate(goesLow.date)}. Your balance may drop below the safe level soon.</div>
    </div>`;
  } else if (events.length > 0) {
    alertBarHtml = `<div class="cf-alert-bar safe">
      <div class="cf-alert-icon">✅</div>
      <div class="cf-alert-text"><strong>Cash flow looks healthy.</strong> No low balance risks detected in the next ${periodLabels[cfPeriod]}.</div>
    </div>`;
  }

  // Insight chips
  const insightHtml = insights.length ? `<div class="cf-insight-row">
    ${insights.map(i => `<div class="cf-insight-chip ${i.type}">${i.icon} ${i.text}</div>`).join('')}
  </div>` : '';

  // Events list
  const eventsListHtml = topEvents.length ? topEvents.map(e => {
    const dotColor = e.type === 'income' ? 'var(--income)' : 'var(--expense)';
    const sign = e.type === 'income' ? '+' : '-';
    const dayStr = e.date === today() ? 'Today' : fmtDate(e.date);
    const sourceIcon = e.source === 'recurring' ? '🔄 ' : e.source === 'payable' ? '💳 ' : '📅 ';
    return `<div class="cf-event">
      <div class="cf-event-dot" style="background:${dotColor}"></div>
      <div class="cf-event-info">
        <div class="cf-event-name">${sourceIcon}${e.label}</div>
        <div class="cf-event-date">${dayStr}</div>
      </div>
      <div class="cf-event-amt ${e.type}">${sign}${fmt(e.amount)}</div>
    </div>`;
  }).join('') : `<div style="padding:16px 0;text-align:center;color:var(--text3);font-size:12px">No upcoming events in this window.<br>Add planned activities or recurring rules.</div>`;

  const moreCount = events.length > 6 ? events.length - 6 : 0;

  el.innerHTML = `<div style="padding:0 14px;margin-bottom:0">
    <div class="sh" style="padding-top:4px"><span class="sh-label">📈 Cash Flow Prediction</span><span class="sh-link" onclick="showCfAllEvents()">Full Detail →</span></div>
  </div>
  <div style="padding:0 14px 18px"><div class="cf-widget">
    <!-- Header with gradient -->
    <div class="cf-header">
      <div class="cf-title-row">
        <div class="cf-title">📈 Cash Flow Forecast</div>
        <div class="cf-period-tabs">
          ${['7d','14d','30d','eom'].map(p => `<button class="cf-period-tab${cfPeriod===p?' active':''}" data-period="${p}" onclick="setCfPeriod('${p}')">${p==='eom'?'EOM':p.toUpperCase()}</button>`).join('')}
        </div>
      </div>
      <div class="cf-balance-row">
        <div class="cf-projected">
          <div class="cf-proj-label">Projected Balance in ${periodLabels[cfPeriod]}</div>
          <div class="cf-proj-amount ${balClass}">${fmt(projectedBalance)}</div>
        </div>
        <div class="cf-delta">
          <div class="cf-delta-val ${deltaClass}">${deltaSign}${fmt(delta)}</div>
          <div class="cf-delta-label">vs today</div>
        </div>
      </div>
    </div>
    <!-- Chart -->
    <div class="cf-chart-area">
      <div class="cf-chart-wrap"><canvas id="cf-chart"></canvas></div>
    </div>
    ${insightHtml}
    ${alertBarHtml ? '<div style="height:10px"></div>' + alertBarHtml : ''}
    <!-- Events list -->
    <div class="cf-body">
      <div class="cf-section-title">📋 Upcoming Events (${events.length}) <span style="font-size:9px;color:var(--text3);font-weight:400;margin-left:4px">🔄 Recurring · 💳 Payables · 📅 Planned</span></div>
      ${eventsListHtml}
      ${moreCount > 0 ? `<div style="text-align:center;padding:8px 0;font-size:11px;color:var(--accent);cursor:pointer" onclick="showCfAllEvents()">+${moreCount} more events →</div>` : ''}
    </div>
    <!-- Summary footer -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border)">
      <div style="background:var(--card);padding:10px;text-align:center">
        <div style="font-family:'Space Mono',monospace;font-size:12px;font-weight:700;color:var(--income)">+${fmt(events.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0))}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">Expected Income</div>
      </div>
      <div style="background:var(--card);padding:10px;text-align:center">
        <div style="font-family:'Space Mono',monospace;font-size:12px;font-weight:700;color:var(--expense)">-${fmt(events.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0))}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">Expected Expenses</div>
      </div>
      <div style="background:var(--card);padding:10px;text-align:center">
        <div style="font-family:'Space Mono',monospace;font-size:12px;font-weight:700;color:${events.length>0?'var(--text2)':'var(--text3)'}">${events.length}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">Events Tracked</div>
      </div>
    </div>
  </div></div></div>`;

  // ── Render the line chart ─────────────────────────────────
  renderCfChart(timeline, currentBalance);
}

function renderCfChart(timeline, currentBalance) {
  const ctx = document.getElementById('cf-chart');
  if (!ctx) return;
  if (cfChart) { cfChart.destroy(); cfChart = null; }

  // Thin out labels for readability
  const step = timeline.length > 20 ? Math.ceil(timeline.length / 14) : 1;
  const labels = ['Today', ...timeline.map((d, i) => {
    if (i % step !== 0 && i !== timeline.length - 1) return '';
    const dt = new Date(d.date + 'T00:00:00');
    return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  })];
  const data = [currentBalance, ...timeline.map(d => d.balance)];

  // Color gradient: red if negative, yellow if low, green if healthy
  const LOW = 2000;
  const pointColors = data.map(v => v < 0 ? '#ff6b6b' : v < LOW ? '#f4a95a' : '#56c8a0');
  const lineColor = data.some(v => v < 0) ? '#ff6b6b' : data.some(v => v < LOW) ? '#f4a95a' : '#56c8a0';

  cfChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Balance',
        data,
        borderColor: lineColor,
        backgroundColor: (ctx2) => {
          const chart = ctx2.chart;
          const { ctx: c, chartArea } = chart;
          if (!chartArea) return 'transparent';
          const grad = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
          grad.addColorStop(0, lineColor.replace(')', ',0.25)').replace('rgb', 'rgba'));
          grad.addColorStop(1, 'transparent');
          return grad;
        },
        fill: true,
        tension: 0.4,
        pointRadius: (ctx2) => {
          const idx = ctx2.dataIndex;
          return timeline[idx - 1]?.events?.length > 0 ? 4 : 2;
        },
        pointBackgroundColor: pointColors,
        pointBorderWidth: 0,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15,21,34,0.97)',
          borderColor: getThemeColors().blue + '44',
          borderWidth: 1,
          titleColor: getThemeColors().text2,
          bodyColor: getThemeColors().text3,
          padding: 10,
          callbacks: {
            label: (ctx2) => {
              const v = ctx2.raw;
              const marker = v < 0 ? ' ⚠️ NEGATIVE' : v < 2000 ? ' ⚠️ LOW' : '';
              return ' ' + fmt(v) + marker;
            },
            afterLabel: (ctx2) => {
              const idx = ctx2.dataIndex;
              const dayData = timeline[idx - 1];
              if (!dayData || !dayData.events.length) return '';
              return dayData.events.slice(0, 3).map(e => `  ${e.type === 'income' ? '+' : '-'}${fmt(e.amount)} ${e.label}`).join('\n');
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: getThemeColors().text3, font: { size: 8 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
          grid: { color: getThemeColors().border, drawBorder: false }
        },
        y: {
          ticks: {
            color: getThemeColors().text3, font: { size: 9 },
            callback: v => {
              if (Math.abs(v) >= 1000) return getCurrency() + (v / 1000).toFixed(0) + 'K';
              return getCurrency() + v;
            }
          },
          grid: { color: getThemeColors().border, drawBorder: false }
        }
      }
    }
  });
}

// ── Show all events in dedicated CF modal ──────────────────
function showCfAllEvents() {
  const endDate = cfEndDate();
  const events = cfCollectEvents(endDate);
  const currentBalance = db.accounts.reduce((s, a) => s + a.balance, 0);
  const timeline = cfBuildTimeline(currentBalance, events, endDate);
  const periodLabels = { '7d': '7 Days', '14d': '14 Days', '30d': '30 Days', 'eom': 'End of Month' };

  let evHtml = '';
  if (!events.length) {
    evHtml = '<div class="empty" style="padding:30px"><p>No upcoming events in this window.</p></div>';
  } else {
    let lastDate = '';
    // Build a running balance map for each date
    const balMap = {};
    timeline.forEach(d => { balMap[d.date] = d.balance; });
    events.forEach(e => {
      if (e.date !== lastDate) {
        lastDate = e.date;
        const dayBal = balMap[e.date];
        const balColor = dayBal < 0 ? 'var(--overdue)' : dayBal < 2000 ? 'var(--planned)' : 'var(--income)';
        evHtml += `<div style="display:flex;justify-content:space-between;align-items:center;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;padding:12px 0 5px;border-bottom:1px solid var(--border)">
          <span>${fmtDate(e.date)}</span>
          ${dayBal !== undefined ? `<span style="font-family:'Space Mono',monospace;color:${balColor};font-size:10px">Balance: ${fmt(dayBal)}</span>` : ''}
        </div>`;
      }
      const sign = e.type === 'income' ? '+' : '-';
      const color = e.type === 'income' ? 'var(--income)' : 'var(--expense)';
      const sourceIcon = e.source === 'recurring' ? '🔄' : e.source === 'payable' ? '💳' : '📅';
      evHtml += `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(46,53,85,0.5)">
        <span style="font-size:15px;flex-shrink:0">${sourceIcon}</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.label}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:1px;text-transform:capitalize">${e.source}</div>
        </div>
        <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:${color};flex-shrink:0">${sign}${fmt(e.amount)}</div>
      </div>`;
    });
  }

  document.getElementById('cf-modal-period').textContent = periodLabels[cfPeriod] + ' · ' + events.length + ' events';
  document.getElementById('cf-modal-events').innerHTML = evHtml;
  openModal('modal-cf-detail');
}

function renderHomeMiniReport(){
  const el=document.getElementById('home-mini-report');if(!el)return;
  const now=new Date();
  const ms=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  const me=localMonthEnd(now.getFullYear(),now.getMonth());
  const txs=db.transactions.filter(t=>t.date>=ms&&t.date<=me);
  if(!txs.length){el.innerHTML='';return;}
  const income=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const net=income-expense;
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  el.innerHTML=`<div class="sh"><span class="sh-label">📊 ${monthName} Summary</span><span class="sh-link" onclick="showScreen('reports')">Full Report →</span></div>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:0 14px;margin-bottom:18px">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center">
      <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--income)">${priv.homeSummary?'••••':fmt(income)}</div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px">Income</div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center">
      <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--expense)">${priv.homeSummary?'••••':fmt(expense)}</div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px">Expenses</div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center">
      <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:${net>=0?'var(--accent2)':'var(--danger)'}">${priv.homeSummary?'••••':fmt(net)}</div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px">Net ${net>=0?'💚':'🔴'}</div>
    </div>
  </div>`;
}

// Compact number formatter for calendar cells: 1500 → 1.5K, 12000 → 12K
function fmtK(n){
  if(n===0)return'';
  if(n>=1000000)return(n/1000000).toFixed(1).replace(/\.0$/,'')+'M';
  if(n>=1000)return(n/1000).toFixed(1).replace(/\.0$/,'')+'K';
  return n.toFixed(0);
}

let homeMiniCalYear=null, homeMiniCalMonth=null;

function renderHomeMiniCal(yearOverride, monthOverride){
  const el=document.getElementById('home-mini-cal');if(!el)return;
  const now=new Date();
  if(yearOverride!==undefined)homeMiniCalYear=yearOverride;
  if(monthOverride!==undefined)homeMiniCalMonth=monthOverride;
  if(homeMiniCalYear===null)homeMiniCalYear=now.getFullYear();
  if(homeMiniCalMonth===null)homeMiniCalMonth=now.getMonth();
  const year=homeMiniCalYear, month=homeMiniCalMonth;
  const todayStr=today();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=new Date(year,month,1).toLocaleDateString('en-US',{month:'long',year:'numeric'});

  const ms=`${year}-${String(month+1).padStart(2,'0')}-01`;
  const me=localMonthEnd(year,month);
  const plannedInMonth=db.planned.filter(p=>p.date>=ms&&p.date<=me);
  const txInMonth=db.transactions.filter(t=>t.date>=ms&&t.date<=me);

  // Transactions per day
  const dayData={};
  txInMonth.forEach(tx=>{
    if(!dayData[tx.date])dayData[tx.date]={exp:0,inc:0};
    if(tx.type==='expense')dayData[tx.date].exp+=tx.amount;
    else if(tx.type==='income')dayData[tx.date].inc+=tx.amount;
  });

  // Planned/overdue per day — exclude payable-linked items (payables already get their own amber dot)
  const dayPlannedMap={};
  plannedInMonth.filter(p=>!p.payableId).forEach(p=>{
    if(!dayPlannedMap[p.date])dayPlannedMap[p.date]={planned:0,overdue:0};
    if(p.status==='pending'&&p.date<todayStr)dayPlannedMap[p.date].overdue++;
    else if(p.status==='pending')dayPlannedMap[p.date].planned++;
  });

  // Payable dots — ONLY unpaid (overdue/current/upcoming) due dates
  const dayPayableMap={};
  db.payables.filter(p=>p.status==='active'&&p.dueDay&&p.monthlyPayment>0).forEach(py=>{
    try {
      const sched=generatePayableSchedule(py);
      sched.filter(s=>s.status==='overdue'||s.status==='current'||s.status==='upcoming').forEach(s=>{
        if(s.date>=ms&&s.date<=me) dayPayableMap[s.date]=(dayPayableMap[s.date]||0)+1;
      });
    } catch(e){}
  });

  // Recurring dots — ONLY unapplied/missed upcoming occurrences (not already-applied = already showing in txInMonth)
  const appliedRecurDates=new Set(db.transactions.filter(t=>t.recurringId&&t.date>=ms&&t.date<=me).map(t=>t.date));
  const dayRecurMap={};
  db.recurring.filter(r=>r.status!=='paused').forEach(r=>{
    try {
      const sched=generateRecurringSchedule(r);
      sched.filter(s=>s.status==='upcoming'||s.status==='current'||s.status==='missed').forEach(s=>{
        // skip if a recurring transaction was already recorded on this exact date
        if(appliedRecurDates.has(s.date)) return;
        if(s.date>=ms&&s.date<=me) dayRecurMap[s.date]=(dayRecurMap[s.date]||0)+1;
      });
    } catch(e){}
  });

  // Goal deadline dates
  const dayGoalMap={};
  db.goals.filter(g=>g.targetDate&&g.status!=='achieved').forEach(g=>{
    if(g.targetDate>=ms&&g.targetDate<=me) dayGoalMap[g.targetDate]=(dayGoalMap[g.targetDate]||0)+1;
  });

  const days=['Su','Mo','Tu','We','Th','Fr','Sa'];
  let html=`<div style="background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;overflow:hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <button onclick="navHomeCal(-1)" style="background:var(--bg3);border:none;color:var(--text);width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">‹</button>
      <div style="font-size:13px;font-weight:700;color:var(--accent)">${monthName}</div>
      <button onclick="navHomeCal(1)" style="background:var(--bg3);border:none;color:var(--text);width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">›</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:4px">
      ${days.map(d=>`<div style="text-align:center;font-size:9px;color:var(--text3);font-weight:700;padding:2px 0;text-transform:uppercase;letter-spacing:0.5px">${d}</div>`).join('')}
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px">`;

  for(let i=0;i<firstDay;i++)html+=`<div></div>`;

  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===todayStr;
    const isFuture=ds>todayStr;
    const data=dayData[ds]||{exp:0,inc:0};
    const pdMap=dayPlannedMap[ds]||{planned:0,overdue:0};
    const hasOverdue=pdMap.overdue>0;
    const hasPlanned=pdMap.planned>0;
    const hasPayable=!!dayPayableMap[ds];
    const hasRecur=!!dayRecurMap[ds];
    const hasGoal=!!dayGoalMap[ds];
    const hasAnyEvent=data.exp>0||data.inc>0||hasOverdue||hasPlanned||hasPayable||hasRecur||hasGoal;

    const numColor=isFuture?'var(--text3)':'var(--text)';
    const todayCircle=isToday?'background:var(--accent);border-radius:50%;color:#fff;width:22px;height:22px;':'';
    const cellBg=isToday?'rgba(124,131,253,0.10)':hasOverdue?'rgba(225,29,72,0.07)':'transparent';
    const cellBorder=isToday?'1.5px solid rgba(124,131,253,0.45)':
      hasOverdue?'1px solid rgba(225,29,72,0.35)':
      hasPayable?'1px solid rgba(245,158,11,0.30)':
      hasPlanned?'1px solid rgba(244,169,90,0.25)':
      hasGoal?'1px solid rgba(16,185,129,0.25)':
      hasRecur?'1px solid rgba(20,184,166,0.20)':'1px solid transparent';

    const expLabel=data.exp>0?`<div style="font-size:8.5px;font-weight:700;color:var(--expense);line-height:1.2;text-align:center">-${fmtK(data.exp)}</div>`:'';
    const incLabel=data.inc>0?`<div style="font-size:8.5px;font-weight:700;color:var(--income);line-height:1.2;text-align:center">+${fmtK(data.inc)}</div>`:'';

    let dotHtml='';
    if(hasOverdue)dotHtml+=`<div style="width:4px;height:4px;border-radius:50%;background:var(--overdue);display:inline-block;margin:0 1px"></div>`;
    if(hasPlanned)dotHtml+=`<div style="width:4px;height:4px;border-radius:50%;background:var(--planned);display:inline-block;margin:0 1px"></div>`;
    if(hasPayable)dotHtml+=`<div style="width:4px;height:4px;border-radius:50%;background:var(--amber);display:inline-block;margin:0 1px"></div>`;
    if(hasGoal)dotHtml+=`<div style="width:4px;height:4px;border-radius:50%;background:var(--emerald);display:inline-block;margin:0 1px"></div>`;
    if(hasRecur)dotHtml+=`<div style="width:4px;height:4px;border-radius:50%;background:var(--violet);display:inline-block;margin:0 1px"></div>`;
    const dotsRow=dotHtml?`<div style="display:flex;justify-content:center;flex-wrap:wrap;margin-top:1px">${dotHtml}</div>`:'';

    html+=`<div onclick="openHomeDayDetail('${ds}')" style="display:flex;flex-direction:column;align-items:center;border-radius:8px;padding:4px 2px;min-height:52px;cursor:pointer;background:${cellBg};border:${cellBorder};transition:background 0.15s${!hasAnyEvent&&!isToday?';opacity:0.45':''}">
      <div style="font-size:11px;font-weight:700;line-height:22px;text-align:center;display:flex;align-items:center;justify-content:center;${todayCircle}color:${isToday?'#fff':numColor};flex-shrink:0">${d}</div>
      ${expLabel}
      ${incLabel}
      ${dotsRow}
    </div>`;
  }

  html+=`</div>
    <div style="display:flex;gap:8px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border);flex-wrap:wrap">
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="color:var(--expense);font-weight:700">-</span>Expense</span>
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="color:var(--income);font-weight:700">+</span>Income</span>
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="display:inline-block;width:6px;height:6px;background:var(--overdue);border-radius:50%"></span>Overdue</span>
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="display:inline-block;width:6px;height:6px;background:var(--amber);border-radius:50%"></span>Payable Due</span>
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="display:inline-block;width:6px;height:6px;background:var(--planned);border-radius:50%"></span>Planned</span>
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="display:inline-block;width:6px;height:6px;background:var(--violet);border-radius:50%"></span>Recurring</span>
      <span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text3)"><span style="display:inline-block;width:6px;height:6px;background:var(--emerald);border-radius:50%"></span>Goal</span>
    </div>
  </div>`;
  el.innerHTML=html;
}

function navHomeCal(dir){
  if(homeMiniCalYear===null){const now=new Date();homeMiniCalYear=now.getFullYear();homeMiniCalMonth=now.getMonth();}
  homeMiniCalMonth+=dir;
  if(homeMiniCalMonth>11){homeMiniCalMonth=0;homeMiniCalYear++;}
  if(homeMiniCalMonth<0){homeMiniCalMonth=11;homeMiniCalYear--;}
  renderHomeMiniCal();
}

function openHomeDayDetail(dateStr){
  const dayTxs=db.transactions.filter(t=>t.date===dateStr);
  const dayPlanned=db.planned.filter(p=>p.date===dateStr);
  const todayStr=today();

  // Payables: only show as upcoming if this date is an UNPAID due date
  const dayPayables=[];
  db.payables.filter(p=>p.status==='active'&&p.dueDay&&p.monthlyPayment>0).forEach(py=>{
    try {
      const sched=generatePayableSchedule(py);
      const thisEntry=sched.find(s=>s.date===dateStr&&(s.status==='overdue'||s.status==='current'||s.status==='upcoming'));
      if(thisEntry) dayPayables.push({py,entry:thisEntry});
    } catch(e){}
  });

  // Recurring: only show if this date has an upcoming/missed (not yet applied) occurrence
  const dayRecurring=[];
  db.recurring.filter(r=>r.status==='active').forEach(r=>{
    try {
      const sched=generateRecurringSchedule(r);
      const thisEntry=sched.find(s=>s.date===dateStr&&(s.status==='upcoming'||s.status==='current'||s.status==='missed'));
      if(thisEntry) dayRecurring.push({r,entry:thisEntry});
    } catch(e){}
  });

  // Goals with target date matching
  const dayGoals=db.goals.filter(g=>g.targetDate===dateStr&&g.status!=='achieved');

  if(!dayTxs.length&&!dayPlanned.length&&!dayPayables.length&&!dayRecurring.length&&!dayGoals.length){
    showToast('No activity on '+fmtDate(dateStr),'info');return;
  }
  const label=fmtDate(dateStr);
  let html=`<div style="font-size:13px;font-weight:700;color:var(--accent);margin-bottom:10px">📅 ${label}</div>`;

  // Payables due (unpaid only)
  if(dayPayables.length){
    html+=`<div style="font-size:10px;font-weight:700;color:var(--amber);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">💳 Payables Due (${dayPayables.length})</div>`;
    dayPayables.forEach(({py,entry})=>{
      const acc=py.linkedAccount?db.accounts.find(a=>a.id===py.linkedAccount):null;
      const isOverdue=entry.status==='overdue';
      const bg=isOverdue?'var(--rose-bg)':'var(--amber-bg)';
      const border=isOverdue?'rgba(225,29,72,.2)':'rgba(245,158,11,.2)';
      const statusBadge=isOverdue?`<span style="font-size:9px;font-weight:700;color:var(--rose)">⚠ OVERDUE</span>`:`<span style="font-size:9px;font-weight:700;color:var(--amber)">📅 DUE</span>`;
      html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border-radius:10px;background:${bg};border:1px solid ${border};margin-bottom:6px" onclick="closeModal('modal-day-detail');setTimeout(()=>openPayableSchedule('${py.id}'),100)">
        <div>
          <div style="font-size:13px;font-weight:700">💳 ${py.name}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">${PAYABLE_TYPES[py.type]||py.type}${acc?' · '+acc.name:''}</div>
          <div style="margin-top:3px">${statusBadge} <span style="font-size:10px;color:var(--text3)">Remaining: ${fmt(py.remaining||0)}</span></div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--expense)">-${fmt(py.monthlyPayment)}</div>
          <div style="font-size:9px;color:var(--text3);text-align:right;margin-top:2px">tap to pay</div>
        </div>
      </div>`;
    });
  }

  // Planned activities — exclude payable-linked items already shown in PAYABLES DUE above
  const shownPayableIds = new Set(dayPayables.map(({py})=>py.id));
  const filteredPlanned = dayPlanned.filter(p => !p.payableId || !shownPayableIds.has(p.payableId));
  if(filteredPlanned.length){
    html+=`<div style="font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;margin-top:${dayPayables.length?'10px':'0'}">📅 Planned (${filteredPlanned.length})</div>`;
    filteredPlanned.forEach(p=>{
      const tc=p.type==='expense'?'var(--expense)':p.type==='income'?'var(--income)':'var(--transfer)';
      const acc=db.accounts.find(a=>a.id===p.accountId);
      const statusColor=p.date<todayStr?'var(--rose)':p.date===todayStr?'var(--amber)':'var(--blue)';
      const statusLabel=p.date<todayStr?'OVERDUE':p.date===todayStr?'TODAY':'UPCOMING';
      const payable=p.payableId?db.payables.find(py=>py.id===p.payableId):null;
      const nameToShow=payable?payable.name:(p.desc||p.category.replace(/^\S+\s/,''));
      html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border-radius:10px;background:var(--bg3);border:1px solid var(--border);margin-bottom:6px;cursor:pointer" onclick="closeModal('modal-day-detail');setTimeout(()=>{ showScreen('goals');setTimeout(()=>showGoalsTab('planned',document.querySelectorAll('#screen-goals .screen-tab')[3]),50); },50)">
        <div>
          <div style="font-size:13px;font-weight:700">${p.category.split(' ')[0]} ${nameToShow}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">${p.category.replace(/^\S+\s/,'')}${acc?' · '+acc.name:''}</div>
          ${p.desc&&!payable?`<div style="font-size:10px;color:var(--text3)">${p.desc}</div>`:''}
          <span style="font-size:9px;font-weight:700;color:${statusColor};background:${p.date<todayStr?'var(--rose-bg)':p.date===todayStr?'var(--amber-bg)':'var(--blue-bg)'};padding:1px 6px;border-radius:4px">${statusLabel}</span>
        </div>
        <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:${tc}">${fmt(p.amount)}</div>
      </div>`;
    });
  }

  // Upcoming/missed recurring (not yet applied)
  if(dayRecurring.length){
    html+=`<div style="font-size:10px;font-weight:700;color:var(--violet);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;margin-top:10px">🔄 Recurring (${dayRecurring.length})</div>`;
    dayRecurring.forEach(({r,entry})=>{
      const tc=r.type==='expense'?'var(--expense)':'var(--income)';
      const acc=db.accounts.find(a=>a.id===r.accountId);
      const isMissed=entry.status==='missed';
      const bg=isMissed?'var(--rose-bg)':'var(--violet-bg)';
      const border=isMissed?'rgba(225,29,72,.2)':'rgba(20,184,166,.2)';
      const badge=isMissed?`<span style="font-size:9px;font-weight:700;color:var(--rose)">⚠ MISSED</span>`:`<span style="font-size:9px;font-weight:700;color:var(--violet)">🔄 ${entry.status==='current'?'TODAY':'UPCOMING'}</span>`;
      html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border-radius:10px;background:${bg};border:1px solid ${border};margin-bottom:6px" onclick="closeModal('modal-day-detail');setTimeout(()=>openRecurringSchedule('${r.id}'),100)">
        <div>
          <div style="font-size:13px;font-weight:700">🔄 ${r.name}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">${r.category.replace(/^\S+\s/,'')}${acc?' · '+acc.name:''} · ${RECUR_FREQ_LABELS[r.frequency]}</div>
          <div style="margin-top:3px">${badge}</div>
        </div>
        <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:${tc}">${r.type==='expense'?'-':'+'}${fmt(r.amount)}</div>
      </div>`;
    });
  }

  // Goals reaching target
  if(dayGoals.length){
    html+=`<div style="font-size:10px;font-weight:700;color:var(--emerald);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;margin-top:10px">🎯 Goal Deadline (${dayGoals.length})</div>`;
    dayGoals.forEach(g=>{
      const pct=Math.min(100,(g.saved/g.target)*100);
      html+=`<div style="padding:9px 10px;border-radius:10px;background:var(--emerald-bg);border:1px solid rgba(16,185,129,.2);margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-size:13px;font-weight:700">${g.emoji||'🎯'} ${g.name}</div>
          <div style="font-size:11px;font-weight:700;color:var(--emerald)">${pct.toFixed(0)}%</div>
        </div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">${fmt(g.saved)} saved of ${fmt(g.target)} target</div>
        <div style="background:var(--bg3);border-radius:99px;height:3px;margin-top:5px;overflow:hidden"><div style="width:${pct.toFixed(1)}%;height:100%;background:var(--emerald);border-radius:99px"></div></div>
      </div>`;
    });
  }

  // Transactions (paid payables + applied recurring appear here as expenses/income naturally)
  if(dayTxs.length){
    html+=`<div style="font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin:${(dayPlanned.length||dayPayables.length||dayRecurring.length||dayGoals.length)?'10px 0 6px':'0 0 6px'}">📊 Transactions (${dayTxs.length})</div>`;
    dayTxs.forEach(tx=>{
      const sign=tx.type==='expense'?'-':'+';
      const tc=tx.type==='expense'?'var(--expense)':tx.type==='income'?'var(--income)':'var(--transfer)';
      const acc=db.accounts.find(a=>a.id===tx.accountId);
      html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="closeModal('modal-day-detail');viewTx('${tx.id}')">
        <div>
          <div style="font-size:12px;font-weight:600">${tx.category.split(' ')[0]} ${tx.category.replace(/^\S+\s/,'')}</div>
          ${(tx.desc||acc)?`<div style="font-size:10px;color:var(--text3)">${acc?acc.name:''}${tx.desc?' · '+tx.desc:''}</div>`:''}
        </div>
        <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:${tc}">${sign}${fmt(tx.amount)}</div>
      </div>`;
    });
  }
  document.getElementById('day-detail-modal-content').innerHTML=html;
  openModal('modal-day-detail');
}

function renderTxList(container,txs){
  if(!txs.length){container.innerHTML=`<div class="empty"><div class="empty-icon">📭</div><p>No transactions in this period.</p></div>`;return;}
  container.innerHTML=txs.map(tx=>{
    const acc=db.accounts.find(a=>a.id===tx.accountId);
    const toAcc=tx.toAccountId?db.accounts.find(a=>a.id===tx.toAccountId):null;
    const sign=tx.type==='expense'?'-':tx.type==='income'?'+':'⇄';
    const amtDisplay=priv.transactions?'<span class="hidden-amount">••••</span>':`${sign} ${fmt(tx.amount)}`;
    return `<div class="tx-item" onclick="viewTx('${tx.id}')">
      <div class="tx-icon ${tx.type}">${tx.category.split(' ')[0]}</div>
      <div class="tx-info">
        <div class="tx-cat">${tx.category.replace(/^\S+\s/,'')}${tx.receipt?' 📎':''}</div>
        <div class="tx-desc">${acc?acc.name:''}${toAcc?' → '+toAcc.name:''}${tx.desc?' • '+tx.desc:''}</div>
        ${tx.ref?`<div class="tx-ref">Ref: ${tx.ref}</div>`:''}
      </div>
      <div class="tx-right">
        <div class="tx-amount ${priv.transactions?'':tx.type}">${amtDisplay}</div>
        <div class="tx-date">${tx.date}</div>
      </div>
    </div>`;
  }).join('');
}
function renderTrendChart(){
  const ctx=document.getElementById('trend-chart');if(!ctx)return;
  const labels=[],expData=[],incData=[];
  const now=new Date();
  let titleText='7-Day Spending Trend';

  if(currentPeriod==='daily'){
    // Last 7 days
    titleText='Last 7 Days';
    for(let i=6;i>=0;i--){
      const d=new Date(now);d.setDate(d.getDate()-i);
      const ds=d.toISOString().split('T')[0];
      labels.push(d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}));
      const dt=db.transactions.filter(t=>t.date===ds);
      expData.push(dt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));
      incData.push(dt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
    }
  } else if(currentPeriod==='weekly'){
    // Last 8 weeks
    titleText='Last 8 Weeks';
    for(let i=7;i>=0;i--){
      const wEnd=new Date(now);wEnd.setDate(now.getDate()-now.getDay()-i*7+6);
      const wStart=new Date(wEnd);wStart.setDate(wEnd.getDate()-6);
      const ws=wStart.toISOString().split('T')[0];
      const we=wEnd.toISOString().split('T')[0];
      labels.push('W'+wEnd.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
      const dt=db.transactions.filter(t=>t.date>=ws&&t.date<=we);
      expData.push(dt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));
      incData.push(dt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
    }
  } else if(currentPeriod==='monthly'){
    // Last 6 months
    titleText='Last 6 Months';
    for(let i=5;i>=0;i--){
      const d=new Date(now.getFullYear(),now.getMonth()-i,1);
      const ms=d.toISOString().split('T')[0];
      const me=new Date(d.getFullYear(),d.getMonth()+1,0).toISOString().split('T')[0];
      labels.push(d.toLocaleDateString('en-US',{month:'short',year:'2-digit'}));
      const dt=db.transactions.filter(t=>t.date>=ms&&t.date<=me);
      expData.push(dt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));
      incData.push(dt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
    }
  } else if(currentPeriod==='yearly'){
    // Last 3 years
    titleText='Last 3 Years';
    for(let i=2;i>=0;i--){
      const y=now.getFullYear()-i;
      labels.push(String(y));
      const dt=db.transactions.filter(t=>t.date.startsWith(String(y)));
      expData.push(dt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));
      incData.push(dt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
    }
  }

  const titleEl=document.getElementById('trend-chart-title');
  if(titleEl)titleEl.textContent=titleText;
  if(trendChart)trendChart.destroy();
  trendChart=new Chart(ctx,{type:'line',data:{labels,datasets:[
    {label:'Expense',data:expData,borderColor:'#f06292',backgroundColor:'rgba(240,98,146,0.1)',tension:0.4,fill:true,pointRadius:3},
    {label:'Income',data:incData,borderColor:'#56c8a0',backgroundColor:'rgba(86,200,160,0.1)',tension:0.4,fill:true,pointRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:getThemeColors().text2,font:{size:10}}}},scales:{x:{ticks:{color:getThemeColors().text3,font:{size:9},maxRotation:45},grid:{color:getThemeColors().border}},y:{ticks:{color:getThemeColors().text3,font:{size:10},callback:v=>getCurrency()+v},grid:{color:getThemeColors().border}}}}});
}

// ===== RENDER TRANSACTIONS =====
function renderTransactions(){
  const txs=filterByPeriod(db.transactions,currentTxPeriod);
  const grouped={};txs.forEach(tx=>{if(!grouped[tx.date])grouped[tx.date]=[];grouped[tx.date].push(tx);});
  const area=document.getElementById('tx-list-area');
  if(!txs.length){area.innerHTML=`<div class="empty"><div class="empty-icon">📭</div><p>No transactions in this period.</p></div>`;return;}
  area.innerHTML=Object.keys(grouped).sort((a,b)=>b.localeCompare(a)).map(d=>{
    const dt=grouped[d];
    const dayExp=dt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const dayInc=dt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const dayIncDisplay=priv.transactions?'<span class="hidden-amount">••••</span>':fmt(dayInc);
    const dayExpDisplay=priv.transactions?'<span class="hidden-amount">••••</span>':fmt(dayExp);
    return `<div class="card" style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
        <div style="font-size:12px;font-weight:600;color:var(--text2)">${new Date(d+'T00:00:00').toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})}</div>
        <div style="font-size:11px">${dayInc>0?`<span style="color:var(--income)">+${dayIncDisplay}</span> `:''}${dayExp>0?`<span style="color:var(--expense)">-${dayExpDisplay}</span>`:''}</div>
      </div>
      ${dt.map(tx=>{
        const acc=db.accounts.find(a=>a.id===tx.accountId);
        const toAcc=tx.toAccountId?db.accounts.find(a=>a.id===tx.toAccountId):null;
        const sign=tx.type==='expense'?'-':tx.type==='income'?'+':'⇄';
        const amtDisplay=priv.transactions?'<span class="hidden-amount">••••</span>':`${sign} ${fmt(tx.amount)}`;
        return `<div class="tx-item" onclick="viewTx('${tx.id}')">
          <div class="tx-icon ${tx.type}">${tx.category.split(' ')[0]}</div>
          <div class="tx-info">
            <div class="tx-cat">${tx.category.replace(/^\S+\s/,'')}${tx.receipt?' 📎':''}</div>
            <div class="tx-desc">${acc?acc.name:''}${toAcc?' → '+toAcc.name:''}${tx.desc?' • '+tx.desc:''}</div>
            ${tx.ref?`<div class="tx-ref">Ref: ${tx.ref}</div>`:''}
          </div>
          <div class="tx-right"><div class="tx-amount ${priv.transactions?'':tx.type}">${amtDisplay}</div><div class="tx-date"><span class="pill ${tx.type}">${tx.type}</span></div></div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
}

// ===== PLANNED =====
function showPlannedTab(tab,btn){
  currentPlannedTab=tab;
  document.querySelectorAll('.screen-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');renderPlanned();
}
function renderPlanned(){
  const c=document.getElementById('goals-content')||document.getElementById('planned-content');
  if(!c)return;
  if(currentPlannedTab==='calendar')renderCalendar(c);
  else if(currentPlannedTab==='list')renderPlannedList(c);
  else if(currentPlannedTab==='overdue')renderOverdue(c);
  else renderLogs(c);
}

// ===== CALENDAR WITH DAILY TOTALS =====
function renderCalendar(container){
  const now=new Date();
  if(!calYear)calYear=now.getFullYear();
  if(calMonth===undefined)calMonth=now.getMonth();
  const todayStr=today();
  const firstDow=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];

  // Build maps
  const txMap={},plMap={};
  db.transactions.forEach(tx=>{
    const k=tx.date;
    if(!txMap[k])txMap[k]={exp:0,inc:0};
    if(tx.type==='expense')txMap[k].exp+=tx.amount;
    else if(tx.type==='income')txMap[k].inc+=tx.amount;
  });
  db.planned.filter(p=>p.status==='pending').forEach(p=>{
    if(!plMap[p.date])plMap[p.date]={hasPlanned:false,hasOverdue:false,hasPayable:false,hasGoal:false,hasRecur:false};
    plMap[p.date].hasPlanned=true;
    if(p.date<todayStr)plMap[p.date].hasOverdue=true;
  });

  // Payable dots — only UNPAID scheduled dates
  const ms2=`${calYear}-${String(calMonth+1).padStart(2,'0')}-01`;
  const me2=localMonthEnd(calYear,calMonth);
  db.payables.filter(p=>p.status==='active'&&p.dueDay&&p.monthlyPayment>0).forEach(py=>{
    try {
      const sched=generatePayableSchedule(py);
      sched.filter(s=>s.status==='overdue'||s.status==='current'||s.status==='upcoming').forEach(s=>{
        if(s.date>=ms2&&s.date<=me2){
          if(!plMap[s.date])plMap[s.date]={hasPlanned:false,hasOverdue:false,hasPayable:false,hasGoal:false,hasRecur:false};
          plMap[s.date].hasPayable=true;
          if(s.status==='overdue')plMap[s.date].hasOverdue=true;
        }
      });
    } catch(e){}
  });

  // Recurring dots — only upcoming/missed occurrences
  db.recurring.filter(r=>r.status!=='paused').forEach(r=>{
    try {
      const sched=generateRecurringSchedule(r);
      sched.filter(s=>s.status==='upcoming'||s.status==='current'||s.status==='missed').forEach(s=>{
        if(s.date>=ms2&&s.date<=me2){
          if(!plMap[s.date])plMap[s.date]={hasPlanned:false,hasOverdue:false,hasPayable:false,hasGoal:false,hasRecur:false};
          plMap[s.date].hasRecur=true;
          if(s.status==='missed')plMap[s.date].hasOverdue=true;
        }
      });
    } catch(e){}
  });

  // Goal target dates
  db.goals.filter(g=>g.targetDate&&g.status!=='achieved').forEach(g=>{
    if(g.targetDate>=ms2&&g.targetDate<=me2){
      if(!plMap[g.targetDate])plMap[g.targetDate]={hasPlanned:false,hasOverdue:false,hasPayable:false,hasGoal:false,hasRecur:false};
      plMap[g.targetDate].hasGoal=true;
    }
  });

  let cells='';
  for(let i=0;i<firstDow;i++)cells+=`<div class="cal-cell empty"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===todayStr;
    const isSel=ds===calSelectedDate;
    const td=txMap[ds];
    const pd=plMap[ds];
    let dotHtml='';
    if(pd){
      if(pd.hasOverdue)dotHtml+=`<div class="cal-dot overdue"></div>`;
      if(pd.hasPayable&&!pd.hasOverdue)dotHtml+=`<div class="cal-dot" style="background:var(--amber)"></div>`;
      if(pd.hasPlanned)dotHtml+=`<div class="cal-dot planned"></div>`;
      if(pd.hasGoal)dotHtml+=`<div class="cal-dot" style="background:var(--emerald)"></div>`;
      if(pd.hasRecur&&!pd.hasOverdue)dotHtml+=`<div class="cal-dot" style="background:var(--violet)"></div>`;
    }
    cells+=`<div class="cal-cell${isToday?' today':''}${isSel?' selected':''} ${td||dotHtml?'':'empty-day'}" onclick="calCellClick('${ds}')">
      <div class="cal-num">${d}</div>
      ${td&&td.exp>0?`<div class="cal-exp">-${shortFmt(td.exp)}</div>`:''}
      ${td&&td.inc>0?`<div class="cal-inc">+${shortFmt(td.inc)}</div>`:''}
      <div style="display:flex;justify-content:center;flex-wrap:wrap">${dotHtml}</div>
    </div>`;
  }

  const dayDetailHtml=calSelectedDate?buildDayDetail(calSelectedDate):'';

  container.innerHTML=`
    <div class="card">
      <div class="cal-nav">
        <button onclick="calNav(-1)">‹</button>
        <div class="cal-month">${MONTHS[calMonth]} ${calYear}</div>
        <button onclick="calNav(1)">›</button>
      </div>
      <div class="cal-day-labels">${['Su','Mo','Tu','We','Th','Fr','Sa'].map(l=>`<div class="cal-dl">${l}</div>`).join('')}</div>
      <div class="cal-grid">${cells}</div>
      <div style="display:flex;gap:10px;font-size:10px;color:var(--text3);margin-top:10px;flex-wrap:wrap">
        <span style="color:var(--expense)">▪ Expenses</span>
        <span style="color:var(--income)">▪ Income</span>
        <span style="color:var(--rose)">🔴 Overdue</span>
        <span style="color:var(--amber)">🟡 Payable</span>
        <span style="color:var(--planned)">🟠 Planned</span>
        <span style="color:var(--emerald)">🟢 Goal</span>
        <span style="color:var(--violet)">🔵 Recurring</span>
      </div>
    </div>
    ${dayDetailHtml}
  `;
}

function shortFmt(n){
  if(n>=1000000)return(n/1000000).toFixed(1)+'M';
  if(n>=1000)return(n/1000).toFixed(1)+'K';
  return n.toFixed(0);
}

function calCellClick(ds){
  if(calSelectedDate===ds){calSelectedDate=null;}else{calSelectedDate=ds;}
  renderPlanned();
}

function buildDayDetail(ds){
  const dayTxs=db.transactions.filter(t=>t.date===ds);
  const dayPlanned=db.planned.filter(p=>p.date===ds&&p.status==='pending');
  const dayExp=dayTxs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const dayInc=dayTxs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const dayNet=dayInc-dayExp;

  let txHtml='';
  if(dayTxs.length){
    txHtml=`<div style="margin-bottom:8px">
      ${dayTxs.map(tx=>{
        const acc=db.accounts.find(a=>a.id===tx.accountId);
        const sign=tx.type==='expense'?'-':tx.type==='income'?'+':'⇄';
        return `<div class="tx-item" onclick="viewTx('${tx.id}')" style="border-bottom:1px solid var(--border);padding:10px 0">
          <div class="tx-icon ${tx.type}" style="width:34px;height:34px;font-size:14px">${tx.category.split(' ')[0]}</div>
          <div class="tx-info">
            <div class="tx-cat" style="font-size:12px">${tx.category.replace(/^\S+\s/,'')}</div>
            <div class="tx-desc">${acc?acc.name:''}${tx.desc?' • '+tx.desc:''}</div>
          </div>
          <div class="tx-right"><div class="tx-amount ${tx.type}" style="font-size:13px">${sign} ${fmt(tx.amount)}</div></div>
        </div>`;
      }).join('')}
    </div>`;
  }

  let plHtml='';
  if(dayPlanned.length){
    plHtml=`<div style="margin-top:10px"><div style="font-size:11px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Planned Activities</div>${renderPlannedItemsHTML(dayPlanned)}</div>`;
  }

  return `<div class="day-detail-panel">
    <div class="day-detail-header">
      <div>
        <div style="font-size:14px;font-weight:700">${fmtShort(ds)}</div>
        <div style="display:flex;gap:10px;margin-top:4px;font-size:11px">
          ${dayInc>0?`<span style="color:var(--income)">+${fmt(dayInc)}</span>`:''}
          ${dayExp>0?`<span style="color:var(--expense)">-${fmt(dayExp)}</span>`:''}
          <span style="color:${dayNet>=0?'var(--accent2)':'var(--danger)'}">Net: ${fmt(dayNet)}</span>
        </div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="day-detail-close" onclick="openAddTransactionForDate('${ds}')">➕</button>
        <button class="day-detail-close" onclick="calSelectedDate=null;renderPlanned()">✕</button>
      </div>
    </div>
    ${dayTxs.length?txHtml:'<div style="text-align:center;color:var(--text3);font-size:12px;padding:12px 0">No transactions on this day</div>'}
    ${plHtml}
  </div>`;
}

function openAddTransactionForDate(ds){
  openAddTransaction();
  setTimeout(()=>document.getElementById('tx-date').value=ds,100);
}

function calNav(dir){calMonth+=dir;if(calMonth<0){calMonth=11;calYear--;}if(calMonth>11){calMonth=0;calYear++;}calSelectedDate=null;renderPlanned();}

// ===== PLANNED LIST =====
function renderPlannedList(container){
  const pending=db.planned.filter(p=>p.status==='pending').sort((a,b)=>a.date.localeCompare(b.date));
  const done=db.planned.filter(p=>p.status==='done').sort((a,b)=>b.date.localeCompare(a.date));
  if(!pending.length&&!done.length){container.innerHTML=`<div class="empty"><div class="empty-icon">📅</div><p>No planned activities.<br>Tap + to add one.</p></div>`;return;}
  let html='';
  if(pending.length){html+=`<div class="section-title">Pending (${pending.length})</div>${renderPlannedItemsHTML(pending)}`;}
  if(done.length){html+=`<div class="section-title" style="margin-top:16px">Completed (${done.length})</div>${done.slice(0,15).map(p=>{const acc=db.accounts.find(a=>a.id===p.accountId);return`<div class="planned-item" style="opacity:0.55"><div class="planned-header"><div class="planned-cat">${p.category}</div><div class="planned-amount" style="color:var(--income)">${fmt(p.amount)}</div></div><div class="planned-meta"><span class="planned-badge done">DONE</span><span>${acc?acc.name:''}</span><span>${fmtDate(p.actualDate||p.date)}</span></div></div>`;}).join('')}`;}
  container.innerHTML=html;
}
function renderOverdue(container){
  const t=today();
  const overdue=db.planned.filter(p=>p.status==='pending'&&p.date<t).sort((a,b)=>a.date.localeCompare(b.date));
  if(!overdue.length){container.innerHTML=`<div class="empty"><div class="empty-icon">✅</div><p>No overdue activities!<br>You're all caught up.</p></div>`;return;}
  container.innerHTML=`<div style="background:rgba(255,107,107,0.1);border:1px solid var(--overdue);border-radius:12px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--overdue)">⚠️ You have ${overdue.length} overdue ${overdue.length===1?'activity':'activities'}. Please review them.</div>${renderPlannedItemsHTML(overdue)}`;
}
function renderLogs(container){
  if(!db.logs.length){container.innerHTML=`<div class="empty"><div class="empty-icon">📜</div><p>No change logs yet.</p></div>`;return;}
  container.innerHTML=`<div class="card">${db.logs.slice(0,100).map(log=>{const dt=new Date(log.timestamp);const ts=dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});return`<div class="log-item"><div class="log-header"><div><span class="log-type ${log.type}">${log.type.toUpperCase().replace('-',' ')}</span></div><div class="log-time">${ts}</div></div><div class="log-detail">${log.detail}</div></div>`;}).join('')}</div>`;
}

function renderPlannedItemsHTML(items){
  const t=today();
  return items.map(p=>{
    const acc=db.accounts.find(a=>a.id===p.accountId);
    const toAcc=p.toAccountId?db.accounts.find(a=>a.id===p.toAccountId):null;
    const status=p.date<t?'overdue':p.date===t?'today':'upcoming';
    const tc=p.type==='expense'?'var(--expense)':p.type==='income'?'var(--income)':'var(--transfer)';
    // Balance check for payable-linked items
    let balWarn='';
    if(p.payableId&&acc&&p.amount>acc.balance){
      const py=db.payables.find(py=>py.id===p.payableId);
      balWarn=`<div style="background:rgba(255,107,107,0.1);border:1px solid var(--overdue);border-radius:8px;padding:8px 10px;font-size:11px;color:var(--overdue);margin-top:6px">⚠️ ${acc.name} has only ${fmt(acc.balance)} — not enough for this ${py?py.name:'payable'} payment of ${fmt(p.amount)}. Please transfer funds before this date.</div>`;
    }
    return `<div class="planned-item ${status}">
      <div class="planned-header">
        <div class="planned-cat">${p.category}${p.payableId?' 💳':''}</div>
        <div class="planned-amount" style="color:${tc}">${fmt(p.amount)}</div>
      </div>
      <div class="planned-meta">
        <span class="planned-badge ${status}">${status.toUpperCase()}</span>
        <span>${acc?acc.name:''}${toAcc?' → '+toAcc.name:''}</span>
        <span>${fmtDate(p.date)}</span>
      </div>
      ${p.desc?`<div style="font-size:11px;color:var(--text3);margin-top:4px">${p.desc}</div>`:''}
      ${balWarn}
      <div class="planned-actions">
        <button type="button" class="planned-btn confirm" onclick="openConfirmPlanned('${p.id}')">✅ Confirm</button>
        <button type="button" class="planned-btn skip" onclick="quickSkip('${p.id}')">⏭ Skip</button>
        <button type="button" class="planned-btn edit-btn" onclick="openEditPlanned('${p.id}')">✏️ Edit</button>
      </div>
    </div>`;
  }).join('');
}

// ===== PLANNED CRUD =====
function openAddPlanned(prefillDate){
  editingPlannedId=null;currentPlannedType='expense';
  document.getElementById('modal-planned-title').textContent='Add Planned Activity';
  document.getElementById('pl-amount').value='';
  document.getElementById('pl-ref').value='';
  document.getElementById('pl-desc').value='';
  document.getElementById('pl-date').value=prefillDate||today();
  document.getElementById('pl-delete-btn').style.display='none';
  document.getElementById('pl-save-btn').textContent='Save Planned Activity';
  dismissFormVAI('planned');
  const vInp=document.getElementById('planned-vai-input');if(vInp)vInp.value='';
  setPlannedType('expense',document.querySelector('#modal-planned .type-tab.expense'));
  fillAccDropdowns();openModal('modal-planned');
}
function setPlannedType(type,btn){
  currentPlannedType=type;
  document.querySelectorAll('#modal-planned .type-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const cats=type==='expense'?EXPENSE_CATS:type==='income'?INCOME_CATS:TRANSFER_CATS;
  document.getElementById('pl-category').innerHTML=cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  const ag=document.getElementById('pl-account-group'),fg=document.getElementById('pl-from-group'),tg=document.getElementById('pl-to-group');
  if(type==='transfer'){ag.style.display='none';fg.style.display='';tg.style.display='';}
  else{ag.style.display='';fg.style.display='none';tg.style.display='none';}
  fillAccDropdowns();
}
function setQuickDate(days){const d=new Date();d.setDate(d.getDate()+days);document.getElementById('pl-date').value=d.toISOString().split('T')[0];}
function savePlanned(){
  const amount=parseFloat(document.getElementById('pl-amount').value);
  const category=document.getElementById('pl-category').value;
  const date=document.getElementById('pl-date').value;
  const ref=document.getElementById('pl-ref').value.trim();
  const desc=document.getElementById('pl-desc').value.trim();
  if(!amount||amount<=0){showToast('Please enter a valid amount','error');return;}
  if(!date){showToast('Please select a date','error');return;}
  let accountId,toAccountId;
  if(currentPlannedType==='transfer'){accountId=document.getElementById('pl-from-account').value;toAccountId=document.getElementById('pl-to').value;if(accountId===toAccountId){showToast('Cannot transfer to same account','error');return;}}
  else accountId=document.getElementById('pl-account').value;
  if(editingPlannedId){const old=db.planned.find(p=>p.id===editingPlannedId);if(old&&old.date!==date)addLog('date-changed',`Date changed: ${fmtDate(old.date)} → ${fmtDate(date)} | ${old.category} ${fmt(old.amount)}`,editingPlannedId,'planned');db.planned=db.planned.filter(p=>p.id!==editingPlannedId);}
  const pl={id:editingPlannedId||uid(),type:currentPlannedType,amount,category,accountId,toAccountId,date,ref,desc,status:'pending',originalDate:date,createdAt:Date.now()};
  db.planned.unshift(pl);
  if(!editingPlannedId)addLog('created',`Planned ${pl.type}: ${pl.category} ${fmt(amount)} on ${fmtDate(date)}`,pl.id,'planned');
  saveDB();closeModal('modal-planned');showToast(editingPlannedId?'Planned activity updated!':'Planned activity saved! 📅');
  editingPlannedId=null;renderPlanned();updateOverdueBadge();
}
function openEditPlanned(id){
  const pl=db.planned.find(p=>p.id===id);if(!pl)return;
  editingPlannedId=id;currentPlannedType=pl.type;
  document.getElementById('modal-planned-title').textContent='Edit Planned Activity';
  document.getElementById('pl-delete-btn').style.display='';
  document.getElementById('pl-save-btn').textContent='Update';
  setPlannedType(pl.type,document.querySelector(`#modal-planned .type-tab.${pl.type}`));
  document.getElementById('pl-amount').value=pl.amount;
  document.getElementById('pl-date').value=pl.date;
  document.getElementById('pl-ref').value=pl.ref||'';
  document.getElementById('pl-desc').value=pl.desc||'';
  const cats=pl.type==='expense'?EXPENSE_CATS:pl.type==='income'?INCOME_CATS:TRANSFER_CATS;
  document.getElementById('pl-category').innerHTML=cats.map(c=>`<option value="${c}"${c===pl.category?' selected':''}>${c}</option>`).join('');
  if(pl.type==='transfer'){document.getElementById('pl-from-account').value=pl.accountId;document.getElementById('pl-to').value=pl.toAccountId;}
  else document.getElementById('pl-account').value=pl.accountId;
  fillAccDropdowns();openModal('modal-planned');
}
function deletePlanned(){showConfirm('Delete Planned Activity?','',()=>{db.planned=db.planned.filter(p=>p.id!==editingPlannedId);saveDB();closeModal('modal-planned');showToast('Deleted','error');editingPlannedId=null;renderPlanned();updateOverdueBadge();});}

// ===== CONFIRM PLANNED =====
function openConfirmPlanned(id){
  const pl=db.planned.find(p=>p.id===id);if(!pl)return;
  confirmingPlannedId=id;
  const acc=db.accounts.find(a=>a.id===pl.accountId);
  const toAcc=pl.toAccountId?db.accounts.find(a=>a.id===pl.toAccountId):null;
  const tc=pl.type==='expense'?'var(--expense)':pl.type==='income'?'var(--income)':'var(--transfer)';
  document.getElementById('confirm-planned-detail').innerHTML=`<div class="card-sm" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">${pl.category.split(' ')[0]}</div><div style="font-family:'Space Mono',monospace;font-size:20px;font-weight:700;color:${tc}">${fmt(pl.amount)}</div><div style="font-size:12px;color:var(--text2);margin-top:4px">${pl.category} • ${acc?acc.name:''}${toAcc?' → '+toAcc.name:''}</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Planned: ${fmtDate(pl.date)}</div></div>`;
  document.getElementById('confirm-actual-date').value=today();
  const feeEl=document.getElementById('confirm-tx-fee');if(feeEl)feeEl.value='';
  const wEl=document.getElementById('confirm-balance-warning');
  if(pl.type==='expense'||pl.type==='transfer'){const a=db.accounts.find(x=>x.id===pl.accountId);if(a&&pl.amount>a.balance){wEl.style.display='block';wEl.textContent=`⚠️ Insufficient balance! ${a.name} has ${fmt(a.balance)} but needs ${fmt(pl.amount)}.`;}else wEl.style.display='none';}
  else wEl.style.display='none';
  openModal('modal-confirm-planned');
}
function executeConfirmPlanned(){
  const pl=db.planned.find(p=>p.id===confirmingPlannedId);if(!pl)return;
  const actualDate=document.getElementById('confirm-actual-date').value||today();
  if(pl.type==='expense'||pl.type==='transfer'){const acc=db.accounts.find(a=>a.id===pl.accountId);if(acc&&pl.amount>acc.balance){showToast(`❌ Insufficient balance! ${acc.name} has ${fmt(acc.balance)}`,'error');return;}}
  const tx={id:uid(),type:pl.type,amount:pl.amount,category:pl.category,accountId:pl.accountId,toAccountId:pl.toAccountId,date:actualDate,ref:pl.ref,desc:(pl.desc?pl.desc+' ':'')+`[Planned: ${fmtDate(pl.originalDate||pl.date)}]`,receipt:null,createdAt:Date.now(),fromPlanned:pl.id};
  db.transactions.unshift(tx);applyTransaction(tx);
  // Record fee if provided
  const txFee=parseFloat(document.getElementById('confirm-tx-fee')?.value)||0;
  if(txFee>0){
    const feeAcc=db.accounts.find(a=>a.id===pl.accountId);
    if(feeAcc)feeAcc.balance-=txFee;
    const feeTx={id:uid(),type:'expense',amount:txFee,category:'💳 Fees',accountId:pl.accountId,date:actualDate,ref:'',desc:`Transaction Fee: ${pl.category}${pl.desc?' — '+pl.desc:''}`,receipt:null,createdAt:Date.now()};
    db.transactions.unshift(feeTx);
    addLog('created',`Transaction fee: ${fmt(txFee)}`,feeTx.id,'transaction');
  }
  pl.status='done';pl.actualDate=actualDate;pl.confirmedAt=Date.now();
  let logMsg=`Confirmed: ${pl.type} ${pl.category} ${fmt(pl.amount)}`;
  if(actualDate!==pl.date)logMsg+=` | Planned: ${fmtDate(pl.date)} → Actual: ${fmtDate(actualDate)}`;
  addLog('confirmed',logMsg,pl.id,'planned');
  saveDB();closeModal('modal-confirm-planned');showToast('Activity confirmed and recorded! ✅');
  renderPlanned();renderHome();renderTransactions();updateOverdueBadge();
}
function executeSkipPlanned(){
  const pl=db.planned.find(p=>p.id===confirmingPlannedId);if(!pl)return;
  pl.status='skipped';pl.skippedAt=Date.now();
  addLog('skipped',`Skipped: ${pl.type} ${pl.category} ${fmt(pl.amount)} (${fmtDate(pl.date)})`,pl.id,'planned');
  saveDB();closeModal('modal-confirm-planned');showToast('Activity skipped','warn');
  renderPlanned();updateOverdueBadge();
}
function quickSkip(id){confirmingPlannedId=id;executeSkipPlanned();}

// ===== LOGS =====
function addLog(type,detail,refId,refType='transaction'){db.logs.unshift({id:uid(),type,detail,refId,refType,timestamp:Date.now()});if(db.logs.length>500)db.logs=db.logs.slice(0,500);}
function updateOverdueBadge(){
  const t=today();const n=db.planned.filter(p=>p.status==='pending'&&p.date<t).length;
  const b=document.getElementById('overdue-badge');const tc=document.getElementById('overdue-count-tab');
  if(b){if(n>0){b.style.display='flex';b.textContent=n;}else{b.style.display='none';}}
  if(tc)tc.textContent=n>0?`(${n})`:'';
}

// ===== REPORTS =====
// FEATURE 2: Avg Daily Burn Rate added
function renderReports(){
  const{start,end}=getDateRange(currentReportPeriod);
  const txs=db.transactions.filter(t=>t.date>=start&&t.date<=end);
  const income=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const net=income-expense;
  // Burn Rate: total expenses / days in period (excludes transfers per financial spec)
  const now=new Date();
  let daysInPeriod=30;
  if(currentReportPeriod==='monthly'){daysInPeriod=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();}
  else if(currentReportPeriod==='weekly'){daysInPeriod=7;}
  else if(currentReportPeriod==='daily'){daysInPeriod=1;}
  else if(currentReportPeriod==='yearly'){daysInPeriod=365;}
  const burn=daysInPeriod>0?expense/daysInPeriod:0;
  const burnHtml=expense>0
    ?`<div class="rs-val" style="color:var(--amber)">${fmt(burn)}<span style="font-size:10px;font-weight:500;color:var(--text3)">/day</span></div>`
    :`<div class="rs-val" style="color:var(--text3)">${getCurrency()}0.00<span style="font-size:10px;font-weight:400">/day</span></div>`;
  document.getElementById('report-stats').innerHTML=`
    <div class="report-stat"><div class="rs-val" style="color:var(--income)">${fmt(income)}</div><div class="rs-label">💰 Income</div></div>
    <div class="report-stat"><div class="rs-val" style="color:var(--expense)">${fmt(expense)}</div><div class="rs-label">💸 Expenses</div></div>
    <div class="report-stat"><div class="rs-val" style="color:${net>=0?'var(--accent2)':'var(--danger)'}">${fmt(net)}</div><div class="rs-label">📊 Net ${net>=0?'💚':'🔴'}</div></div>
    <div class="report-stat" title="Average daily spending (excl. transfers)">${burnHtml}<div class="rs-label">🔥 Daily Burn</div></div>
  `;
  renderBarChart();
  renderPieChart(txs.filter(t=>t.type==='expense'));
  const catMap={};txs.filter(t=>t.type==='expense').forEach(tx=>{catMap[tx.category]=(catMap[tx.category]||0)+tx.amount;});
  const catList=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const maxAmt=catList[0]?.[1]||1;
  document.getElementById('cat-breakdown').innerHTML=catList.length?catList.map((c,i)=>`<div class="cat-item"><div class="cat-dot" style="background:${COLOR_PALETTE[i%COLOR_PALETTE.length]}"></div><div class="cat-name">${c[0]}</div><div class="cat-bar-wrap"><div class="cat-bar" style="width:${(c[1]/maxAmt*100).toFixed(0)}%;background:${COLOR_PALETTE[i%COLOR_PALETTE.length]}"></div></div><div class="cat-amount">${fmt(c[1])}</div></div>`).join(''):`<div class="empty" style="padding:20px"><p>No expense data yet</p></div>`;
}
function renderIncomeReport(){
  const el=document.getElementById('reports-income-panel');if(!el)return;
  const now=new Date();
  const rp=currentIncomeReportPeriod||'monthly';
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  if(rp==='yearly'){
    // Yearly view: last 5 years
    const currentYear=now.getFullYear();
    const yearlyData=[];
    for(let y=currentYear-4;y<=currentYear;y++){
      const txs=db.transactions.filter(t=>t.type==='income'&&t.date.startsWith(String(y)));
      const total=txs.reduce((s,t)=>s+t.amount,0);
      const bycat={};txs.forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
      yearlyData.push({year:y,total,txs,bycat});
    }
    const totalAll=yearlyData.reduce((s,y)=>s+y.total,0);
    const avgYearly=totalAll/yearlyData.filter(y=>y.total>0).length||0;
    const bestYear=yearlyData.reduce((a,b)=>b.total>a.total?b:a,yearlyData[0]);
    const allCatMap={};
    db.transactions.filter(t=>t.type==='income').forEach(t=>{allCatMap[t.category]=(allCatMap[t.category]||0)+t.amount;});
    const catList=Object.entries(allCatMap).sort((a,b)=>b[1]-a[1]);
    const maxCat=catList[0]?.[1]||1;
    const totalIncome=Object.values(allCatMap).reduce((s,v)=>s+v,0);

    let html=`<div style="padding:12px 0">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
      <div class="card-sm" style="text-align:center">
        <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--income)">${fmt(totalAll)}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:3px">All-Time</div>
      </div>
      <div class="card-sm" style="text-align:center">
        <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--accent)">${fmt(avgYearly)}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:3px">Avg/Year</div>
      </div>
      <div class="card-sm" style="text-align:center">
        <div style="font-family:'Space Mono',monospace;font-size:11px;font-weight:700;color:var(--planned)">${bestYear.year}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:3px">Best Year</div>
      </div>
    </div>
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">Yearly Income</div>
      <div class="chart-wrap"><canvas id="income-bar-chart"></canvas></div>
    </div>
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">🍩 Income by Source</div>
      <div class="chart-wrap"><canvas id="income-pie-chart"></canvas></div>
    </div>
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">💰 Income by Source</div>`;
    if(!catList.length){html+='<div class="empty" style="padding:20px"><p>No income recorded yet</p></div>';}
    else{catList.forEach(([cat,amt],i)=>{const pct=(amt/maxCat*100).toFixed(0);const share=(totalIncome>0?(amt/totalIncome*100).toFixed(1):0);html+=`<div class="budget-item"><div class="budget-item-row"><div class="budget-cat">${cat}</div><div style="display:flex;align-items:center;gap:8px"><span style="font-size:10px;color:var(--text3)">${share}%</span><div class="budget-pct" style="color:var(--income)">${fmt(amt)}</div></div></div><div class="budget-bar-wrap"><div class="budget-bar" style="width:${pct}%;background:${COLOR_PALETTE[i%COLOR_PALETTE.length]}"></div></div></div>`;});}
    html+='</div>';
    html+=`<div class="card" style="margin-bottom:12px"><div class="section-title">📅 Year-by-Year Breakdown</div><div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="padding:8px 6px;text-align:left;color:var(--text3);font-weight:700">Year</th><th style="padding:8px 6px;text-align:right;color:var(--text3);font-weight:700">Total</th><th style="padding:8px 6px;text-align:right;color:var(--text3);font-weight:700">Txns</th></tr></thead><tbody>`;
    yearlyData.forEach(yd=>{
      const isCurrent=yd.year===currentYear;
      html+=`<tr style="border-bottom:1px solid var(--border);${isCurrent?'background:rgba(124,131,253,0.06);':''}">
        <td style="padding:8px 6px;font-weight:${isCurrent?700:400};color:${isCurrent?'var(--accent)':'var(--text)'}">${yd.year}${isCurrent?' ◀':''}</td>
        <td style="padding:8px 6px;text-align:right;font-family:'Space Mono',monospace;font-weight:700;color:${yd.total>0?'var(--income)':'var(--text3)'}">${yd.total>0?fmt(yd.total):'—'}</td>
        <td style="padding:8px 6px;text-align:right;color:var(--text3)">${yd.txs.length||'—'}</td>
      </tr>`;
    });
    html+='</tbody></table></div></div></div>';
    el.innerHTML=html;
    // Render yearly bar chart
    const ctx=document.getElementById('income-bar-chart');
    if(ctx){
      const incData=yearlyData.map(y=>y.total);
      if(window.incomeBarChart)window.incomeBarChart.destroy();
      const tc=getThemeColors();
      window.incomeBarChart=new Chart(ctx,{type:'bar',data:{labels:yearlyData.map(y=>String(y.year)),datasets:[{label:'Income',data:incData,backgroundColor:incData.map(v=>v>0?'rgba(16,185,129,0.75)':'rgba(16,185,129,0.12)'),borderRadius:6,borderColor:incData.map(v=>v>0?'rgba(16,185,129,1)':'transparent'),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tc.text3,font:{size:9}},grid:{color:tc.border}},y:{ticks:{color:tc.text3,font:{size:10},callback:v=>getCurrency()+v},grid:{color:tc.border}}}}});
    }
    const piCtx=document.getElementById('income-pie-chart');
    if(piCtx&&catList.length){
      if(window.incomePieChart)window.incomePieChart.destroy();
      const tc=getThemeColors();
      const INCOME_COLORS=['#10B981','#3B82F6','#14B8A6','#8B5CF6','#F59E0B','#EC4899','#06B6D4','#84CC16','#F97316','#6366F1','#EF4444','#A855F7'];
      window.incomePieChart=new Chart(piCtx,{type:'doughnut',data:{labels:catList.map(([c])=>c.replace(/^\S+\s/,'')),datasets:[{data:catList.map(([,v])=>v),backgroundColor:INCOME_COLORS.slice(0,catList.length),borderWidth:2,borderColor:tc.card,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:tc.text2,font:{size:9},boxWidth:10,padding:8}}}}});
    }
    return;
  }

  // Monthly view (default)
  const year=now.getFullYear();
  const monthlyData=months.map((m,i)=>{
    const ms=`${year}-${String(i+1).padStart(2,'0')}-01`;
    const me=localMonthEnd(year,i);
    const txs=db.transactions.filter(t=>t.type==='income'&&t.date>=ms&&t.date<=me);
    const total=txs.reduce((s,t)=>s+t.amount,0);
    const bycat={};txs.forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
    return{month:m,total,txs,bycat};
  });
  const totalIncome=monthlyData.reduce((s,m)=>s+m.total,0);
  const avgMonthly=totalIncome/12;
  const bestMonth=monthlyData.reduce((a,b)=>b.total>a.total?b:a,monthlyData[0]);
  const allCatMap={};
  db.transactions.filter(t=>t.type==='income'&&t.date.startsWith(String(year))).forEach(t=>{allCatMap[t.category]=(allCatMap[t.category]||0)+t.amount;});
  const catList=Object.entries(allCatMap).sort((a,b)=>b[1]-a[1]);
  const maxCat=catList[0]?.[1]||1;

  let html=`<div style="padding:12px 0">
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
    <div class="card-sm" style="text-align:center">
      <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--income)">${fmt(totalIncome)}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:3px">Total ${year}</div>
    </div>
    <div class="card-sm" style="text-align:center">
      <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--accent)">${fmt(avgMonthly)}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:3px">Avg/Month</div>
    </div>
    <div class="card-sm" style="text-align:center">
      <div style="font-family:'Space Mono',monospace;font-size:11px;font-weight:700;color:var(--planned)">${bestMonth.month}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:3px">Best Month</div>
    </div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <div class="section-title">Monthly Income — ${year}</div>
    <div class="chart-wrap"><canvas id="income-bar-chart"></canvas></div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <div class="section-title">🍩 Income by Source — Distribution</div>
    <div class="chart-wrap"><canvas id="income-pie-chart"></canvas></div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <div class="section-title">💰 Income by Source</div>`;
  if(!catList.length){html+='<div class="empty" style="padding:20px"><p>No income recorded yet</p></div>';}
  else{
    catList.forEach(([cat,amt],i)=>{
      const pct=(amt/maxCat*100).toFixed(0);
      const share=(totalIncome>0?(amt/totalIncome*100).toFixed(1):0);
      html+=`<div class="budget-item">
        <div class="budget-item-row">
          <div class="budget-cat">${cat}</div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:10px;color:var(--text3)">${share}%</span>
            <div class="budget-pct" style="color:var(--income)">${fmt(amt)}</div>
          </div>
        </div>
        <div class="budget-bar-wrap"><div class="budget-bar" style="width:${pct}%;background:${COLOR_PALETTE[i%COLOR_PALETTE.length]}"></div></div>
      </div>`;
    });
  }
  html+='</div>';
  html+=`<div class="card" style="margin-bottom:12px">
    <div class="section-title">📅 Month-by-Month Breakdown</div>
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:11px">
        <thead><tr style="border-bottom:2px solid var(--border)">
          <th style="padding:8px 6px;text-align:left;color:var(--text3);font-weight:700">Month</th>
          <th style="padding:8px 6px;text-align:right;color:var(--text3);font-weight:700">Total</th>
          <th style="padding:8px 6px;text-align:right;color:var(--text3);font-weight:700">Txns</th>
          <th style="padding:8px 6px;text-align:right;color:var(--text3);font-weight:700">vs Avg</th>
        </tr></thead><tbody>`;
  monthlyData.forEach(md=>{
    const diff=md.total-avgMonthly;
    const diffColor=diff>=0?'var(--income)':'var(--danger)';
    const diffStr=diff===0?'—':(diff>0?'+':'')+fmt(Math.abs(diff));
    const isNow=md.month===months[now.getMonth()];
    html+=`<tr style="border-bottom:1px solid var(--border);${isNow?'background:rgba(124,131,253,0.06);':''}">
      <td style="padding:8px 6px;font-weight:${isNow?700:400};color:${isNow?'var(--accent)':'var(--text)'}">${md.month}${isNow?' ◀':''}</td>
      <td style="padding:8px 6px;text-align:right;font-family:'Space Mono',monospace;font-weight:700;color:${md.total>0?'var(--income)':'var(--text3)'}">${md.total>0?fmt(md.total):'—'}</td>
      <td style="padding:8px 6px;text-align:right;color:var(--text3)">${md.txs.length||'—'}</td>
      <td style="padding:8px 6px;text-align:right;font-size:10px;color:${diffColor}">${md.total>0?diffStr:'—'}</td>
    </tr>`;
  });
  html+='</tbody></table></div></div></div>';
  el.innerHTML=html;

  // Render income bar chart
  const ctx=document.getElementById('income-bar-chart');
  if(ctx){
    const incData=monthlyData.map(m=>m.total);
    if(window.incomeBarChart)window.incomeBarChart.destroy();
    const tc=getThemeColors();
    window.incomeBarChart=new Chart(ctx,{type:'bar',data:{labels:months,datasets:[{label:'Income',data:incData,backgroundColor:incData.map(v=>v>0?'rgba(16,185,129,0.75)':'rgba(16,185,129,0.12)'),borderRadius:6,borderColor:incData.map(v=>v>0?'rgba(16,185,129,1)':'transparent'),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(15,23,42,0.95)',titleColor:tc.text2,bodyColor:tc.emerald,borderColor:tc.emerald+'44',borderWidth:1}},scales:{x:{ticks:{color:tc.text3,font:{size:9}},grid:{color:tc.border}},y:{ticks:{color:tc.text3,font:{size:10},callback:v=>getCurrency()+v},grid:{color:tc.border}}}}});
  }
  // Render income pie chart
  const piCtx=document.getElementById('income-pie-chart');
  if(piCtx&&catList.length){
    if(window.incomePieChart)window.incomePieChart.destroy();
    const tc=getThemeColors();
    const INCOME_COLORS=['#10B981','#3B82F6','#14B8A6','#8B5CF6','#F59E0B','#EC4899','#06B6D4','#84CC16','#F97316','#6366F1','#EF4444','#A855F7','#22C55E','#0EA5E9','#D946EF','#FB923C'];
    window.incomePieChart=new Chart(piCtx,{type:'doughnut',data:{labels:catList.map(([c])=>c.replace(/^\S+\s/,'')),datasets:[{data:catList.map(([,v])=>v),backgroundColor:INCOME_COLORS.slice(0,catList.length),borderWidth:2,borderColor:tc.card,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:tc.text2,font:{size:9},boxWidth:10,padding:8}},tooltip:{backgroundColor:'rgba(15,23,42,0.95)',titleColor:tc.text2,bodyColor:'#F0F6FF',borderColor:tc.emerald+'44',borderWidth:1,callbacks:{label:ctx2=>' '+fmt(ctx2.raw)+' ('+((ctx2.raw/totalIncome)*100).toFixed(1)+'%)'}}}}});
  }
}
function renderBarChart(){
  const ctx=document.getElementById('bar-chart');if(!ctx)return;
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const year=new Date().getFullYear();
  const labels=[],incData=[],expData=[];
  for(let m=0;m<12;m++){const s=`${year}-${String(m+1).padStart(2,'0')}-01`;const e=new Date(year,m+1,0).toISOString().split('T')[0];const mt=db.transactions.filter(t=>t.date>=s&&t.date<=e);labels.push(months[m]);incData.push(mt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));expData.push(mt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));}
  if(barChart)barChart.destroy();
  barChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Income',data:incData,backgroundColor:'rgba(16,185,129,0.75)',borderRadius:6,borderColor:'rgba(16,185,129,0.9)',borderWidth:1},{label:'Expense',data:expData,backgroundColor:'rgba(225,29,72,0.7)',borderRadius:6,borderColor:'rgba(225,29,72,0.85)',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:getThemeColors().text2,font:{size:10}}}},scales:{x:{ticks:{color:getThemeColors().text3,font:{size:9}},grid:{color:getThemeColors().border}},y:{ticks:{color:getThemeColors().text3,font:{size:10},callback:v=>getCurrency()+v},grid:{color:getThemeColors().border}}}}});
}
function renderPieChart(expenseTxs){
  const ctx=document.getElementById('pie-chart');if(!ctx)return;
  const catMap={};expenseTxs.forEach(tx=>{catMap[tx.category]=(catMap[tx.category]||0)+tx.amount;});
  const labels=Object.keys(catMap),data=Object.values(catMap);
  if(pieChart)pieChart.destroy();if(!labels.length)return;
  pieChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:COLOR_PALETTE.slice(0,labels.length),borderWidth:2,borderColor:getThemeColors().card}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:getThemeColors().text2,font:{size:9},boxWidth:10,padding:8}}}}});
}

// ===== PERIOD SETTERS =====
function setPeriod(p,btn){currentPeriod=p;document.querySelectorAll('#home-period-tabs .period-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderHome();}
function setTxPeriod(p,btn){currentTxPeriod=p;document.querySelectorAll('#tx-period-tabs .period-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderTransactions();}
function setReportPeriod(p,btn){currentReportPeriod=p;document.querySelectorAll('#report-period-tabs .period-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderReports();}
let currentBudgetReportPeriod='monthly';
let currentIncomeReportPeriod='monthly';
function setBudgetReportPeriod(p,btn){
  currentBudgetReportPeriod=p;
  document.querySelectorAll('#budget-report-period-tabs .period-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderBudgetReport();
}
function setIncomeReportPeriod(p,btn){
  currentIncomeReportPeriod=p;
  document.querySelectorAll('#income-report-period-tabs .period-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderIncomeReport();
}

// ===== SETTINGS =====
function openCurrencySettings(){document.getElementById('currency-select').value=db.settings.currency||'₱|PHP';openModal('modal-currency');}
function _initSettingsAppStyle(){
  const style = db.settings.appStyle || 'classic';
  document.querySelectorAll('.style-option-btn').forEach(b=>b.classList.remove('active'));
  const activeBtn = document.getElementById('style-btn-'+style);
  if(activeBtn) activeBtn.classList.add('active');
  const lbl = document.getElementById('app-style-label');
  if(lbl) lbl.textContent = style==='classic' ? 'Classic Style' : 'Old Style';
  // Show/hide widget settings (only for classic mode)
  const ws = document.getElementById('home-widget-settings');
  if(ws) ws.style.display = style==='classic' ? '' : 'none';
  // Render widget toggle states
  _renderHomeWidgetToggles();
}

function updateEyeBtn(){
  const allHidden=priv.homeTotal&&priv.homeSummary&&priv.chips&&priv.cards&&priv.accounts&&priv.transactions;
  const btn=document.getElementById('global-eye-btn');
  if(!btn) return;
  const eyeOpen = `<span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>`;
  const eyeClosed = `<span class="hico"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"/></svg></span>`;
  btn.innerHTML = allHidden ? eyeClosed : eyeOpen;
}

function setAppStyle(style, btn){
  db.settings.appStyle = style;
  saveDB();
  document.querySelectorAll('.style-option-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const lbl = document.getElementById('app-style-label');
  if(lbl) lbl.textContent = style==='classic' ? 'Classic Style' : 'Old Style';

  // Show/hide widget settings section (only relevant in classic mode)
  const widgetSection = document.getElementById('home-widget-settings');
  if(widgetSection) widgetSection.style.display = style==='classic' ? '' : 'none';

  // Swap the home screen layout
  _applyHomeStyle(style);
  showToast(style==='classic' ? '✨ Switched to Classic Style' : '📱 Switched to Old Style');
}

function _applyHomeStyle(style){
  const homeEl = document.getElementById('screen-home');
  if(!homeEl) return;
  if(style==='old'){
    // Restore original layout: header with logo, hero card, add CTA, old quick actions, chips
    homeEl.setAttribute('data-style','old');
  } else {
    homeEl.setAttribute('data-style','classic');
  }
  renderHome();
}

function _applyHomeWidgetVisibility(){
  const style = db.settings.appStyle || 'classic';
  // In old style all widgets are always visible
  if(style === 'old'){
    ['cashflow','miniReport','calendar','budgetPanel'].forEach(k=>{
      const el = document.getElementById('widget-'+k);
      if(el) el.style.display = '';
    });
    return;
  }
  // Classic style: controlled by homeWidgets settings
  const w = getHomeWidgets();
  const map = {cashflow:'showCashflow', miniReport:'showMiniReport', calendar:'showCalendar', budgetPanel:'showBudgetPanel'};
  Object.entries(map).forEach(([k,setting])=>{
    const el = document.getElementById('widget-'+k);
    if(el) el.style.display = w[setting] ? '' : 'none';
  });
}
function saveCurrency(){db.settings.currency=document.getElementById('currency-select').value;const label=document.querySelector(`#currency-select option[value="${db.settings.currency}"]`)?.textContent||'';document.getElementById('currency-display').textContent=label;saveDB();closeModal('modal-currency');renderHome();renderAccountsScreen();showToast('Currency updated!');}
function exportData(){const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`finflow-backup-${today()}.json`;a.click();showToast('Data exported! 📤');}
function importData(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(data.accounts&&data.transactions){db={...data,logs:data.logs||[],planned:data.planned||[]};saveDB();renderHome();showToast('Data imported! 📥');}else showToast('Invalid backup file','error');}catch{showToast('Invalid file format','error');}};reader.readAsText(file);e.target.value='';}
// FEATURE 3: Secure Clear All Data — requires typing DELETE
function confirmClearData(){
  document.getElementById('clear-data-input').value='';
  onClearDataInput('');
  openModal('modal-clear-data');
  setTimeout(()=>{document.getElementById('clear-data-input').focus();},300);
}
function onClearDataInput(val){
  const btn=document.getElementById('clear-data-confirm-btn');
  const hint=document.getElementById('clear-data-hint');
  const inp=document.getElementById('clear-data-input');
  const match=val==='DELETE';
  if(btn){btn.disabled=!match;btn.style.opacity=match?'1':'0.4';btn.style.cursor=match?'pointer':'not-allowed';}
  if(hint){hint.textContent=match?'✅ Ready to delete — click the button below':'Enter exactly: DELETE (case-sensitive)';hint.style.color=match?'var(--emerald)':'var(--text3)';}
  if(inp){inp.style.borderColor=val.length>0&&!match?'var(--rose)':match?'var(--emerald)':'var(--border)';}
}
function executeClearData(){
  if(document.getElementById('clear-data-input').value!=='DELETE')return;
  // QA: Data wipe executed
  console.log('Data wipe executed');
  closeModal('modal-clear-data');
  // Clear all finflow_* keys in localStorage
  Object.keys(localStorage).filter(k=>k.startsWith('finflow')).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('finflow_pre_demo');
  db={accounts:[],transactions:[],planned:[],logs:[],settings:{},payables:[],qrCodes:[],qrContacts:[],budgets:[],goals:[],recurring:[]};
  saveDB();
  renderHome();renderAccountsScreen();renderTransactions();renderPayables();
  updateOverdueBadge();updatePayablesBadge();
  showToast('✅ All data cleared successfully. App reset.','success');
}
function executeSavingsGuardedTx(){
  closeModal('modal-savings-guard');
  if(!pendingSavingsTx)return;
  const p=pendingSavingsTx; pendingSavingsTx=null;
  const tx={id:uid(),type:p.type,amount:p.amount,category:p.category,accountId:p.accountId,toAccountId:p.toAccountId,date:p.date,ref:p.ref,desc:p.desc,receipt:receiptData,createdAt:Date.now()};
  db.transactions.unshift(tx);applyTransaction(tx);
  addLog('created',`New ${tx.type}: ${tx.category} ${fmt(p.amount)} on ${p.date} [savings dipped]`,tx.id);
  saveDB();closeModal('modal-tx');
  showToast('Transaction saved (savings reserve dipped) ⚠️','warn');
  renderHome();renderTransactions();
  if(tx.type==='expense')setTimeout(()=>checkBudgetAfterTx(tx),400);
}
function showConfirm(title,msg,onOk){document.getElementById('confirm-title').textContent=title;document.getElementById('confirm-msg').textContent=msg;document.getElementById('confirm-ok-btn').onclick=()=>{onOk();closeModal('modal-confirm');};openModal('modal-confirm');}

// ===== PAYABLES =====
const PAYABLE_TYPES={loan:'🏦 Bank/Personal Loan',credit:'💳 Credit Card',spl:'📱 BuyNow PayLater',other:'📋 Other'};
const PAYABLE_COLORS={loan:'var(--accent)',credit:'var(--expense)',spl:'var(--planned)',other:'var(--text2)'};

function updatePayablesBadge(){
  // Count payables with overdue or current-month unpaid due dates (within next 3 days)
  const todayStr=today();
  const nowDate=new Date();
  let dueSoon=0;
  db.payables.filter(p=>p.status==='active'&&p.dueDay&&p.monthlyPayment>0).forEach(py=>{
    try {
      const sched=generatePayableSchedule(py);
      const urgent=sched.find(s=>{
        if(s.status!=='overdue'&&s.status!=='current'&&s.status!=='upcoming') return false;
        const diff=(new Date(s.date+'T00:00:00')-nowDate)/(1000*60*60*24);
        return diff<=-1||diff<=3; // overdue or due within 3 days
      });
      if(urgent) dueSoon++;
    } catch(e){}
  });
  const badge=document.getElementById('payables-badge');
  if(badge){if(dueSoon>0){badge.style.display='flex';badge.textContent=dueSoon;}else badge.style.display='none';}
}

function updateRecurringBadge(){
  const nowDate=new Date();
  let dueSoon=0;
  db.recurring.filter(r=>r.status==='active').forEach(r=>{
    try {
      const sched=generateRecurringSchedule(r);
      const urgent=sched.find(s=>{
        if(s.status!=='missed'&&s.status!=='current'&&s.status!=='upcoming') return false;
        const diff=(new Date(s.date+'T00:00:00')-nowDate)/(1000*60*60*24);
        return diff<=-1||diff<=3;
      });
      if(urgent) dueSoon++;
    } catch(e){}
  });
  // Use the goals badge for recurring (since recurring is on Goals screen)
  const badge=document.getElementById('recurring-badge');
  if(badge){if(dueSoon>0){badge.style.display='flex';badge.textContent=dueSoon;}else badge.style.display='none';}
}

function openAddPayable(){
  editingPayableId=null;
  document.getElementById('modal-payable-title').textContent='Add Payable';
  document.getElementById('py-name').value='';
  document.getElementById('py-type').value='loan';
  document.getElementById('py-total').value='';
  document.getElementById('py-paid').value='';
  document.getElementById('py-monthly').value='';
  document.getElementById('py-interest').value='';
  document.getElementById('py-due-day').value='';
  document.getElementById('py-overpay').value='no';
  document.getElementById('py-single-month').value='no';
  document.getElementById('py-notes').value='';
  document.getElementById('py-delete-btn').style.display='none';
  document.getElementById('py-save-btn').textContent='Save Payable';
  // Reset Form VAI
  dismissFormVAI('payable');
  const vInp=document.getElementById('payable-vai-input');if(vInp)vInp.value='';
  // fill account dropdown
  const opts='<option value="">-- No linked account --</option>'+db.accounts.map(a=>`<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name}</option>`).join('');
  document.getElementById('py-account').innerHTML=opts;
  openModal('modal-payable');
}
function openEditPayable(id){
  const py=db.payables.find(p=>p.id===id);if(!py)return;
  editingPayableId=id;
  document.getElementById('modal-payable-title').textContent='Edit Payable';
  document.getElementById('py-name').value=py.name;
  document.getElementById('py-type').value=py.type;
  document.getElementById('py-total').value=py.totalAmount;
  document.getElementById('py-paid').value=py.paidAmount||0;
  document.getElementById('py-monthly').value=py.monthlyPayment||'';
  document.getElementById('py-interest').value=py.interestRate||'';
  document.getElementById('py-due-day').value=py.dueDay||'';
  document.getElementById('py-overpay').value=py.allowOverpay?'yes':'no';
  document.getElementById('py-single-month').value=py.singleMonthOnly?'yes':'no';
  document.getElementById('py-notes').value=py.notes||'';
  document.getElementById('py-delete-btn').style.display='';
  document.getElementById('py-save-btn').textContent='Update Payable';
  dismissFormVAI('payable');
  const vInp=document.getElementById('payable-vai-input');if(vInp)vInp.value='';
  const opts='<option value="">-- No linked account --</option>'+db.accounts.map(a=>`<option value="${a.id}"${a.id===py.linkedAccount?' selected':''}>${ACC_ICONS[a.type]} ${a.name}</option>`).join('');
  document.getElementById('py-account').innerHTML=opts;
  openModal('modal-payable');
}
function savePayable(){
  const name=document.getElementById('py-name').value.trim();
  const type=document.getElementById('py-type').value;
  const totalAmount=parseFloat(document.getElementById('py-total').value)||0;
  const paidAmount=parseFloat(document.getElementById('py-paid').value)||0;
  const monthlyPayment=parseFloat(document.getElementById('py-monthly').value)||0;
  const interestRate=parseFloat(document.getElementById('py-interest').value)||0;
  const dueDay=parseInt(document.getElementById('py-due-day').value)||null;
  const allowOverpay=document.getElementById('py-overpay').value==='yes';
  const singleMonthOnly=document.getElementById('py-single-month').value==='yes';
  const linkedAccount=document.getElementById('py-account').value||null;
  const notes=document.getElementById('py-notes').value.trim();
  if(!name){showToast('Please enter a payable name','error');return;}
  if(totalAmount<=0){showToast('Please enter a valid total amount','error');return;}
  if(paidAmount>totalAmount&&!allowOverpay){showToast('Paid amount cannot exceed total amount','error');return;}
  const remaining=Math.max(0,totalAmount-paidAmount);
  const status=remaining<=0?'paid':'active';
  if(editingPayableId){
    const py=db.payables.find(p=>p.id===editingPayableId);
    if(py)Object.assign(py,{name,type,totalAmount,paidAmount,monthlyPayment,interestRate,dueDay,allowOverpay,singleMonthOnly,linkedAccount,notes,remaining,status});
  }else{
    db.payables.push({id:uid(),name,type,totalAmount,paidAmount,monthlyPayment,interestRate,dueDay,allowOverpay,singleMonthOnly,linkedAccount,notes,remaining,status,payments:[],createdAt:Date.now()});
  }
  saveDB();closeModal('modal-payable');
  showToast(editingPayableId?'Payable updated! 💳':'Payable added! 💳');
  // Auto-add to planner if new payable with due day and monthly payment
  if(!editingPayableId&&dueDay&&monthlyPayment>0){
    autoSchedulePayable(db.payables[db.payables.length-1]);
  }
  editingPayableId=null;renderPayables();updatePayablesBadge();
}
function deletePayable(){
  showConfirm('Delete Payable?','All payment history will be lost.',()=>{
    db.payables=db.payables.filter(p=>p.id!==editingPayableId);
    saveDB();closeModal('modal-payable');showToast('Payable deleted','error');
    editingPayableId=null;renderPayables();updatePayablesBadge();
  });
}

function autoSchedulePayable(py){
  if(!py.dueDay||!py.monthlyPayment)return;
  // Add next 3 months of payments to planner
  const now=new Date();
  let added=0;
  for(let i=0;i<3;i++){
    const d=new Date(now.getFullYear(),now.getMonth()+i,py.dueDay);
    if(d<now)continue; // skip past dates
    const dateStr=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    // Check if already scheduled
    const exists=db.planned.some(p=>p.payableId===py.id&&p.date===dateStr);
    if(!exists){
      const pl={id:uid(),type:'expense',amount:py.monthlyPayment,category:'💰 Bills',accountId:py.linkedAccount||db.accounts[0]?.id||'',date:dateStr,ref:'',desc:`Auto-scheduled: ${py.name}`,status:'pending',originalDate:dateStr,createdAt:Date.now(),payableId:py.id};
      db.planned.push(pl);
      added++;
    }
  }
  if(added>0){
    saveDB();
    setTimeout(()=>showToast(`📅 Auto-scheduled ${added} payment${added>1?'s':''} to your planner!`,'success'),500);
    updateOverdueBadge();
  }
}

// ─── PAYABLE REPAYMENT SCHEDULE ENGINE ────────────────────────
/**
 * Generates a complete repayment schedule for a payable.
 * Handles advance multi-month payments correctly.
 * Returns array of { date, monthKey, amount, status, paymentRef }
 */
function generatePayableSchedule(py) {
  if(!py.dueDay||!py.monthlyPayment) return [];
  const todayStr=today();
  const schedule=[];

  // Build set of "month keys" covered by payments
  // Each payment.months tells how many consecutive months starting from its due month
  const coveredMonths=new Map(); // 'YYYY-MM' → payment object
  (py.payments||[]).forEach(pay=>{
    const months=pay.months||1;
    const payDate=new Date(pay.date+'T00:00:00');
    // Find which due month this payment covers (the next due date at or after payment date)
    let dueMo=new Date(payDate.getFullYear(),payDate.getMonth(),py.dueDay);
    if(dueMo<payDate) dueMo=new Date(payDate.getFullYear(),payDate.getMonth()+1,py.dueDay);
    for(let m=0;m<months;m++){
      const d=new Date(dueMo.getFullYear(),dueMo.getMonth()+m,py.dueDay);
      const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
      if(!coveredMonths.has(key)) coveredMonths.set(key,pay);
    }
  });

  // Determine start: earliest covered month OR first upcoming due date
  let startDate;
  if(py.createdAt){
    const cd=new Date(py.createdAt);
    startDate=new Date(cd.getFullYear(),cd.getMonth(),py.dueDay);
    if(startDate<cd) startDate=new Date(cd.getFullYear(),cd.getMonth()+1,py.dueDay);
  } else {
    const now=new Date();
    startDate=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
    if(startDate<now) startDate=new Date(now.getFullYear(),now.getMonth()+1,py.dueDay);
  }
  // Also consider earliest covered month
  coveredMonths.forEach((_,key)=>{
    const[y,m]=key.split('-').map(Number);
    const d=new Date(y,m-1,py.dueDay);
    if(d<startDate) startDate=d;
  });

  // Row count based on REMAINING (not totalAmount) so schedule shows only what's left
  const remaining = Math.max(0, py.remaining||0);
  const futureInstall = py.monthlyPayment>0 ? Math.ceil(remaining/py.monthlyPayment) : 0;
  const totalRows = coveredMonths.size + futureInstall;
  if(!totalRows) return [];

  let iter=new Date(startDate);
  let futureCount=0;

  for(let i=0;i<Math.min(totalRows+2,120);i++){
    // Use local date parts to avoid UTC timezone shift (e.g. UTC+8 would show day-1 with toISOString)
    const dateStr=iter.getFullYear()+'-'+String(iter.getMonth()+1).padStart(2,'0')+'-'+String(iter.getDate()).padStart(2,'0');
    const monthKey=iter.getFullYear()+'-'+String(iter.getMonth()+1).padStart(2,'0');
    const isPaid=coveredMonths.has(monthKey);
    const payRef=isPaid?coveredMonths.get(monthKey):null;

    let rowAmount;
    if(isPaid){
      rowAmount=py.monthlyPayment;
    } else {
      if(futureCount>=futureInstall) break; // all future slots filled
      const alreadyAllocated=futureCount*py.monthlyPayment;
      rowAmount=Math.min(py.monthlyPayment, Math.max(0, remaining-alreadyAllocated));
      if(rowAmount<=0) break;
      futureCount++;
    }

    let status;
    if(isPaid) status='paid';
    else if(dateStr<todayStr) status='overdue';
    else if(dateStr===todayStr) status='current';
    else status='upcoming';

    schedule.push({date:dateStr,monthKey,amount:rowAmount,status,payRef});
    if(!isPaid && futureCount>=futureInstall) break;
    iter=new Date(iter.getFullYear(),iter.getMonth()+1,py.dueDay);
  }
  return schedule;
}

function openPayableSchedule(id){
  const py=db.payables.find(p=>p.id===id);if(!py)return;
  const color=PAYABLE_COLORS[py.type]||'var(--text2)';
  const schedule=generatePayableSchedule(py);
  const paidCount=schedule.filter(s=>s.status==='paid').length;
  const overdueCount=schedule.filter(s=>s.status==='overdue').length;
  const totalCount=schedule.length;
  const pct=py.totalAmount>0?Math.min(100,((py.paidAmount||0)/py.totalAmount)*100):0;

  document.getElementById('payable-schedule-title').textContent='📅 '+py.name+' — Repayment Schedule';

  // Summary cards
  document.getElementById('payable-schedule-summary').innerHTML=`
    <div class="sched-summary">
      <div><div class="sched-sum-val" style="color:${color}">${fmt(py.remaining||0)}</div><div class="sched-sum-lbl">Remaining</div></div>
      <div><div class="sched-sum-val" style="color:var(--income)">${fmt(py.paidAmount||0)}</div><div class="sched-sum-lbl">Paid</div></div>
      <div><div class="sched-sum-val">${paidCount}/${totalCount}</div><div class="sched-sum-lbl">Installments</div></div>
    </div>`;

  // Progress bar
  const progressColor=pct>=80?'var(--income)':pct>=40?'var(--planned)':'var(--expense)';
  document.getElementById('payable-schedule-progress').innerHTML=`
    <div style="margin-bottom:8px">
      <div class="sched-progress-row">
        <div class="sched-progress-bar-wrap">
          <div class="sched-progress-bar" style="width:${pct.toFixed(1)}%;background:${progressColor}"></div>
        </div>
        <span style="font-size:11px;font-weight:700;color:${progressColor};min-width:36px">${pct.toFixed(0)}%</span>
      </div>
      ${overdueCount>0?`<div style="font-size:11px;color:var(--rose);font-weight:600">⚠️ ${overdueCount} payment${overdueCount>1?'s':''} overdue — please record payment to stay on track.</div>`:''}
      ${py.interestRate>0?`<div style="font-size:10px;color:var(--text3);margin-top:4px">Interest rate: ${py.interestRate}% per year</div>`:''}
    </div>`;

  // Schedule table
  if(schedule.length){
    const rows=schedule.map((s,i)=>{
      const acc=s.payRef?(db.accounts.find(a=>a.id===s.payRef.accountId)||null):null;
      let badge='',rowClass='';
      if(s.status==='paid'){badge=`<span class="sched-badge paid">✓ Paid</span>`;rowClass='sched-paid';}
      else if(s.status==='current'){badge=`<span class="sched-badge current">📅 Due Today</span>`;rowClass='sched-current';}
      else if(s.status==='overdue'){badge=`<span class="sched-badge overdue">⚠ Overdue</span>`;rowClass='sched-overdue';}
      else{badge=`<span class="sched-badge upcoming">${i===schedule.filter(x=>x.status!=='paid').findIndex(x=>x.status==='upcoming')+paidCount?'Next':'⏳ Upcoming'}</span>`;}

      const payNote=s.payRef?`<div style="font-size:9px;color:var(--text3);margin-top:2px">${fmtDate(s.payRef.date)}${acc?' · '+acc.name:''}${s.payRef.months>1?' · '+s.payRef.months+'mo advance':''}</div>`:'';
      return`<tr class="${rowClass}">
        <td><div style="font-weight:600">#${i+1}</div></td>
        <td><div style="font-weight:600">${fmtDate(s.date)}</div></td>
        <td><div style="font-family:var(--mono);font-weight:700;color:var(--expense)">-${fmt(s.amount)}</div>${payNote}</td>
        <td>${badge}</td>
      </tr>`;
    }).join('');
    document.getElementById('payable-schedule-table').innerHTML=`
      <div class="schedule-wrap">
        <table class="schedule-table">
          <thead><tr><th>#</th><th>Due Date</th><th>Amount</th><th>Status</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  } else {
    document.getElementById('payable-schedule-table').innerHTML=`<div style="text-align:center;color:var(--text3);padding:16px;font-size:12px">No schedule to display. Add a due day and monthly payment to generate a forecast.</div>`;
  }

  // Wire up buttons
  document.getElementById('payable-schedule-pay-btn').onclick=()=>{closeModal('modal-payable-schedule');openPayPayable(id);};
  document.getElementById('payable-schedule-edit-btn').onclick=()=>{closeModal('modal-payable-schedule');openEditPayable(id);};
  openModal('modal-payable-schedule');
}

// ─── RECURRING SCHEDULE ENGINE ────────────────────────────────
/**
 * Generates occurrence list for a recurring rule.
 * Compares against db.transactions (recurringId match) to determine applied status.
 * Returns array of { date, status: 'applied'|'missed'|'current'|'upcoming'|'paused' }
 */
function generateRecurringSchedule(r) {
  const todayStr=today();
  const schedule=[];
  const start=new Date(r.startDate+'T00:00:00');
  const endDate=r.endDate;
  const MAX=48; // max 48 occurrences to show

  // Build set of dates where this recurring has been applied — check recurringDate first, fall back to transaction date
  const appliedDates=new Set(
    db.transactions.filter(tx=>tx.recurringId===r.id).map(tx=>tx.recurringDate||tx.date)
  );

  // Helper: clamp day to last day of a given month
  function clampDay(year, month, day) {
    const lastDay = new Date(year, month + 1, 0).getDate();
    return Math.min(day, lastDay);
  }

  // Helper: get day of month (use dueDay if set and monthly, else startDate day)
  const dayOfMonth=(r.frequency==='monthly'&&r.dueDay)?r.dueDay:start.getDate();

  // Generate all occurrence dates
  let iter=new Date(start);
  // For monthly with dueDay, align to the dueDay
  if(r.frequency==='monthly'&&r.dueDay){
    iter=new Date(start.getFullYear(),start.getMonth(),r.dueDay);
    if(iter<start) iter=new Date(start.getFullYear(),start.getMonth()+1,r.dueDay);
  }

  // Semi-monthly: generate sorted list of (year,month,day) pairs
  if(r.frequency==='semimonthly'){
    const d1=r.semiDay1||15, d2=r.semiDay2||30;
    // Find the first occurrence >= start
    let y=start.getFullYear(), m=start.getMonth();
    // Build all pairs for this month and onwards
    for(let safety=0;safety<200&&schedule.length<MAX;safety++){
      const days=[d1,d2].map(d=>clampDay(y,m,d)).sort((a,b)=>a-b);
      for(const d of days){
        if(schedule.length>=MAX) break;
        const dateObj=new Date(y,m,d);
        const dateStr=dateObj.getFullYear()+'-'+String(dateObj.getMonth()+1).padStart(2,'0')+'-'+String(dateObj.getDate()).padStart(2,'0');
        if(dateStr<r.startDate) continue;
        if(endDate&&dateStr>endDate) break;
        const isApplied=appliedDates.has(dateStr);
        const monthKey=dateStr.substring(0,7);
        const isAppliedThisMonth=!isApplied&&[...appliedDates].some(ad=>ad.startsWith(monthKey));
        let status;
        if(isApplied||isAppliedThisMonth)status='applied';
        else if(r.status==='paused')status='paused';
        else if(dateStr<todayStr)status='missed';
        else if(dateStr===todayStr)status='current';
        else status='upcoming';
        schedule.push({date:dateStr,status});
      }
      if(!endDate){
        const futureCount=schedule.filter(s=>s.status==='upcoming'||s.status==='current').length;
        if(futureCount>=12) break;
      }
      m++;if(m>11){m=0;y++;}
    }
    return schedule;
  }

  for(let i=0;i<MAX;i++){
    const dateStr=iter.getFullYear()+'-'+String(iter.getMonth()+1).padStart(2,'0')+'-'+String(iter.getDate()).padStart(2,'0');
    if(endDate&&dateStr>endDate) break;

    const isApplied=appliedDates.has(dateStr);
    // Also check if any transaction in this month has the recurringId with recurringDate in this month
    const monthKey=dateStr.substring(0,7);
    const isAppliedThisMonth=!isApplied&&[...appliedDates].some(d=>d.startsWith(monthKey));

    let status;
    if(isApplied||isAppliedThisMonth) status='applied';
    else if(r.status==='paused') status='paused';
    else if(dateStr<todayStr) status='missed';
    else if(dateStr===todayStr) status='current';
    else status='upcoming';

    schedule.push({date:dateStr,status});

    // Advance to next occurrence
    if(r.frequency==='daily') iter=new Date(iter.getTime()+86400000);
    else if(r.frequency==='weekly') iter=new Date(iter.getTime()+7*86400000);
    else if(r.frequency==='monthly') iter=new Date(iter.getFullYear(),iter.getMonth()+1,dayOfMonth);
    else if(r.frequency==='yearly') iter=new Date(iter.getFullYear()+1,iter.getMonth(),iter.getDate());
    else break;

    // Stop if no endDate and we have enough future ones
    if(!endDate){
      const futureCount=schedule.filter(s=>s.status==='upcoming'||s.status==='current').length;
      if(futureCount>=12) break;
    }
  }
  return schedule;
}

function openRecurringSchedule(id){
  const r=db.recurring.find(r=>r.id===id);if(!r)return;
  const acc=db.accounts.find(a=>a.id===r.accountId);
  const schedule=generateRecurringSchedule(r);
  const appliedCount=schedule.filter(s=>s.status==='applied').length;
  const missedCount=schedule.filter(s=>s.status==='missed').length;
  const upcomingCount=schedule.filter(s=>s.status==='upcoming'||s.status==='current').length;
  const amtColor=r.type==='income'?'var(--income)':'var(--expense)';
  const amtSign=r.type==='income'?'+':'-';
  const isPaused=r.status==='paused';

  document.getElementById('recur-schedule-title').textContent='🔄 '+r.name+' — Schedule';

  // Summary
  document.getElementById('recur-schedule-summary').innerHTML=`
    <div class="sched-summary" style="margin-bottom:12px">
      <div><div class="sched-sum-val" style="color:${amtColor}">${amtSign}${fmt(r.amount)}</div><div class="sched-sum-lbl">Per ${RECUR_FREQ_LABELS[r.frequency]}</div></div>
      <div><div class="sched-sum-val" style="color:var(--income)">${appliedCount}</div><div class="sched-sum-lbl">Applied</div></div>
      <div><div class="sched-sum-val" style="color:${missedCount>0?'var(--rose)':'var(--text3)'}">${missedCount}</div><div class="sched-sum-lbl">Missed</div></div>
    </div>
    <div style="font-size:11px;color:var(--text2);margin-bottom:10px;background:var(--bg3);border-radius:10px;padding:10px 12px;line-height:1.6">
      <strong>${r.category.replace(/^\S+\s/,'')}</strong>${acc?' · '+acc.name:''} · ${RECUR_FREQ_LABELS[r.frequency]}
      ${r.startDate?`<br>Started: ${fmtDate(r.startDate)}`:''}
      ${r.endDate?`<br>Ends: ${fmtDate(r.endDate)}`:'<br>No end date'}
      ${isPaused?'<br><strong style="color:var(--amber)">⏸ Currently Paused</strong>':''}
      ${missedCount>0?`<br><strong style="color:var(--rose)">⚠️ ${missedCount} missed occurrence${missedCount>1?'s':''} — apply now to catch up</strong>`:''}
    </div>`;

  // Table
  if(schedule.length){
    const rows=schedule.map((s,i)=>{
      let badge='',rowClass='';
      if(s.status==='applied'){badge=`<span class="sched-badge applied">✓ Applied</span>`;rowClass='sched-paid';}
      else if(s.status==='current'){badge=`<span class="sched-badge current">📅 Due Today</span>`;rowClass='sched-current';}
      else if(s.status==='missed'){badge=`<span class="sched-badge missed">⚠ Missed</span>`;rowClass='sched-overdue';}
      else if(s.status==='paused'){badge=`<span class="sched-badge paused">⏸ Paused</span>`;}
      else{badge=`<span class="sched-badge upcoming">⏳ Upcoming</span>`;}
      // Find the applied transaction — check recurringDate first, then fall back to month-key
      const tx=db.transactions.find(t=>t.recurringId===r.id&&(t.recurringDate===s.date||(!t.recurringDate&&t.date.startsWith(s.date.substring(0,7)))));
      const txNote=tx?`<div style="font-size:9px;color:var(--text3);margin-top:1px">Paid ${fmtDate(tx.date)}</div>`:'';
      // Clickable rows for unpaid occurrences — open pay modal directly
      const isPayable=s.status!=='applied'&&s.status!=='paused'&&r.status!=='paused';
      const rowClick=isPayable?`onclick="closeModal('modal-recur-schedule');setTimeout(()=>openRecurPay('${r.id}'),200)" style="cursor:pointer"`:'';
      return`<tr class="${rowClass}" ${rowClick}>
        <td><div style="font-weight:600">#${i+1}</div></td>
        <td><div style="font-weight:600">${fmtDate(s.date)}</div></td>
        <td><div style="font-family:var(--mono);font-weight:700;color:${amtColor}">${amtSign}${fmt(r.amount)}</div>${txNote}</td>
        <td>${badge}</td>
      </tr>`;
    }).join('');
    document.getElementById('recur-schedule-table').innerHTML=`
      <div class="schedule-wrap">
        <table class="schedule-table">
          <thead><tr><th>#</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  } else {
    document.getElementById('recur-schedule-table').innerHTML=`<div style="text-align:center;color:var(--text3);padding:16px;font-size:12px">No occurrences generated. Check the start date and frequency.</div>`;
  }

  // Wire buttons
  const applyBtn=document.getElementById('recur-schedule-apply-btn');
  if(r.type==='income'){
    applyBtn.textContent='✅ Mark as Received';
    applyBtn.onclick=()=>{closeModal('modal-recur-schedule');setTimeout(()=>openRecurPay(id),200);};
  } else {
    applyBtn.textContent='💰 Pay Now';
    applyBtn.onclick=()=>{closeModal('modal-recur-schedule');setTimeout(()=>openRecurPay(id),200);};
  }
  document.getElementById('recur-schedule-pause-btn').textContent=isPaused?'▶ Resume Rule':'⏸ Pause Rule';
  document.getElementById('recur-schedule-pause-btn').onclick=()=>{toggleRecurPause(id);closeModal('modal-recur-schedule');};
  document.getElementById('recur-schedule-edit-btn').onclick=()=>{closeModal('modal-recur-schedule');openEditRecurring(id);};
  openModal('modal-recur-schedule');
}

function openPayPayable(id){
  const py=db.payables.find(p=>p.id===id);if(!py)return;
  payingPayableId=id;
  const tc=PAYABLE_COLORS[py.type]||'var(--text)';
  document.getElementById('pay-payable-detail').innerHTML=`<div class="card-sm" style="text-align:center">
    <div style="font-size:13px;font-weight:700">${py.name}</div>
    <div style="font-family:'Space Mono',monospace;font-size:18px;font-weight:700;color:${tc};margin-top:4px">${fmt(py.remaining)} remaining</div>
    <div style="font-size:11px;color:var(--text3);margin-top:4px">${fmt(py.paidAmount)} paid of ${fmt(py.totalAmount)} total</div>
    ${py.dueDay?`<div style="font-size:11px;color:var(--amber);margin-top:4px">📅 Due every ${py.dueDay}${py.dueDay===1?'st':py.dueDay===2?'nd':py.dueDay===3?'rd':'th'} of month</div>`:''}
  </div>`;
  // Reset months
  document.getElementById('pay-months').value='1';
  document.getElementById('pay-months-note').style.display='none';
  document.querySelectorAll('#modal-pay-payable .planned-btn').forEach(b=>b.classList.remove('confirm'));
  // Hide multi-month selector for singleMonthOnly payables
  const monthsGroup=document.querySelector('#modal-pay-payable .form-group');
  if(monthsGroup)monthsGroup.style.display=py.singleMonthOnly?'none':'block';
  document.getElementById('pay-amount').value=py.monthlyPayment||'';
  document.getElementById('pay-date').value=today();
  document.getElementById('pay-ref').value='';
  document.getElementById('pay-tx-fee').value='';
  document.getElementById('pay-balance-warning').style.display='none';
  const opts=db.accounts.map(a=>`<option value="${a.id}"${a.id===py.linkedAccount?' selected':''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('pay-from-account').innerHTML=opts;
  openModal('modal-pay-payable');
}

function setPayMonths(months, btn){
  const py=db.payables.find(p=>p.id===payingPayableId);if(!py)return;
  document.getElementById('pay-months').value=months;
  // Highlight selected button
  document.querySelectorAll('#modal-pay-payable .planned-btn').forEach(b=>b.classList.remove('confirm'));
  if(btn)btn.classList.add('confirm');
  // Update amount
  const baseAmt=py.monthlyPayment||0;
  if(baseAmt>0)document.getElementById('pay-amount').value=(baseAmt*months).toFixed(2);
  // Show note about advance payment
  const noteEl=document.getElementById('pay-months-note');
  if(months>1&&py.dueDay){
    const now=new Date();
    let nextDue=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
    if(nextDue<now)nextDue=new Date(now.getFullYear(),now.getMonth()+1,py.dueDay);
    const waiveDates=[];
    for(let i=0;i<months;i++){
      const d=new Date(nextDue.getFullYear(),nextDue.getMonth()+i,py.dueDay);
      waiveDates.push(d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}));
    }
    const afterDate=new Date(nextDue.getFullYear(),nextDue.getMonth()+months,py.dueDay);
    noteEl.style.display='block';
    noteEl.innerHTML=`📅 Paying ${months} month${months>1?'s':''} in advance.<br><strong>Waived:</strong> ${waiveDates.join(', ')}<br><strong>Next due:</strong> ${afterDate.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`;
  } else {
    noteEl.style.display='none';
  }
  checkPayableWarning();
}
function checkPayableWarning(){
  const py=db.payables.find(p=>p.id===payingPayableId);if(!py)return;
  const amount=parseFloat(document.getElementById('pay-amount').value)||0;
  const txFee=parseFloat(document.getElementById('pay-tx-fee').value)||0;
  const totalOut=amount+txFee;
  const wEl=document.getElementById('pay-balance-warning');
  // Check overpayment (fee doesn't count toward payable balance)
  if(!py.allowOverpay&&amount>py.remaining){
    wEl.style.display='block';wEl.textContent=`⚠️ Payment of ${fmt(amount)} exceeds remaining balance of ${fmt(py.remaining)}. Overpayment is not allowed for this payable.`;
    return;
  }
  // Check account balance (amount + fee)
  const accId=document.getElementById('pay-from-account').value;
  const acc=db.accounts.find(a=>a.id===accId);
  if(acc&&totalOut>acc.balance){
    wEl.style.display='block';
    wEl.textContent=txFee>0
      ?`⚠️ Insufficient balance! ${acc.name} has ${fmt(acc.balance)} but total (payment ${fmt(amount)} + fee ${fmt(txFee)}) is ${fmt(totalOut)}.`
      :`⚠️ Insufficient account balance! ${acc.name} has ${fmt(acc.balance)}.`;
  } else wEl.style.display='none';
}
function executePayPayable(){
  const py=db.payables.find(p=>p.id===payingPayableId);if(!py)return;
  const amount=parseFloat(document.getElementById('pay-amount').value)||0;
  const accId=document.getElementById('pay-from-account').value;
  const payDate=document.getElementById('pay-date').value||today();
  const ref=document.getElementById('pay-ref').value.trim();
  const txFee=parseFloat(document.getElementById('pay-tx-fee').value)||0;
  const months=parseInt(document.getElementById('pay-months').value)||1;
  if(amount<=0){showToast('Please enter a valid amount','error');return;}
  // Validations
  if(!py.allowOverpay&&amount>py.remaining){showToast(`❌ Cannot overpay! Remaining: ${fmt(py.remaining)}`,'error');return;}
  const acc=db.accounts.find(a=>a.id===accId);
  const totalOut=amount+txFee;
  if(acc&&totalOut>acc.balance){
    showToast(txFee>0?`❌ Insufficient balance! Need ${fmt(totalOut)} (payment + fee) but ${acc.name} has ${fmt(acc.balance)}`:`❌ Insufficient balance in ${acc.name}`,'error');return;
  }
  // Check savings reserve
  if(acc){
    const reserve=acc.savingsReserve||0;
    if(reserve>0&&(acc.balance-totalOut)<reserve){
      showToast(`⚠️ Warning: This will dip below your savings reserve of ${fmt(reserve)} in ${acc.name}`,'warn');
    }
    // Check goal protection
    const goalProtection=getGoalProtectedAmount(accId);
    if(goalProtection>0&&(acc.balance-totalOut)<goalProtection){
      const linkedGoals=db.goals.filter(g=>g.linkedAccountId===accId&&g.status!=='achieved');
      showToast(`⚠️ Warning: Payment touches protected goal funds (${fmt(goalProtection)}) in ${acc.name}`,'warn');
    }
  }
  // Deduct from account
  if(acc)acc.balance-=amount;
  // Update payable
  py.paidAmount=(py.paidAmount||0)+amount;
  py.remaining=Math.max(0,py.totalAmount-py.paidAmount);
  if(py.remaining<=0)py.status='paid';
  if(!py.payments)py.payments=[];
  py.payments.push({id:uid(),amount,accountId:accId,date:payDate,ref,months,createdAt:Date.now()});
  // Build multi-month coverage label for transaction description
  let txDesc=`Payment: ${py.name}`;
  if(months>1&&py.dueDay){
    const now2=new Date();
    let firstDue=new Date(now2.getFullYear(),now2.getMonth(),py.dueDay);
    if(firstDue<now2)firstDue=new Date(now2.getFullYear(),now2.getMonth()+1,py.dueDay);
    const lastDue=new Date(firstDue.getFullYear(),firstDue.getMonth()+months-1,py.dueDay);
    const fmtD=d=>d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
    txDesc+=` — Paid for ${fmtD(firstDue)} to ${fmtD(lastDue)}`;
  } else if(months>1){
    txDesc+=` (${months} months)`;
  }
  // Create transaction record
  const tx={id:uid(),type:'expense',amount,category:'💰 Bills',accountId:accId,date:payDate,ref,desc:txDesc,receipt:null,createdAt:Date.now(),payableId:py.id};
  db.transactions.unshift(tx);
  // Record fee as a separate transaction if provided
  if(txFee>0){
    if(acc)acc.balance-=txFee;
    const feeTx={id:uid(),type:'expense',amount:txFee,category:'💳 Fees',accountId:accId,date:payDate,ref,desc:`Transaction Fee: ${py.name}`,receipt:null,createdAt:Date.now(),payableId:py.id};
    db.transactions.unshift(feeTx);
    addLog('created',`Transaction fee: ${py.name} ${fmt(txFee)}`,feeTx.id,'transaction');
  }
  addLog('created',`Payable payment: ${py.name} ${fmt(amount)}${months>1?' ('+months+' months)':''}`,py.id,'payable');

  // ── Handle advance multi-month payment: waive scheduled dates ─
  // For singleMonthOnly payables: only mark the CURRENT due month as paid, no auto-scheduling
  if(py.dueDay&&py.status!=='paid'){
    const now=new Date();
    let nextDue=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
    if(nextDue<now)nextDue=new Date(now.getFullYear(),now.getMonth()+1,py.dueDay);

    // Mark the upcoming 'months' planned entries as waived/completed
    for(let i=0;i<months;i++){
      const waiveDate=new Date(nextDue.getFullYear(),nextDue.getMonth()+i,py.dueDay);
      const waiveDateStr=waiveDate.getFullYear()+'-'+String(waiveDate.getMonth()+1).padStart(2,'0')+'-'+String(waiveDate.getDate()).padStart(2,'0');
      const existingPl=db.planned.find(p=>p.payableId===py.id&&p.status==='pending'&&p.date===waiveDateStr);
      if(existingPl){
        existingPl.status='completed';existingPl.completedAt=Date.now();
        existingPl.completedNote=`Auto-waived: paid ${months} month${months>1?'s':''} in advance on ${payDate}`;
      } else {
        const monthStr=waiveDateStr.substring(0,7);
        const pl=db.planned.find(p=>p.payableId===py.id&&p.status==='pending'&&p.date.startsWith(monthStr));
        if(pl){pl.status='completed';pl.completedAt=Date.now();pl.completedNote=`Auto-waived: advance payment`;}
      }
    }

    // singleMonthOnly: do NOT auto-schedule the next due date — amount may change
    if(!py.singleMonthOnly){
      // Schedule next due date after advance payment window
      const nextDueFuture=new Date(nextDue.getFullYear(),nextDue.getMonth()+months,py.dueDay);
      const nextDueFutureStr=nextDueFuture.getFullYear()+'-'+String(nextDueFuture.getMonth()+1).padStart(2,'0')+'-'+String(nextDueFuture.getDate()).padStart(2,'0');
      const exists=db.planned.some(p=>p.payableId===py.id&&p.date===nextDueFutureStr&&p.status==='pending');
      if(!exists&&py.status!=='paid'){
        db.planned.push({id:uid(),type:'expense',amount:py.monthlyPayment||amount,category:'💰 Bills',accountId:accId,date:nextDueFutureStr,ref:'',desc:`Scheduled: ${py.name}`,status:'pending',originalDate:nextDueFutureStr,createdAt:Date.now(),payableId:py.id});
      }
    }
  }

  saveDB();closeModal('modal-pay-payable');
  let successMsg=py.status==='paid'?`🎉 ${py.name} is now FULLY PAID!`:`Payment recorded! ${fmt(py.remaining)} remaining`;
  if(months>1)successMsg=`✅ ${months} months paid! Next due date advanced.`;
  showToast(successMsg,'success');
  payingPayableId=null;renderPayables();renderHome();updatePayablesBadge();
  renderGoalsScreen();// refresh planned tab if visible
}

// ===== CATCH-UP / OVERDUE PAYMENT =====
let catchupPayableId=null;

/**
 * Calculate how many days overdue a payable is
 * based on the oldest unpaid past-due schedule entry.
 */
function getOverdueDays(py){
  const schedule=generatePayableSchedule(py);
  const overdue=schedule.filter(s=>s.status==='overdue');
  if(!overdue.length)return 0;
  const oldest=overdue[0];
  const diff=Math.ceil((new Date()-new Date(oldest.date+'T00:00:00'))/(1000*60*60*24));
  return Math.max(0,diff);
}

function openCatchupPayable(id){
  const py=db.payables.find(p=>p.id===id);if(!py)return;
  catchupPayableId=id;
  const schedule=generatePayableSchedule(py);
  const overdueEntries=schedule.filter(s=>s.status==='overdue');
  const overdueDays=getOverdueDays(py);
  const overdueTotal=overdueEntries.reduce((s,e)=>s+e.amount,0);
  const color=PAYABLE_COLORS[py.type]||'var(--text2)';

  document.getElementById('catchup-payable-detail').innerHTML=`<div class="card-sm" style="text-align:center">
    <div style="font-size:13px;font-weight:700">${py.name}</div>
    <div style="font-family:var(--mono);font-size:18px;font-weight:700;color:${color};margin-top:4px">${fmt(py.remaining)} remaining</div>
    <div style="font-size:11px;color:var(--text3);margin-top:4px">${overdueEntries.length} overdue installment${overdueEntries.length>1?'s':''}</div>
  </div>`;

  document.getElementById('catchup-overdue-info').innerHTML=
    `⏰ This payable is overdue by <strong>${overdueDays} day${overdueDays!==1?'s':''}</strong>.<br>
     <strong>Overdue installments:</strong><br>
     ${overdueEntries.map(e=>`• ${e.label||fmtDate(e.date)} — ${fmt(e.amount)}`).join('<br>')}<br>
     <strong>Suggested catch-up: ${fmt(overdueTotal)}</strong> — add late fee below if any.`;

  document.getElementById('catchup-amount').value=overdueTotal>0?overdueTotal.toFixed(2):'';
  document.getElementById('catchup-late-fee').value='0';
  document.getElementById('catchup-date').value=today();
  document.getElementById('catchup-notes').value='';
  document.getElementById('catchup-preview').style.display='none';

  const opts=db.accounts.map(a=>`<option value="${a.id}"${a.id===py.linkedAccount?' selected':''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('catchup-from-account').innerHTML=opts;
  openModal('modal-catchup-payable');
  updateCatchupPreview();
}

function updateCatchupPreview(){
  const amount=parseFloat(document.getElementById('catchup-amount').value)||0;
  const lateFee=parseFloat(document.getElementById('catchup-late-fee').value)||0;
  const total=amount+lateFee;
  const prev=document.getElementById('catchup-preview');
  if(amount>0){
    prev.style.display='block';
    prev.innerHTML=`💰 Paying <strong>${fmt(total)}</strong> today${lateFee>0?` (includes <strong>${fmt(lateFee)}</strong> late fee as separate record)`:''}`;
  } else {
    prev.style.display='none';
  }
}

function executeCatchupPayment(){
  const py=db.payables.find(p=>p.id===catchupPayableId);if(!py)return;
  const catchupAmount=parseFloat(document.getElementById('catchup-amount').value)||0;
  const lateFee=parseFloat(document.getElementById('catchup-late-fee').value)||0;
  const accId=document.getElementById('catchup-from-account').value;
  const payDate=document.getElementById('catchup-date').value||today();
  const notes=document.getElementById('catchup-notes').value.trim();

  if(catchupAmount<=0){showToast('Please enter a catch-up amount','error');return;}
  const acc=db.accounts.find(a=>a.id===accId);
  const totalOut=catchupAmount+lateFee;
  if(acc&&totalOut>acc.balance){showToast(`❌ Insufficient balance! ${acc.name} has ${fmt(acc.balance)}`,'error');return;}

  // Identify which overdue installments are covered
  const schedule=generatePayableSchedule(py);
  const overdueEntries=schedule.filter(s=>s.status==='overdue');
  let covered=[];
  let principal=catchupAmount;
  for(const entry of overdueEntries){
    if(principal<=0)break;
    covered.push(entry);
    principal-=entry.amount;
  }
  const coveredLabels=covered.map(e=>e.label||fmtDate(e.date));

  // Deduct from account
  if(acc)acc.balance-=totalOut;

  // Update payable principal
  py.paidAmount=(py.paidAmount||0)+catchupAmount;
  py.remaining=Math.max(0,py.totalAmount-py.paidAmount);
  if(py.remaining<=0)py.status='paid';
  if(!py.payments)py.payments=[];
  // ⚠️  IMPORTANT: use the FIRST OVERDUE due-date as the payment reference date
  // so that generatePayableSchedule correctly maps this payment to the right months.
  const firstOverdueDueDate=covered.length>0?covered[0].date:payDate;
  py.payments.push({
    id:uid(),
    amount:catchupAmount,
    lateFee,
    accountId:accId,
    date:firstOverdueDueDate,   // anchor to first overdue due date for schedule engine
    actualDate:payDate,          // when money was actually paid
    ref:'catch-up',
    notes,
    months:Math.max(1,covered.length),  // number of installments covered
    createdAt:Date.now(),
    type:'catchup'
  });

  // Mark covered overdue planned entries as completed
  covered.forEach(entry=>{
    const monthStr=entry.date.substring(0,7);
    const pl=db.planned.find(p=>p.payableId===py.id&&p.status==='pending'&&p.date.startsWith(monthStr));
    if(pl){pl.status='completed';pl.completedAt=Date.now();pl.completedNote=`Catch-up payment on ${payDate}`;}
  });

  // Build description mentioning covered months
  const covDesc=coveredLabels.length?` — covered: ${coveredLabels.join(' & ')}`:'';
  const txDesc=`Catch-up Payment: ${py.name}${covDesc}${notes?' ('+notes+')':''}`;

  // Create main catch-up transaction
  const tx={id:uid(),type:'expense',amount:catchupAmount,category:'💰 Bills',accountId:accId,date:payDate,ref:'catch-up',desc:txDesc,receipt:null,createdAt:Date.now(),payableId:py.id};
  db.transactions.unshift(tx);

  // Create separate late fee transaction if applicable
  if(lateFee>0){
    const feeTx={id:uid(),type:'expense',amount:lateFee,category:'💳 Fees',accountId:accId,date:payDate,ref:'late-fee',desc:`Late Fee: ${py.name}`,receipt:null,createdAt:Date.now(),payableId:py.id};
    db.transactions.unshift(feeTx);
    addLog('created',`Late fee: ${py.name} ${fmt(lateFee)}`,feeTx.id,'transaction');
  }
  addLog('created',`Catch-up payment: ${py.name} ${fmt(catchupAmount)}`,tx.id,'payable');

  saveDB();closeModal('modal-catchup-payable');

  // Toast message
  let msg=covered.length===1
    ?`✅ Marked ${coveredLabels[0]} installment as paid. Great job catching up!`
    :`✅ Marked ${coveredLabels.join(' & ')} installments as paid. Great job catching up!`;
  if(py.status==='paid')msg=`🎉 ${py.name} is now FULLY PAID!`;
  showToast(msg,'success');

  catchupPayableId=null;renderPayables();renderHome();updatePayablesBadge();
}

// Schedule payment
function openSchedulePayable(id){
  const py=db.payables.find(p=>p.id===id);if(!py)return;
  schedulingPayableId=id;
  const tc=PAYABLE_COLORS[py.type]||'var(--text)';
  document.getElementById('schedule-payable-detail').innerHTML=`<div class="card-sm" style="text-align:center"><div style="font-size:13px;font-weight:700">${py.name}</div><div style="font-family:'Space Mono',monospace;font-size:16px;color:${tc};margin-top:4px">${fmt(py.remaining)} remaining</div></div>`;
  // Suggest next due date
  if(py.dueDay){const d=new Date();d.setDate(py.dueDay);if(d<new Date())d.setMonth(d.getMonth()+1);document.getElementById('sched-date').value=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
  else document.getElementById('sched-date').value=today();
  document.getElementById('sched-amount').value=py.monthlyPayment||'';
  document.getElementById('sched-notes').value='';
  document.getElementById('sched-balance-warning').style.display='none';
  // Populate account dropdown
  const opts=db.accounts.map(a=>`<option value="${a.id}"${a.id===py.linkedAccount?' selected':''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('sched-account').innerHTML=opts;
  openModal('modal-schedule-payable');
  setTimeout(checkSchedBalance,100);
}
function checkSchedBalance(){
  const py=db.payables.find(p=>p.id===schedulingPayableId);if(!py)return;
  const amount=parseFloat(document.getElementById('sched-amount').value)||0;
  const accId=document.getElementById('sched-account').value;
  const acc=db.accounts.find(a=>a.id===accId);
  const warn=document.getElementById('sched-balance-warning');
  if(acc&&amount>0&&acc.balance<amount){
    warn.style.display='block';
    warn.textContent=`⚠️ Heads up! ${acc.name} only has ${fmt(acc.balance)} — not enough for this payment of ${fmt(amount)}. You'll be reminded to top up before the scheduled date.`;
  }else{warn.style.display='none';}
}
function executeSchedulePayable(){
  const py=db.payables.find(p=>p.id===schedulingPayableId);if(!py)return;
  const date=document.getElementById('sched-date').value;
  const amount=parseFloat(document.getElementById('sched-amount').value)||py.monthlyPayment||0;
  const notes=document.getElementById('sched-notes').value.trim();
  const selAccId=document.getElementById('sched-account').value;
  if(!date){showToast('Please select a date','error');return;}
  const accId=selAccId||py.linkedAccount||db.accounts[0]?.id;
  const acc=db.accounts.find(a=>a.id===accId);
  const pl={id:uid(),type:'expense',amount,category:'💰 Bills',accountId:accId,date,ref:'',desc:`Scheduled: ${py.name}${notes?' — '+notes:''}`,status:'pending',originalDate:date,createdAt:Date.now(),payableId:py.id};
  db.planned.push(pl);
  addLog('created',`Scheduled payable payment: ${py.name} ${fmt(amount)} on ${fmtDate(date)}`,py.id,'payable');
  saveDB();closeModal('modal-schedule-payable');
  // Balance check notification
  if(acc&&amount>acc.balance){
    setTimeout(()=>showToast(`⚠️ ${acc.name} balance is low! Top up before ${fmtDate(date)}.`,'warn'),400);
  }else{
    showToast('Payment scheduled to calendar! 📅');
  }
  schedulingPayableId=null;updateOverdueBadge();renderPayables();
}

// Render payables
function renderPayables(){
  try{
    checkPayablesBalanceAlerts();
    const container=document.getElementById('payables-content');
    if(!container){console.warn('payables-content not found');return;}
    if(currentPayablesTab==='active')renderActivePayables(container);
    else if(currentPayablesTab==='summary')renderPayablesSummary(container);
    else if(currentPayablesTab==='history')renderPayablesHistory(container);
    else renderPaidPayables(container);
  }catch(err){
    const c=document.getElementById('payables-content');
    if(c)c.innerHTML=`<div class="empty"><div class="empty-icon">⚠️</div><p>Error loading payables.<br><small style="color:var(--text3)">${err.message}</small></p></div>`;
    console.error('renderPayables error:',err);
  }
}
function renderActivePayables(container){
  const active=db.payables.filter(p=>p.status==='active');
  if(!active.length){
    container.innerHTML='<div class="empty"><div class="empty-icon">💳</div><p>No active payables.<br>Tap + to add a loan,<br>credit card, or BNPL.</p></div>';
    return;
  }
  let html='';
  active.forEach(function(py){
    const pct=Math.min(100,((py.paidAmount||0)/py.totalAmount)*100);
    const color=PAYABLE_COLORS[py.type]||'var(--text2)';
    const progressColor=pct>=80?'var(--income)':pct>=40?'var(--planned)':'var(--expense)';

    // Calculate next unpaid due date
    const todayStr=today();
    const schedule=generatePayableSchedule(py);
    const nextUnpaid=schedule.find(s=>s.status==='overdue'||s.status==='current'||s.status==='upcoming');
    const overdueCount=schedule.filter(s=>s.status==='overdue').length;
    const paidCount=schedule.filter(s=>s.status==='paid').length;
    const totalInstallments=schedule.length;

    let dueHtml='';
    if(nextUnpaid){
      const daysUntil=Math.ceil((new Date(nextUnpaid.date+'T00:00:00')-new Date())/(1000*60*60*24));
      if(nextUnpaid.status==='overdue')dueHtml=`<span style="color:var(--overdue);font-size:11px">⚠️ ${overdueCount} payment${overdueCount>1?'s':''} overdue</span>`;
      else if(daysUntil<=3)dueHtml=`<span style="color:var(--planned);font-size:11px">⏰ Due in ${daysUntil===0?'today':daysUntil+' day'+(daysUntil!==1?'s':'')}</span>`;
      else dueHtml=`<span style="font-size:11px;color:var(--text3)">📅 Next due: ${fmtDate(nextUnpaid.date)}</span>`;
    } else if(py.dueDay){
      dueHtml=`<span style="font-size:11px;color:var(--income)">✅ Fully paid off!</span>`;
    }

    html+='<div class="payable-card" onclick="openPayableSchedule(\''+py.id+'\')">';
    html+='<div class="payable-header">';
    html+='<div><div class="payable-name">'+py.name+'</div>';
    html+='<span class="payable-type-badge '+py.type+'">'+PAYABLE_TYPES[py.type]+'</span></div>';
    html+='<div style="text-align:right">';
    html+='<div style="font-family:var(--mono);font-size:16px;font-weight:700;color:'+color+'">'+fmt(py.remaining||0)+'</div>';
    html+='<div style="font-size:10px;color:var(--text3)">remaining</div></div></div>';
    html+='<div style="font-size:11px;color:var(--text3);margin-bottom:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">';
    html+=dueHtml;
    if(py.monthlyPayment)html+='<span>Monthly: '+fmt(py.monthlyPayment)+'</span>';
    if(totalInstallments>0)html+='<span style="color:var(--text3)">'+paidCount+'/'+totalInstallments+' paid</span>';
    html+='</div>';
    html+='<div class="payable-progress-wrap"><div class="payable-progress-bar" style="width:'+pct.toFixed(1)+'%;background:'+progressColor+'"></div></div>';
    html+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-top:4px">';
    html+='<span>Paid: '+fmt(py.paidAmount||0)+'</span><span>'+pct.toFixed(0)+'% done</span><span>Total: '+fmt(py.totalAmount)+'</span></div>';
    html+='<div class="payable-actions">';
    html+='<button type="button" class="payable-btn pay" onclick="event.stopPropagation();openPayPayable(\''+py.id+'\')">💰 Pay Now</button>';
    html+='<button type="button" class="payable-btn" style="background:var(--blue-bg);border-color:rgba(59,130,246,.3);color:var(--blue)" onclick="event.stopPropagation();openPayableSchedule(\''+py.id+'\')">📊 Schedule</button>';
    html+='<button type="button" class="payable-btn edit" onclick="event.stopPropagation();openEditPayable(\''+py.id+'\')">✏️ Edit</button>';
    html+='</div>';
    // Show Catch-up button if overdue
    if(overdueCount>0){
      html+='<button type="button" class="payable-btn" style="width:100%;margin-top:6px;background:var(--rose-bg);border-color:rgba(225,29,72,.35);color:var(--rose);font-size:11px" onclick="event.stopPropagation();openCatchupPayable(\''+py.id+'\')">🔴 Catch-up / Pay Overdue ('+overdueCount+' month'+( overdueCount>1?'s':'')+' behind)</button>';
    }
    html+='</div>';
  });
  container.innerHTML=html;
}
function renderPayablesSummary(container){
  const active=db.payables.filter(p=>p.status==='active');
  const totalOwed=active.reduce((s,p)=>s+(p.remaining||0),0);
  const totalMonthly=active.reduce((s,p)=>s+(p.monthlyPayment||0),0);
  const totalPaid=db.payables.reduce((s,p)=>s+(p.paidAmount||0),0);
  let html=`<div class="payable-summary-grid">
    <div class="payable-sum-card"><div class="psv" style="color:var(--expense)">${fmt(totalOwed)}</div><div class="psl">Total Owed</div></div>
    <div class="payable-sum-card"><div class="psv" style="color:var(--planned)">${fmt(totalMonthly)}</div><div class="psl">Monthly Due</div></div>
    <div class="payable-sum-card"><div class="psv" style="color:var(--income)">${fmt(totalPaid)}</div><div class="psl">Total Paid</div></div>
    <div class="payable-sum-card"><div class="psv" style="color:var(--accent)">${active.length}</div><div class="psl">Active Payables</div></div>
  </div>`;
  if(!active.length){html+=`<div class="empty"><div class="empty-icon">🎉</div><p>No active payables!</p></div>`;container.innerHTML=html;return;}
  const byType={loan:[],credit:[],spl:[],other:[]};
  active.forEach(p=>{if(byType[p.type])byType[p.type].push(p);});
  Object.entries(byType).forEach(function(entry){
    const type=entry[0],arr=entry[1];
    if(!arr.length)return;
    const subtotal=arr.reduce((s,p)=>s+(p.remaining||0),0);
    html+='<div class="card"><div class="section-title">'+PAYABLE_TYPES[type]+' <span style="color:'+PAYABLE_COLORS[type]+'">'+fmt(subtotal)+'</span></div>';
    arr.forEach(function(p){
      const pct=Math.min(100,((p.paidAmount||0)/p.totalAmount)*100);
      html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">';
      html+='<div><div style="font-size:13px;font-weight:600">'+p.name+'</div>';
      html+='<div style="font-size:11px;color:var(--text3)">'+pct.toFixed(0)+'% paid</div></div>';
      html+='<div style="text-align:right"><div style="font-family:\'Space Mono\',monospace;font-size:13px;font-weight:700;color:'+PAYABLE_COLORS[type]+'">'+fmt(p.remaining||0)+'</div>';
      if(p.monthlyPayment)html+='<div style="font-size:10px;color:var(--text3)">'+fmt(p.monthlyPayment)+'/mo</div>';
      html+='</div></div>';
    });
    html+='</div>';
  });
  container.innerHTML=html;
}
function renderPaidPayables(container){
  const paid=db.payables.filter(p=>p.status==='paid');
  if(!paid.length){container.innerHTML=`<div class="empty"><div class="empty-icon">🎉</div><p>No fully paid payables yet.</p></div>`;return;}
  container.innerHTML=paid.map(p=>`<div class="payable-card" onclick="openEditPayable('${p.id}')">
    <div class="payable-header"><div><div class="payable-name">${p.name}</div><span class="payable-type-badge ${p.type}">${PAYABLE_TYPES[p.type]}</span></div><div style="text-align:right"><div style="font-size:12px;font-weight:700;color:var(--income)">✅ PAID OFF</div><div style="font-family:'Space Mono',monospace;font-size:13px;color:var(--text2)">${fmt(p.totalAmount)}</div></div></div>
    <div class="payable-progress-wrap"><div class="payable-progress-bar" style="width:100%;background:var(--income)"></div></div>
  </div>`).join('');
}

function renderPayablesHistory(container){
  // All payables with their payment history
  const all=db.payables;
  if(!all.length){container.innerHTML=`<div class="empty"><div class="empty-icon">💳</div><p>No payables recorded yet.</p></div>`;return;}
  let html='';
  all.forEach(py=>{
    const payments=(py.payments||[]).sort((a,b)=>b.date?.localeCompare(a.date)||0);
    const color=PAYABLE_COLORS[py.type]||'var(--text2)';
    const pct=Math.min(100,((py.paidAmount||0)/py.totalAmount)*100);
    html+=`<div class="payable-card">
      <div class="payable-header" onclick="openPayableHistory('${py.id}')" style="cursor:pointer">
        <div>
          <div class="payable-name">${py.name} <span style="font-size:11px;color:var(--accent)">▼ ${payments.length} payments</span></div>
          <span class="payable-type-badge ${py.type}">${PAYABLE_TYPES[py.type]}</span>
        </div>
        <div style="text-align:right">
          <div style="font-family:'Space Mono',monospace;font-size:15px;font-weight:700;color:${color}">${fmt(py.paidAmount||0)}</div>
          <div style="font-size:10px;color:var(--text3)">paid of ${fmt(py.totalAmount)}</div>
        </div>
      </div>
      <div class="payable-progress-wrap"><div class="payable-progress-bar" style="width:${pct.toFixed(1)}%;background:${pct>=80?'var(--income)':pct>=40?'var(--planned)':'var(--expense)'}"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-top:4px;margin-bottom:8px">
        <span>${pct.toFixed(0)}% paid</span><span>${fmt(py.remaining||0)} remaining</span>
      </div>
      ${payments.length>0?`
      <div style="border-top:1px solid var(--border);padding-top:10px">
        <div style="font-size:11px;font-weight:700;color:var(--text2);margin-bottom:8px">Recent Payments</div>
        ${payments.slice(0,3).map(pay=>{
          const acc=db.accounts.find(a=>a.id===pay.accountId);
          const mths=pay.months||1;
          let coverageLine='';
          if(mths>1&&py.dueDay){
            const payDate=new Date(pay.date+'T00:00:00');
            let firstDue=new Date(payDate.getFullYear(),payDate.getMonth(),py.dueDay);
            if(firstDue<payDate)firstDue=new Date(payDate.getFullYear(),payDate.getMonth()+1,py.dueDay);
            const lastDue=new Date(firstDue.getFullYear(),firstDue.getMonth()+mths-1,py.dueDay);
            const fd=firstDue.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
            const ld=lastDue.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
            coverageLine=`<div style="font-size:9px;color:var(--blue-l);font-weight:600">📅 ${fd} — ${ld}</div>`;
          }
          const mBadge=mths>1?`<span style="font-size:8px;font-weight:700;background:var(--blue-bg);color:var(--blue-l);padding:1px 5px;border-radius:4px;margin-left:4px">${mths}M</span>`:'';
          return`<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--border)">
            <div>
              <div style="font-size:12px;font-weight:600;color:var(--income)">+${fmt(pay.amount)}${mBadge}</div>
              <div style="font-size:10px;color:var(--text3)">${fmtDate(pay.date)}${acc?' · '+acc.name:''}${pay.ref?' · '+pay.ref:''}</div>
              ${coverageLine}
            </div>
            <div style="font-size:10px;color:var(--income)">✓ Paid</div>
          </div>`;
        }).join('')}
        ${payments.length>3?`<div style="text-align:center;padding:6px;font-size:11px;color:var(--accent);cursor:pointer" onclick="openPayableHistory('${py.id}')">View all ${payments.length} payments →</div>`:''}
      </div>`:'<div style="font-size:12px;color:var(--text3);text-align:center;padding:8px">No payments recorded yet</div>'}
    </div>`;
  });
  container.innerHTML=html;
}

function openPayableHistory(id){
  const py=db.payables.find(p=>p.id===id);if(!py)return;
  const payments=(py.payments||[]).sort((a,b)=>b.date?.localeCompare(a.date)||0);
  const color=PAYABLE_COLORS[py.type]||'var(--text2)';
  document.getElementById('payable-history-title').textContent=py.name+' — Payment History';
  document.getElementById('payable-history-detail').innerHTML=`<div style="background:var(--bg3);border-radius:12px;padding:12px 14px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center">
    <div><div style="font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:var(--income)">${fmt(py.paidAmount||0)}</div><div style="font-size:10px;color:var(--text3)">Total Paid</div></div>
    <div><div style="font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:${color}">${fmt(py.remaining||0)}</div><div style="font-size:10px;color:var(--text3)">Remaining</div></div>
    <div><div style="font-family:'Space Mono',monospace;font-size:14px;font-weight:700">${payments.length}</div><div style="font-size:10px;color:var(--text3)">Payments</div></div>
  </div>`;
  if(!payments.length){
    document.getElementById('payable-history-list').innerHTML=`<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No payments recorded yet for this payable.</div>`;
  } else {
    document.getElementById('payable-history-list').innerHTML=`<div class="card" style="margin-top:0">${payments.map(pay=>{
      const acc=db.accounts.find(a=>a.id===pay.accountId);
      const months=pay.months||1;
      // Build coverage label for multi-month payments
      let coverageHtml='';
      if(months>1&&py.dueDay){
        const payDate=new Date(pay.date+'T00:00:00');
        let firstDue=new Date(payDate.getFullYear(),payDate.getMonth(),py.dueDay);
        if(firstDue<payDate)firstDue=new Date(payDate.getFullYear(),payDate.getMonth()+1,py.dueDay);
        const lastDue=new Date(firstDue.getFullYear(),firstDue.getMonth()+months-1,py.dueDay);
        const fmtD=d=>d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
        coverageHtml=`<div style="font-size:10px;color:var(--blue-l);margin-top:3px;font-weight:600">📅 Covers: ${fmtD(firstDue)} — ${fmtD(lastDue)}</div>`;
      }
      const monthsBadge=months>1?`<span style="font-size:9px;font-weight:700;background:var(--blue-bg);color:var(--blue-l);padding:2px 7px;border-radius:6px;margin-left:6px">${months} Months Advance</span>`:'';
      return`<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px 0;border-bottom:1px solid var(--border)">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px">
            <div style="font-size:13px;font-weight:700;color:var(--income)">+${fmt(pay.amount)}</div>
            ${monthsBadge}
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px">${fmtDate(pay.date)}${acc?' · '+acc.name:''}</div>
          ${coverageHtml}
          ${pay.ref?`<div style="font-size:10px;color:var(--text3)">Ref: ${pay.ref}</div>`:''}
        </div>
        <div style="text-align:right;flex-shrink:0;margin-left:10px">
          <div style="font-size:10px;color:var(--income);font-weight:700">✓ Paid</div>
          ${months>1?`<div style="font-size:9px;color:var(--text3);margin-top:2px">${months} cycles</div>`:''}
        </div>
      </div>`;
    }).join('')}</div>`;
  }
  openModal('modal-payable-history');
}

// ===== QR CODES =====
function renderQRScreen(){
  const screen=document.getElementById('accounts-list-screen');

  // Sub-tab header
  const subTabsHTML=`<div class="qr-subtabs">
    <button class="qr-subtab${currentQRSubTab==='received'?' active':''}" onclick="switchQRSubTab('received',this)">📲 Received</button>
    <button class="qr-subtab${currentQRSubTab==='contacts'?' active':''}" onclick="switchQRSubTab('contacts',this)">👥 Contacts</button>
  </div>`;

  if(currentQRSubTab==='received'){
    if(!db.qrCodes.length){
      screen.innerHTML=subTabsHTML+`<div class="empty"><div class="empty-icon">📲</div><p>No QR codes yet.<br>Tap <strong>＋</strong> to add your GCash,<br>Maya, or bank QR code.</p></div>`;
      return;
    }
    screen.innerHTML=subTabsHTML+db.qrCodes.map(qr=>{
      const acc=qr.linkedAccount?db.accounts.find(a=>a.id===qr.linkedAccount):null;
      const iconBg=acc?acc.color+'22':'var(--bg3)';
      const iconChar=acc?ACC_ICONS[acc.type]:'📲';
      return `<div class="qr-card">
        <div class="qr-header">
          <div class="qr-icon" style="background:${iconBg}">${iconChar}</div>
          <div class="qr-info">
            <div class="qr-name">${qr.label}</div>
            <div class="qr-sub">${[qr.owner,acc?acc.name:''].filter(Boolean).join(' · ')}</div>
          </div>
        </div>
        <div class="qr-img-wrap"><img src="${qr.image}" alt="QR Code for ${qr.label}" loading="lazy"></div>
        <div class="qr-actions">
          <button type="button" class="qr-btn present" onclick="presentQR('${qr.id}')">📲 Present</button>
          <button type="button" class="qr-btn download" onclick="downloadQR('${qr.id}')">⬇️ Save</button>
          <button type="button" class="qr-btn delete" onclick="openEditQR('${qr.id}')">✏️ Edit</button>
        </div>
      </div>`;
    }).join('');
  } else {
    // Contacts tab
    if(!db.qrContacts.length){
      screen.innerHTML=subTabsHTML+`<div class="empty"><div class="empty-icon">👥</div><p>No QR contacts yet.<br>Tap <strong>＋</strong> to save the QR code<br>of a person or merchant.</p></div>`;
      return;
    }
    const typeEmoji={'person':'👤','merchant':'🏪','business':'🏢','other':'📋'};
    const typeLabel={'person':'Person','merchant':'Merchant / Store','business':'Business','other':'Other'};
    screen.innerHTML=subTabsHTML+db.qrContacts.map(c=>{
      const emoji=typeEmoji[c.type]||'👤';
      const initials=c.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
      const avatarInner=c.profileImage
        ?`<img src="${c.profileImage}" alt="${c.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`
        :`<span style="font-size:18px;font-weight:700;color:var(--blue-l)">${initials}</span>`;
      return `<div class="qrc-card">
        <div class="qrc-header">
          <div class="qrc-avatar" style="background:${c.profileImage?'transparent':'var(--blue-bg)'}">${avatarInner}</div>
          <div class="qrc-info">
            <div class="qrc-name">${c.name}</div>
            <div class="qrc-type">${emoji} ${typeLabel[c.type]||'Other'}${c.accountInfo?' · '+c.accountInfo:''}</div>
          </div>
        </div>
        <div class="qrc-img-wrap"><img src="${c.image}" alt="QR for ${c.name}" loading="lazy"></div>
        <div class="qrc-actions">
          <button type="button" class="qr-btn present" onclick="presentQRContact('${c.id}')">📲 Present</button>
          <button type="button" class="qr-btn download" onclick="downloadQRContact('${c.id}')">⬇️ Save</button>
          <button type="button" class="qr-btn delete" onclick="openEditQRContact('${c.id}')">✏️ Edit</button>
        </div>
      </div>`;
    }).join('');
  }
}

function switchQRSubTab(tab){
  currentQRSubTab=tab;
  renderQRScreen();
}


function openAddQR(){
  editingQRId=null;qrUploadData=null;
  document.getElementById('modal-qr-title').textContent='Add QR Code';
  document.getElementById('qr-label').value='';
  document.getElementById('qr-owner').value='';
  document.getElementById('qr-delete-btn').style.display='none';
  document.getElementById('qr-save-btn').textContent='Save QR Code';
  // Reset upload zone
  document.getElementById('qr-upload-label-default').style.display='';
  document.getElementById('qr-upload-preview').style.display='none';
  document.getElementById('qr-remove-btn').style.display='none';
  document.getElementById('qr-file-input').value='';
  document.getElementById('qr-upload-zone').classList.remove('has-file');
  // Account dropdown
  const opts='<option value="">-- Not linked to account --</option>'+db.accounts.map(a=>`<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name}</option>`).join('');
  document.getElementById('qr-account').innerHTML=opts;
  openModal('modal-qr');
}
function openEditQR(id){
  const qr=db.qrCodes.find(q=>q.id===id);if(!qr)return;
  editingQRId=id;qrUploadData=qr.image;
  document.getElementById('modal-qr-title').textContent='Edit QR Code';
  document.getElementById('qr-label').value=qr.label;
  document.getElementById('qr-owner').value=qr.owner||'';
  document.getElementById('qr-delete-btn').style.display='';
  document.getElementById('qr-save-btn').textContent='Update QR Code';
  document.getElementById('qr-upload-label-default').style.display='none';
  document.getElementById('qr-upload-preview').style.display='block';
  document.getElementById('qr-preview-img').src=qr.image;
  document.getElementById('qr-preview-fname').textContent='📷 QR image saved';
  document.getElementById('qr-remove-btn').style.display='block';
  document.getElementById('qr-upload-zone').classList.add('has-file');
  const opts='<option value="">-- Not linked to account --</option>'+db.accounts.map(a=>`<option value="${a.id}"${a.id===qr.linkedAccount?' selected':''}>${ACC_ICONS[a.type]} ${a.name}</option>`).join('');
  document.getElementById('qr-account').innerHTML=opts;
  openModal('modal-qr');
}
function handleQRUpload(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){showToast('File too large! Max 5MB','error');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    qrUploadData=ev.target.result;
    document.getElementById('qr-upload-label-default').style.display='none';
    document.getElementById('qr-upload-preview').style.display='block';
    document.getElementById('qr-preview-img').src=qrUploadData;
    document.getElementById('qr-preview-fname').textContent='📷 '+file.name;
    document.getElementById('qr-remove-btn').style.display='block';
    document.getElementById('qr-upload-zone').classList.add('has-file');
  };
  reader.readAsDataURL(file);
}
function removeQRUpload(){
  qrUploadData=null;
  document.getElementById('qr-upload-label-default').style.display='';
  document.getElementById('qr-upload-preview').style.display='none';
  document.getElementById('qr-preview-img').src='';
  document.getElementById('qr-remove-btn').style.display='none';
  document.getElementById('qr-upload-zone').classList.remove('has-file');
  document.getElementById('qr-file-input').value='';
}
function saveQR(){
  const label=document.getElementById('qr-label').value.trim();
  const owner=document.getElementById('qr-owner').value.trim();
  const linkedAccount=document.getElementById('qr-account').value||null;
  if(!label){showToast('Please enter a label','error');return;}
  if(!qrUploadData){showToast('Please upload a QR code image','error');return;}
  if(editingQRId){
    const qr=db.qrCodes.find(q=>q.id===editingQRId);
    if(qr)Object.assign(qr,{label,owner,linkedAccount,image:qrUploadData});
  }else{
    db.qrCodes.push({id:uid(),label,owner,linkedAccount,image:qrUploadData,createdAt:Date.now()});
  }
  saveDB();closeModal('modal-qr');
  showToast(editingQRId?'QR code updated!':'QR code saved! 📲');
  editingQRId=null;renderQRScreen();
}
function deleteQR(){
  showConfirm('Delete QR Code?','',()=>{
    db.qrCodes=db.qrCodes.filter(q=>q.id!==editingQRId);
    saveDB();closeModal('modal-qr');showToast('QR code deleted','error');
    editingQRId=null;renderQRScreen();
  });
}
function presentQR(id){
  const qr=db.qrCodes.find(q=>q.id===id);if(!qr)return;
  const acc=qr.linkedAccount?db.accounts.find(a=>a.id===qr.linkedAccount):null;
  qrFSData=qr;
  _openQRFullscreen(qr.image, qr.label, `${qr.owner||''}${acc?' · '+acc.name:''}`);
}
function presentQRContact(id){
  const c=db.qrContacts.find(q=>q.id===id);if(!c)return;
  qrFSData=c;
  _openQRFullscreen(c.image, c.name, c.accountInfo||'');
}
function _openQRFullscreen(img,name,sub){
  _qrZoomLevel=1;
  document.getElementById('qr-fs-name').textContent=name;
  document.getElementById('qr-fs-sub').textContent=sub;
  const fsImg=document.getElementById('qr-fs-img');
  fsImg.src=img;
  fsImg.style.transform='scale(1)';
  document.getElementById('qr-fs-zoom-label').textContent='100%';
  document.getElementById('qr-fullscreen').classList.add('open');
}
let _qrZoomLevel=1;
function qrZoom(dir){
  const steps=[0.6,0.8,1,1.3,1.6,2.0,2.5,3.2];
  const img=document.getElementById('qr-fs-img');
  const label=document.getElementById('qr-fs-zoom-label');
  let idx=steps.findIndex(s=>Math.abs(s-_qrZoomLevel)<0.05);
  if(idx<0)idx=2;
  idx=Math.max(0,Math.min(steps.length-1,idx+dir));
  _qrZoomLevel=steps[idx];
  img.style.transform=`scale(${_qrZoomLevel})`;
  label.textContent=Math.round(_qrZoomLevel*100)+'%';
}
function closeQRFullscreen(){
  const img=document.getElementById('qr-fs-img');
  if(img){img.style.transform='scale(1)';}
  document.getElementById('qr-fullscreen').classList.remove('open');
  _qrZoomLevel=1;
}
function downloadQRFullscreen(){if(qrFSData)downloadQRById(qrFSData.id);}
function downloadQR(id){downloadQRById(id);}
function downloadQRById(id){
  const qr=db.qrCodes.find(q=>q.id===id);if(!qr)return;
  const a=document.createElement('a');
  a.href=qr.image;
  a.download=`${qr.label.replace(/\s+/g,'-')}-QR.png`;
  a.click();
  showToast('QR code downloaded! ⬇️');
}
function downloadQRContact(id){
  const c=db.qrContacts.find(q=>q.id===id);if(!c)return;
  const a=document.createElement('a');
  a.href=c.image;
  a.download=`${c.name.replace(/\s+/g,'-')}-QR.png`;
  a.click();
  showToast('QR downloaded! ⬇️');
}

// ── QR Contact CRUD ──
function _resetQRCProfileUI(){
  qrcProfileData=null;
  const circle=document.getElementById('qrc-profile-circle');
  const ph=document.getElementById('qrc-profile-placeholder');
  const img=document.getElementById('qrc-profile-img');
  const lbl=document.getElementById('qrc-profile-lbl');
  const rmv=document.getElementById('qrc-profile-remove');
  if(circle)circle.classList.remove('has-img');
  if(ph)ph.style.display='';
  if(img){img.style.display='none';img.src='';}
  if(lbl)lbl.textContent='Tap to add photo';
  if(rmv)rmv.style.display='none';
}
function _setQRCProfileUI(dataUrl){
  qrcProfileData=dataUrl;
  const circle=document.getElementById('qrc-profile-circle');
  const ph=document.getElementById('qrc-profile-placeholder');
  const img=document.getElementById('qrc-profile-img');
  const lbl=document.getElementById('qrc-profile-lbl');
  const rmv=document.getElementById('qrc-profile-remove');
  if(circle)circle.classList.add('has-img');
  if(ph)ph.style.display='none';
  if(img){img.src=dataUrl;img.style.display='block';}
  if(lbl)lbl.textContent='Tap to change photo';
  if(rmv)rmv.style.display='block';
}
function handleQRCProfileUpload(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>3*1024*1024){showToast('Photo too large! Max 3MB','error');return;}
  const reader=new FileReader();
  reader.onload=ev=>_setQRCProfileUI(ev.target.result);
  reader.readAsDataURL(file);
}
function removeQRCProfile(){
  _resetQRCProfileUI();
  document.getElementById('qrc-profile-file').value='';
}
function openAddQRContact(){
  editingQRContactId=null;qrcUploadData=null;
  _resetQRCProfileUI();
  document.getElementById('modal-qrc-title').textContent='Add QR Contact';
  document.getElementById('qrc-name').value='';
  document.getElementById('qrc-type').value='person';
  document.getElementById('qrc-account-info').value='';
  document.getElementById('qrc-delete-btn').style.display='none';
  document.getElementById('qrc-save-btn').textContent='Save Contact';
  document.getElementById('qrc-upload-label-default').style.display='';
  document.getElementById('qrc-upload-preview').style.display='none';
  document.getElementById('qrc-remove-btn').style.display='none';
  document.getElementById('qrc-file-input').value='';
  document.getElementById('qrc-upload-zone').classList.remove('has-file');
  openModal('modal-qr-contact');
}
function openEditQRContact(id){
  const c=db.qrContacts.find(q=>q.id===id);if(!c)return;
  editingQRContactId=id;qrcUploadData=c.image;
  document.getElementById('modal-qrc-title').textContent='Edit Contact';
  document.getElementById('qrc-name').value=c.name;
  document.getElementById('qrc-type').value=c.type||'person';
  document.getElementById('qrc-account-info').value=c.accountInfo||'';
  document.getElementById('qrc-delete-btn').style.display='';
  document.getElementById('qrc-save-btn').textContent='Update Contact';
  document.getElementById('qrc-upload-label-default').style.display='none';
  document.getElementById('qrc-upload-preview').style.display='block';
  document.getElementById('qrc-preview-img').src=c.image;
  document.getElementById('qrc-preview-fname').textContent='📷 QR image saved';
  document.getElementById('qrc-remove-btn').style.display='block';
  document.getElementById('qrc-upload-zone').classList.add('has-file');
  // Profile photo
  if(c.profileImage){_setQRCProfileUI(c.profileImage);}else{_resetQRCProfileUI();}
  openModal('modal-qr-contact');
}
function handleQRContactUpload(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){showToast('File too large! Max 5MB','error');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    qrcUploadData=ev.target.result;
    document.getElementById('qrc-upload-label-default').style.display='none';
    document.getElementById('qrc-upload-preview').style.display='block';
    document.getElementById('qrc-preview-img').src=qrcUploadData;
    document.getElementById('qrc-preview-fname').textContent='📷 '+file.name;
    document.getElementById('qrc-remove-btn').style.display='block';
    document.getElementById('qrc-upload-zone').classList.add('has-file');
  };
  reader.readAsDataURL(file);
}
function removeQRContactUpload(){
  qrcUploadData=null;
  document.getElementById('qrc-upload-label-default').style.display='';
  document.getElementById('qrc-upload-preview').style.display='none';
  document.getElementById('qrc-preview-img').src='';
  document.getElementById('qrc-remove-btn').style.display='none';
  document.getElementById('qrc-upload-zone').classList.remove('has-file');
  document.getElementById('qrc-file-input').value='';
}
function saveQRContact(){
  const name=document.getElementById('qrc-name').value.trim();
  const type=document.getElementById('qrc-type').value;
  const accountInfo=document.getElementById('qrc-account-info').value.trim();
  if(!name){showToast('Please enter a name','error');return;}
  if(!qrcUploadData){showToast('Please upload their QR code image','error');return;}
  const profileImage=qrcProfileData||null;
  if(editingQRContactId){
    const c=db.qrContacts.find(q=>q.id===editingQRContactId);
    if(c)Object.assign(c,{name,type,accountInfo,image:qrcUploadData,profileImage});
  }else{
    db.qrContacts.push({id:uid(),name,type,accountInfo,image:qrcUploadData,profileImage,createdAt:Date.now()});
  }
  saveDB();closeModal('modal-qr-contact');
  showToast(editingQRContactId?'Contact updated!':'Contact saved! 👥');
  editingQRContactId=null;renderQRScreen();
}
function deleteQRContact(){
  showConfirm('Delete QR Contact?','',()=>{
    db.qrContacts=db.qrContacts.filter(q=>q.id!==editingQRContactId);
    saveDB();closeModal('modal-qr-contact');showToast('Contact deleted','error');
    editingQRContactId=null;renderQRScreen();
  });
}
function checkDuePlanned(){
  const t=today();
  const due=db.planned.filter(p=>p.status==='pending'&&p.date<=t);
  if(due.length){const ov=due.filter(p=>p.date<t).length;const td=due.filter(p=>p.date===t).length;let m='';if(ov)m+=`⚠️ ${ov} overdue! `;if(td)m+=`📅 ${td} due today!`;if(m)setTimeout(()=>showToast(m.trim(),'warn'),1200);}
}

// ===== ONBOARDING =====
function checkOnboarding(){
  if(!localStorage.getItem('finflow_onboarded')){
    document.getElementById('modal-onboarding').classList.add('open');
  }
}
function closeOnboarding(){
  localStorage.setItem('finflow_onboarded','1');
  document.getElementById('modal-onboarding').classList.remove('open');
}

// ===== PATCH NOTES =====
const PATCH_NOTES_VERSION='1.0';
const PATCH_NOTES_KEY='finflow_patch_seen';

const PATCH_NOTES=[
  {
    version:'1.0',
    date:'March 2026',
    emoji:'📲',
    title:'QR Contacts, Zoom & UI Improvements',
    highlights:[
      {
        icon:'📲',
        title:'Received Tab — Redesigned QR Code UI',
        what:'The QR Codes tab has been fully redesigned and renamed to "Received". Your personal QR codes (GCash, Maya, Bank QR) are now displayed in a clean, card-based layout with proper styling and improved readability.',
        example:'Example: Your GCash QR now shows as a polished card with your name, account, a large QR preview, and action buttons at the bottom.'
      },
      {
        icon:'👥',
        title:'Contacts Tab — Save QR Codes of Others',
        what:'Brand new "Contacts" sub-tab in the QR Payments section. Save QR codes of people, merchants, and businesses you frequently pay. Each contact card shows their name, type, and QR image.',
        example:'Example: Save your landlord\'s BPI QR, your friend\'s GCash QR, or a sari-sari store\'s Maya QR — all in one place under Contacts.'
      },
      {
        icon:'🔍',
        title:'Zoom QR Code for Easy Scanning',
        what:'When presenting a QR code fullscreen, you can now pinch-to-zoom or use the on-screen + / − buttons to zoom in and out. Perfect for scanning from across a counter or on a dimmer screen.',
        example:'Example: Tap "Present", then tap ＋ to zoom in — the cashier can now scan your QR from further away.'
      },
      {
        icon:'✨',
        title:'Improved QR Card Design',
        what:'QR cards now have a clean, structured layout: account icon + name at the top, a centered QR image in the middle, and action buttons (Present, Download, Edit) neatly at the bottom.',
        example:'Example: Each QR card clearly shows which account it belongs to, the QR code image, and quick-action buttons.'
      },
    ]
  }
];


function checkPatchBadge(){
  const seen=localStorage.getItem(PATCH_NOTES_KEY);
  const badge=document.getElementById('patch-badge');
  const dot=document.getElementById('patch-new-dot');
  if(seen!==PATCH_NOTES_VERSION){
    if(badge)badge.style.display='flex';
    if(dot)dot.style.display='block';
  }else{
    if(badge)badge.style.display='none';
    if(dot)dot.style.display='none';
  }
}

function openPatchNotes(){
  const modal=document.getElementById('modal-patch-notes');
  const content=document.getElementById('patch-notes-content');
  if(!modal||!content)return;

  // Build HTML
  let html='';
  PATCH_NOTES.forEach(release=>{
    html+=`<div style="margin-bottom:28px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
        <div style="width:42px;height:42px;border-radius:12px;background:var(--emerald-bg);border:1px solid rgba(16,185,129,.25);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${release.emoji}</div>
        <div>
          <div style="font-size:16px;font-weight:800;letter-spacing:-.3px">${release.title}</div>
          <div style="font-size:11px;color:var(--text3)">Version ${release.version} · ${release.date}</div>
        </div>
      </div>`;
    release.highlights.forEach((item,i)=>{
      html+=`<div style="
        background:var(--card);border:1px solid var(--border);border-radius:14px;
        padding:14px 15px;margin-bottom:10px;
      ">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:20px">${item.icon}</span>
          <div style="font-size:13px;font-weight:700;color:var(--text)">${item.title}</div>
        </div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:8px">${item.what}</div>
        <div style="background:var(--blue-bg);border-left:3px solid var(--blue);border-radius:0 8px 8px 0;padding:8px 11px;font-size:11px;color:var(--text2);line-height:1.6">
          ${item.example}
        </div>
      </div>`;
    });
    html+='</div>';
  });

  html+=`<div style="text-align:center;padding:12px 0;font-size:11px;color:var(--text3)">
    All your data is stored safely on your device. 🔒<br>Thank you for using FinFlow!
  </div>`;

  content.innerHTML=html;
  modal.style.display='flex';
  content.scrollTop=0;

  // Mark as seen
  localStorage.setItem(PATCH_NOTES_KEY,PATCH_NOTES_VERSION);
  const badge=document.getElementById('patch-badge');
  const dot=document.getElementById('patch-new-dot');
  if(badge)badge.style.display='none';
  if(dot)dot.style.display='none';
}

function closePatchNotes(){
  const modal=document.getElementById('modal-patch-notes');
  if(modal){modal.style.display='none';}
}

// ===== PAYABLES BALANCE ALERT =====
function checkPayablesBalanceAlerts(){
  const banner=document.getElementById('payables-alert-banner');
  if(!banner)return;
  const now=new Date();
  const alerts=[];
  db.payables.filter(p=>p.status==='active'&&p.dueDay&&p.linkedAccount).forEach(py=>{
    const acc=db.accounts.find(a=>a.id===py.linkedAccount);
    if(!acc)return;
    // Next due date
    let dueDate=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
    if(dueDate<now)dueDate=new Date(now.getFullYear(),now.getMonth()+1,py.dueDay);
    const daysUntil=Math.ceil((dueDate-now)/(1000*60*60*24));
    if(daysUntil<=7){
      const needed=py.monthlyPayment||py.remaining||0;
      if(acc.balance<needed){
        const dateStr=dueDate.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
        alerts.push(`⚠️ ${py.name}: Payment of ${fmt(needed)} due ${dateStr} — ${acc.name} only has ${fmt(acc.balance)}. Please top up or change the linked account.`);
      }
    }
  });
  // Also check planned payable items
  const todayStr=today();
  db.planned.filter(p=>p.payableId&&p.status==='pending').forEach(pl=>{
    const py=db.payables.find(py=>py.id===pl.payableId);
    if(!py)return;
    const acc=db.accounts.find(a=>a.id===pl.accountId);
    if(!acc)return;
    const d=new Date(pl.date+'T00:00:00');
    const daysUntil=Math.ceil((d-now)/(1000*60*60*24));
    if(daysUntil<=7&&daysUntil>=0&&acc.balance<pl.amount){
      const dateStr=d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
      const isDup=alerts.some(a=>a.includes(py.name));
      if(!isDup)alerts.push(`⚠️ ${py.name}: Scheduled payment of ${fmt(pl.amount)} on ${dateStr} is not covered by ${acc.name} (${fmt(acc.balance)} available). Please transfer funds or update the account.`);
    }
  });
  if(alerts.length){
    banner.style.display='block';
    banner.innerHTML=alerts.map(a=>`<div style="margin-bottom:${alerts.length>1?'8px':'0'}">${a}</div>`).join('');
  }else{
    banner.style.display='none';
  }
}

// ===== LIGHT / DARK MODE =====
// ══════════════════════════════════════════════════════════════
// THEME SYSTEM — 6 Premium Themes
// ══════════════════════════════════════════════════════════════
const THEMES = {
  midnight:  { label: 'Midnight',  mode: 'dark'  },
  obsidian:  { label: 'Obsidian',  mode: 'dark'  },
  forest:    { label: 'Forest',    mode: 'dark'  },
  ivory:     { label: 'Ivory',     mode: 'light' },
  arctic:    { label: 'Arctic',    mode: 'light' },
  'rose-gold':{ label: 'Rose Gold', mode: 'light' },
};

let currentThemeKey = 'midnight';

function applyThemeByKey(key) {
  if (!THEMES[key]) key = 'midnight';
  currentThemeKey = key;
  const theme = THEMES[key];
  const html = document.documentElement;

  // Remove all theme data attrs + light class
  html.removeAttribute('data-theme');
  html.classList.remove('light');

  // Apply
  if (key !== 'midnight') html.setAttribute('data-theme', key);
  if (theme.mode === 'light') html.classList.add('light');

  localStorage.setItem('finflow_theme_key', key);
  updateThemePickerUI();

  // Refresh charts if visible
  try {
    if (document.getElementById('screen-reports')?.classList.contains('active')) renderReports();
    if (document.getElementById('screen-home')?.classList.contains('active')) renderTrendChart();
  } catch(e) {}

  showToast(theme.label + (theme.mode==='dark'?' 🌙':' ☀️') + ' theme applied','success');
}

// ── backward compat ─────────────────────────────────────────
function applyTheme(legacyVal) {
  if (legacyVal === 'light') applyThemeByKey('ivory');
  else applyThemeByKey('midnight');
}
function toggleTheme() {
  const theme = THEMES[currentThemeKey];
  const isDark = theme.mode === 'dark';
  applyThemeByKey(isDark ? 'ivory' : 'midnight');
}

// ── Set dark/light mode in picker ──────────────────────────
function setThemeMode(mode) {
  const darkSection  = document.getElementById('dark-themes-section');
  const lightSection = document.getElementById('light-themes-section');
  const darkBtn  = document.getElementById('mode-dark-btn');
  const lightBtn = document.getElementById('mode-light-btn');
  if (darkSection)  darkSection.style.display  = mode==='dark'  ? '' : 'none';
  if (lightSection) lightSection.style.display = mode==='light' ? '' : 'none';
  if (darkBtn)  darkBtn.classList.toggle('active',  mode==='dark');
  if (lightBtn) lightBtn.classList.toggle('active', mode==='light');
}

// ── Update the theme picker UI state ───────────────────────
function updateThemePickerUI() {
  const theme = THEMES[currentThemeKey];
  if (!theme) return;

  // Update "currently" label
  const lbl = document.getElementById('current-theme-label');
  if (lbl) lbl.textContent = theme.label + ' · ' + (theme.mode==='dark' ? '🌙 Dark' : '☀️ Light');

  // Show correct mode section
  setThemeMode(theme.mode);

  // Highlight selected card
  document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('selected'));
  const sel = document.getElementById('theme-card-' + currentThemeKey);
  if (sel) sel.classList.add('selected');

  // Update mode toggle buttons
  const darkBtn  = document.getElementById('mode-dark-btn');
  const lightBtn = document.getElementById('mode-light-btn');
  if (darkBtn)  darkBtn.classList.toggle('active',  theme.mode==='dark');
  if (lightBtn) lightBtn.classList.toggle('active', theme.mode==='light');
}

// backward compat
function updateThemeUI() { updateThemePickerUI(); }

function initTheme() {
  const saved = localStorage.getItem('finflow_theme_key');
  const oldSaved = localStorage.getItem('finflow_theme');
  if (saved && THEMES[saved]) {
    applyThemeByKey(saved);
    return;
  }
  if (oldSaved === 'light') { applyThemeByKey('ivory'); return; }
  // Default to Ivory (white/light Classic style)
  applyThemeByKey('ivory');
  window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (!localStorage.getItem('finflow_theme_key')) {
      applyThemeByKey('ivory'); // always ivory as default
    }
  });
}

// ===== BUDGET TOOLS =====
function getBudgetSpend(category, period, targetMonth){
  // period: 'monthly' or 'yearly', targetMonth: 'YYYY-MM' string (optional)
  const now=new Date();
  let ms, me;
  if(period==='yearly'){
    ms=`${now.getFullYear()}-01-01`;
    me=`${now.getFullYear()}-12-31`;
  } else if(targetMonth){
    const [y,m]=targetMonth.split('-').map(Number);
    ms=new Date(y,m-1,1).toISOString().split('T')[0];
    me=localDate(new Date(y,m,0));
  } else {
    ms=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
    me=localMonthEnd(now.getFullYear(),now.getMonth());
  }
  return db.transactions.filter(t=>t.type==='expense'&&t.category===category&&t.date>=ms&&t.date<=me).reduce((s,t)=>s+t.amount,0);
}
function getMonthlySpend(category){return getBudgetSpend(category,'monthly');}

function toggleBudgetMonthSelector(){
  const period=document.getElementById('budget-period').value;
  const group=document.getElementById('budget-month-selector-group');
  if(group)group.style.display=period==='monthly'?'':'none';
}

function populateBudgetMonthOptions(){
  const sel=document.getElementById('budget-target-month');if(!sel)return;
  const now=new Date();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  let opts='<option value="">— All months (default) —</option>';
  // Show current month + next 11 months
  for(let i=0;i<12;i++){
    const d=new Date(now.getFullYear(),now.getMonth()+i,1);
    const val=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const lbl=`${months[d.getMonth()]} ${d.getFullYear()}${i===0?' (This Month)':i===1?' (Next Month)':''}`;
    opts+=`<option value="${val}">${lbl}</option>`;
  }
  sel.innerHTML=opts;
}

function openAddBudget(){
  editingBudgetId=null;
  document.getElementById('modal-budget-title').textContent='Add Budget Limit';
  document.getElementById('budget-save-btn').textContent='Save Budget';
  document.getElementById('budget-delete-btn').style.display='none';
  document.getElementById('budget-limit').value='';
  document.getElementById('budget-period').value='monthly';
  document.getElementById('budget-current-spend').style.display='none';
  document.getElementById('budget-month-selector-group').style.display='';
  populateBudgetMonthOptions();
  document.getElementById('budget-target-month').value='';
  dismissFormVAI('budget');
  const vInp=document.getElementById('budget-vai-input');if(vInp)vInp.value='';
  // Category dropdown — only expense cats not already budgeted (for current/default)
  const budgetedCats=db.budgets.filter(b=>!b.targetMonth).map(b=>b.category);
  const available=EXPENSE_CATS.filter(c=>!budgetedCats.includes(c));
  document.getElementById('budget-category').innerHTML=(available.length?available:EXPENSE_CATS).map(c=>`<option value="${c}">${c}</option>`).join('');
  openModal('modal-budget');
}
function openEditBudget(id){
  const b=db.budgets.find(b=>b.id===id);if(!b)return;
  editingBudgetId=id;
  document.getElementById('modal-budget-title').textContent='Edit Budget';
  document.getElementById('budget-save-btn').textContent='Update Budget';
  document.getElementById('budget-delete-btn').style.display='';
  document.getElementById('budget-category').innerHTML=`<option value="${b.category}">${b.category}</option>`;
  document.getElementById('budget-limit').value=b.monthlyLimit;
  document.getElementById('budget-period').value=b.period||'monthly';
  populateBudgetMonthOptions();
  const tm=document.getElementById('budget-target-month');
  if(tm)tm.value=b.targetMonth||'';
  const period=b.period||'monthly';
  document.getElementById('budget-month-selector-group').style.display=period==='monthly'?'':'none';
  const spent=getBudgetSpend(b.category,period,b.targetMonth||null);
  const pct=((spent/b.monthlyLimit)*100).toFixed(0);
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let periodLabel='This month';
  if(period==='yearly')periodLabel='This year';
  else if(b.targetMonth){const[y,m]=b.targetMonth.split('-').map(Number);periodLabel=months[m-1]+' '+y;}
  const spendEl=document.getElementById('budget-current-spend');
  spendEl.style.display='block';
  spendEl.textContent=`${periodLabel}: ${fmt(spent)} spent of ${fmt(b.monthlyLimit)} limit (${pct}%)`;
  openModal('modal-budget');
}
function saveBudget(){
  const category=document.getElementById('budget-category').value;
  const monthlyLimit=parseFloat(document.getElementById('budget-limit').value)||0;
  const period=document.getElementById('budget-period').value||'monthly';
  const targetMonth=period==='monthly'?(document.getElementById('budget-target-month').value||null):null;
  if(!category){showToast('Please select a category','error');return;}
  if(monthlyLimit<=0){showToast('Please enter a valid limit','error');return;}
  if(editingBudgetId){
    const b=db.budgets.find(b=>b.id===editingBudgetId);
    if(b)Object.assign(b,{category,monthlyLimit,period,targetMonth});
  }else{
    db.budgets.push({id:uid(),category,monthlyLimit,period,targetMonth,createdAt:Date.now()});
  }
  saveDB();closeModal('modal-budget');
  const monthsArr=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let msg=editingBudgetId?'Budget updated! 🎯':'Budget set! 🎯';
  if(targetMonth){const[y,m]=targetMonth.split('-').map(Number);msg=`Budget set for ${monthsArr[m-1]} ${y}! 🎯`;}
  showToast(msg,'success');
  editingBudgetId=null;
  renderBudgetHomePanel();
  renderBudgetScreen();
  renderDefaultBudget();
}
function deleteBudget(){
  showConfirm('Remove Budget?','This budget limit will be removed.',()=>{
    db.budgets=db.budgets.filter(b=>b.id!==editingBudgetId);
    saveDB();closeModal('modal-budget');
    showToast('Budget removed','error');
    editingBudgetId=null;renderBudgetHomePanel();renderBudgetScreen();renderDefaultBudget();
  });
}
function renderBudgetSettings(){
  // Legacy function — kept for backward compatibility; budget is now in the Budget screen
  const el=document.getElementById('budget-list-settings');if(!el)return;
}
function renderBudgetHomePanel(){
  const el=document.getElementById('budget-home-panel');if(!el)return;
  if(!db.budgets.length){el.innerHTML='';return;}
  const active=db.budgets.filter(b=>getMonthlySpend(b.category)>0||(getMonthlySpend(b.category)/b.monthlyLimit)>0.3);
  if(!active.length){el.innerHTML='';return;}
  el.innerHTML=`<div class="budget-widget">
    <div class="bw-hdr">
      <span class="bw-title">🎯 Budget</span>
      <span class="bw-link" onclick="showScreen('budget')">Details →</span>
    </div>
    ${active.slice(0,3).map(b=>{
      const spent=getMonthlySpend(b.category);
      const pct=Math.min(100,(spent/b.monthlyLimit)*100);
      const barColor=pct>=100?'var(--danger)':pct>=80?'var(--planned)':'var(--income)';
      const pctClass=pct>=100?'budget-over':pct>=80?'budget-warn':'';
      return`<div class="bw-item">
        <div class="bw-row">
          <span class="bw-cat">${b.category}</span>
          <span class="bw-pct ${pctClass}">${pct.toFixed(0)}%</span>
        </div>
        <div class="bw-bar-wrap"><div class="bw-bar" style="width:${pct.toFixed(1)}%;background:${barColor}"></div></div>
      </div>`;
    }).join('')}
  </div>`;
}
// ===== BUDGET SCREEN =====
let budgetScreenYear=null, budgetScreenMonth=null;
function initBudgetScreen(){
  const now=new Date();
  if(budgetScreenYear===null)budgetScreenYear=now.getFullYear();
  if(budgetScreenMonth===null)budgetScreenMonth=now.getMonth();
}
function navBudgetMonth(dir){
  initBudgetScreen();
  budgetScreenMonth+=dir;
  if(budgetScreenMonth<0){budgetScreenMonth=11;budgetScreenYear--;}
  if(budgetScreenMonth>11){budgetScreenMonth=0;budgetScreenYear++;}
  renderBudgetScreen();
}
// ===== BUDGET SCREEN TABS =====
let budgetMainTab = 'monthly'; // 'monthly' | 'default'

function switchBudgetMainTab(tab) {
  budgetMainTab = tab;
  const mBtn = document.getElementById('budget-tab-monthly');
  const dBtn = document.getElementById('budget-tab-default');
  const mPanel = document.getElementById('budget-panel-monthly');
  const dPanel = document.getElementById('budget-panel-default');
  const addBtn = document.getElementById('budget-header-add-btn');
  if(tab === 'monthly') {
    mBtn.className = 'budget-main-tab active-budget-tab';
    dBtn.className = 'budget-main-tab';
    mPanel.style.display = 'flex';
    dPanel.style.display = 'none';
    addBtn.title = 'Add budget for this month';
    renderBudgetScreen();
  } else {
    dBtn.className = 'budget-main-tab active-budget-tab';
    mBtn.className = 'budget-main-tab';
    mPanel.style.display = 'none';
    dPanel.style.display = 'flex';
    addBtn.title = 'Add default budget category';
    renderDefaultBudget();
  }
}

function budgetHeaderAdd() {
  if(budgetMainTab === 'default') openAddDefaultBudget();
  else openBudgetAddForMonth();
}

// ── Default Budget Tab ──────────────────────────────────────────
function getDefaultBudgets() {
  // Default budgets are db.budgets with no targetMonth and period='monthly' (or no period)
  return db.budgets.filter(b => !b.targetMonth && (b.period || 'monthly') === 'monthly');
}

function renderDefaultBudget() {
  const el = document.getElementById('budget-default-content');
  if (!el) return;
  const defaults = getDefaultBudgets();
  const now = new Date();
  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  let html = '<div style="padding:14px 16px">';

  // Info banner
  html += `<div style="background:var(--blue-bg);border:1px solid rgba(77,142,255,.2);border-radius:12px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
    <div style="font-weight:700;color:var(--blue-l);margin-bottom:4px">🗂 Default Budget Template</div>
    This is your <strong>monthly spending plan</strong>. Every new month, FinFlow automatically copies these limits so you don't have to set them again.<br>
    <span style="color:var(--text3);font-size:11px">Changes here only affect <em>future</em> months — past months are kept as-is.</span>
  </div>`;

  if (!defaults.length) {
    html += `<div class="card" style="text-align:center;padding:28px 16px">
      <div style="font-size:40px;margin-bottom:12px">🗂</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:8px">No Default Budget Yet</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:16px">Add category limits here and FinFlow will auto-apply them every month.</div>
      <button class="btn-primary" onclick="openAddDefaultBudget()" style="width:auto;padding:10px 24px">➕ Add Category</button>
    </div>`;
  } else {
    const total = defaults.reduce((s, b) => s + b.monthlyLimit, 0);
    html += `<div class="card" style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:12px;color:var(--text3);font-weight:600">TOTAL MONTHLY BUDGET</div>
        <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--emerald)">${fmt(total)}</div>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">${defaults.length} categor${defaults.length===1?'y':'ies'} · auto-copies to new months</div>
    </div>`;
    html += `<div class="card">`;
    defaults.forEach(b => {
      const now2 = new Date();
      const ymStr = `${now2.getFullYear()}-${String(now2.getMonth()+1).padStart(2,'0')}`;
      const spent = getBudgetSpend(b.category, 'monthly', null);
      const pct = Math.min(100, (spent / b.monthlyLimit) * 100);
      const barColor = pct>=100?'var(--rose)':pct>=80?'var(--amber)':'var(--emerald)';
      html += `<div class="budget-item" onclick="openEditBudget('${b.id}')">
        <div class="budget-item-row">
          <div class="budget-cat">${b.category}</div>
          <div class="budget-pct ${pct>=100?'budget-over':pct>=80?'budget-warn':''}">${fmt(b.monthlyLimit)}</div>
        </div>
        <div class="budget-bar-wrap"><div class="budget-bar" style="width:${pct.toFixed(1)}%;background:${barColor}"></div></div>
        <div class="budget-amounts"><span style="color:var(--text3)">This month: ${fmt(spent)} spent</span><span style="color:var(--text3)">${pct>=100?'<span style="color:var(--rose)">Over budget!</span>':fmt(b.monthlyLimit-spent)+' left'}</span></div>
      </div>`;
    });
    html += `</div>
    <button class="btn-primary" style="margin-top:12px;background:var(--bg3);color:var(--text);border:1px solid var(--border);box-shadow:none" onclick="openAddDefaultBudget()">➕ Add Category</button>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function openAddDefaultBudget() {
  editingBudgetId = null;
  document.getElementById('modal-budget-title').textContent = 'Add Default Budget';
  document.getElementById('budget-save-btn').textContent = 'Save';
  document.getElementById('budget-delete-btn').style.display = 'none';
  document.getElementById('budget-limit').value = '';
  document.getElementById('budget-period').value = 'monthly';
  document.getElementById('budget-current-spend').style.display = 'none';
  document.getElementById('budget-month-selector-group').style.display = 'none'; // default = no target month
  document.getElementById('budget-target-month').value = '';
  dismissFormVAI('budget');
  const vInp = document.getElementById('budget-vai-input'); if(vInp) vInp.value = '';
  const budgetedCats = db.budgets.filter(b => !b.targetMonth).map(b => b.category);
  const available = EXPENSE_CATS.filter(c => !budgetedCats.includes(c));
  document.getElementById('budget-category').innerHTML = (available.length ? available : EXPENSE_CATS).map(c => `<option value="${c}">${c}</option>`).join('');
  openModal('modal-budget');
}

// ── Monthly Budget Auto-generation ─────────────────────────────
/**
 * Ensure a monthly budget exists for the given YYYY-MM.
 * If not, copies from default budgets (no targetMonth items).
 * Called automatically when the budget screen is viewed and on new transactions.
 */
function ensureMonthlyBudget(ymStr) {
  const defaults = getDefaultBudgets();
  if (!defaults.length) return; // nothing to copy
  defaults.forEach(def => {
    const exists = db.budgets.some(b => b.category === def.category && b.targetMonth === ymStr);
    if (!exists) {
      db.budgets.push({
        id: uid(),
        category: def.category,
        monthlyLimit: def.monthlyLimit,
        period: 'monthly',
        targetMonth: ymStr,
        autoGenerated: true,
        createdAt: Date.now()
      });
    }
  });
  saveDB();
}

function maybeAutoGenerateBudgetForCurrentMonth() {
  const now = new Date();
  const ymStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  ensureMonthlyBudget(ymStr);
}

function renderBudgetScreen(){
  initBudgetScreen();
  // Auto-generate monthly budget from defaults if needed
  const ymViewStr=`${budgetScreenYear}-${String(budgetScreenMonth+1).padStart(2,'0')}`;
  ensureMonthlyBudget(ymViewStr);
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const SHORT=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const now=new Date();
  // Update label
  const labelEl=document.getElementById('budget-screen-month-label');
  if(labelEl)labelEl.textContent=`${MONTHS[budgetScreenMonth]} ${budgetScreenYear}`;
  // Render month quick-tabs
  const tabsEl=document.getElementById('budget-screen-month-tabs');
  if(tabsEl){
    let tabs='';
    for(let m=0;m<12;m++){
      const y=budgetScreenYear;
      const isActive=m===budgetScreenMonth&&y===budgetScreenYear;
      const isCurrent=m===now.getMonth()&&y===now.getFullYear();
      const ymCheck=`${y}-${String(m+1).padStart(2,'0')}`;
      const hasBudget=db.budgets.some(b=>b.targetMonth===ymCheck||(!b.targetMonth&&(b.period||'monthly')==='monthly'));
      tabs+=`<button onclick="setBudgetScreenMonth(${y},${m})" style="flex-shrink:0;padding:6px 14px;border-radius:99px;border:1.5px solid ${isActive?'var(--blue)':'var(--border)'};background:${isActive?'var(--blue)':'var(--bg2)'};color:${isActive?'#fff':isCurrent?'var(--blue)':'var(--text3)'};font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;position:relative">${SHORT[m]}${isCurrent&&!isActive?'<span style="position:absolute;top:2px;right:2px;width:5px;height:5px;background:var(--blue);border-radius:50%"></span>':''}</button>`;
    }
    tabsEl.innerHTML=tabs;
    const activeBtn=tabsEl.querySelector('[style*="var(--blue)"]');
    if(activeBtn)setTimeout(()=>activeBtn.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}),50);
  }
  // Get budgets for this month: items with targetMonth=ymViewStr OR default items (no targetMonth)
  const el=document.getElementById('budget-screen-content');if(!el)return;
  const monthBudgets=db.budgets.filter(b=>{
    const p=b.period||'monthly';
    if(p==='yearly')return false;
    if(b.targetMonth===ymViewStr)return true;
    // Also show defaults that have no month-specific override
    if(!b.targetMonth){
      const hasOverride=db.budgets.some(o=>o.category===b.category&&o.targetMonth===ymViewStr);
      return !hasOverride;
    }
    return false;
  });
  const ms=`${budgetScreenYear}-${String(budgetScreenMonth+1).padStart(2,'0')}-01`;
  const me=localMonthEnd(budgetScreenYear,budgetScreenMonth);
  const totalSpent=db.transactions.filter(t=>t.type==='expense'&&t.date>=ms&&t.date<=me).reduce((s,t)=>s+t.amount,0);
  const totalBudgeted=monthBudgets.reduce((s,b)=>s+b.monthlyLimit,0);
  const overallPct=totalBudgeted>0?Math.min(100,(totalSpent/totalBudgeted)*100):0;
  const isCurrentMonth=budgetScreenMonth===now.getMonth()&&budgetScreenYear===now.getFullYear();
  const daysTotal=new Date(budgetScreenYear,budgetScreenMonth+1,0).getDate();
  const daysDone=isCurrentMonth?now.getDate():daysTotal;
  let html='<div style="padding:14px 16px">';
  if(totalBudgeted>0){
    html+=`<div class="card" style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:13px;font-weight:700">Monthly Overview</div>
        <div style="font-size:13px;font-weight:700;color:${overallPct>=100?'var(--rose)':overallPct>=80?'var(--amber)':'var(--emerald)'}">${overallPct.toFixed(0)}%</div>
      </div>
      <div style="background:var(--bg3);border-radius:99px;height:8px;overflow:hidden;margin-bottom:8px">
        <div style="width:${overallPct.toFixed(1)}%;height:100%;border-radius:99px;background:${overallPct>=100?'var(--rose)':overallPct>=80?'var(--amber)':'var(--emerald)'}"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3)">
        <span>${fmt(totalSpent)} spent</span>
        <span>Day ${daysDone} of ${daysTotal}</span>
        <span>${fmt(totalBudgeted)} budgeted</span>
      </div>
    </div>`;
  }
  if(!monthBudgets.length){
    html+=`<div class="card" style="text-align:center;padding:28px 16px">
      <div style="font-size:40px;margin-bottom:12px">📊</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:8px">No budgets for ${MONTHS[budgetScreenMonth]}</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:16px">Set spending limits for each category to track your monthly budget, or add categories to your Default Template to auto-fill each month.</div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn-primary" onclick="openBudgetAddForMonth()" style="width:auto;padding:10px 20px">➕ This Month Only</button>
        <button class="btn-primary btn-secondary" onclick="switchBudgetMainTab('default')" style="width:auto;padding:10px 20px">🗂 Edit Default</button>
      </div>
    </div>`;
  } else {
    html+=`<div class="card">`;
    monthBudgets.sort((a,b)=>{
      const sa=getBudgetSpend(a.category,'monthly',ymViewStr)/a.monthlyLimit;
      const sb=getBudgetSpend(b.category,'monthly',ymViewStr)/b.monthlyLimit;
      return sb-sa;
    }).forEach(b=>{
      const spent=getBudgetSpend(b.category,'monthly',ymViewStr);
      const pct=Math.min(100,(spent/b.monthlyLimit)*100);
      const barColor=pct>=100?'var(--rose)':pct>=80?'var(--amber)':'var(--emerald)';
      const projMulti=isCurrentMonth&&daysDone>0?daysTotal/daysDone:1;
      const proj=isCurrentMonth&&daysDone<daysTotal?spent*projMulti:spent;
      const projWarn=isCurrentMonth&&proj>b.monthlyLimit&&pct<100;
      const isAutoGen=!b.targetMonth||b.autoGenerated;
      html+=`<div class="budget-item" onclick="openEditBudget('${b.id}')">
        <div class="budget-item-row">
          <div class="budget-cat">${b.category}${isAutoGen&&!b.targetMonth?'<span style="font-size:9px;color:var(--text3);background:var(--bg3);border-radius:4px;padding:1px 5px;margin-left:5px">default</span>':''}</div>
          <div class="budget-pct ${pct>=100?'budget-over':pct>=80?'budget-warn':''}">${pct.toFixed(0)}%</div>
        </div>
        <div class="budget-bar-wrap"><div class="budget-bar" style="width:${pct.toFixed(1)}%;background:${barColor}"></div></div>
        <div class="budget-amounts">
          <span>${fmt(spent)} of ${fmt(b.monthlyLimit)}</span>
          ${projWarn?`<span style="color:var(--rose)">⚠️ Proj: ${fmt(proj)}</span>`:`<span style="color:${pct>=100?'var(--rose)':'var(--text3)'}">${pct>=100?fmt(spent-b.monthlyLimit)+' over':fmt(b.monthlyLimit-spent)+' left'}</span>`}
        </div>
      </div>`;
    });
    html+=`</div>`;
    html+=`<button class="btn-primary" style="margin-top:12px;background:var(--bg3);color:var(--text);border:1px solid var(--border);box-shadow:none" onclick="openBudgetAddForMonth()">➕ Add Another Category</button>`;
  }
  html+='</div>';
  el.innerHTML=html;
}
function setBudgetScreenMonth(y,m){budgetScreenYear=y;budgetScreenMonth=m;renderBudgetScreen();}
function openBudgetAddForMonth(){
  initBudgetScreen();
  const ymStr=`${budgetScreenYear}-${String(budgetScreenMonth+1).padStart(2,'0')}`;
  openAddBudget();
  // Pre-select the month
  setTimeout(()=>{
    const sel=document.getElementById('budget-target-month');
    if(sel)sel.value=ymStr;
    toggleBudgetMonthSelector();
  },100);
}


function renderBudgetReport(){
  const el=document.getElementById('reports-budget-panel');if(!el)return;
  const now=new Date();
  const rp=currentBudgetReportPeriod||'monthly';
  const periodLabel=rp==='yearly'?now.getFullYear().toString():now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const periodTitle=rp==='yearly'?`📆 ${periodLabel} Annual Budget`:` 📅 ${periodLabel} Budget Tracker`;
  if(!db.budgets.length){
    el.innerHTML=`<div class="card"><div style="text-align:center;padding:20px"><div style="font-size:40px;margin-bottom:12px">🎯</div><div style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:8px">No Budgets Set</div><div style="font-size:12px;color:var(--text3);margin-bottom:16px">Set monthly or yearly spending limits per category to track your progress.</div><button class="btn-primary" onclick="showScreen('settings')">Go to Settings → Budget</button></div></div>`;
    return;
  }
  let daysTotal, daysDone, projMultiplier;
  if(rp==='yearly'){
    daysTotal=((now.getFullYear()%4===0&&(now.getFullYear()%100!==0||now.getFullYear()%400===0))?366:365);
    const start=new Date(now.getFullYear(),0,1);
    daysDone=Math.ceil((now-start)/(1000*60*60*24))+1;
  } else {
    daysTotal=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
    daysDone=now.getDate();
  }
  projMultiplier=daysTotal/daysDone;

  // Filter budgets by period type
  const relevantBudgets=db.budgets.filter(b=>(b.period||'monthly')===rp);
  const allBudgets=relevantBudgets.length?relevantBudgets:db.budgets.filter(b=>!b.period||b.period==='monthly');

  let html=`<div style="font-size:13px;color:var(--text2);margin-bottom:12px">${periodTitle}</div>`;
  const totalBudgeted=allBudgets.reduce((s,b)=>s+b.monthlyLimit,0);
  const totalSpent=allBudgets.reduce((s,b)=>s+getBudgetSpend(b.category,rp,b.targetMonth||null),0);
  const overallPct=Math.min(100,(totalSpent/totalBudgeted)*100);
  html+=`<div class="card" style="margin-bottom:12px">
    <div class="budget-item-row" style="margin-bottom:8px"><div style="font-size:14px;font-weight:700">Overall Budget</div><div class="budget-pct ${overallPct>=100?'budget-over':overallPct>=80?'budget-warn':''}">${overallPct.toFixed(0)}%</div></div>
    <div class="budget-bar-wrap" style="height:10px"><div class="budget-bar" style="width:${overallPct.toFixed(1)}%;background:${overallPct>=100?'var(--danger)':overallPct>=80?'var(--planned)':'var(--income)'}"></div></div>
    <div class="budget-amounts"><span>${fmt(totalSpent)} spent</span><span>${fmt(totalBudgeted)} total limit</span></div>
    <div style="font-size:10px;color:var(--text3);margin-top:6px">Day ${daysDone} of ${daysTotal} (${((daysDone/daysTotal)*100).toFixed(0)}% through ${rp==='yearly'?'year':'month'})</div>
  </div>`;
  html+=`<div class="card">`;
  allBudgets.sort((a,b)=>{const pa=(getBudgetSpend(a.category,rp,a.targetMonth||null)/a.monthlyLimit);const pb=(getBudgetSpend(b.category,rp,b.targetMonth||null)/b.monthlyLimit);return pb-pa;}).forEach(b=>{
    const spent=getBudgetSpend(b.category,rp,b.targetMonth||null);
    const pct=Math.min(100,(spent/b.monthlyLimit)*100);
    const proj=spent*projMultiplier;
    const barColor=pct>=100?'var(--danger)':pct>=80?'var(--planned)':'var(--income)';
    const projWarn=proj>b.monthlyLimit;
    html+=`<div class="budget-item" onclick="openEditBudget('${b.id}')">
      <div class="budget-item-row">
        <div class="budget-cat">${b.category}</div>
        <div class="budget-pct ${pct>=100?'budget-over':pct>=80?'budget-warn':''}">${pct.toFixed(0)}%</div>
      </div>
      <div class="budget-bar-wrap"><div class="budget-bar" style="width:${pct.toFixed(1)}%;background:${barColor}"></div></div>
      <div class="budget-amounts">
        <span>${fmt(spent)} of ${fmt(b.monthlyLimit)}</span>
        ${projWarn?`<span style="color:var(--danger)">⚠️ Projected: ${fmt(proj)}</span>`:`<span>${fmt(b.monthlyLimit-spent)} left</span>`}
      </div>
    </div>`;
  });
  html+='</div>';
  // Yearly breakdown by month for yearly budgets
  if(rp==='yearly'&&allBudgets.length>0){
    html+=`<div class="card" style="margin-top:12px"><div class="section-title">Monthly Breakdown</div>`;
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const year=now.getFullYear();
    const tableRows=months.map((m,idx)=>{
      const ms=`${year}-${String(idx+1).padStart(2,'0')}-01`;
      const me=localMonthEnd(year,idx);
      const mSpent=allBudgets.reduce((s,b)=>{
        return s+db.transactions.filter(t=>t.type==='expense'&&t.category===b.category&&t.date>=ms&&t.date<=me).reduce((ss,t)=>ss+t.amount,0);
      },0);
      const mBudget=allBudgets.reduce((s,b)=>s+b.monthlyLimit/12,0);
      const mPct=mBudget>0?Math.min(100,(mSpent/mBudget)*100):0;
      const isCurrent=idx===now.getMonth();
      return `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);${isCurrent?'background:rgba(124,131,253,0.05);border-radius:6px;padding:6px 8px;':''}">
        <div style="width:28px;font-size:11px;font-weight:700;color:${isCurrent?'var(--accent)':'var(--text3)'}">${m}</div>
        <div style="flex:1;background:var(--bg3);border-radius:99px;height:5px;overflow:hidden"><div style="width:${mPct.toFixed(1)}%;height:100%;border-radius:99px;background:${mPct>=100?'var(--danger)':mPct>=80?'var(--planned)':'var(--income)'}"></div></div>
        <div style="min-width:60px;text-align:right;font-family:'Space Mono',monospace;font-size:10px">${fmt(mSpent)}</div>
      </div>`;
    }).join('');
    html+=tableRows+'</div>';
  }
  el.innerHTML=html;
}
function checkBudgetAfterTx(tx){
  if(tx.type!=='expense')return;
  const b=db.budgets.find(b=>b.category===tx.category);
  if(!b)return;
  const spent=getMonthlySpend(tx.category);
  const pct=(spent/b.monthlyLimit)*100;
  if(pct>=100){showToast(`🔴 Over budget! ${tx.category.replace(/^\S+\s/,'')} hit ${fmt(spent)}/${fmt(b.monthlyLimit)} (${pct.toFixed(0)}%)!`,'error');}
  else if(pct>=80){showToast(`🟡 ${tx.category.replace(/^\S+\s/,'')} budget at ${pct.toFixed(0)}% — watch out!`,'warn');}
  renderBudgetHomePanel();
}

// ═══════════════════════════════════════════════════════════════
// AI AUTO-CATEGORIZATION ENGINE v1.0
// Supports: manual text entry, voice (en-US, en-PH, fil-PH)
// Features: merchant DB, pattern learning, confidence scores
// ═══════════════════════════════════════════════════════════════

// ── Merchant Database (initial + dynamic learning) ────────────
const MERCHANT_DB = [
  // Fast Food / Dining PH
  { name:'Jollibee',    cat:'🍔 Food', keys:['jollibee','jabee','jb jollibee'],         conf:0.96 },
  { name:"McDonald's",  cat:'🍔 Food', keys:['mcdonalds','mcdo','mcdonald'],             conf:0.96 },
  { name:'KFC',         cat:'🍔 Food', keys:['kfc','kentucky fried'],                    conf:0.95 },
  { name:'Chowking',    cat:'🍔 Food', keys:['chowking','chow king'],                    conf:0.94 },
  { name:'Greenwich',   cat:'🍔 Food', keys:['greenwich'],                               conf:0.94 },
  { name:'Mang Inasal', cat:'🍔 Food', keys:['mang inasal','inasal'],                   conf:0.95 },
  { name:'Shakeys',     cat:'🍔 Food', keys:['shakeys','shakey'],                        conf:0.94 },
  { name:'Pizza Hut',   cat:'🍔 Food', keys:['pizza hut','pizzahut'],                   conf:0.94 },
  { name:'Starbucks',   cat:'🍔 Food', keys:['starbucks','sbux','starbuck'],             conf:0.96 },
  { name:'7-Eleven',    cat:'🍔 Food', keys:['7eleven','7-eleven','7 eleven','711'],     conf:0.90 },
  { name:'Ministop',    cat:'🍔 Food', keys:['ministop','mini stop'],                   conf:0.90 },
  { name:'Alfamart',    cat:'🛒 Shopping', keys:['alfamart'],                           conf:0.88 },
  { name:'Indomaret',   cat:'🛒 Shopping', keys:['indomaret'],                          conf:0.88 },
  // Grocery / Supermarket
  { name:'SM Supermarket', cat:'🍔 Food', keys:['sm supermarket','sm grocery','puregold'], conf:0.91 },
  { name:'Robinsons',   cat:'🍔 Food', keys:['robinsons supermarket','robinsons grocery'], conf:0.91 },
  { name:'Landers',     cat:'🍔 Food', keys:['landers','landers central'],              conf:0.93 },
  { name:'S&R',         cat:'🍔 Food', keys:['s&r','s and r','s&r membership'],         conf:0.92 },
  // Shopping / Mall
  { name:'SM Store',    cat:'👕 Shopping', keys:['sm store','sm department','sm dept'],  conf:0.90 },
  { name:'Robinsons Mall', cat:'👕 Shopping', keys:['robinsons mall','robinsons dept'], conf:0.89 },
  { name:'Ayala Mall',  cat:'👕 Shopping', keys:['ayala mall','ayala'],                 conf:0.85 },
  { name:'Shopee',      cat:'👕 Shopping', keys:['shopee'],                             conf:0.94 },
  { name:'Lazada',      cat:'👕 Shopping', keys:['lazada'],                             conf:0.94 },
  { name:'Shein',       cat:'👕 Shopping', keys:['shein'],                              conf:0.93 },
  // Transport
  { name:'Grab',        cat:'🚌 Transport', keys:['grab','grabcar','grab ride','grab food'], conf:0.96 },
  { name:'Angkas',      cat:'🚌 Transport', keys:['angkas'],                            conf:0.96 },
  { name:'Jeep',        cat:'🚌 Transport', keys:['jeep','jeepney','jeepney fare'],     conf:0.92 },
  { name:'MRT/LRT',     cat:'🚌 Transport', keys:['mrt','lrt','metro rail'],            conf:0.93 },
  { name:'Bus',         cat:'🚌 Transport', keys:['bus fare','bus'],                    conf:0.85 },
  { name:'Gas Station', cat:'🚌 Transport', keys:['petron','shell gas','caltex','seaoil','jetti','gas','gasoline','fuel'], conf:0.93 },
  { name:'Parking',     cat:'🚌 Transport', keys:['parking','parkade'],                 conf:0.90 },
  // Bills / Utilities
  { name:'Meralco',     cat:'💰 Bills', keys:['meralco','electric bill'],               conf:0.97 },
  { name:'PLDT',        cat:'📱 Subscriptions', keys:['pldt','fibr'],                  conf:0.96 },
  { name:'Globe',       cat:'📱 Subscriptions', keys:['globe telecom','globe load','globe bill'], conf:0.95 },
  { name:'Smart',       cat:'📱 Subscriptions', keys:['smart telecom','smart load','smart bill'], conf:0.95 },
  { name:'Converge',    cat:'📱 Subscriptions', keys:['converge','converge ict'],       conf:0.95 },
  { name:'Maynilad',    cat:'💰 Bills', keys:['maynilad','water bill'],                 conf:0.96 },
  { name:'Netflix',     cat:'📱 Subscriptions', keys:['netflix'],                      conf:0.97 },
  { name:'Spotify',     cat:'📱 Subscriptions', keys:['spotify'],                      conf:0.97 },
  { name:'YouTube',     cat:'📱 Subscriptions', keys:['youtube premium'],              conf:0.97 },
  // Health
  { name:'Mercury Drug', cat:'💊 Health', keys:['mercury drug','mercury','drug store'], conf:0.94 },
  { name:'Rose Pharmacy', cat:'💊 Health', keys:['rose pharmacy','rose pharma'],        conf:0.93 },
  { name:'Watsons',     cat:'💊 Health', keys:['watsons','watson'],                    conf:0.91 },
  // E-wallets / Banks (income/transfer hints)
  { name:'GCash',       cat:'🔄 Transfer', keys:['gcash','g-cash'],                    conf:0.88 },
  { name:'Maya',        cat:'🔄 Transfer', keys:['maya','paymaya'],                    conf:0.88 },
  // Income patterns
  { name:'Salary',      cat:'💼 Salary', keys:['salary','sweldo','sahod'],              conf:0.97, type:'income' },
  { name:'Freelance',   cat:'💸 Freelance / Side Hustle', keys:['freelance','project payment','client'], conf:0.90, type:'income' },
  { name:'Bonus',       cat:'🏆 Bonus / Commission', keys:['bonus','commission','incentive'], conf:0.92, type:'income' },
  { name:'Allowance',   cat:'🎁 Gift / Allowance', keys:['allowance','baon'],           conf:0.90, type:'income' },
  { name:'Interest',    cat:'🏦 Interest Earned', keys:['interest earned','bank interest'], conf:0.93, type:'income' },
];

// ── Keyword category map ──────────────────────────────────────
const KEYWORD_CAT_MAP = {
  '🍔 Food':         ['food','eat','meal','lunch','dinner','breakfast','coffee','restaurant','fastfood','pizza','milk tea','boba','snack','groceries','grocery','kain','ulam','merienda'],
  '🚌 Transport':    ['transport','fare','gas','gasoline','fuel','ride','commute','taxi','bus','jeep','mrt','lrt','parking','toll','pasada','byahe','sakay'],
  '💊 Health':       ['health','medicine','doctor','clinic','hospital','medical','pharmacy','vitamins','checkup','gamot'],
  '👕 Shopping':     ['shop','shopping','clothes','shoes','bought','purchase','mall','damit','sapatos','bili'],
  '💰 Bills':        ['bill','bills','electric','water','internet','phone','wifi','rent','utilities','bayad','kuryente','tubig'],
  '📱 Subscriptions':['netflix','spotify','youtube','subscription','premium','monthly plan'],
  '🎮 Entertainment':['entertainment','movie','game','concert','fun','sine','laro','fun'],
  '📚 Education':    ['tuition','school','education','book','training','course','seminar'],
  '💇 Personal Care':['haircut','salon','grooming','personal','beauty','spa','facial'],
  '✈️ Travel':       ['travel','hotel','airfare','flight','booking','trip','bakasyon'],
  '💼 Salary':       ['salary','sweldo','sahod'],
  '💸 Freelance / Side Hustle': ['freelance','project','client','gig'],
  '🎁 Gift / Allowance': ['allowance','baon','gift','regalo'],
  '🏆 Bonus / Commission': ['bonus','commission','incentive'],
};

// ── Type keyword detection ────────────────────────────────────
const TYPE_KEYWORDS = {
  expense: ['spent','paid','bought','purchase','nagastos','binili','gastos','bayad','spend','spend for','food','fare','bill','subscription'],
  income:  ['salary','received','income','payment received','deposit','bayad sa akin','sweldo','sahod','freelance earn','earned','bonus'],
  transfer:['transfer','move','send','lipat','padala','remit'],
};

// ── Dynamic learned patterns (stored in db.aiPatterns) ────────
function getAiPatterns() {
  return db.aiPatterns || {};
}
function saveAiPattern(text, result) {
  if (!db.aiPatterns) db.aiPatterns = {};
  const key = text.toLowerCase().trim().substring(0, 30);
  db.aiPatterns[key] = { ...result, learnedAt: Date.now() };
  // Trim to last 200 patterns
  const keys = Object.keys(db.aiPatterns);
  if (keys.length > 200) {
    const oldest = keys.sort((a,b) => (db.aiPatterns[a].learnedAt||0) - (db.aiPatterns[b].learnedAt||0));
    delete db.aiPatterns[oldest[0]];
  }
  saveDB();
}

// ── Core: parse text → result object ─────────────────────────
function aiParseText(rawText) {
  const text  = rawText.trim();
  const lower = text.toLowerCase();
  const result = { type: null, category: null, merchant: null, amount: 0, confidence: 0, suggestions: [] };

  // 0. Check learned patterns first (user-correction boosted)
  const patterns = getAiPatterns();
  for (const [pat, learned] of Object.entries(patterns)) {
    if (lower.includes(pat)) {
      return { ...result, ...learned, confidence: Math.min(0.99, (learned.confidence||0.5)+0.15), fromLearning: true };
    }
  }

  // 1. Extract amount (digit match or spoken number)
  const numWords = {zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19,twenty:20,thirty:30,forty:40,fifty:50,sixty:60,seventy:70,eighty:80,ninety:90,hundred:100,thousand:1000};
  const digitMatch = lower.match(/(\d[\d,\.]*)/);
  if (digitMatch) {
    result.amount = parseFloat(digitMatch[1].replace(/,/g,''));
  } else {
    let words = lower.replace(/[^\w\s]/g,' ').split(/\s+/);
    let total = 0, current = 0;
    words.forEach(w => {
      const v = numWords[w]; if (v === undefined) return;
      if (v === 1000) { total = (total+current)*1000; current = 0; }
      else if (v === 100) { current *= 100; }
      else current += v;
    });
    result.amount = total + current;
  }

  // 2. Detect transaction type
  let typeConf = 0;
  for (const [type, kws] of Object.entries(TYPE_KEYWORDS)) {
    for (const kw of kws) {
      if (lower.includes(kw)) {
        const c = kw.length > 5 ? 0.85 : 0.65;
        if (c > typeConf) { result.type = type; typeConf = c; }
      }
    }
  }

  // 3. Merchant database lookup
  let merchantConf = 0;
  for (const m of MERCHANT_DB) {
    for (const k of m.keys) {
      if (lower.includes(k)) {
        if (m.conf > merchantConf) {
          merchantConf = m.conf;
          result.merchant = m.name;
          result.category = m.cat;
          if (m.type && !result.type) result.type = m.type;
        }
        break;
      }
    }
  }

  // 4. Keyword category fallback if no merchant matched
  if (!result.category) {
    let catConf = 0;
    for (const [cat, kws] of Object.entries(KEYWORD_CAT_MAP)) {
      for (const kw of kws) {
        if (lower.includes(kw)) {
          const c = kw.length > 5 ? 0.70 : 0.55;
          if (c > catConf) { result.category = cat; catConf = c; }
        }
      }
    }
    // Category from user history (pattern analysis)
    if (!result.category) {
      const histMatch = getHistoryCategory(lower);
      if (histMatch) { result.category = histMatch.cat; merchantConf = Math.max(merchantConf, 0.55); }
    }
  }

  // 5. Infer type from category if not detected
  if (!result.type && result.category) {
    const incCats = ['💼 Salary','💸 Freelance / Side Hustle','🎁 Gift / Allowance','📈 Investment Returns','🏪 Business Revenue','🔄 Refund / Reimbursement','🏠 Rental Income','💹 Stock / Crypto Gains','🏆 Bonus / Commission','🎓 Scholarship / Grant','🤝 Government Benefit','💳 Cashback / Rewards','🏦 Interest Earned','📦 Sold Items','🎵 Royalties / Passive','💰 Other Income'];
    result.type = incCats.includes(result.category) ? 'income' : 'expense';
  }
  if (!result.type) result.type = 'expense'; // default

  // 6. Calculate overall confidence
  const hasAmount  = result.amount > 0   ? 0.3 : 0;
  const hasMerchant= merchantConf > 0    ? merchantConf * 0.5 : 0;
  const hasCat     = result.category     ? 0.2 : 0;
  const hasType    = typeConf > 0        ? typeConf * 0.1 : 0.05;
  result.confidence = Math.min(0.99, hasAmount + hasMerchant + hasCat + hasType);

  // 7. Build suggestions if low confidence (< 0.60)
  if (result.confidence < 0.60) {
    const cats = result.type === 'income' ? INCOME_CATS : EXPENSE_CATS;
    const top = cats.slice(0, 5);
    result.suggestions = top;
  }

  return result;
}

// ── History-based category suggestion ────────────────────────
function getHistoryCategory(lowerText) {
  const words = lowerText.split(/\s+/).filter(w => w.length > 3);
  if (!words.length) return null;
  const freq = {};
  db.transactions.filter(t => t.desc || t.ref).forEach(t => {
    const d = ((t.desc||'')+(t.ref||'')).toLowerCase();
    if (words.some(w => d.includes(w))) {
      freq[t.category] = (freq[t.category]||0) + 1;
    }
  });
  const sorted = Object.entries(freq).sort((a,b) => b[1]-a[1]);
  return sorted[0] ? { cat: sorted[0][0], count: sorted[0][1] } : null;
}

// ── State ─────────────────────────────────────────────────────
let currentAiResult = null;
let smartVoiceRecog = null;
let smartVoiceListening = false;
let categoryManuallyChanged = false;
let smartInputTimer = null;

// ══════════════════════════════════════════════════════════════
// FEATURE 1 + 4: Unified Secure Voice Engine
// Cyber-security: temporary mic access only — privacy first.
// All streams destroyed immediately after recording stops.
// ══════════════════════════════════════════════════════════════
let _voiceEngine = {
  // Shared state
  activeStream: null,         // MediaStream — always cleaned up on stop
  pendingCallback: null,      // fn(text) called when transcript finalised
  silenceTimer: null,         // FEATURE 4: 2s silence timer
  silenceDelay: 2000,         // ms — configurable
  currentTranscript: '',      // live transcript
  recognition: null,          // SpeechRecognition instance
  listening: false,
  context: null,              // string tag e.g. 'smartInput', 'formVAI-payable', 'vaiBar', 'generic-...'
  onFinalise: null,           // fn(transcript) — final processing callback
  liveTextEl: null,           // element to update with live text
  inputFieldEl: null,         // optional text field to mirror live text into

  // FEATURE 1: show permission modal first (only once), then call _start
  request(context, onFinalise, liveTextElId, inputFieldElId) {
    if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
      showToast('Voice input not supported. Try Chrome or Edge.', 'error'); return;
    }
    // Check if mic is disabled by user
    if(db.settings.micEnabled === false) {
      showToast('🎤 Microphone is disabled. Turn it on in Settings → Voice AI.', 'warn'); return;
    }
    // Stop any active session first
    if (this.listening) { this.stop(true); return; }
    this.context = context;
    this.onFinalise = onFinalise;
    this.liveTextEl  = liveTextElId  ? document.getElementById(liveTextElId)  : null;
    this.inputFieldEl= inputFieldElId? document.getElementById(inputFieldElId): null;
    // If already granted permission before — skip modal, go directly
    if(db.settings.micPermGranted === true) {
      this._start(); return;
    }
    // Show one-time permission modal
    _voicePermCallback = () => this._start();
    openModal('modal-mic-permission');
    setTimeout(()=>{ const btn=document.getElementById('mic-allow-btn'); if(btn)btn.focus(); }, 200);
  },

  async _start() {
    closeModal('modal-mic-permission');
    // FEATURE 1: Explicit getUserMedia for browser permission prompt + stream handle
    try {
      this.activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch(e) {
      if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError') {
        showToast('Microphone access denied. Enable mic in browser settings.', 'error');
      } else {
        showToast('Could not access microphone: '+e.message, 'error');
      }
      return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    this.recognition = new SR();
    // FEATURE 4: continuous=true + interimResults for 2s silence detection
    this.recognition.lang = 'en-US';
    this.recognition.continuous = true;
    this.recognition.interimResults = true;
    this.recognition.maxAlternatives = 1;
    this.currentTranscript = '';
    this.listening = true;
    _showRecordingBanner(true, '');

    this.recognition.onstart = () => {
      _showRecordingBanner(true, '');
    };

    this.recognition.onresult = (e) => {
      // Build live transcript
      let interim = '';
      let finalPart = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) finalPart += e.results[i][0].transcript + ' ';
        else interim += e.results[i][0].transcript;
      }
      if (finalPart) this.currentTranscript += finalPart;
      const liveText = (this.currentTranscript + interim).trim();
      // Update live displays
      _showRecordingBanner(true, liveText);
      if (this.liveTextEl) this.liveTextEl.textContent = liveText ? ('🎙️ '+liveText) : '🎙️ Listening…';
      if (this.inputFieldEl) this.inputFieldEl.value = liveText;
      // Fire oninput-style callbacks live (for form VAI preview)
      if (this.onLive) this.onLive(liveText);
      // FEATURE 4: Reset 2s silence timer on every speech event
      clearTimeout(this.silenceTimer);
      this.silenceTimer = setTimeout(() => {
        // 2 seconds of silence — finalise
        const final = (this.currentTranscript).trim() || liveText;
        if (final) this.stop(false, final);
        else this.stop(true);
      }, this.silenceDelay);
    };

    this.recognition.onspeechend = () => {
      // Speech ended — start silence timer if not already running
      clearTimeout(this.silenceTimer);
      this.silenceTimer = setTimeout(() => {
        const final = this.currentTranscript.trim();
        if (final) this.stop(false, final);
        else this.stop(true);
      }, this.silenceDelay);
    };

    this.recognition.onerror = (ev) => {
      if (ev.error === 'no-speech') {
        // Continue listening, just no speech yet
        return;
      }
      this.stop(true);
      if (ev.error === 'not-allowed') showToast('Microphone access denied.', 'error');
      else if (ev.error !== 'aborted') showToast('Voice error: '+ev.error, 'error');
    };

    this.recognition.onend = () => {
      // Auto-restart if still listening (browser cuts stream) — FEATURE 4 robustness
      if (this.listening && !this.silenceTimer) {
        try { this.recognition.start(); } catch(e) {}
      }
    };

    try { this.recognition.start(); }
    catch(e) {
      this.stop(true);
      showToast('Cannot start mic. Check permissions.', 'error');
    }
  },

  stop(cancelled, finalTranscript) {
    clearTimeout(this.silenceTimer);
    this.silenceTimer = null;
    this.listening = false;
    _showRecordingBanner(false, '');
    // FEATURE 1: Always destroy mic stream immediately
    if (this.activeStream) {
      this.activeStream.getTracks().forEach(t => t.stop());
      this.activeStream = null;
    }
    if (this.recognition) {
      try { this.recognition.stop(); } catch(e) {}
      this.recognition = null;
    }
    if (!cancelled && finalTranscript && this.onFinalise) {
      this.onFinalise(finalTranscript);
    }
    // Reset live display
    if (this.liveTextEl) this.liveTextEl.textContent = '';
    this.currentTranscript = '';
    this.onLive = null;
  }
};

let _voicePermCallback = null;   // set before opening permission modal

function _onMicAllow() {
  // Save permission granted so modal won't show again
  db.settings.micPermGranted = true;
  db.settings.micEnabled = true;
  saveDB();
  updateMicToggleUI();
  if (_voicePermCallback) { _voicePermCallback(); _voicePermCallback = null; }
}
function _onMicDeny() {
  closeModal('modal-mic-permission');
  _voicePermCallback = null;
}

function setMicEnabled(enabled) {
  db.settings.micEnabled = enabled;
  if(!enabled) {
    db.settings.micPermGranted = false; // reset so modal shows again if re-enabled
    _voiceEngine.stop(true);
    stopSmartVoice();
  }
  saveDB();
  updateMicToggleUI();
  showToast(enabled ? '🎤 Microphone enabled' : '🔇 Microphone disabled', 'info');
}

function updateMicToggleUI() {
  const tog = document.getElementById('mic-enabled-toggle');
  const sub = document.getElementById('mic-toggle-sub');
  if (!tog) return;
  const enabled = db.settings.micEnabled !== false;
  tog.checked = enabled;
  if (sub) sub.textContent = enabled
    ? (db.settings.micPermGranted ? '✅ Permission granted — mic is active' : '⏳ Tap a mic button to grant permission')
    : '🔇 Mic disabled — tap to re-enable';
}

function _stopAllVoice() {
  _voiceEngine.stop(true);
  stopSmartVoice();
}

// Show/hide persistent recording banner with live text
function _showRecordingBanner(show, liveText) {
  const banner = document.getElementById('recording-banner');
  const liveEl = document.getElementById('rec-live-text');
  if (!banner) return;
  banner.classList.toggle('show', show);
  if (liveEl) liveEl.textContent = liveText ? ('"'+liveText.slice(0,48)+(liveText.length>48?'…':'')+'"') : '';
}

// ── onSmartInput: debounced real-time parsing ─────────────────
function onSmartInput(text) {
  document.getElementById('smart-input-bar').classList.toggle('active', text.length > 0);
  clearTimeout(smartInputTimer);
  if (!text.trim()) { dismissAiResult(); return; }
  smartInputTimer = setTimeout(() => {
    const result = aiParseText(text);
    currentAiResult = result;
    renderAiResultCard(result);
    // If high confidence, also auto-switch type tab
    if (result.confidence >= 0.80 && result.type) {
      const typeBtn = document.querySelector(`#modal-tx .type-tab.${result.type}`);
      if (typeBtn) setTxType(result.type, typeBtn);
    }
  }, 350);
}

// ── Render AI result card ──────────────────────────────────────
function renderAiResultCard(r) {
  const card = document.getElementById('ai-result-card');
  const fields = document.getElementById('ai-result-fields');
  const badge = document.getElementById('ai-conf-badge');
  const meter = document.getElementById('ai-conf-meter');
  const sugg = document.getElementById('ai-suggestions');

  const pct = Math.round(r.confidence * 100);
  badge.textContent = pct + '%';
  badge.className = 'ai-conf-badge ' + (pct >= 80 ? 'high' : pct >= 50 ? 'medium' : 'low');
  meter.style.width = pct + '%';
  meter.style.background = pct >= 80 ? 'var(--emerald)' : pct >= 50 ? 'var(--amber)' : 'var(--rose)';

  const typeEmoji = r.type === 'income' ? '💰' : r.type === 'transfer' ? '🔄' : '💸';
  const typeLabel = r.type ? (r.type.charAt(0).toUpperCase()+r.type.slice(1)) : '?';

  fields.innerHTML = `
    <div class="ai-result-field">
      <div class="ai-field-label">Type</div>
      <div class="ai-field-value">${typeEmoji} ${typeLabel}</div>
    </div>
    <div class="ai-result-field">
      <div class="ai-field-label">Amount</div>
      <div class="ai-field-value" style="color:var(--${r.type==='income'?'emerald':'rose'})">${r.amount > 0 ? fmt(r.amount) : '—'}</div>
    </div>
    <div class="ai-result-field">
      <div class="ai-field-label">Category</div>
      <div class="ai-field-value">${r.category || '—'}</div>
    </div>
    <div class="ai-result-field">
      <div class="ai-field-label">Merchant</div>
      <div class="ai-field-value">${r.merchant || '—'}</div>
    </div>`;

  card.classList.add('show');

  // Suggestions for low confidence
  if (r.suggestions && r.suggestions.length && r.confidence < 0.60) {
    sugg.style.display = 'flex';
    sugg.innerHTML = '<span style="font-size:10px;color:var(--text3);align-self:center">Suggest:</span>' +
      r.suggestions.slice(0,4).map(c =>
        `<button class="ai-suggestion-chip" onclick="applySuggestion('${c.replace(/'/g,"\\'")}')">${c}</button>`
      ).join('');
  } else {
    sugg.style.display = 'none';
    sugg.innerHTML = '';
  }
}

// ── Apply the AI result to the form ───────────────────────────
function applySmartResult() {
  const r = currentAiResult;
  if (!r) return;

  // Switch type
  if (r.type) {
    const typeBtn = document.querySelector(`#modal-tx .type-tab.${r.type}`);
    if (typeBtn) setTxType(r.type, typeBtn);
  }
  // Amount
  if (r.amount > 0) document.getElementById('tx-amount').value = r.amount;
  // Category
  if (r.category) {
    const sel = document.getElementById('tx-category');
    for (const opt of sel.options) {
      if (opt.value === r.category) { sel.value = r.category; break; }
    }
  }
  // Merchant → ref field
  if (r.merchant) document.getElementById('tx-ref').value = r.merchant;
  // Description from smart input
  const inputVal = document.getElementById('smart-input-field').value;
  if (inputVal) document.getElementById('tx-desc').value = inputVal;
  // Date
  document.getElementById('tx-date').value = today();

  checkBalanceWarning();
  categoryManuallyChanged = false;

  // Save pattern for learning
  if (r.confidence >= 0.50) saveAiPattern(inputVal, r);

  // Feedback
  const learnMsg = r.fromLearning ? ' <span class="ai-learn-badge">🧠 From memory</span>' : '';
  showToast('✨ Applied! '+(r.category||'')+' '+(r.amount>0?fmt(r.amount):'')+(r.fromLearning?' · From memory':''),'success');

  // Collapse result card
  dismissAiResult();
  document.getElementById('smart-input-field').value = '';
  document.getElementById('smart-input-bar').classList.remove('active');
}

// ── Apply a suggestion chip ───────────────────────────────────
function applySuggestion(cat) {
  const sel = document.getElementById('tx-category');
  for (const opt of sel.options) {
    if (opt.value === cat) { sel.value = cat; break; }
  }
  // Update currentAiResult
  if (currentAiResult) {
    currentAiResult.category = cat;
    currentAiResult.confidence = Math.max(currentAiResult.confidence, 0.60);
    // Learn this correction
    const inputVal = document.getElementById('smart-input-field').value;
    saveAiPattern(inputVal, currentAiResult);
    showToast(`📂 Category set: ${cat} · 🧠 FinFlow learned!`, 'success');
  }
  renderAiResultCard(currentAiResult);
}

// ── Category manually changed → learn ─────────────────────────
function onCategoryManualChange() {
  categoryManuallyChanged = true;
  if (currentAiResult) {
    const newCat = document.getElementById('tx-category').value;
    if (newCat !== currentAiResult.category) {
      currentAiResult.category = newCat;
      const inputVal = document.getElementById('smart-input-field').value;
      if (inputVal) {
        saveAiPattern(inputVal, currentAiResult);
        showToast('🧠 FinFlow learned from your correction!','info');
      }
    }
  }
}

function dismissAiResult() {
  const card = document.getElementById('ai-result-card');
  if (card) card.classList.remove('show');
  const sugg = document.getElementById('ai-suggestions');
  if (sugg) { sugg.style.display = 'none'; sugg.innerHTML = ''; }
  currentAiResult = null;
}
function focusSmartInput() {
  document.getElementById('smart-input-field').focus();
}

// ── Smart Voice Input (now backed by unified secure voice engine) ─────
// FEATURE 1 + 4: Permission modal → getUserMedia → 2s silence → auto-stop
function toggleSmartVoice() {
  // If already listening via engine, stop
  if (_voiceEngine.listening && _voiceEngine.context === 'smartInput') {
    _voiceEngine.stop(false, _voiceEngine.currentTranscript.trim());
    return;
  }
  const btn       = document.getElementById('smart-voice-btn');
  const bar       = document.getElementById('smart-voice-status');
  const inputBar  = document.getElementById('smart-input-bar');
  if (btn) btn.classList.add('listening');
  if (bar) bar.classList.add('show');
  if (inputBar) inputBar.classList.add('listening');
  _voiceEngine.onLive = (text) => {
    const txt = document.getElementById('smart-voice-text');
    const field = document.getElementById('smart-input-field');
    if (txt) txt.textContent = '🎙️ ' + text;
    if (field) field.value = text;
    onSmartInput(text);
  };
  _voiceEngine.request('smartInput', (finalText) => {
    stopSmartVoice();
    onSmartInput(finalText);
  }, 'smart-voice-text', 'smart-input-field');
}

function stopSmartVoice() {
  smartVoiceListening = false;
  const btn = document.getElementById('smart-voice-btn');
  const bar = document.getElementById('smart-voice-status');
  const inputBar = document.getElementById('smart-input-bar');
  if (btn) btn.classList.remove('listening');
  if (bar) bar.classList.remove('show');
  if (inputBar) inputBar.classList.remove('listening');
  if (smartVoiceRecog) { try { smartVoiceRecog.stop(); } catch(e) {} smartVoiceRecog = null; }
}

// ── Reset smart input when modal opens ───────────────────────
function resetSmartInput() {
  const field = document.getElementById('smart-input-field');
  if (field) field.value = '';
  dismissAiResult();
  stopSmartVoice();
  categoryManuallyChanged = false;
  currentAiResult = null;
  const bar = document.getElementById('smart-input-bar');
  if (bar) bar.classList.remove('active','listening');
}

// ── Keep old parseVoiceInput & toggleVoiceInput for compat ────
function toggleVoiceInput() { toggleSmartVoice(); }
function parseVoiceInput(text) { onSmartInput(text); }

// ── Generic voice input for any field ─────────────────────────
// Usage: genericVoice(btnId, targetFieldId, onResult, statusId)
let genericVoiceRecog = null;
let genericVoiceListening = false;
// FEATURE 1+4: genericVoice — routes through unified secure voice engine
function genericVoice(btnId, targetFieldId, onResult, statusId) {
  if (_voiceEngine.listening) { _voiceEngine.stop(false, _voiceEngine.currentTranscript.trim()); return; }
  const btn = document.getElementById(btnId);
  const st  = statusId ? document.getElementById(statusId) : null;
  if (btn) btn.classList.add('listening');
  if (st)  { st.style.display='flex'; st.textContent='🎙️ Listening…'; }
  _voiceEngine.onLive = (text) => {
    const field = document.getElementById(targetFieldId);
    if (field) field.value = text;
    if (st) st.textContent = '🎙️ '+text;
  };
  _voiceEngine.request('generic-'+btnId, (final) => {
    if (btn) btn.classList.remove('listening');
    if (st)  { st.textContent='🎙️ '+final; setTimeout(()=>{ if(st)st.style.display='none'; }, 1800); }
    const field = document.getElementById(targetFieldId);
    if (field) field.value = final;
    if (onResult) onResult(final);
  }, null, targetFieldId);
}

// ===== END AI CATEGORIZATION ENGINE ======

// ===== SMART ALERTS =====
function generateSmartAlerts(){
  const alerts=[];
  const now=new Date();
  const todayStr=today();
  // --- BUDGET ALERTS ---
  db.budgets.forEach(b=>{
    const spent=getMonthlySpend(b.category);
    const pct=(spent/b.monthlyLimit)*100;
    const catLabel=b.category.replace(/^\S+\s/,'');
    const key='budget-'+b.id+'-'+Math.floor(pct/20);
    if(pct>=100&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'danger',icon:'🔴',text:`You've exceeded your <strong>${catLabel}</strong> budget! Spent ${fmt(spent)} of ${fmt(b.monthlyLimit)} limit.`,action:null});}
    else if(pct>=80&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'warn',icon:'🟡',text:`<strong>${catLabel}</strong> budget at ${pct.toFixed(0)}% — ${fmt(b.monthlyLimit-spent)} remaining. Watch your spending!`,action:null});}
    else if(pct>=60&&!dismissedAlerts.has(key)){
      const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
      const pctMonthDone=(now.getDate()/daysInMonth)*100;
      if(pct>pctMonthDone+15){alerts.push({key,type:'warn',icon:'⚡',text:`You're burning through <strong>${catLabel}</strong> faster than usual — ${pct.toFixed(0)}% of budget in ${Math.round(pctMonthDone)}% of month.`,action:null});}
    }
  });
  // --- PAYABLE UPCOMING ALERTS ---
  db.payables.filter(p=>p.status==='active'&&p.dueDay).forEach(py=>{
    const d=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
    if(d<now)d.setMonth(d.getMonth()+1);
    const daysUntil=Math.ceil((d-now)/(1000*60*60*24));
    const key='payable-due-'+py.id+'-'+d.toISOString().split('T')[0];
    if(daysUntil<=3&&daysUntil>=0&&!dismissedAlerts.has(key)){
      const acc=py.linkedAccount?db.accounts.find(a=>a.id===py.linkedAccount):null;
      const balOk=!acc||acc.balance>=(py.monthlyPayment||0);
      alerts.push({key,type:balOk?'warn':'danger',icon:'💳',text:`<strong>${py.name}</strong> payment of ${fmt(py.monthlyPayment||0)} due in ${daysUntil===0?'today':daysUntil+' days'}${!balOk?` — ⚠️ ${acc.name} balance is low!`:''}`,action:null});}
  });
  // --- PLANNED ITEMS UPCOMING ---
  const upcoming=db.planned.filter(p=>p.status==='pending'&&p.date>=todayStr);
  upcoming.filter(p=>{const d=new Date(p.date+'T00:00:00');return Math.ceil((d-now)/(1000*60*60*24))<=2;}).forEach(p=>{
    const key='planned-'+p.id;
    if(!dismissedAlerts.has(key)){
      const d=new Date(p.date+'T00:00:00');
      const daysUntil=Math.ceil((d-now)/(1000*60*60*24));
      const acc=db.accounts.find(a=>a.id===p.accountId);
      const balWarn=acc&&p.amount>acc.balance;
      alerts.push({key,type:balWarn?'danger':'info',icon:'📅',text:`Planned: <strong>${p.category.replace(/^\S+\s/,'')}</strong> ${fmt(p.amount)} ${daysUntil===0?'today':`in ${daysUntil} day${daysUntil!==1?'s':''}`}${balWarn?` — ⚠️ ${acc.name} balance insufficient`:''}`,action:null});
    }
  });
  // --- CASH FLOW PREDICTION ALERTS ---
  try {
    const cfEnd = cfEndDate ? cfEndDate() : null;
    if (cfEnd) {
      const cfEvts = cfCollectEvents(cfEnd);
      const cfBal = db.accounts.reduce((s,a)=>s+a.balance,0);
      const cfTl = cfBuildTimeline(cfBal, cfEvts, cfEnd);
      const cfNeg = cfTl.find(d => d.balance < 0);
      const cfLow = cfTl.find(d => d.balance < 2000 && d.balance >= 0);
      const cfKeyNeg = 'cf-negative-' + cfEnd;
      const cfKeyLow = 'cf-low-' + cfEnd;
      if (cfNeg && !dismissedAlerts.has(cfKeyNeg)) {
        alerts.push({key:cfKeyNeg,type:'danger',icon:'📈',text:`<strong>Cash Flow Alert:</strong> Your balance is predicted to go negative (${fmt(cfNeg.balance)}) on ${fmtDate(cfNeg.date)} based on upcoming events.`,action:null});
      } else if (cfLow && !dismissedAlerts.has(cfKeyLow)) {
        alerts.push({key:cfKeyLow,type:'warn',icon:'📈',text:`<strong>Cash Flow Warning:</strong> Balance may drop below ${fmt(2000)} on ${fmtDate(cfLow.date)}. Your balance may drop below the safe level soon.`,action:null});
      }
    }
  } catch(e) {}
  // --- SAVINGS RESERVE ALERTS ---
  db.accounts.filter(a=>(a.savingsReserve||0)>0).forEach(acc=>{
    const reserve=acc.savingsReserve||0;
    const pct=((acc.balance-reserve)/reserve)*100;
    const key='savings-low-'+acc.id;
    if(acc.balance<reserve&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'danger',icon:'🛡️',text:`<strong>${acc.name}</strong> balance (${fmt(acc.balance)}) is below your savings reserve of ${fmt(reserve)}! Consider topping up.`,action:null});
    } else if(acc.balance<reserve*1.2&&acc.balance>=reserve&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'warn',icon:'🛡️',text:`<strong>${acc.name}</strong> is running close to your savings reserve (${fmt(reserve)}). Current balance: ${fmt(acc.balance)}.`,action:null});
    }
  });
  // --- NO RENT CHECK (around 25th) ---
  if(now.getDate()>=23){
    const rentCats=['🏠 Rent/Utilities','💰 Bills'];
    const hasRent=rentCats.some(c=>{const s=getMonthlySpend(c);return s>0;});
    const key='rent-check-'+now.getFullYear()+'-'+now.getMonth();
    if(!hasRent&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'info',icon:'🏠',text:`No rent or bills recorded this month yet. If rent is due soon, don't forget to add it!`,action:null});}
  }
  // --- GOAL PROTECTION ALERTS (balance nearing saved goal target) ---
  db.goals.filter(g=>g.linkedAccountId&&g.status!=='achieved'&&(g.saved||0)>0).forEach(g=>{
    const acc=db.accounts.find(a=>a.id===g.linkedAccountId);if(!acc)return;
    const protected_=g.saved||0;
    const buffer=acc.balance-protected_;
    const key='goal-protect-'+g.id;
    if(buffer<0&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'danger',icon:'🎯',text:`<strong>${acc.name}</strong> balance (${fmt(acc.balance)}) is BELOW the ${fmt(protected_)} saved for goal "<strong>${g.name}</strong>"! Expenses from this account are blocked.`,action:null});
    } else if(buffer>=0&&buffer<protected_*0.2&&!dismissedAlerts.has(key)){
      alerts.push({key,type:'warn',icon:'🎯',text:`<strong>${acc.name}</strong> balance is getting close to your goal "${g.name}" savings amount (${fmt(protected_)} protected). Balance: ${fmt(acc.balance)}.`,action:null});
    }
  });
  return alerts;
}
function renderSmartAlerts(){
  const alerts=generateSmartAlerts();
  // Update bell badge
  const badge=document.getElementById('bell-badge');
  if(badge){if(alerts.length){badge.style.display='flex';badge.textContent=alerts.length;}else badge.style.display='none';}
  // Render in sheet
  const content=document.getElementById('alerts-sheet-content');
  if(!content)return;
  if(!alerts.length){
    content.innerHTML='<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">All clear! No alerts right now ✓</div>';
    return;
  }
  content.innerHTML=alerts.map(a=>`
    <div class="smart-alert-item">
      <span class="sa-icon">${a.icon}</span>
      <span class="sa-text">${a.text}</span>
      <button class="sa-dismiss-btn" onclick="dismissAlert('${a.key}')" title="Dismiss">✕</button>
    </div>`).join('');
}
function toggleAlertsSheet(){
  const sheet=document.getElementById('alerts-sheet');
  if(sheet)sheet.classList.toggle('open');
}
function dismissAlert(key){
  dismissedAlerts.add(key);
  try{localStorage.setItem('finflow_dismissed_alerts',JSON.stringify([...dismissedAlerts]));}catch(e){}
  renderSmartAlerts();
}
// Clear stale dismissed alerts monthly
function cleanDismissedAlerts(){
  const now=new Date();
  const prefix=now.getFullYear()+'-'+now.getMonth();
  const toKeep=[...dismissedAlerts].filter(k=>k.includes(prefix)||k.includes('payable')||k.includes('budget'));
  dismissedAlerts=new Set(toKeep);
  try{localStorage.setItem('finflow_dismissed_alerts',JSON.stringify([...dismissedAlerts]));}catch(e){}
}

// ===== SAVINGS GOALS =====
const GOAL_EMOJIS=['🎯','✈️','🏠','🚗','📱','💻','💍','🎓','🏋️','🌴','🎸','🏖️','💰','🏆','🛒','🍕','☕','🎮','📷','⌚','👗','👠','🏥','🌏','🛫','🏕️','🎉','🎁','🏦','💎','🚀','🐶','🏡','🌊','🎨','🎵'];

function renderGoalIconPicker(selectedEmoji){
  const el=document.getElementById('goal-icon-picker');if(!el)return;
  el.innerHTML=GOAL_EMOJIS.map(e=>`<button type="button" onclick="selectGoalIcon('${e}')" style="width:36px;height:36px;border-radius:8px;border:2px solid ${e===selectedEmoji?'var(--blue)':'transparent'};background:${e===selectedEmoji?'var(--blue-bg)':'var(--bg3)'};font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;-webkit-appearance:none" id="gi-${e.codePointAt(0)}">${e}</button>`).join('');
}
function selectGoalIcon(emoji){
  document.getElementById('goal-emoji').value=emoji;
  renderGoalIconPicker(emoji);
}

function handleGoalsAdd(){
  if(currentGoalsTab==='recurring')openAddRecurring();
  else if(currentGoalsTab==='planned')openAddPlanned();
  else openAddGoal();
}
function showGoalsTab(tab,btn){
  currentGoalsTab=tab;
  document.querySelectorAll('#screen-goals .screen-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const addBtn=document.getElementById('goals-add-btn');
  if(addBtn)addBtn.textContent=tab==='recurring'?'➕':tab==='planned'?'➕':'➕';
  // Update VAI bar context based on sub-tab — all forms now have embedded Smart Input
  hideVAIBar();
  renderGoalsScreen();
}
function renderGoalsScreen(){
  const el=document.getElementById('goals-content');if(!el)return;
  if(currentGoalsTab==='active')renderGoalsList(false);
  else if(currentGoalsTab==='achieved')renderGoalsList(true);
  else if(currentGoalsTab==='recurring')renderRecurringList();
  else if(currentGoalsTab==='planned')renderPlannedTab();
}
// ===== REDESIGNED PLANNED TAB =====
function renderPlannedTab(){
  const el=document.getElementById('goals-content');if(!el)return;
  const todayStr=today();
  const now=new Date();
  const cur=getCurrency();

  // --- SECTION 1: Payable Upcoming Payments (auto from payables) ---
  let payableSection='';
  const activePayables=db.payables.filter(p=>p.status==='active'&&p.dueDay&&p.monthlyPayment>0);
  if(activePayables.length){
    const rows=activePayables.map(py=>{
      const acc=py.linkedAccount?db.accounts.find(a=>a.id===py.linkedAccount):null;
      let d=new Date(now.getFullYear(),now.getMonth(),py.dueDay);
      if(d<now)d=new Date(now.getFullYear(),now.getMonth()+1,py.dueDay);
      const dateStr=d.toISOString().split('T')[0];
      const daysUntil=Math.ceil((d-now)/(1000*60*60*24));
      const sufficient=acc&&acc.balance>=py.monthlyPayment;
      const balWarn=acc&&acc.balance<py.monthlyPayment?`<div style="font-size:10px;color:var(--danger);margin-top:4px">⚠️ ${acc.name} only has ${fmt(acc.balance)}</div>`:'';
      let statusBadge='';
      if(daysUntil<=0)statusBadge=`<span class="planned-badge overdue">OVERDUE</span>`;
      else if(daysUntil<=3)statusBadge=`<span class="planned-badge today">DUE SOON</span>`;
      else statusBadge=`<span class="planned-badge upcoming">UPCOMING</span>`;
      return`<div class="planned-item${daysUntil<=0?' overdue':daysUntil<=3?' today':''}">
        <div class="planned-header">
          <div class="planned-cat">💳 ${py.name}</div>
          <div class="planned-amount" style="color:var(--expense)">${fmt(py.monthlyPayment)}</div>
        </div>
        <div class="planned-meta">
          ${statusBadge}
          ${acc?`<span>${acc.name}</span>`:'<span style="color:var(--danger)">⚠️ No account linked</span>'}
          <span>${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</span>
        </div>
        ${balWarn}
        <div class="planned-actions">
          <button type="button" class="planned-btn confirm" onclick="openPayPayable('${py.id}')">💰 Pay Now</button>
          <button type="button" class="planned-btn edit-btn" onclick="openEditPayable('${py.id}')">✏️ Edit</button>
        </div>
      </div>`;
    }).join('');
    payableSection=`<div class="section-title" style="margin-top:0">💳 Payable Due Dates</div>${rows}`;
  }

  // --- SECTION 2: Goals Monthly Contribution Plan ---
  let goalsSection='';
  const activeGoals=db.goals.filter(g=>g.status!=='achieved'&&g.target>g.saved);
  if(activeGoals.length){
    const rows=activeGoals.map(g=>{
      const remaining=Math.max(0,g.target-g.saved);
      let monthlyTarget=0;
      if(g.targetDate){
        const td=new Date(g.targetDate+'T00:00:00');
        const months=Math.max(1,Math.ceil((td-now)/(1000*60*60*24*30)));
        monthlyTarget=remaining/months;
      }
      const pct=Math.min(100,(g.saved/g.target)*100);
      const barColor=pct>=60?'var(--accent)':pct>=30?'var(--planned)':'var(--expense)';
      return`<div class="planned-item">
        <div class="planned-header">
          <div class="planned-cat">${g.emoji||'🎯'} ${g.name}</div>
          <div class="planned-amount" style="color:var(--accent)">${fmt(g.saved)} / ${fmt(g.target)}</div>
        </div>
        <div style="margin:6px 0 4px">
          <div style="background:var(--bg3);border-radius:99px;height:4px;overflow:hidden">
            <div style="width:${pct.toFixed(1)}%;height:100%;border-radius:99px;background:${barColor}"></div>
          </div>
        </div>
        <div class="planned-meta">
          <span class="planned-badge upcoming">${pct.toFixed(0)}% SAVED</span>
          ${g.targetDate?`<span>Target: ${fmtDate(g.targetDate)}</span>`:''}
          ${monthlyTarget>0?`<span>~${fmt(monthlyTarget)}/mo needed</span>`:''}
        </div>
        <div class="planned-actions">
          <button type="button" class="planned-btn confirm" onclick="openAddFundsModal('${g.id}')">➕ Add Funds</button>
          <button type="button" class="planned-btn edit-btn" onclick="openEditGoal('${g.id}')">✏️ Edit</button>
        </div>
      </div>`;
    }).join('');
    goalsSection=`<div class="section-title" style="margin-top:16px">🎯 Savings Goals Progress</div>${rows}`;
  }

  // --- SECTION 3: Upcoming Recurring Transactions ---
  let recurSection='';
  const activeRecurring=db.recurring.filter(r=>!r.paused&&r.nextDate);
  if(activeRecurring.length){
    const upcomingRecur=activeRecurring.filter(r=>r.nextDate&&r.nextDate>=todayStr)
      .sort((a,b)=>a.nextDate.localeCompare(b.nextDate)).slice(0,5);
    if(upcomingRecur.length){
      const rows=upcomingRecur.map(r=>{
        const acc=db.accounts.find(a=>a.id===r.accountId);
        const d=new Date(r.nextDate+'T00:00:00');
        const daysUntil=Math.ceil((d-now)/(1000*60*60*24));
        let statusBadge=daysUntil<=0?`<span class="planned-badge overdue">TODAY</span>`:
          daysUntil<=3?`<span class="planned-badge today">IN ${daysUntil}D</span>`:
          `<span class="planned-badge upcoming">IN ${daysUntil}D</span>`;
        const tc=r.type==='expense'?'var(--expense)':'var(--income)';
        return`<div class="planned-item">
          <div class="planned-header">
            <div class="planned-cat">🔄 ${r.name}</div>
            <div class="planned-amount" style="color:${tc}">${r.type==='expense'?'-':'+'} ${fmt(r.amount)}</div>
          </div>
          <div class="planned-meta">
            ${statusBadge}
            ${acc?`<span>${acc.name}</span>`:''}
            <span>${fmtDate(r.nextDate)}</span>
            <span style="text-transform:capitalize">${r.frequency}</span>
          </div>
        </div>`;
      }).join('');
      recurSection=`<div class="section-title" style="margin-top:16px">🔄 Upcoming Recurring</div>${rows}`;
    }
  }

  // --- SECTION 4: Manual One-time Planned Activities ---
  let manualSection='';
  const manualPlanned=db.planned.filter(p=>p.status==='pending'&&!p.payableId).sort((a,b)=>a.date.localeCompare(b.date));
  if(manualPlanned.length){
    manualSection=`<div class="section-title" style="margin-top:16px">📌 One-Time Planned Activities <span style="font-size:11px;font-weight:400;color:var(--text3)">(${manualPlanned.length})</span></div>${renderPlannedItemsHTML(manualPlanned)}`;
  }

  const isEmpty=!payableSection&&!goalsSection&&!recurSection&&!manualSection;
  if(isEmpty){
    el.innerHTML=`<div class="empty"><div class="empty-icon">📅</div><p>No planned activities yet.<br>Add payables with due dates, create savings goals, or set up recurring transactions to see them here.<br><br>Tap ➕ to add a one-time planned payment.</p></div>`;
    return;
  }

  el.innerHTML=`<div style="padding:14px 16px">
    ${payableSection}
    ${goalsSection}
    ${recurSection}
    ${manualSection}
  </div>`;
}

function renderGoalsList(showAchieved){
  const el=document.getElementById('goals-content');if(!el)return;
  const goals=db.goals.filter(g=>showAchieved?(g.status==='achieved'):(g.status!=='achieved'));
  if(!goals.length){
    el.innerHTML=`<div class="empty"><div class="empty-icon">${showAchieved?'🏆':'🎯'}</div><p>${showAchieved?'No achieved goals yet.<br>Keep saving!':'No goals yet.<br>Tap ➕ to create one!'}</p></div>`;
    return;
  }
  const now=new Date();
  el.innerHTML=goals.map(g=>{
    const pct=Math.min(100,(g.saved/g.target)*100);
    const remaining=Math.max(0,g.target-g.saved);
    const barColor=pct>=100?'var(--income)':pct>=60?'var(--accent)':pct>=30?'var(--planned)':'var(--expense)';
    let daysLeft='', dailyNeeded='';
    if(g.targetDate&&g.status!=='achieved'){
      const td=new Date(g.targetDate+'T00:00:00');
      daysLeft=Math.max(0,Math.ceil((td-now)/(1000*60*60*24)));
      dailyNeeded=daysLeft>0?(remaining/daysLeft).toFixed(0):0;
    }
    const isAchieved=g.status==='achieved';
    const linkedAcc=g.linkedAccountId?db.accounts.find(a=>a.id===g.linkedAccountId):null;
    const linkedBadge=linkedAcc?`<div style="font-size:10px;color:var(--violet);background:var(--violet-bg);border-radius:6px;padding:2px 7px;display:inline-flex;align-items:center;gap:3px;margin-top:4px">🏦 ${linkedAcc.name}</div>`:'';
    return`<div class="goal-card${isAchieved?' achieved':''}" onclick="openEditGoal('${g.id}')">
      <div class="goal-hdr">
        <div class="goal-emoji-wrap" style="background:${barColor}22">${g.emoji||'🎯'}</div>
        <div class="goal-info">
          <div class="goal-name">${g.name}</div>
          <div class="goal-deadline">${g.targetDate?'Target: '+fmtDate(g.targetDate):'No deadline'}${isAchieved?' · ✅ Achieved!':''}</div>
          ${linkedBadge}
        </div>
        <div class="goal-pct-badge" style="background:${barColor}22;color:${barColor}">${pct.toFixed(0)}%</div>
      </div>
      <div class="goal-bar-wrap"><div class="goal-bar" style="width:${pct.toFixed(1)}%;background:${barColor}"></div></div>
      <div class="goal-stats-row">
        <div class="goal-stat-box">
          <div class="goal-stat-val" style="color:var(--income)">${fmt(g.saved)}</div>
          <div class="goal-stat-lbl">Saved</div>
        </div>
        <div class="goal-stat-box">
          <div class="goal-stat-val">${fmt(g.target)}</div>
          <div class="goal-stat-lbl">Target</div>
        </div>
        <div class="goal-stat-box">
          <div class="goal-stat-val" style="color:${remaining>0?'var(--expense)':'var(--income)'}">${remaining>0?fmt(remaining):'✅ Done'}</div>
          <div class="goal-stat-lbl">Remaining</div>
        </div>
      </div>
      ${dailyNeeded&&remaining>0?`<div style="background:rgba(124,131,253,0.1);border-radius:10px;padding:8px 12px;font-size:11px;color:var(--accent);margin-top:8px;text-align:center">💡 Save ${fmt(Number(dailyNeeded))} per day to reach your goal on time (${daysLeft} days left)</div>`:''}
      ${!isAchieved?`<div class="goal-actions" onclick="event.stopPropagation()">
        <button class="goal-action-btn add" onclick="openAddFundsModal('${g.id}')">➕ Add Funds</button>
        <button class="goal-action-btn edit" onclick="openEditGoal('${g.id}')">✏️ Edit</button>
        ${pct>=100?`<button class="goal-action-btn achieved-btn" onclick="markGoalAchieved('${g.id}')">🏆 Done!</button>`:''}
      </div>`:''}
    </div>`;
  }).join('');
}
function openAddGoal(){
  editingGoalId=null;
  document.getElementById('modal-goal-title').textContent='New Savings Goal';
  document.getElementById('goal-save-btn').textContent='Create Goal';
  document.getElementById('goal-delete-btn').style.display='none';
  document.getElementById('goal-name').value='';
  document.getElementById('goal-emoji').value='🎯';
  document.getElementById('goal-target').value='';
  document.getElementById('goal-saved').value='';
  document.getElementById('goal-date').value='';
  document.getElementById('goal-notes').value='';
  const accOpts='<option value="">— No linked account —</option>'+db.accounts.map(a=>`<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('');
  document.getElementById('goal-linked-account').innerHTML=accOpts;
  dismissFormVAI('goal');
  const vInp=document.getElementById('goal-vai-input');if(vInp)vInp.value='';
  renderGoalIconPicker('🎯');
  openModal('modal-goal');
}
function openEditGoal(id){
  const g=db.goals.find(g=>g.id===id);if(!g)return;
  editingGoalId=id;
  document.getElementById('modal-goal-title').textContent='Edit Goal';
  document.getElementById('goal-save-btn').textContent='Update Goal';
  document.getElementById('goal-delete-btn').style.display='';
  document.getElementById('goal-name').value=g.name;
  document.getElementById('goal-emoji').value=g.emoji||'🎯';
  document.getElementById('goal-target').value=g.target;
  document.getElementById('goal-saved').value=g.saved;
  document.getElementById('goal-date').value=g.targetDate||'';
  document.getElementById('goal-notes').value=g.notes||'';
  const accOpts='<option value="">— No linked account —</option>'+db.accounts.map(a=>`<option value="${a.id}"${a.id===g.linkedAccountId?' selected':''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('');
  document.getElementById('goal-linked-account').innerHTML=accOpts;
  renderGoalIconPicker(g.emoji||'🎯');
  openModal('modal-goal');
}
function saveGoal(){
  const name=document.getElementById('goal-name').value.trim();
  const emoji=document.getElementById('goal-emoji').value.trim()||'🎯';
  const target=parseFloat(document.getElementById('goal-target').value)||0;
  const saved=parseFloat(document.getElementById('goal-saved').value)||0;
  const targetDate=document.getElementById('goal-date').value||null;
  const notes=document.getElementById('goal-notes').value.trim();
  const linkedAccountId=document.getElementById('goal-linked-account').value||null;
  if(!name){showToast('Please enter a goal name','error');return;}
  if(target<=0){showToast('Please enter a target amount','error');return;}
  if(editingGoalId){
    const g=db.goals.find(g=>g.id===editingGoalId);
    if(g)Object.assign(g,{name,emoji,target,saved,targetDate,notes,linkedAccountId,updatedAt:Date.now()});
    showToast('Goal updated! 🎯','success');
  } else {
    db.goals.push({id:uid(),name,emoji,target,saved,targetDate,notes,linkedAccountId,status:'active',contributions:[],createdAt:Date.now()});
    showToast('Goal created! 🎯 Start saving!','success');
  }
  saveDB();closeModal('modal-goal');editingGoalId=null;renderGoalsScreen();renderHome();
}
function deleteGoal(){
  showConfirm('Delete Goal?','This goal and all contributions will be removed.',()=>{
    db.goals=db.goals.filter(g=>g.id!==editingGoalId);
    saveDB();closeModal('modal-goal');editingGoalId=null;renderGoalsScreen();showToast('Goal deleted','error');
  });
}
let goalFundType='income'; // 'income' or 'transfer'
function setGoalFundType(type,btn){
  goalFundType=type;
  document.querySelectorAll('#goal-fund-type-grid .type-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('goal-funds-from-group').style.display=type==='transfer'?'':'none';
  const hints={income:'This will record a new income transaction to the goal account.',transfer:'This will transfer from another account to the goal account.'};
  document.getElementById('goal-fund-type-hint').textContent=hints[type];
}
function openAddFundsModal(goalId){
  const g=db.goals.find(g=>g.id===goalId);if(!g)return;
  addingFundsGoalId=goalId;
  goalFundType='income';
  const remaining=Math.max(0,g.target-g.saved);
  document.getElementById('goal-funds-info').innerHTML=`<strong>${g.emoji||'🎯'} ${g.name}</strong><br>Saved: ${fmt(g.saved)} / ${fmt(g.target)} · Still needed: <strong>${fmt(remaining)}</strong>${g.linkedAccountId?'<br>📍 Linked to: '+((db.accounts.find(a=>a.id===g.linkedAccountId)||{}).name||''):''}`;
  document.getElementById('goal-funds-amount').value='';
  document.getElementById('goal-funds-date').value=today();
  document.getElementById('goal-funds-balance-warn').style.display='none';
  // Populate accounts
  const linkedAccId=g.linkedAccountId;
  const destOpts=db.accounts.map(a=>`<option value="${a.id}"${a.id===linkedAccId?' selected':''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('goal-funds-account').innerHTML=destOpts;
  const srcOpts=db.accounts.filter(a=>!linkedAccId||a.id!==linkedAccId).map(a=>`<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('goal-funds-from-account').innerHTML=srcOpts;
  // Reset type buttons
  document.querySelectorAll('#goal-fund-type-grid .type-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('gft-income').classList.add('active');
  document.getElementById('goal-funds-from-group').style.display='none';
  document.getElementById('goal-fund-type-hint').textContent='This will record a new income transaction to the goal account.';
  openModal('modal-goal-funds');
}
function confirmAddFundsToGoal(){
  const g=db.goals.find(g=>g.id===addingFundsGoalId);if(!g)return;
  const amount=parseFloat(document.getElementById('goal-funds-amount').value)||0;
  const dateVal=document.getElementById('goal-funds-date').value||today();
  const destAccId=document.getElementById('goal-funds-account').value;
  const fromAccId=goalFundType==='transfer'?document.getElementById('goal-funds-from-account').value:'';
  if(amount<=0){showToast('Please enter a valid amount','error');return;}
  if(!destAccId){showToast('Please select a destination account','error');return;}
  if(goalFundType==='transfer'&&!fromAccId){showToast('Please select a source account','error');return;}
  const destAcc=db.accounts.find(a=>a.id===destAccId);
  const fromAcc=fromAccId?db.accounts.find(a=>a.id===fromAccId):null;
  // Check source balance for transfer
  if(goalFundType==='transfer'&&fromAcc&&fromAcc.balance<amount){
    document.getElementById('goal-funds-balance-warn').style.display='block';
    document.getElementById('goal-funds-balance-warn').textContent=`⚠️ ${fromAcc.name} only has ${fmt(fromAcc.balance)} — insufficient for this transfer.`;
    return;
  }
  const newSaved=g.saved+amount;
  const newPct=Math.min(100,(newSaved/g.target)*100);
  const txDesc=goalFundType==='income'?`Income to Goal: ${g.name}`:
    `Transfer for Goal: ${g.name} (from ${fromAcc?fromAcc.name:''})`;
  const confirmHtml=`<div class="card-sm" style="text-align:center;margin-bottom:14px">
    <div style="font-size:32px">${g.emoji||'🎯'}</div>
    <div style="font-size:16px;font-weight:700;margin:6px 0">${g.name}</div>
    <div style="font-family:var(--mono);font-size:22px;font-weight:700;color:var(--emerald)">+${fmt(amount)}</div>
  </div>
  <div style="display:grid;gap:8px">
    <div class="card-sm"><div style="font-size:10px;color:var(--text3)">TYPE</div><div>${goalFundType==='income'?'💰 Income':'🔄 Transfer'}</div></div>
    ${goalFundType==='transfer'&&fromAcc?`<div class="card-sm"><div style="font-size:10px;color:var(--text3)">FROM</div><div>${ACC_ICONS[fromAcc.type]} ${fromAcc.name} (${fmt(fromAcc.balance)})</div></div>`:''}
    <div class="card-sm"><div style="font-size:10px;color:var(--text3)">TO ACCOUNT</div><div>${destAcc?ACC_ICONS[destAcc.type]+' '+destAcc.name:'Unknown'}</div></div>
    <div class="card-sm"><div style="font-size:10px;color:var(--text3)">DATE</div><div>${dateVal}</div></div>
    <div class="card-sm"><div style="font-size:10px;color:var(--text3)">DESCRIPTION</div><div>${txDesc}</div></div>
    <div class="card-sm" style="background:var(--emerald-bg)"><div style="font-size:10px;color:var(--text3)">GOAL PROGRESS AFTER</div>
      <div style="font-family:var(--mono);font-size:13px;color:var(--emerald)">${fmt(g.saved)} → ${fmt(newSaved)} / ${fmt(g.target)} (${newPct.toFixed(1)}%)</div>
      <div style="background:var(--bg3);border-radius:99px;height:4px;margin-top:6px;overflow:hidden"><div style="width:${newPct.toFixed(1)}%;height:100%;border-radius:99px;background:var(--emerald)"></div></div>
    </div>
  </div>`;
  document.getElementById('goal-funds-confirm-detail').innerHTML=confirmHtml;
  // Store for execute
  document.getElementById('goal-funds-confirm-detail').dataset.amount=amount;
  document.getElementById('goal-funds-confirm-detail').dataset.date=dateVal;
  document.getElementById('goal-funds-confirm-detail').dataset.destAccId=destAccId;
  document.getElementById('goal-funds-confirm-detail').dataset.fromAccId=fromAccId||'';
  document.getElementById('goal-funds-confirm-detail').dataset.type=goalFundType;
  closeModal('modal-goal-funds');
  openModal('modal-goal-funds-confirm');
}
function executeAddFundsToGoal(){
  const g=db.goals.find(g=>g.id===addingFundsGoalId);if(!g)return;
  const det=document.getElementById('goal-funds-confirm-detail').dataset;
  const amount=parseFloat(det.amount)||0;
  const dateVal=det.date||today();
  const destAccId=det.destAccId;
  const fromAccId=det.fromAccId;
  const fundType=det.type;
  const destAcc=db.accounts.find(a=>a.id===destAccId);
  const fromAcc=fromAccId?db.accounts.find(a=>a.id===fromAccId):null;
  // Create transaction(s)
  if(fundType==='income'){
    // Income transaction to dest account
    const tx={id:uid(),type:'income',amount,category:'💰 Other Income',accountId:destAccId,date:dateVal,desc:`Goal: ${g.name}`,recurringId:null,goalId:g.id,createdAt:Date.now()};
    db.transactions.unshift(tx);
    if(destAcc)destAcc.balance+=amount;
  } else {
    // Transfer from source to dest
    if(fromAcc)fromAcc.balance-=amount;
    if(destAcc)destAcc.balance+=amount;
    const tx={id:uid(),type:'transfer',amount,category:'🔄 Transfer',accountId:fromAccId,toAccountId:destAccId,date:dateVal,desc:`Goal Transfer: ${g.name}`,goalId:g.id,createdAt:Date.now()};
    db.transactions.unshift(tx);
  }
  // Update goal savings
  g.saved+=amount;
  g.contributions=g.contributions||[];
  g.contributions.push({amount,date:dateVal,type:fundType,fromAccId,destAccId,note:`${fundType==='income'?'Income':'Transfer'}: ${fmt(amount)}`});
  const achieved=g.saved>=g.target;
  if(achieved&&g.status!=='achieved'){
    g.status='achieved';
    saveDB();closeModal('modal-goal-funds-confirm');addingFundsGoalId=null;
    renderGoalsScreen();renderHome();
    showToast(`🎉 Goal "${g.name}" achieved! Congratulations!`,'success');
    setTimeout(()=>launchConfetti(),300);
    return;
  }
  saveDB();closeModal('modal-goal-funds-confirm');addingFundsGoalId=null;
  showToast(`💰 ${fmt(amount)} saved to "${g.name}"! Goal ${((g.saved/g.target)*100).toFixed(0)}% complete.`,'success');
  renderGoalsScreen();renderHome();
}
function markGoalAchieved(id){
  const g=db.goals.find(g=>g.id===id);if(!g)return;
  g.status='achieved';saveDB();
  showToast(`🏆 "${g.name}" marked as achieved!`,'success');
  renderGoalsScreen();
  setTimeout(launchConfetti,200);
}
function launchConfetti(){
  const canvas=document.getElementById('confetti-canvas');if(!canvas)return;
  canvas.style.display='block';
  canvas.width=window.innerWidth;canvas.height=window.innerHeight;
  const ctx=canvas.getContext('2d');
  const pieces=[];
  const colors=['#7c83fd','#56c8a0','#f4a95a','#f06292','#4fc3f7','#aed581'];
  for(let i=0;i<120;i++){pieces.push({x:Math.random()*canvas.width,y:-20,w:8+Math.random()*8,h:8+Math.random()*8,color:colors[Math.floor(Math.random()*colors.length)],vy:3+Math.random()*5,vx:(Math.random()-0.5)*6,rot:Math.random()*360,rotV:(Math.random()-0.5)*10});}
  let frame=0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);ctx.restore();
      p.x+=p.vx;p.y+=p.vy;p.rot+=p.rotV;p.vy+=0.08;
    });
    frame++;
    if(frame<180)requestAnimationFrame(draw);
    else{ctx.clearRect(0,0,canvas.width,canvas.height);canvas.style.display='none';}
  }
  draw();
}

// ===== RECURRING TRANSACTIONS =====
const RECUR_FREQ_LABELS={daily:'Daily',weekly:'Weekly',monthly:'Monthly',semimonthly:'Semi-Monthly',yearly:'Yearly'};

function renderRecurringList(){
  const el=document.getElementById('goals-content');if(!el)return;
  if(!db.recurring.length){
    el.innerHTML=`<div class="empty"><div class="empty-icon">🔄</div><p>No recurring rules yet.<br>Tap ➕ to set up automatic transactions.</p></div>`;
    return;
  }
  el.innerHTML=db.recurring.map(r=>{
    const acc=db.accounts.find(a=>a.id===r.accountId);
    const isPaused=r.status==='paused';
    const amtSign=r.type==='income'?'+':'-';
    const todayStr=today();

    // Get upcoming occurrence info
    const schedule=generateRecurringSchedule(r);
    const nextDue=schedule.find(s=>s.status==='upcoming'||s.status==='current');
    const overdueSched=schedule.filter(s=>s.status==='missed');
    const appliedCount=schedule.filter(s=>s.status==='applied').length;

    let dueBadge='';
    if(isPaused){
      dueBadge=`<span class="recur-badge" style="background:rgba(90,98,130,0.15);color:var(--text3)">⏸ Paused</span>`;
    } else if(overdueSched.length>0){
      dueBadge=`<span class="recur-badge" style="background:var(--rose-bg);color:var(--rose)">⚠️ ${overdueSched.length} missed</span>`;
      // Also show next upcoming date alongside the missed badge
      if(nextDue){
        const daysUntil=Math.ceil((new Date(nextDue.date+'T00:00:00')-new Date())/(1000*60*60*24));
        if(daysUntil===0)dueBadge+=`<span class="recur-badge" style="background:var(--amber-bg);color:var(--amber)">📅 Due Today</span>`;
        else if(daysUntil<=3)dueBadge+=`<span class="recur-badge" style="background:var(--amber-bg);color:var(--amber)">⏰ In ${daysUntil}d</span>`;
        else dueBadge+=`<span class="recur-badge next">Next: ${fmtDate(nextDue.date)}</span>`;
      }
    } else if(nextDue){
      const daysUntil=Math.ceil((new Date(nextDue.date+'T00:00:00')-new Date())/(1000*60*60*24));
      if(daysUntil===0)dueBadge=`<span class="recur-badge" style="background:var(--amber-bg);color:var(--amber)">📅 Due Today</span>`;
      else if(daysUntil<=3)dueBadge=`<span class="recur-badge" style="background:var(--amber-bg);color:var(--amber)">⏰ In ${daysUntil}d</span>`;
      else dueBadge=`<span class="recur-badge next">Next: ${fmtDate(nextDue.date)}</span>`;
    } else if(r.endDate&&todayStr>r.endDate){
      dueBadge=`<span class="recur-badge" style="background:var(--emerald-bg);color:var(--emerald)">✅ Completed</span>`;
    }

    return`<div class="recur-card${isPaused?' paused':''}" onclick="openRecurringSchedule('${r.id}')">
      <div class="recur-hdr">
        <div class="recur-left">
          <div class="recur-icon ${r.type}" style="background:${r.type==='income'?'rgba(86,200,160,0.12)':'rgba(240,98,146,0.12)'}">${r.category.split(' ')[0]}</div>
          <div>
            <div class="recur-name">${r.name}</div>
            <div class="recur-cat">${r.category.replace(/^\S+\s/,'')}</div>
          </div>
        </div>
        <div class="recur-amount" style="color:${r.type==='income'?'var(--income)':'var(--expense)'}">${amtSign}${fmt(r.amount)}</div>
      </div>
      <div class="recur-meta">
        <span class="recur-badge ${r.type}">${r.type==='income'?'↑ Income':'↓ Expense'}</span>
        <span class="recur-badge freq">🔄 ${RECUR_FREQ_LABELS[r.frequency]}</span>
        ${dueBadge}
        ${acc?`<span style="font-size:10px;color:var(--text3)">${ACC_ICONS[acc.type]} ${acc.name}</span>`:''}
        ${appliedCount>0?`<span style="font-size:10px;color:var(--text3)">${appliedCount} applied</span>`:''}
      </div>
      <div class="recur-actions" onclick="event.stopPropagation()">
        <button class="recur-btn apply" onclick="openRecurPay('${r.id}')">${r.type==='income'?'✅ Received':'💰 Pay Now'}</button>
        <button class="recur-btn sched" onclick="openRecurringSchedule('${r.id}')">📊 Schedule</button>
        <button class="recur-btn pause" onclick="toggleRecurPause('${r.id}')">${isPaused?'▶ Resume':'⏸ Pause'}</button>
        <button class="recur-btn del" onclick="deleteRecurring('${r.id}')">🗑</button>
      </div>
    </div>`;
  }).join('');
}
function getNextRecurDate(r){
  const now=new Date();
  const start=new Date(r.startDate+'T00:00:00');
  if(r.endDate&&today()>r.endDate)return null;
  if(r.frequency==='daily'){const d=new Date(Math.max(now,start));d.setDate(d.getDate()+1);return d.toISOString().split('T')[0];}
  if(r.frequency==='weekly'){const d=new Date(Math.max(now,start));d.setDate(d.getDate()+7);return d.toISOString().split('T')[0];}
  if(r.frequency==='monthly'){const d=new Date(now.getFullYear(),now.getMonth()+1,start.getDate());return d.toISOString().split('T')[0];}
  if(r.frequency==='semimonthly'){
    const d1=r.semiDay1||15,d2=r.semiDay2||30;
    const todayStr=today();
    // Find next cutoff date after today in this or next month
    for(let mo=0;mo<3;mo++){
      const y=now.getFullYear(),m=now.getMonth()+mo;
      const yr=y+Math.floor(m/12),mt=m%12;
      for(const d of [d1,d2].sort((a,b)=>a-b)){
        const lastDay=new Date(yr,mt+1,0).getDate();
        const actualD=Math.min(d,lastDay);
        const ds=yr+'-'+String(mt+1).padStart(2,'0')+'-'+String(actualD).padStart(2,'0');
        if(ds>todayStr)return ds;
      }
    }
    return null;
  }
  if(r.frequency==='yearly'){return`${now.getFullYear()+1}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;}
  return null;
}
function setRecurType(type,btn){
  currentRecurType=type;
  document.querySelectorAll('#modal-recur .type-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const cats=type==='expense'?EXPENSE_CATS:INCOME_CATS;
  document.getElementById('recur-category').innerHTML=cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}
function openAddRecurring(){
  editingRecurId=null;
  currentRecurType='expense';
  document.getElementById('modal-recur-title').textContent='New Recurring Transaction';
  document.getElementById('recur-save-btn').textContent='Save Rule';
  document.getElementById('recur-delete-btn').style.display='none';
  document.getElementById('recur-name').value='';
  document.getElementById('recur-amount').value='';
  document.getElementById('recur-freq').value='monthly';
  document.getElementById('recur-start').value=today();
  document.getElementById('recur-end').value='';
  document.getElementById('recur-due-day').value='';
  document.getElementById('recur-semi-day1').value='15';
  document.getElementById('recur-semi-day2').value='30';
  onRecurFreqChange();
  const cats=EXPENSE_CATS;
  document.getElementById('recur-category').innerHTML=cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  document.querySelector('#modal-recur .type-tab.expense').classList.add('active');
  document.querySelector('#modal-recur .type-tab.income').classList.remove('active');
  const accOpts=db.accounts.map(a=>`<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name}</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('recur-account').innerHTML=accOpts;
  dismissFormVAI('recurring');
  const vInp=document.getElementById('recurring-vai-input');if(vInp)vInp.value='';
  openModal('modal-recur');
}
function openEditRecurring(id){
  const r=db.recurring.find(r=>r.id===id);if(!r)return;
  editingRecurId=id;
  currentRecurType=r.type;
  document.getElementById('modal-recur-title').textContent='Edit Recurring Rule';
  document.getElementById('recur-save-btn').textContent='Update Rule';
  document.getElementById('recur-delete-btn').style.display='';
  document.getElementById('recur-name').value=r.name;
  document.getElementById('recur-amount').value=r.amount;
  document.getElementById('recur-freq').value=r.frequency;
  document.getElementById('recur-start').value=r.startDate;
  document.getElementById('recur-end').value=r.endDate||'';
  document.getElementById('recur-due-day').value=r.dueDay||'';
  document.getElementById('recur-semi-day1').value=r.semiDay1||15;
  document.getElementById('recur-semi-day2').value=r.semiDay2||30;
  onRecurFreqChange();
  const cats=r.type==='expense'?EXPENSE_CATS:INCOME_CATS;
  document.getElementById('recur-category').innerHTML=cats.map(c=>`<option value="${c}"${c===r.category?' selected':''}>${c}</option>`).join('');
  document.querySelectorAll('#modal-recur .type-tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`#modal-recur .type-tab.${r.type}`).classList.add('active');
  const accOpts=db.accounts.map(a=>`<option value="${a.id}"${a.id===r.accountId?' selected':''}>${ACC_ICONS[a.type]} ${a.name}</option>`).join('')||'<option value="">No accounts</option>';
  document.getElementById('recur-account').innerHTML=accOpts;
  openModal('modal-recur');
}
function onRecurFreqChange(){
  const freq=document.getElementById('recur-freq').value;
  const semiGrp=document.getElementById('recur-semimonthly-group');
  const dueDayGrp=document.getElementById('recur-due-day-group');
  if(semiGrp)semiGrp.style.display=freq==='semimonthly'?'':'none';
  if(dueDayGrp)dueDayGrp.style.display=(freq==='monthly')?'':'none';
}

function saveRecurring(){
  const name=document.getElementById('recur-name').value.trim();
  const amount=parseFloat(document.getElementById('recur-amount').value)||0;
  const category=document.getElementById('recur-category').value;
  const accountId=document.getElementById('recur-account').value;
  const frequency=document.getElementById('recur-freq').value;
  const startDate=document.getElementById('recur-start').value;
  const endDate=document.getElementById('recur-end').value||null;
  const dueDay=parseInt(document.getElementById('recur-due-day').value)||null;
  // Semi-monthly: two cutoff days
  let semiDay1=null,semiDay2=null;
  if(frequency==='semimonthly'){
    semiDay1=Math.max(1,Math.min(31,parseInt(document.getElementById('recur-semi-day1').value)||15));
    semiDay2=Math.max(1,Math.min(31,parseInt(document.getElementById('recur-semi-day2').value)||30));
    if(semiDay1===semiDay2){showToast('The two cutoff days must be different','error');return;}
    if(semiDay1>semiDay2){const tmp=semiDay1;semiDay1=semiDay2;semiDay2=tmp;} // ensure day1<day2
  }
  if(!name){showToast('Please enter a name','error');return;}
  if(amount<=0){showToast('Please enter a valid amount','error');return;}
  if(!startDate){showToast('Please set a start date','error');return;}
  if(editingRecurId){
    const r=db.recurring.find(r=>r.id===editingRecurId);
    if(r)Object.assign(r,{name,amount,category,accountId,frequency,startDate,endDate,dueDay,semiDay1,semiDay2,type:currentRecurType});
    showToast('Recurring rule updated! 🔄','success');
  } else {
    db.recurring.push({id:uid(),name,amount,category,accountId,frequency,startDate,endDate,dueDay,semiDay1,semiDay2,type:currentRecurType,status:'active',lastApplied:null,createdAt:Date.now()});
    showToast('Recurring rule saved! 🔄','success');
  }
  saveDB();closeModal('modal-recur');editingRecurId=null;renderGoalsScreen();renderCashFlow();
}
function deleteRecurring(id){
  const rid=id||editingRecurId;if(!rid)return;
  showConfirm('Delete Rule?','Future transactions will not be auto-created. Existing transactions are unaffected.',()=>{
    db.recurring=db.recurring.filter(r=>r.id!==rid);
    saveDB();closeModal('modal-recur');editingRecurId=null;renderGoalsScreen();showToast('Rule deleted','error');
  });
}
function toggleRecurPause(id){
  const r=db.recurring.find(r=>r.id===id);if(!r)return;
  r.status=r.status==='paused'?'active':'paused';
  saveDB();renderGoalsScreen();updateRecurringBadge();
  showToast(r.status==='paused'?'Recurring paused ⏸':'Recurring resumed ▶','success');
}
// ─── RECURRING PAY NOW / RECEIVED ────────────────────────────────────────────

function openRecurPay(id) {
  const r = db.recurring.find(r => r.id === id); if (!r) return;
  payingRecurId = id;
  const isIncome = r.type === 'income';
  const amtColor = isIncome ? 'var(--income)' : 'var(--expense)';
  const amtSign  = isIncome ? '+' : '-';

  if (isIncome) {
    // ── INCOME: "Mark as Received" modal ───────────────────────────────────
    document.getElementById('recur-receive-title').textContent = '✅ Received: ' + r.name;
    document.getElementById('recur-receive-detail').innerHTML = `
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center">
        <div style="font-size:12px;color:var(--text3)">${r.category.replace(/^\S+\s/,'')}</div>
        <div style="font-family:var(--mono);font-size:20px;font-weight:700;color:${amtColor};margin:4px 0">${amtSign}${fmt(r.amount)}</div>
        <div style="font-size:11px;color:var(--text3)">${RECUR_FREQ_LABELS[r.frequency]}</div>
      </div>`;

    // Build unpaid occurrence chips
    const schedule = generateRecurringSchedule(r);
    const pending = schedule.filter(s => s.status === 'missed' || s.status === 'current' || s.status === 'upcoming').slice(0, 12);
    const occEl = document.getElementById('recur-receive-occurrences');
    if (pending.length) {
      occEl.innerHTML = pending.map((s, i) => {
        const isFirst = i === 0;
        const chipColor = s.status === 'missed' ? 'var(--rose)' : s.status === 'current' ? 'var(--amber)' : 'var(--blue)';
        return `<label style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;background:var(--bg3);border:1.5px solid ${isFirst ? chipColor : 'var(--border)'};cursor:pointer;transition:border 0.15s" id="recur-recv-chip-${i}">
          <input type="radio" name="recur-recv-occ" value="${s.date}" ${isFirst ? 'checked' : ''} onchange="highlightRecurRecvChip()" style="accent-color:${chipColor}">
          <div style="flex:1">
            <div style="font-size:12px;font-weight:700">${fmtDate(s.date)}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:1px">${s.status === 'missed' ? '⚠️ Missed' : s.status === 'current' ? '📅 Today' : '⏳ Upcoming'}</div>
          </div>
          <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:${amtColor}">${amtSign}${fmt(r.amount)}</div>
        </label>`;
      }).join('');
    } else {
      occEl.innerHTML = `<div style="font-size:12px;color:var(--text3);padding:10px;text-align:center">No pending occurrences — all up to date! ✅</div>`;
    }

    document.getElementById('recur-receive-amount').value = r.amount;
    document.getElementById('recur-receive-date').value = today();
    document.getElementById('recur-receive-ref').value = '';
    const accOpts = db.accounts.map(a => `<option value="${a.id}"${a.id === r.accountId ? ' selected' : ''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('') || '<option value="">No accounts</option>';
    document.getElementById('recur-receive-account').innerHTML = accOpts;
    openModal('modal-recur-receive');

  } else {
    // ── EXPENSE: "Pay Now" modal ───────────────────────────────────────────
    document.getElementById('recur-pay-title').textContent = '💰 Pay: ' + r.name;
    document.getElementById('recur-pay-detail').innerHTML = `
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center">
        <div style="font-size:12px;color:var(--text3)">${r.category.replace(/^\S+\s/,'')}</div>
        <div style="font-family:var(--mono);font-size:20px;font-weight:700;color:${amtColor};margin:4px 0">${amtSign}${fmt(r.amount)}</div>
        <div style="font-size:11px;color:var(--text3)">${RECUR_FREQ_LABELS[r.frequency]}</div>
      </div>`;

    // Build unpaid occurrence checkboxes (allow multi-select for catch-up)
    const schedule = generateRecurringSchedule(r);
    const pending = schedule.filter(s => s.status === 'missed' || s.status === 'current' || s.status === 'upcoming').slice(0, 12);
    const occEl = document.getElementById('recur-pay-occurrences');
    if (pending.length) {
      occEl.innerHTML = pending.map((s, i) => {
        const isFirst = i === 0;
        const chipColor = s.status === 'missed' ? 'var(--rose)' : s.status === 'current' ? 'var(--amber)' : 'var(--blue)';
        return `<label style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;background:var(--bg3);border:1.5px solid ${isFirst ? chipColor : 'var(--border)'};cursor:pointer;transition:border 0.15s" id="recur-pay-chip-${i}">
          <input type="checkbox" name="recur-pay-occ" value="${s.date}" ${isFirst ? 'checked' : ''} onchange="updateRecurPayAmount()" style="accent-color:${chipColor};width:16px;height:16px">
          <div style="flex:1">
            <div style="font-size:12px;font-weight:700">${fmtDate(s.date)}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:1px">${s.status === 'missed' ? '⚠️ Missed' : s.status === 'current' ? '📅 Due Today' : '⏳ Upcoming'}</div>
          </div>
          <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:${amtColor}">${amtSign}${fmt(r.amount)}</div>
        </label>`;
      }).join('');
    } else {
      occEl.innerHTML = `<div style="font-size:12px;color:var(--text3);padding:10px;text-align:center">No pending occurrences — all up to date! ✅</div>`;
    }

    // Update selection note
    updateRecurPayAmount();

    document.getElementById('recur-pay-date').value = today();
    document.getElementById('recur-pay-ref').value = '';
    document.getElementById('recur-pay-tx-fee').value = '';
    document.getElementById('recur-pay-late-fee').value = '';
    document.getElementById('recur-pay-balance-warning').style.display = 'none';
    const accOpts = db.accounts.map(a => `<option value="${a.id}"${a.id === r.accountId ? ' selected' : ''}>${ACC_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('') || '<option value="">No accounts</option>';
    document.getElementById('recur-pay-account').innerHTML = accOpts;
    openModal('modal-recur-pay');
  }
}

function updateRecurPayAmount() {
  const r = db.recurring.find(r => r.id === payingRecurId); if (!r) return;
  const checked = [...document.querySelectorAll('#recur-pay-occurrences input[type=checkbox]:checked')];
  const count = checked.length;
  const total = r.amount * count;
  document.getElementById('recur-pay-amount').value = total > 0 ? total.toFixed(2) : '';

  // Color chips based on checked state
  document.querySelectorAll('#recur-pay-occurrences label').forEach((lbl, i) => {
    const cb = lbl.querySelector('input[type=checkbox]');
    lbl.style.borderColor = cb.checked ? 'var(--accent)' : 'var(--border)';
  });

  const noteEl = document.getElementById('recur-pay-selection-note');
  if (count > 1) {
    noteEl.style.display = 'block';
    noteEl.innerHTML = `📅 Paying <strong>${count} occurrences</strong> — total <strong>${fmt(total)}</strong>`;
  } else if (count === 0) {
    noteEl.style.display = 'block';
    noteEl.innerHTML = `<span style="color:var(--rose)">⚠️ Select at least one occurrence to pay.</span>`;
  } else {
    noteEl.style.display = 'none';
  }
  checkRecurPayWarning();
}

function highlightRecurRecvChip() {
  document.querySelectorAll('#recur-receive-occurrences label').forEach((lbl) => {
    const rb = lbl.querySelector('input[type=radio]');
    lbl.style.borderColor = rb.checked ? 'var(--accent)' : 'var(--border)';
  });
}

function checkRecurPayWarning() {
  const r = db.recurring.find(r => r.id === payingRecurId); if (!r) return;
  const amount = parseFloat(document.getElementById('recur-pay-amount').value) || 0;
  const txFee  = parseFloat(document.getElementById('recur-pay-tx-fee').value)  || 0;
  const lateFee= parseFloat(document.getElementById('recur-pay-late-fee').value) || 0;
  const totalOut = amount + txFee + lateFee;
  const accId = document.getElementById('recur-pay-account').value;
  const acc = db.accounts.find(a => a.id === accId);
  const wEl = document.getElementById('recur-pay-balance-warning');
  if (acc && totalOut > acc.balance) {
    wEl.style.display = 'block';
    const parts = [];
    if(amount>0) parts.push(`payment ${fmt(amount)}`);
    if(txFee>0)  parts.push(`tx fee ${fmt(txFee)}`);
    if(lateFee>0)parts.push(`late fee ${fmt(lateFee)}`);
    wEl.textContent = `⚠️ Insufficient balance! ${acc.name} has ${fmt(acc.balance)} but total (${parts.join(' + ')}) = ${fmt(totalOut)}.`;
  } else {
    wEl.style.display = 'none';
  }
}

function executeRecurPay() {
  const r = db.recurring.find(r => r.id === payingRecurId); if (!r) return;
  const checked = [...document.querySelectorAll('#recur-pay-occurrences input[type=checkbox]:checked')];
  if (checked.length === 0) { showToast('Please select at least one occurrence to pay.', 'error'); return; }
  const amount   = parseFloat(document.getElementById('recur-pay-amount').value) || 0;
  const accId    = document.getElementById('recur-pay-account').value;
  const payDate  = document.getElementById('recur-pay-date').value || today();
  const txFee    = parseFloat(document.getElementById('recur-pay-tx-fee').value) || 0;
  const lateFee  = parseFloat(document.getElementById('recur-pay-late-fee').value) || 0;
  const ref      = document.getElementById('recur-pay-ref').value.trim();
  const totalOut = amount + txFee + lateFee;

  if (amount <= 0) { showToast('Please enter a valid payment amount.', 'error'); return; }
  const acc = db.accounts.find(a => a.id === accId);
  if (acc && totalOut > acc.balance) {
    showToast(`❌ Insufficient balance! Need ${fmt(totalOut)} but ${acc.name} has only ${fmt(acc.balance)}.`, 'error'); return;
  }
  // Savings reserve warning
  if (acc) {
    const reserve = acc.savingsReserve || 0;
    if (reserve > 0 && (acc.balance - totalOut) < reserve) {
      showToast(`⚠️ This will dip below your savings reserve of ${fmt(reserve)} in ${acc.name}.`, 'warn');
    }
  }

  const occDates = checked.map(cb => cb.value);
  const occCount = occDates.length;
  const perOcc   = amount / occCount;

  // Create one transaction per occurrence so schedule correctly marks each as applied
  occDates.forEach((dateStr, i) => {
    const txDesc = occCount > 1
      ? `Payment: ${r.name} (${i+1}/${occCount}) — ${fmtDate(dateStr)}`
      : `Payment: ${r.name}`;
    const tx = { id: uid(), type: 'expense', amount: perOcc, category: r.category, accountId: accId, date: payDate, ref, desc: txDesc, recurringId: r.id, recurringDate: dateStr, createdAt: Date.now() };
    db.transactions.unshift(tx);
    applyTransaction(tx);
  });

  // Transaction fee — single record
  if (txFee > 0) {
    if (acc) acc.balance -= txFee;
    db.transactions.unshift({ id: uid(), type: 'expense', amount: txFee, category: '💳 Fees', accountId: accId, date: payDate, ref, desc: `Transaction Fee: ${r.name}`, recurringId: r.id, createdAt: Date.now() });
  }
  // Late fee — single record
  if (lateFee > 0) {
    if (acc) acc.balance -= lateFee;
    db.transactions.unshift({ id: uid(), type: 'expense', amount: lateFee, category: '💳 Fees', accountId: accId, date: payDate, ref, desc: `Late Fee: ${r.name}`, recurringId: r.id, createdAt: Date.now() });
  }

  r.lastApplied = payDate;
  addLog('created', `Recurring paid: ${r.name} ${fmt(amount)} × ${occCount}`, r.id, 'recurring');

  saveDB();
  closeModal('modal-recur-pay');
  payingRecurId = null;
  const msg = occCount > 1
    ? `✅ ${r.name}: ${occCount} occurrences paid (${fmt(amount)})!`
    : `✅ ${r.name}: ${fmt(amount)} paid!`;
  showToast(msg, 'success');
  renderHome(); renderTransactions(); renderGoalsScreen(); renderCashFlow();
}

function executeRecurReceive() {
  const r = db.recurring.find(r => r.id === payingRecurId); if (!r) return;
  const selectedOcc = document.querySelector('#recur-receive-occurrences input[type=radio]:checked');
  if (!selectedOcc) { showToast('Please select which occurrence was received.', 'error'); return; }
  const occDate  = selectedOcc.value;
  const amount   = parseFloat(document.getElementById('recur-receive-amount').value) || 0;
  const accId    = document.getElementById('recur-receive-account').value;
  const recvDate = document.getElementById('recur-receive-date').value || today();
  const ref      = document.getElementById('recur-receive-ref').value.trim();

  if (amount <= 0) { showToast('Please enter a valid amount.', 'error'); return; }
  if (!accId)      { showToast('Please select an account.', 'error'); return; }

  const txDesc = `Received: ${r.name} — ${fmtDate(occDate)}`;
  const tx = { id: uid(), type: 'income', amount, category: r.category, accountId: accId, date: recvDate, ref, desc: txDesc, recurringId: r.id, recurringDate: occDate, createdAt: Date.now() };
  db.transactions.unshift(tx);
  applyTransaction(tx);
  r.lastApplied = recvDate;
  addLog('created', `Recurring received: ${r.name} ${fmt(amount)}`, r.id, 'recurring');

  saveDB();
  closeModal('modal-recur-receive');
  payingRecurId = null;
  showToast(`✅ ${r.name}: ${fmt(amount)} marked as received!`, 'success');
  renderHome(); renderTransactions(); renderGoalsScreen(); renderCashFlow();
}

function applyRecurringNow(id, txFee=0){
  // Legacy auto-apply (called by applyDueRecurring / autoApplyRecur only — not user-facing)
  const r=db.recurring.find(r=>r.id===id);if(!r||r.status==='paused')return;
  openRecurPay(id);
}
function applyDueRecurring(){
  // Called on app load — auto-apply any overdue recurring rules
  const t=today();
  db.recurring.filter(r=>r.status==='active').forEach(r=>{
    if(r.endDate&&t>r.endDate)return;
    if(!r.lastApplied&&t>=r.startDate){autoApplyRecur(r,t);return;}
    if(!r.lastApplied)return;
    const la=new Date(r.lastApplied+'T00:00:00');
    const now=new Date(t+'T00:00:00');
    let due=false;
    if(r.frequency==='daily')due=now>la;
    else if(r.frequency==='weekly')due=(now-la)/(1000*60*60*24)>=7;
    else if(r.frequency==='monthly'){due=now.getMonth()!==la.getMonth()||now.getFullYear()!==la.getFullYear();}
    else if(r.frequency==='semimonthly'){
      // Due if today is one of the cutoff days and hasn't been applied this cutoff period
      const d1=r.semiDay1||15,d2=r.semiDay2||30;
      const todayDate=now.getDate();
      const lastMonth=la.getMonth(),lastDay=la.getDate(),lastYear=la.getFullYear();
      const isDay1=todayDate===Math.min(d1,new Date(now.getFullYear(),now.getMonth()+1,0).getDate());
      const isDay2=todayDate===Math.min(d2,new Date(now.getFullYear(),now.getMonth()+1,0).getDate());
      if(isDay1||isDay2){
        // Only apply if lastApplied was before this cutoff date
        const lastAppliedMonthSame=lastMonth===now.getMonth()&&lastYear===now.getFullYear();
        if(!lastAppliedMonthSame)due=true;
        else if(isDay2&&lastDay<d2)due=true; // applied at day1, now at day2
      }
    }
    else if(r.frequency==='yearly')due=now.getFullYear()!==la.getFullYear();
    if(due)autoApplyRecur(r,t);
  });
}
function autoApplyRecur(r,dateStr){
  const alreadyApplied=db.transactions.some(tx=>tx.recurringId===r.id&&tx.date===dateStr);
  if(alreadyApplied)return;
  const acc=db.accounts.find(a=>a.id===r.accountId);
  if(r.type==='expense'&&acc&&acc.balance<r.amount)return; // skip if insufficient balance
  const tx={id:uid(),type:r.type,amount:r.amount,category:r.category,accountId:r.accountId,date:dateStr,desc:r.name+' (auto)',recurringId:r.id,createdAt:Date.now()};
  db.transactions.unshift(tx);applyTransaction(tx);
  r.lastApplied=dateStr;
  addLog('created',`Auto-applied recurring: ${r.name} ${fmt(r.amount)}`,tx.id);
}

// ===== ADVANCED EXPORT =====
function openExportModal(){
  const el=document.getElementById('export-preview');
  if(el)updateExportPreview();
  openModal('modal-export');
}
function updateExportPreview(){
  const period=document.getElementById('export-period')?.value||'month';
  const type=document.getElementById('export-type')?.value||'all';
  const txs=getExportTxs(period,type);
  const income=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const el=document.getElementById('export-preview');
  if(el)el.innerHTML=`<strong>${txs.length} transactions</strong> · Income: ${fmt(income)} · Expenses: ${fmt(expense)} · Net: ${fmt(income-expense)}`;
}
function getExportTxs(period,type){
  const now=new Date();
  let start,end;
  if(period==='month'){start=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];end=localMonthEnd(now.getFullYear(),now.getMonth());}
  else if(period==='lastmonth'){start=localDate(new Date(now.getFullYear(),now.getMonth()-1,1));end=localDate(new Date(now.getFullYear(),now.getMonth(),0));}
  else if(period==='year'){start=`${now.getFullYear()}-01-01`;end=`${now.getFullYear()}-12-31`;}
  else{start='1970-01-01';end='2099-12-31';}
  let txs=db.transactions.filter(t=>t.date>=start&&t.date<=end);
  if(type!=='all')txs=txs.filter(t=>t.type===type);
  return txs.sort((a,b)=>a.date.localeCompare(b.date));
}
function doExport(format){
  const period=document.getElementById('export-period')?.value||'month';
  const type=document.getElementById('export-type')?.value||'all';
  const txs=getExportTxs(period,type);
  if(!txs.length){showToast('No transactions found for selected filters','warn');return;}
  const periodLabel={'month':'This Month','lastmonth':'Last Month','year':'This Year','all':'All Time'}[period]||period;
  if(format==='csv')exportCSV(txs,periodLabel);
  else if(format==='xlsx')exportXLSX(txs,periodLabel);
  else if(format==='pdf')exportPDF(txs,periodLabel);
  showToast(`Exported as ${format.toUpperCase()}! 📤`,'success');
  closeModal('modal-export');
}
function exportCSV(txs,label){
  const cur=getCurrency();
  const rows=[['Date','Type','Category','Amount','Account','Description','Reference']];
  txs.forEach(tx=>{
    const acc=db.accounts.find(a=>a.id===tx.accountId);
    rows.push([tx.date,tx.type,tx.category,tx.amount,acc?acc.name:'',tx.desc||'',tx.ref||'']);
  });
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadBlob(new Blob([csv],{type:'text/csv'}),`FinFlow-${label.replace(/\s/g,'-')}-${today()}.csv`);
}
function exportXLSX(txs,label){
  if(!window.XLSX){showToast('XLSX library not loaded','error');return;}
  const cur=getCurrency();
  const income=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  // Build rows
  const rows=[['FinFlow Export — '+label],[''],[`Period: ${label}`,`Exported: ${today()}`],[''],[`Total Income: ${cur}${income.toFixed(2)}`,`Total Expenses: ${cur}${expense.toFixed(2)}`,`Net: ${cur}${(income-expense).toFixed(2)}`],[''],[`Date`,`Type`,`Category`,`Amount (${cur})`,`Account`,`Description`,`Reference`]];
  txs.forEach(tx=>{
    const acc=db.accounts.find(a=>a.id===tx.accountId);
    rows.push([tx.date,tx.type,tx.category,tx.type==='expense'?-tx.amount:tx.amount,acc?acc.name:'',tx.desc||'',tx.ref||'']);
  });
  const wb=window.XLSX.utils.book_new();
  const ws=window.XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:12},{wch:10},{wch:20},{wch:14},{wch:18},{wch:28},{wch:16}];
  window.XLSX.utils.book_append_sheet(wb,ws,'Transactions');
  window.XLSX.writeFile(wb,`FinFlow-${label.replace(/\s/g,'-')}-${today()}.xlsx`);
}
function exportPDF(txs,label){
  const cur=getCurrency();
  const income=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const net=income-expense;
  // Category breakdown
  const catMap={};txs.filter(t=>t.type==='expense').forEach(t=>{catMap[t.category]=(catMap[t.category]||0)+t.amount;});
  const catList=Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
  // Build HTML PDF
  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>FinFlow Report — ${label}</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;margin:0;padding:24px;color:#1e243a;background:#fff;font-size:13px;}
    .header{background:linear-gradient(135deg,#4f5fcc,#2d3aa8);color:#fff;border-radius:12px;padding:20px 24px;margin-bottom:20px;}
    .header h1{margin:0 0 4px;font-size:22px;font-weight:800;}
    .header p{margin:0;opacity:0.7;font-size:12px;}
    .stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px;}
    .stat{background:#f2f4fb;border-radius:10px;padding:14px;text-align:center;}
    .stat-val{font-size:18px;font-weight:700;font-family:monospace;}
    .stat-lbl{font-size:11px;color:#5a6285;margin-top:4px;}
    .inc{color:#1e9d6e;} .exp{color:#d63b6a;} .net{color:${net>=0?'#1e9d6e':'#d63b6a'};}
    table{width:100%;border-collapse:collapse;margin-bottom:20px;}
    th{background:#e8ecf8;padding:8px 10px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
    td{padding:8px 10px;border-bottom:1px solid #e8ecf8;font-size:12px;}
    tr:nth-child(even) td{background:#f8f9fe;}
    .pill{display:inline-block;padding:2px 7px;border-radius:99px;font-size:10px;font-weight:700;}
    .pill.income{background:#d4f5e9;color:#1e7d52;}.pill.expense{background:#fde0ea;color:#b0264e;}.pill.transfer{background:#e0e2ff;color:#3a44c4;}
    .cat-section{margin-bottom:20px;}
    .cat-section h3{font-size:14px;font-weight:700;margin-bottom:10px;color:#1e243a;}
    .cat-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
    .cat-bar-name{width:160px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cat-bar-bg{flex:1;background:#e8ecf8;border-radius:4px;height:8px;}
    .cat-bar-fill{height:100%;border-radius:4px;background:#4f5fcc;}
    .cat-amount{min-width:80px;text-align:right;font-family:monospace;font-size:12px;}
    .footer{margin-top:20px;padding-top:14px;border-top:1px solid #e8ecf8;font-size:11px;color:#9098be;text-align:center;}
  </style></head><body>
  <div class="header">
    <h1>💸 FinFlow — ${label}</h1>
    <p>Exported on ${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p>
  </div>
  <div class="stats-row">
    <div class="stat"><div class="stat-val inc">${cur}${income.toFixed(2)}</div><div class="stat-lbl">Total Income</div></div>
    <div class="stat"><div class="stat-val exp">${cur}${expense.toFixed(2)}</div><div class="stat-lbl">Total Expenses</div></div>
    <div class="stat"><div class="stat-val net">${cur}${net.toFixed(2)}</div><div class="stat-lbl">Net ${net>=0?'Savings':'Deficit'}</div></div>
  </div>
  ${catList.length?`<div class="cat-section"><h3>Top Expense Categories</h3>${catList.map(([cat,amt])=>{const pct=(amt/expense*100).toFixed(0);return`<div class="cat-bar-row"><div class="cat-bar-name">${cat}</div><div class="cat-bar-bg"><div class="cat-bar-fill" style="width:${pct}%"></div></div><div class="cat-amount">${cur}${amt.toFixed(2)}</div></div>`;}).join('')}</div>`:''}
  <table>
    <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Account</th><th>Description</th></tr></thead>
    <tbody>${txs.map(tx=>{const acc=db.accounts.find(a=>a.id===tx.accountId);const sign=tx.type==='expense'?'-':tx.type==='income'?'+':'';return`<tr><td>${tx.date}</td><td><span class="pill ${tx.type}">${tx.type}</span></td><td>${tx.category}</td><td style="font-family:monospace;font-weight:700;color:${tx.type==='income'?'#1e9d6e':tx.type==='expense'?'#d63b6a':'#3a44c4'}">${sign}${cur}${tx.amount.toFixed(2)}</td><td>${acc?acc.name:''}</td><td>${tx.desc||''}</td></tr>`;}).join('')}</tbody>
  </table>
  <div class="footer">Generated by FinFlow · ${txs.length} transactions · All data is private and stored on your device</div>
  </body></html>`;
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`FinFlow-${label.replace(/\s/g,'-')}-${today()}.html`;
  a.click();URL.revokeObjectURL(url);
}
function downloadBlob(blob,filename){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
}

function doFullExport(format){
  if(format==='xlsx'){exportFullXLSX();}
  else if(format==='csv'){exportAllCSV();}
  closeModal('modal-export');
}

function exportFullXLSX(){
  if(!window.XLSX){showToast('XLSX library not loaded','error');return;}
  const cur=getCurrency();
  const wb=window.XLSX.utils.book_new();
  const dateStr=today();

  // 1. Transactions sheet
  const txRows=[['Date','Type','Category','Amount','Account','Description','Reference']];
  db.transactions.forEach(tx=>{
    const acc=db.accounts.find(a=>a.id===tx.accountId);
    txRows.push([tx.date,tx.type,tx.category,tx.type==='expense'?-tx.amount:tx.amount,acc?acc.name:'',tx.desc||'',tx.ref||'']);
  });
  const wsTx=window.XLSX.utils.aoa_to_sheet(txRows);
  wsTx['!cols']=[{wch:12},{wch:10},{wch:20},{wch:14},{wch:18},{wch:28},{wch:16}];
  window.XLSX.utils.book_append_sheet(wb,wsTx,'Transactions');

  // 2. Accounts sheet
  const accRows=[['Account Name','Type','Balance','Account No.','Holder','Opening Balance']];
  db.accounts.forEach(a=>{
    accRows.push([a.name,a.type,a.balance,a.accountNumber||'',a.holderName||'',a.openingBalance||0]);
  });
  const wsAcc=window.XLSX.utils.aoa_to_sheet(accRows);
  wsAcc['!cols']=[{wch:22},{wch:12},{wch:14},{wch:18},{wch:20},{wch:16}];
  window.XLSX.utils.book_append_sheet(wb,wsAcc,'Accounts');

  // 3. Payables sheet
  const pyRows=[['Name','Type','Total Amount','Paid','Remaining','Monthly Payment','Interest %','Due Day','Status','Notes']];
  db.payables.forEach(p=>{
    pyRows.push([p.name,PAYABLE_TYPES[p.type],p.totalAmount,p.paidAmount||0,p.remaining||0,p.monthlyPayment||0,p.interestRate||0,p.dueDay||'',p.status,p.notes||'']);
  });
  const wsPy=window.XLSX.utils.aoa_to_sheet(pyRows);
  wsPy['!cols']=[{wch:22},{wch:22},{wch:14},{wch:12},{wch:12},{wch:16},{wch:12},{wch:8},{wch:10},{wch:20}];
  window.XLSX.utils.book_append_sheet(wb,wsPy,'Payables');

  // 4. Payable Payments sheet
  const ppRows=[['Payable Name','Amount','Date','Account','Reference']];
  db.payables.forEach(p=>{(p.payments||[]).forEach(pay=>{const acc=db.accounts.find(a=>a.id===pay.accountId);ppRows.push([p.name,pay.amount,pay.date,acc?acc.name:'',pay.ref||'']);});});
  const wsPP=window.XLSX.utils.aoa_to_sheet(ppRows);
  wsPP['!cols']=[{wch:22},{wch:12},{wch:12},{wch:18},{wch:16}];
  window.XLSX.utils.book_append_sheet(wb,wsPP,'Payable Payments');

  // 5. Goals sheet
  const goalRows=[['Name','Target','Saved','Remaining','Progress %','Target Date','Status','Notes']];
  db.goals.forEach(g=>{
    const saved=g.savedAmount||0;
    const pct=g.targetAmount>0?((saved/g.targetAmount)*100).toFixed(1):0;
    goalRows.push([g.name,g.targetAmount,saved,Math.max(0,g.targetAmount-saved),pct,g.targetDate||'',g.achieved?'Achieved':'In Progress',g.notes||'']);
  });
  const wsGoals=window.XLSX.utils.aoa_to_sheet(goalRows);
  wsGoals['!cols']=[{wch:22},{wch:14},{wch:14},{wch:12},{wch:12},{wch:14},{wch:14},{wch:20}];
  window.XLSX.utils.book_append_sheet(wb,wsGoals,'Goals');

  // 6. Planned Activities sheet
  const plRows=[['Date','Type','Category','Amount','Account','Description','Status']];
  db.planned.forEach(p=>{const acc=db.accounts.find(a=>a.id===p.accountId);plRows.push([p.date,p.type,p.category,p.amount,acc?acc.name:'',p.desc||'',p.status]);});
  const wsPl=window.XLSX.utils.aoa_to_sheet(plRows);
  wsPl['!cols']=[{wch:12},{wch:10},{wch:20},{wch:14},{wch:18},{wch:28},{wch:10}];
  window.XLSX.utils.book_append_sheet(wb,wsPl,'Planned Activities');

  // 7. Budget sheet
  const budgetRows=[['Category','Period','Limit','Current Spend','% Used','Remaining']];
  db.budgets.forEach(b=>{
    const period=b.period||'monthly';
    const spent=getBudgetSpend(b.category,period);
    const pct=b.monthlyLimit>0?((spent/b.monthlyLimit)*100).toFixed(1):0;
    budgetRows.push([b.category,period,b.monthlyLimit,spent,pct,Math.max(0,b.monthlyLimit-spent)]);
  });
  const wsBudget=window.XLSX.utils.aoa_to_sheet(budgetRows);
  wsBudget['!cols']=[{wch:22},{wch:10},{wch:14},{wch:14},{wch:10},{wch:12}];
  window.XLSX.utils.book_append_sheet(wb,wsBudget,'Budgets');

  window.XLSX.writeFile(wb,`FinFlow-Full-Export-${dateStr}.xlsx`);
  showToast('Full data exported as XLSX! 📦','success');
}

function exportAllCSV(){
  // Export each data type as separate CSV and download them
  const cur=getCurrency();
  const dateStr=today();
  // Transactions
  let txRows=[['Date','Type','Category','Amount','Account','Description','Reference']];
  db.transactions.forEach(tx=>{const acc=db.accounts.find(a=>a.id===tx.accountId);txRows.push([tx.date,tx.type,tx.category,tx.amount,acc?acc.name:'',tx.desc||'',tx.ref||'']);});
  downloadBlob(new Blob([txRows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')],{type:'text/csv'}),`FinFlow-Transactions-${dateStr}.csv`);
  // Accounts
  let accRows=[['Name','Type','Balance','Account No.','Holder']];
  db.accounts.forEach(a=>accRows.push([a.name,a.type,a.balance,a.accountNumber||'',a.holderName||'']));
  setTimeout(()=>downloadBlob(new Blob([accRows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')],{type:'text/csv'}),`FinFlow-Accounts-${dateStr}.csv`),300);
  // Payables
  let pyRows=[['Name','Type','Total','Paid','Remaining','Monthly','Due Day','Status']];
  db.payables.forEach(p=>pyRows.push([p.name,p.type,p.totalAmount,p.paidAmount||0,p.remaining||0,p.monthlyPayment||0,p.dueDay||'',p.status]));
  setTimeout(()=>downloadBlob(new Blob([pyRows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')],{type:'text/csv'}),`FinFlow-Payables-${dateStr}.csv`),600);
  // Goals
  let goalRows=[['Name','Target','Saved','Target Date','Status']];
  db.goals.forEach(g=>goalRows.push([g.name,g.targetAmount,g.savedAmount||0,g.targetDate||'',g.achieved?'Achieved':'In Progress']));
  setTimeout(()=>downloadBlob(new Blob([goalRows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')],{type:'text/csv'}),`FinFlow-Goals-${dateStr}.csv`),900);
  showToast('Exported 4 CSV files! 🗂️','success');
}

// ═══════════════════════════════════════════════════════════════════
// VOICE AI SETTINGS  –  per-record field configuration & smart parser
// ═══════════════════════════════════════════════════════════════════

// ── Schema: field definitions per record type ──────────────────────
// formField: the real DOM id that will be filled on confirm
const VAI_SCHEMA = {
  payable: {
    label:'Payable / Loan', icon:'💳',
    openFn: 'openAddPayable',
    triggerWords: ['loan','payable','utang','debt','credit','bnpl','installment'],
    fields: [
      {id:'name',          label:'Name / Description', type:'text',   enabled:true,  keywords:['loan','for','named','called','it\'s'],       formField:'py-name'    },
      {id:'totalAmount',   label:'Total Amount',        type:'number', enabled:true,  keywords:['total','amount','principal','worth'],         formField:'py-total'   },
      {id:'paidAmount',    label:'Already Paid',        type:'number', enabled:false, keywords:['paid','already paid','existing','covered'],   formField:'py-paid'    },
      {id:'monthlyPayment',label:'Monthly Payment',     type:'number', enabled:true,  keywords:['monthly','per month','installment','mo'],     formField:'py-monthly' },
      {id:'interestRate',  label:'Interest Rate (%)',   type:'number', enabled:false, keywords:['interest','rate','percent'],                  formField:'py-interest'},
      {id:'dueDay',        label:'Due Day (of month)',  type:'number', enabled:true,  keywords:['due','every','day','on the'],                 formField:'py-due-day' },
      {id:'notes',         label:'Notes',               type:'text',   enabled:false, keywords:['note','memo','details','about'],              formField:'py-notes'   },
    ]
  },
  goal: {
    label:'Savings Goal', icon:'🎯',
    openFn: 'openAddGoal',
    triggerWords: ['goal','save','saving','target','fund','dream'],
    fields: [
      {id:'name',   label:'Goal Name',     type:'text',   enabled:true,  keywords:['goal','for','save','named','called'], formField:'goal-name'   },
      {id:'target', label:'Target Amount', type:'number', enabled:true,  keywords:['target','need','total','amount'],     formField:'goal-target' },
      {id:'saved',  label:'Already Saved', type:'number', enabled:false, keywords:['saved','have','existing','already'],  formField:'goal-saved'  },
    ]
  },
  recurring: {
    label:'Recurring Rule', icon:'🔄',
    openFn: 'openAddRecurring',
    triggerWords: ['recurring','repeat','monthly','every','subscription','auto','regular'],
    fields: [
      {id:'name',   label:'Rule Name', type:'text',   enabled:true,  keywords:['named','called','for'],               formField:'recur-name'   },
      {id:'amount', label:'Amount',    type:'number', enabled:true,  keywords:['amount','cost','pay','charge'],        formField:'recur-amount' },
      {id:'dueDay', label:'Due Day',   type:'number', enabled:true,  keywords:['due','every','day','on the','nth'],    formField:'recur-due-day'},
    ]
  },
  planned: {
    label:'Upcoming Event', icon:'📅',
    openFn: 'openAddPlanned',
    triggerWords: ['plan','planned','schedule','upcoming','event','future','bill'],
    fields: [
      {id:'amount', label:'Amount',      type:'number', enabled:true,  keywords:['amount','cost','pay'],         formField:'pl-amount'},
      {id:'desc',   label:'Description', type:'text',   enabled:true,  keywords:['for','about','description'],   formField:'pl-desc'  },
    ]
  },
  account: {
    label:'Account', icon:'🏦',
    openFn: 'openAddAccount',
    triggerWords: ['account','wallet','bank','gcash','maya','savings','cash'],
    fields: [
      {id:'name',    label:'Account Name', type:'text',   enabled:true,  keywords:['account','named','called','bank'],    formField:'acc-name'   },
      {id:'balance', label:'Balance',      type:'number', enabled:true,  keywords:['balance','opening','amount','worth'],  formField:'acc-balance'},
    ]
  },
  budget: {
    label:'Budget Limit', icon:'📊',
    openFn: 'openAddBudget',
    triggerWords: ['budget','limit','cap','spending','set budget','monthly limit'],
    fields: [
      {id:'amount', label:'Budget Amount', type:'number', enabled:true,  keywords:['budget','limit','cap','amount','set'],    formField:'budget-limit-amount'},
    ]
  }
};

// ── Runtime state ──────────────────────────────────────────────────
let vaiCurrentTab   = 'payable';
let vaiPendingResult = null;
let vaiVoiceRecog   = null;
let vaiListening    = false;
let vaiCurrentScreen = null; // which screen the bar is active for

// ── Config: get merged defaults+saved from db.settings ─────────────
function getVAIConfig() {
  const saved = db.settings.vaiConfig || {};
  const merged = {};
  for (const [rtype, schema] of Object.entries(VAI_SCHEMA)) {
    const s = saved[rtype] || {};
    merged[rtype] = {
      ...schema,
      triggerWords: s.triggerWords !== undefined ? s.triggerWords : [...schema.triggerWords],
      fields: schema.fields.map(f => {
        const sf = (s.fields||[]).find(x => x.id === f.id) || {};
        return {
          ...f,
          enabled:  sf.enabled  !== undefined ? sf.enabled  : f.enabled,
          keywords: sf.keywords !== undefined ? [...sf.keywords] : [...f.keywords],
        };
      })
    };
  }
  return merged;
}

function persistVAIConfig(config) {
  if (!db.settings.vaiConfig) db.settings.vaiConfig = {};
  for (const [rtype, cfg] of Object.entries(config)) {
    db.settings.vaiConfig[rtype] = {
      triggerWords: cfg.triggerWords,
      fields: cfg.fields.map(f => ({ id:f.id, enabled:f.enabled, keywords:[...f.keywords] }))
    };
  }
  saveDB();
}

// ── SETTINGS MODAL ─────────────────────────────────────────────────
function openVAISettings() {
  vaiCurrentTab = 'payable';
  document.querySelectorAll('#vai-type-tabs .vai-tab-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  if (!window._vaiDraft) window._vaiDraft = {};
  // FEATURE 4: Sync silence toggle to saved setting
  const delayEnabled = (db.settings.vaiSilenceDelay===undefined) ? true : db.settings.vaiSilenceDelay>0;
  const tog = document.getElementById('vai-silence-toggle');
  if(tog) {
    tog.checked = delayEnabled;
    _updateToggleStyle(delayEnabled);
  }
  openModal('modal-vai-settings');
  renderVAITab('payable');
}

// Visual toggle thumb/track update
function _updateToggleStyle(on) {
  const track = document.getElementById('vai-silence-track');
  const thumb = document.getElementById('vai-silence-thumb');
  if(track) track.style.background = on ? 'var(--emerald)' : 'var(--border)';
  if(thumb) thumb.style.transform  = on ? 'translateX(16px)' : 'translateX(0)';
}

function switchVAITab(type, btn) {
  _vaiSaveTabDraft(vaiCurrentTab);
  vaiCurrentTab = type;
  document.querySelectorAll('#vai-type-tabs .vai-tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderVAITab(type);
}

function renderVAITab(type) {
  const config = getVAIConfig();
  // Apply any in-progress draft
  if (window._vaiDraft && window._vaiDraft[type]) {
    const d = window._vaiDraft[type];
    config[type].triggerWords = d.triggerWords;
    config[type].fields = d.fields;
  }
  const def = config[type];
  const panel = document.getElementById('vai-fields-panel');

  const enabledCount = def.fields.filter(f=>f.enabled).length;
  const exampleParts = [def.triggerWords[0]||''];
  def.fields.filter(f=>f.enabled).slice(0,3).forEach(f=>{
    exampleParts.push((f.keywords[0]||'')+(f.type==='number'?' [amount]':' [text]'));
  });

  let html = `
    <div style="background:var(--bg3);border-radius:10px;padding:11px 12px;margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">🔑 Trigger Keywords
        <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text3);font-size:10px"> — comma-separated words that identify this record type</span>
      </div>
      <input type="text" id="vai-triggers-${type}" class="vai-kw-input"
        value="${def.triggerWords.join(', ')}"
        placeholder="e.g. loan, payable, utang">
    </div>

    <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">
      📋 Fields &amp; Keywords
      <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:10px">(${enabledCount} active)</span>
    </div>`;

  def.fields.forEach(f => {
    html += `
    <div class="vai-field-row ${f.enabled?'enabled':''}" id="vai-row-${type}-${f.id}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:${f.enabled?'8px':'0'}">
        <label class="toggle-switch" style="flex-shrink:0">
          <input type="checkbox" id="vai-chk-${type}-${f.id}" ${f.enabled?'checked':''}
            onchange="vaiToggleField('${type}','${f.id}',this.checked)">
          <div class="toggle-track"></div>
        </label>
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:700;color:var(--text)">${f.label}</div>
          <div style="font-size:9.5px;color:var(--text3);margin-top:1px">
            Type: <b>${f.type}</b> · fills <code style="font-size:9px;background:var(--bg2);padding:0 4px;border-radius:3px">#${f.formField}</code>
          </div>
        </div>
        <div id="vai-badge-${type}-${f.id}" style="font-size:9px;font-weight:700;border-radius:6px;padding:2px 8px;border:1px solid;
          ${f.enabled
            ? 'color:var(--emerald);background:var(--emerald-bg);border-color:rgba(16,185,129,.3)'
            : 'color:var(--text3);background:var(--bg);border-color:var(--border)'}">
          ${f.enabled?'ON':'OFF'}
        </div>
      </div>
      <div id="vai-kw-row-${type}-${f.id}" style="${f.enabled?'':'display:none'}">
        <div style="font-size:9px;color:var(--text3);margin-bottom:4px">
          🔑 Keywords that signal <b>${f.label}</b> — the value after these words is extracted:
        </div>
        <input type="text" id="vai-kw-${type}-${f.id}" class="vai-kw-input"
          value="${f.keywords.join(', ')}"
          placeholder="e.g. total, amount, principal">
      </div>
    </div>`;
  });

  html += `
    <div style="background:var(--blue-bg);border:1px solid rgba(59,130,246,.2);border-radius:10px;padding:10px 12px;margin-top:8px">
      <div style="font-size:10px;font-weight:700;color:var(--blue);margin-bottom:4px">💡 Example phrase after saving</div>
      <div style="font-size:10px;color:var(--text3);line-height:1.5;font-style:italic">"${exampleParts.join(' ')}"</div>
    </div>`;

  panel.innerHTML = html;
}

function vaiToggleField(type, fieldId, enabled) {
  const kwRow  = document.getElementById(`vai-kw-row-${type}-${fieldId}`);
  const badge  = document.getElementById(`vai-badge-${type}-${fieldId}`);
  const row    = document.getElementById(`vai-row-${type}-${fieldId}`);
  if (kwRow) kwRow.style.display = enabled ? '' : 'none';
  if (badge) {
    badge.textContent = enabled ? 'ON' : 'OFF';
    badge.style.color        = enabled ? 'var(--emerald)' : 'var(--text3)';
    badge.style.background   = enabled ? 'var(--emerald-bg)' : 'var(--bg)';
    badge.style.borderColor  = enabled ? 'rgba(16,185,129,.3)' : 'var(--border)';
  }
  if (row) row.classList.toggle('enabled', enabled);
}

// Collect current tab's DOM values into draft buffer (called on tab switch & save)
function _vaiSaveTabDraft(type) {
  const trigEl = document.getElementById(`vai-triggers-${type}`);
  if (!trigEl) return; // tab not rendered yet
  const config = getVAIConfig();
  if (window._vaiDraft && window._vaiDraft[type]) {
    // already have draft fields structure; update it
  }
  if (!window._vaiDraft) window._vaiDraft = {};
  window._vaiDraft[type] = {
    triggerWords: trigEl.value.split(',').map(s=>s.trim()).filter(Boolean),
    fields: VAI_SCHEMA[type].fields.map(f => {
      const chk = document.getElementById(`vai-chk-${type}-${f.id}`);
      const kw  = document.getElementById(`vai-kw-${type}-${f.id}`);
      return {
        ...f,
        enabled:  chk ? chk.checked : f.enabled,
        keywords: kw  ? kw.value.split(',').map(s=>s.trim()).filter(Boolean) : [...f.keywords],
      };
    })
  };
}

function saveVAISettings() {
  _vaiSaveTabDraft(vaiCurrentTab);
  const config = getVAIConfig();
  if (window._vaiDraft) {
    for (const [type, draft] of Object.entries(window._vaiDraft)) {
      if (config[type]) {
        config[type].triggerWords = draft.triggerWords;
        config[type].fields       = draft.fields;
      }
    }
  }
  persistVAIConfig(config);
  window._vaiDraft = {};
  closeModal('modal-vai-settings');
  renderVAISettingsSummary();
  showToast('✅ Voice AI settings saved!','success');
}

function renderVAISettingsSummary() {
  const el = document.getElementById('vai-settings-summary');
  if (!el) return;
  const config = getVAIConfig();
  el.innerHTML = Object.entries(config).map(([type, def]) => {
    const n = def.fields.filter(f=>f.enabled).length;
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border)">
      <div style="font-size:12px;font-weight:600">${def.icon} ${def.label}</div>
      <div style="font-size:10px;font-weight:700;color:${n>0?'var(--emerald)':'var(--text3)'}">${n} field${n!==1?'s':''} active</div>
    </div>`;
  }).join('')
  + `<div style="font-size:10px;color:var(--text3);margin-top:8px;line-height:1.5">
       Tap <b>Configure Voice AI Fields</b> to customise. Then use the 🎤 bar on Payables or Goals screens.
     </div>`;
}

// ── PARSER ─────────────────────────────────────────────────────────
// Spoken number words → numeric value (reuses same logic as aiParseText)
const VAI_NUM_WORDS={zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19,twenty:20,thirty:30,forty:40,fifty:50,sixty:60,seventy:70,eighty:80,ninety:90,hundred:100,thousand:1000,million:1000000};

function vaiSpokenToNum(str){
  // Try plain digit first
  const dig=str.match(/^[\s,]*(\d[\d,\.]*)/);
  if(dig) return parseFloat(dig[1].replace(/,/g,''));
  // Word-based
  const words=str.toLowerCase().replace(/[^a-z\s]/g,' ').split(/\s+/);
  let total=0,cur=0;
  for(const w of words){
    const v=VAI_NUM_WORDS[w];
    if(v===undefined) break;
    if(v===1000000){total=(total+cur)*v;cur=0;}
    else if(v===1000){total=(total+cur)*1000;cur=0;}
    else if(v===100){cur*=100;}
    else cur+=v;
  }
  return total+cur;
}

function vaiExtractAllNums(str){
  return [...str.matchAll(/(\d[\d,\.]*)/g)].map(m=>parseFloat(m[1].replace(/,/g,''))).filter(n=>n>0);
}

// Find position of next field keyword in remaining text (for bounding text fields)
function vaiNextKeywordPos(str, enabledFields, currentId){
  let min=str.length;
  for(const f of enabledFields){
    if(f.id===currentId) continue;
    for(const kw of f.keywords){
      const p=str.toLowerCase().indexOf(kw.toLowerCase());
      if(p>0&&p<min) min=p;
    }
  }
  return min;
}

function parseVAIText(rawText, hintType=null) {
  const text  = rawText.trim();
  const lower = text.toLowerCase();
  const config = getVAIConfig();

  // 1. Detect record type via trigger words (longest match wins)
  //    If hintType is provided, use it directly (called from a form context)
  let detectedType=hintType||null, bestScore=hintType?1:0;
  if(!hintType){
    for(const [rtype,def] of Object.entries(config)){
      let score=0;
      for(const kw of def.triggerWords){
        if(lower.includes(kw.toLowerCase())) score+=kw.length;
      }
      if(score>bestScore){bestScore=score;detectedType=rtype;}
    }
  }
  if(!detectedType||bestScore===0) return null;

  const def           = config[detectedType];
  const enabledFields = def.fields.filter(f=>f.enabled);
  const parsedValues  = {};
  const allNums       = vaiExtractAllNums(lower);
  let   numIdx        = 0;           // fallback number cursor
  let   totalScore    = 0;

  // 2. Per-field extraction
  for(const field of enabledFields){
    let found=false;
    for(const kw of field.keywords){
      const kwL = kw.toLowerCase();
      const idx = lower.indexOf(kwL);
      if(idx===-1) continue;

      const afterKw = text.slice(idx+kw.length).trimStart();

      if(field.type==='number'){
        const val=vaiSpokenToNum(afterKw);
        if(val>0){ parsedValues[field.id]=val; totalScore+=1.2; found=true; break; }

      }else if(field.type==='text'){
        const bound  = vaiNextKeywordPos(afterKw, enabledFields, field.id);
        const phrase = afterKw.slice(0,bound).trim().split(/\s+/).slice(0,6).join(' ');
        if(phrase){ parsedValues[field.id]=phrase; totalScore+=0.9; found=true; break; }
      }
    }

    // Fallback: for number fields, consume the next unused digit in the utterance
    if(!found && field.type==='number'){
      // Skip numbers already assigned
      const used=new Set(Object.values(parsedValues).filter(v=>typeof v==='number'));
      while(numIdx<allNums.length && used.has(allNums[numIdx])) numIdx++;
      if(numIdx<allNums.length){ parsedValues[field.id]=allNums[numIdx++]; totalScore+=0.4; }
    }
  }

  // 3. Confidence
  const fillRatio   = enabledFields.length ? Object.keys(parsedValues).length/enabledFields.length : 0;
  const trigBoost   = bestScore>0 ? 0.25 : 0;
  const scoreBoost  = Math.min(0.15, totalScore*0.03);
  const confidence  = Math.min(0.97, fillRatio*0.60+trigBoost+scoreBoost);

  // 4. Unrecognised words (content words not in any keyword list)
  const allKW = new Set([
    ...def.triggerWords.flatMap(k=>k.toLowerCase().split(/\s+/)),
    ...enabledFields.flatMap(f=>f.keywords.flatMap(k=>k.toLowerCase().split(/\s+/)))
  ]);
  const unrecognised = lower.split(/\s+/).filter(w=>{
    const clean=w.replace(/[^a-z0-9]/g,'');
    return clean.length>2 && !allKW.has(clean) && !/^\d/.test(clean);
  }).filter((w,i,a)=>a.indexOf(w)===i).slice(0,5);

  return { recordType:detectedType, fields:parsedValues, enabledFields, rawText:text, confidence, unrecognised, def };
}

// ── CONFIRM MODAL ──────────────────────────────────────────────────
function showVAIConfirm(parsed) {
  if(!parsed){ showToast('⚠️ Could not detect record type. Include words like "loan", "goal", "recurring"…','warn'); return; }
  vaiPendingResult = parsed;
  const pct = Math.round(parsed.confidence*100);

  document.getElementById('vai-confirm-title').textContent = `${parsed.def.icon} Voice AI — ${parsed.def.label}`;

  // Confidence bar
  const bar = document.getElementById('vai-conf-bar');
  bar.style.width      = pct+'%';
  bar.style.background = pct>=70 ? 'var(--emerald)' : pct>=40 ? 'var(--amber)' : 'var(--rose)';
  const pctEl = document.getElementById('vai-conf-pct');
  pctEl.textContent  = pct+'%';
  pctEl.style.color  = pct>=70 ? 'var(--emerald)' : pct>=40 ? 'var(--amber)' : 'var(--rose)';
  document.getElementById('vai-raw-text').textContent = `"${parsed.rawText}"`;

  // Fields
  const container = document.getElementById('vai-confirm-fields');
  container.innerHTML = parsed.enabledFields.map(f=>{
    const val   = parsed.fields[f.id];
    const hasVal = val!==undefined;
    const disp  = hasVal ? (f.type==='number' ? fmt(val) : val) : '—';
    return `<div class="vai-confirm-field ${hasVal?'filled':'empty'}">
      <div style="flex:1;min-width:0">
        <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">${f.label}</div>
        <div style="font-size:15px;font-weight:700;color:${hasVal?'var(--text)':'var(--text3)'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${disp}</div>
      </div>
      <div style="display:flex;align-items:center;gap:5px;flex-shrink:0;margin-left:10px">
        ${hasVal
          ? `<span style="font-size:11px;font-weight:700;color:var(--emerald);background:var(--emerald-bg);border-radius:6px;padding:3px 9px">✓ Filled</span>`
          : `<span style="font-size:11px;font-weight:700;color:var(--amber);background:var(--amber-bg);border-radius:6px;padding:3px 9px">Missing</span>`
        }
      </div>
    </div>`;
  }).join('');

  // Unrecognised hint
  const unrecEl = document.getElementById('vai-unrecognised');
  if(parsed.unrecognised&&parsed.unrecognised.length){
    unrecEl.style.display='';
    unrecEl.innerHTML=`⚠️ <b>Unrecognised words:</b> "${parsed.unrecognised.join('", "')}" —
      add them as field keywords in <b>Voice AI Settings</b> to improve accuracy.`;
  }else{
    unrecEl.style.display='none';
  }

  openModal('modal-vai-confirm');
}

// ── EXECUTE CONFIRM → open target form pre-filled ─────────────────
function executeVAIConfirm() {
  const parsed = vaiPendingResult;
  if(!parsed) return;
  closeModal('modal-vai-confirm');
  vaiPendingResult = null;
  const {recordType:type, fields} = parsed;

  setTimeout(()=>{
    if(type==='payable'){
      openAddPayable();
      setTimeout(()=>{
        if(fields.name)          setFld('py-name', fields.name);
        if(fields.totalAmount)   setFldNum('py-total',   fields.totalAmount);
        if(fields.paidAmount)    setFldNum('py-paid',    fields.paidAmount);
        if(fields.monthlyPayment)setFldNum('py-monthly', fields.monthlyPayment);
        if(fields.interestRate)  setFldNum('py-interest',fields.interestRate);
        if(fields.dueDay)        setFld('py-due-day', fields.dueDay);
        if(fields.notes)         setFld('py-notes',   fields.notes);
        vaiFormToast(fields);
      },220);

    }else if(type==='goal'){
      openAddGoal();
      setTimeout(()=>{
        if(fields.name)  setFld('goal-name',  fields.name);
        if(fields.target)setFldNum('goal-target',fields.target);
        if(fields.saved) setFldNum('goal-saved', fields.saved);
        vaiFormToast(fields);
      },220);

    }else if(type==='recurring'){
      openAddRecurring();
      setTimeout(()=>{
        if(fields.name)  setFld('recur-name',   fields.name);
        if(fields.amount)setFldNum('recur-amount',fields.amount);
        if(fields.dueDay)setFld('recur-due-day', fields.dueDay);
        vaiFormToast(fields);
      },220);

    }else if(type==='planned'){
      openAddPlanned();
      setTimeout(()=>{
        if(fields.amount)setFldNum('pl-amount',fields.amount);
        if(fields.desc)  setFld('pl-desc',    fields.desc);
        vaiFormToast(fields);
      },220);

    }else if(type==='account'){
      openAddAccount();
      setTimeout(()=>{
        if(fields.name)   setFld('acc-name',    fields.name);
        if(fields.balance)setFldNum('acc-balance',fields.balance);
        vaiFormToast(fields);
      },220);

    }else if(type==='budget'){
      openAddBudget();
      setTimeout(()=>{
        if(fields.amount)setFldNum('budget-limit-amount',fields.amount);
        vaiFormToast(fields);
      },220);
    }
  },160);
}

function setFld(id,val){ const el=document.getElementById(id); if(el){el.value=val;el.dispatchEvent(new Event('input',{bubbles:true}));} }
function setFldNum(id,val){ setFld(id,val); }
function vaiFormToast(fields){ showToast(`✨ Voice AI filled ${Object.keys(fields).length} field(s). Review &amp; save!`,'success'); }

// ══════════════════════════════════════════════════════════════
// ── FORM-LEVEL VAI SMART INPUT ────────────────────────────────
// Embedded smart voice/text input inside each form
// ══════════════════════════════════════════════════════════════
const _fvaiState   = {};   // parsed result per formType
const _fvaiRecog   = {};   // speech recognition instances
const _fvaiActive  = {};   // is voice listening per formType

// Map formType key → how to fill the form
const FORM_VAI_FILL = {
  payable: (fields) => {
    if(fields.name)          setFld('py-name',    fields.name);
    if(fields.totalAmount)   setFldNum('py-total',   fields.totalAmount);
    if(fields.paidAmount)    setFldNum('py-paid',    fields.paidAmount);
    if(fields.monthlyPayment)setFldNum('py-monthly', fields.monthlyPayment);
    if(fields.interestRate)  setFldNum('py-interest',fields.interestRate);
    if(fields.dueDay)        setFld('py-due-day', String(fields.dueDay));
    if(fields.notes)         setFld('py-notes',   fields.notes);
  },
  account: (fields) => {
    if(fields.name)    setFld('acc-name',    fields.name);
    if(fields.balance) setFldNum('acc-balance',fields.balance);
  },
  budget: (fields) => {
    if(fields.amount) setFldNum('budget-limit', fields.amount);
  },
  goal: (fields) => {
    if(fields.name)   setFld('goal-name',   fields.name);
    if(fields.target) setFldNum('goal-target', fields.target);
    if(fields.saved)  setFldNum('goal-saved',  fields.saved);
  },
  recurring: (fields) => {
    if(fields.name)   setFld('recur-name',    fields.name);
    if(fields.amount) setFldNum('recur-amount', fields.amount);
    if(fields.dueDay) setFld('recur-due-day',  String(fields.dueDay));
  },
  planned: (fields) => {
    if(fields.amount) setFldNum('pl-amount', fields.amount);
    if(fields.desc)   setFld('pl-desc',    fields.desc);
  }
};

// Parse text using VAI config for the specific form type (no trigger word needed — we know the type)
function parseFormVAIText(text, formType) {
  const config  = getVAIConfig();
  const def     = config[formType];
  if (!def) return null;
  const lower   = text.trim().toLowerCase();
  const enabledFields = def.fields.filter(f => f.enabled);
  const parsedValues  = {};
  const allNums = vaiExtractAllNums(lower);
  let numIdx    = 0;
  let totalScore = 0;

  for (const field of enabledFields) {
    let found = false;
    for (const kw of field.keywords) {
      const kwL = kw.toLowerCase();
      const idx = lower.indexOf(kwL);
      if (idx === -1) continue;
      const afterKw = text.trim().slice(idx + kw.length).trimStart();
      if (field.type === 'number') {
        const val = vaiSpokenToNum(afterKw);
        if (val > 0) { parsedValues[field.id] = val; totalScore += 1.2; found = true; break; }
      } else if (field.type === 'text') {
        const bound  = vaiNextKeywordPos(afterKw, enabledFields, field.id);
        const phrase = afterKw.slice(0, bound).trim().split(/\s+/).slice(0, 6).join(' ');
        if (phrase) { parsedValues[field.id] = phrase; totalScore += 0.9; found = true; break; }
      }
    }
    if (!found && field.type === 'number') {
      const used = new Set(Object.values(parsedValues).filter(v => typeof v === 'number'));
      while (numIdx < allNums.length && used.has(allNums[numIdx])) numIdx++;
      if (numIdx < allNums.length) { parsedValues[field.id] = allNums[numIdx++]; totalScore += 0.4; }
    }
  }

  const fillRatio  = enabledFields.length ? Object.keys(parsedValues).length / enabledFields.length : 0;
  const confidence = Math.min(0.97, fillRatio * 0.70 + Math.min(0.15, totalScore * 0.03));

  return { recordType: formType, fields: parsedValues, enabledFields, rawText: text.trim(), confidence, def };
}

function onFormVAI(formType, text) {
  if (!text.trim()) { dismissFormVAI(formType); return; }
  const parsed = parseFormVAIText(text, formType);
  if (parsed && Object.keys(parsed.fields).length > 0) {
    _fvaiState[formType] = parsed;
    _renderFormVAIResult(formType, parsed);
  } else {
    dismissFormVAI(formType);
    const hint = document.getElementById(formType+'-vai-hint');
    if (hint) hint.textContent = '⚠️ No fields detected. Check your VAI settings or add more keywords.';
  }
}

function _renderFormVAIResult(formType, parsed) {
  const card      = document.getElementById(formType+'-vai-result');
  const flds      = document.getElementById(formType+'-vai-fields');
  const confBadge = document.getElementById(formType+'-vai-conf');
  const meter     = document.getElementById(formType+'-vai-meter');
  if (!card) return;

  const pct = Math.round(parsed.confidence * 100);
  const col = pct >= 60 ? 'var(--emerald)' : pct >= 35 ? 'var(--amber)' : 'var(--rose)';
  const cls = pct >= 60 ? '' : pct >= 35 ? 'mid' : 'low';

  confBadge.textContent = pct + '%';
  confBadge.className   = 'form-vai-conf-badge ' + cls;
  meter.style.width     = pct + '%';
  meter.style.background = col;

  flds.innerHTML = parsed.enabledFields.map(f => {
    const val    = parsed.fields[f.id];
    const hasVal = val !== undefined;
    const disp   = hasVal ? (f.type === 'number' ? fmt(val) : val) : '—';
    return `<div class="form-vai-field">
      <div class="form-vai-field-lbl">${f.label}</div>
      <div class="form-vai-field-val ${hasVal ? '' : 'empty'}">${disp}</div>
    </div>`;
  }).join('');

  card.classList.add('show');
  const hint = document.getElementById(formType+'-vai-hint');
  if (hint) hint.textContent = `${pct}% confidence · ${Object.keys(parsed.fields).length} field(s) detected`;
}

function applyFormVAI(formType) {
  const parsed = _fvaiState[formType];
  if (!parsed || !Object.keys(parsed.fields).length) {
    showToast('⚠️ Nothing to apply. Speak or type a command first.', 'warn'); return;
  }
  const filler = FORM_VAI_FILL[formType];
  if (filler) filler(parsed.fields);
  showToast(`✨ Voice AI filled ${Object.keys(parsed.fields).length} field(s). Review & save!`, 'success');
  dismissFormVAI(formType);
  const inp = document.getElementById(formType+'-vai-input');
  if (inp) inp.value = '';
}

function dismissFormVAI(formType) {
  const card = document.getElementById(formType+'-vai-result');
  if (card) card.classList.remove('show');
  _fvaiState[formType] = null;
  const hint = document.getElementById(formType+'-vai-hint');
  if (hint) {
    const labels = {payable:'💳 Payable / Loan',account:'🏦 Account',budget:'📊 Budget',goal:'🎯 Savings Goal',recurring:'🔄 Recurring Rule'};
    hint.textContent = (labels[formType]||'') + ' — speak or type to pre-fill the form';
  }
}

// FEATURE 1+4: Form VAI voice — permission modal → getUserMedia → 2s silence
function toggleFormVAIVoice(formType) {
  // Toggle off if same form is active
  if (_voiceEngine.listening && _voiceEngine.context === 'formVAI-'+formType) {
    _voiceEngine.stop(false, _voiceEngine.currentTranscript.trim());
    stopFormVAIVoice(formType);
    return;
  }
  _fvaiActive[formType] = true;
  const mic   = document.getElementById(formType+'-vai-mic');
  const vsBar = document.getElementById(formType+'-vai-voice-status');
  if (mic)   mic.classList.add('listening');
  if (vsBar) vsBar.classList.add('show');
  _voiceEngine.onLive = (text) => {
    const inp = document.getElementById(formType+'-vai-input');
    if (inp) { inp.value = text; onFormVAI(formType, text); }
  };
  _voiceEngine.request('formVAI-'+formType, (finalText) => {
    stopFormVAIVoice(formType);
    const inp = document.getElementById(formType+'-vai-input');
    if (inp) { inp.value = finalText; onFormVAI(formType, finalText); }
  }, formType+'-vai-voice-status', formType+'-vai-input');
}

function stopFormVAIVoice(formType) {
  _fvaiActive[formType] = false;
  const mic   = document.getElementById(formType+'-vai-mic');
  const vsBar = document.getElementById(formType+'-vai-voice-status');
  if (mic)   mic.classList.remove('listening');
  if (vsBar) vsBar.classList.remove('show');
  if (_fvaiRecog[formType]) { try { _fvaiRecog[formType].stop(); } catch(e) {} _fvaiRecog[formType] = null; }
}

// ── FLOATING QUICK BAR ─────────────────────────────────────────────
function showVAIBar(recordType){
  vaiCurrentScreen = recordType;
  const bar = document.getElementById('vai-quick-bar');
  if(!bar) return;
  bar.classList.add('show');
  const inp  = document.getElementById('vai-quick-input');
  const hint = document.getElementById('vai-bar-hint');
  if(inp){
    inp.value = '';
    inp._vaiType = recordType;
    const def    = getVAIConfig()[recordType]||{};
    const eflds  = (def.fields||[]).filter(f=>f.enabled);
    const ex     = [def.triggerWords?.[0]||'', ...eflds.slice(0,3).map(f=>`${f.keywords[0]||''} [${f.type==='number'?'0':'…'}]`)].join(' ');
    inp.placeholder = eflds.length ? `e.g. "${ex}"` : 'Speak or type…';
  }
  // Show context label
  if(hint){
    const def = getVAIConfig()[recordType]||{};
    const ctxLabel = def.icon && def.label ? `${def.icon} <b style="color:var(--blue)">${def.label}</b> — speak or type to pre-fill the form` : '';
    hint.innerHTML = ctxLabel;
  }
}

function hideVAIBar(){
  vaiCurrentScreen = null;
  const bar = document.getElementById('vai-quick-bar');
  if(bar) bar.classList.remove('show');
  stopVAIVoice();
}

function onVAITextInput(text){
  const hint = document.getElementById('vai-bar-hint');
  if(!hint) return;
  if(text.trim().length>3){
    const parsed = parseVAIText(text);
    if(parsed){
      const pct=Math.round(parsed.confidence*100);
      const col=pct>=60?'var(--emerald)':pct>=35?'var(--amber)':'var(--rose)';
      hint.innerHTML=`${parsed.def.icon} <b>${parsed.def.label}</b> · ${Object.keys(parsed.fields).length} field(s) · <b style="color:${col}">${pct}% confidence</b>`;
    }else{
      hint.innerHTML='<span style="color:var(--amber)">⚠️ Add a trigger word: loan, goal, recurring, plan, account…</span>';
    }
  }else{
    // Restore context hint when cleared
    if(vaiCurrentScreen){
      const def = getVAIConfig()[vaiCurrentScreen]||{};
      hint.innerHTML = def.icon && def.label ? `${def.icon} <b style="color:var(--blue)">${def.label}</b> — speak or type to pre-fill the form` : '';
    }else{
      hint.textContent='';
    }
  }
}

function parseAndConfirmVAI(text, source){
  if(!text.trim()){ showToast('⚠️ Please speak or type a command first.','warn'); return; }
  const parsed = parseVAIText(text);
  showVAIConfirm(parsed);
}

// FEATURE 1+4: VAI Quick Bar voice — permission modal → getUserMedia → 2s silence
function toggleVAIVoice(){
  if(_voiceEngine.listening && _voiceEngine.context==='vaiBar'){
    _voiceEngine.stop(false, _voiceEngine.currentTranscript.trim());
    stopVAIVoice(); return;
  }
  vaiListening=true;
  const micBtn=document.getElementById('vai-mic-btn');
  const hint  =document.getElementById('vai-bar-hint');
  if(micBtn) micBtn.classList.add('listening');
  if(hint)   hint.textContent='🎙️ Listening…';
  _voiceEngine.onLive = (text) => {
    const inp=document.getElementById('vai-quick-input');
    if(inp) inp.value=text;
    onVAITextInput(text);
    if(hint) hint.textContent='🎙️ '+text.slice(0,60);
  };
  _voiceEngine.request('vaiBar', (finalText) => {
    stopVAIVoice();
    parseAndConfirmVAI(finalText, 'voice');
  }, null, 'vai-quick-input');
}

function stopVAIVoice(){
  vaiListening=false;
  const micBtn=document.getElementById('vai-mic-btn');
  if(micBtn) micBtn.classList.remove('listening');
  if(vaiVoiceRecog){ try{vaiVoiceRecog.stop();}catch(e){} vaiVoiceRecog=null; }
}

// ── Hook VAI bar into screen navigation ───────────────────────────
// Patching is done after the original showScreen exists (see INIT below)
const VAI_SCREENS={};  // All forms now have embedded Smart Input — floating bar disabled for cleanliness
function _vaiOnScreenChange(name){
  // Always hide the floating bar — each form has its own embedded Smart Input
  hideVAIBar();
}


// ══════════════════════════════════════════════════════════════
// ── DEMO / SAMPLE DATA MODE ───────────────────────────────────
// ══════════════════════════════════════════════════════════════
function buildDemoData() {
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  const ld = (yr,mo,d) => `${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const todayStr = today();
  const prev = (days) => { const d=new Date(now); d.setDate(d.getDate()-days); return localDate(d); };
  const next = (days) => { const d=new Date(now); d.setDate(d.getDate()+days); return localDate(d); };

  const accBDO   = uid(); const accGCash = uid(); const accCash = uid(); const accMaya = uid();
  const pyLoan   = uid(); const pyCC     = uid(); const pyHP   = uid();
  const goalVac  = uid(); const goalPhone= uid(); const goalEF = uid();
  const recNetflix=uid(); const recRent  = uid(); const recSal = uid();
  const budFood  = uid(); const budTrans = uid(); const budEntm = uid();

  const accounts = [
    {id:accBDO,  name:'BDO Savings',    type:'bank',    balance:42500,  savingsReserve:5000, color:'#3B82F6', accountNumber:'****4821', holderName:'Juan Dela Cruz', createdAt:Date.now()-30*864e5},
    {id:accGCash,name:'GCash',          type:'ewallet', balance:3200,   savingsReserve:500,  color:'#10B981', accountNumber:'09171234567', holderName:'Juan Dela Cruz', createdAt:Date.now()-30*864e5},
    {id:accCash,  name:'Cash on Hand',  type:'cash',    balance:1800,   savingsReserve:0,    color:'#F59E0B', createdAt:Date.now()-30*864e5},
    {id:accMaya,  name:'Maya Wallet',   type:'ewallet', balance:6800,   savingsReserve:1000, color:'#8B5CF6', accountNumber:'09281234567', holderName:'Juan Dela Cruz', createdAt:Date.now()-20*864e5},
  ];

  const payables = [
    {id:pyLoan, name:'BDO Personal Loan', type:'loan',   totalAmount:120000, paidAmount:36000, remaining:84000, monthlyPayment:5000, interestRate:12, dueDay:15, allowOverpay:false, linkedAccount:accBDO,  notes:'3-year loan, started Jan 2024', status:'active', payments:[
      {id:uid(),amount:5000,accountId:accBDO,date:prev(45),ref:'AUTO-001',months:1,createdAt:Date.now()-45*864e5},
      {id:uid(),amount:5000,accountId:accBDO,date:prev(15),ref:'AUTO-002',months:1,createdAt:Date.now()-15*864e5},
      {id:uid(),amount:15000,accountId:accBDO,date:prev(5), ref:'ADVANCE-003',months:3,createdAt:Date.now()-5*864e5},
    ], createdAt:Date.now()-400*864e5},
    {id:pyCC,   name:'BDO Credit Card',   type:'credit', totalAmount:28000,  paidAmount:8000,  remaining:20000, monthlyPayment:3500, interestRate:24, dueDay:20, allowOverpay:false, linkedAccount:accBDO,  notes:'Mastercard ending 9832', status:'active', payments:[
      {id:uid(),amount:3500,accountId:accBDO,date:prev(30),ref:'CC-MIN-001',months:1,createdAt:Date.now()-30*864e5},
      {id:uid(),amount:4500,accountId:accBDO,date:prev(8), ref:'CC-MIN-002',months:1,createdAt:Date.now()-8*864e5},
    ], createdAt:Date.now()-90*864e5},
    {id:pyHP,   name:'Home Credit',       type:'spl',    totalAmount:10000,  paidAmount:1500,  remaining:8500,  monthlyPayment:900,  interestRate:0,  dueDay:24, allowOverpay:false, linkedAccount:accGCash,'notes':'Samsung phone installment', status:'active', payments:[
      {id:uid(),amount:900, accountId:accGCash,date:prev(20),ref:'HC-001',months:1,createdAt:Date.now()-20*864e5},
      {id:uid(),amount:600, accountId:accGCash,date:prev(5), ref:'HC-ADV',months:1,createdAt:Date.now()-5*864e5},
    ], createdAt:Date.now()-60*864e5},
  ];

  const goals = [
    {id:goalVac, name:'Palawan Vacation', emoji:'✈️', target:50000, saved:12500, targetDate:ld(y,m+5,15), linkedAccount:accBDO,  notes:'Flights + hotel for 4 nights', status:'active', createdAt:Date.now()-60*864e5},
    {id:goalPhone,name:'New iPhone 16',   emoji:'📱', target:75000, saved:31000, targetDate:ld(y,m+3,1),  linkedAccount:accMaya, notes:'iPhone 16 Pro 256GB', status:'active', createdAt:Date.now()-45*864e5},
    {id:goalEF,  name:'Emergency Fund',   emoji:'🛡️', target:100000,saved:85000, targetDate:ld(y,m+2,1),  linkedAccount:accBDO,  notes:'6 months of expenses', status:'active', createdAt:Date.now()-180*864e5},
  ];

  const recurring = [
    {id:recNetflix,name:'Netflix',        type:'expense',amount:299,  frequency:'monthly',startDate:ld(y-1,0,5),  dueDay:5,  category:'🎬 Entertainment',accountId:accGCash,status:'active', createdAt:Date.now()-365*864e5},
    {id:recRent,   name:'House Rent',     type:'expense',amount:8000, frequency:'monthly',startDate:ld(y-1,0,1),  dueDay:1,  category:'🏠 Housing',     accountId:accBDO,  status:'active', createdAt:Date.now()-365*864e5},
    {id:recSal,    name:'Monthly Salary', type:'income', amount:45000,frequency:'monthly',startDate:ld(y-1,0,25), dueDay:25, category:'💼 Salary',      accountId:accBDO,  status:'active', createdAt:Date.now()-365*864e5},
    {id:uid(),     name:'PhilHealth',     type:'expense',amount:500,  frequency:'monthly',startDate:ld(y-1,0,15), dueDay:15, category:'🏥 Healthcare', accountId:accBDO,  status:'active', createdAt:Date.now()-200*864e5},
    {id:uid(),     name:'SSS Contribution',type:'expense',amount:1125,frequency:'monthly',startDate:ld(y-1,0,15), dueDay:15, category:'💼 Salary',      accountId:accBDO,  status:'active', createdAt:Date.now()-200*864e5},
  ];

  const budgets = [
    {id:budFood, category:'🍔 Food',         monthlyLimit:8000, period:'monthly', createdAt:Date.now()-30*864e5},
    {id:budTrans,category:'🚌 Transport',     monthlyLimit:3000, period:'monthly', createdAt:Date.now()-30*864e5},
    {id:budEntm, category:'🎬 Entertainment', monthlyLimit:1500, period:'monthly', createdAt:Date.now()-30*864e5},
    {id:uid(),   category:'🛒 Shopping',      monthlyLimit:5000, period:'monthly', createdAt:Date.now()-30*864e5},
    {id:uid(),   category:'💊 Health',        monthlyLimit:2000, period:'monthly', createdAt:Date.now()-30*864e5},
  ];

  const transactions = [
    // Current month income & expenses
    {id:uid(),type:'income', amount:45000,category:'💼 Salary',      accountId:accBDO,  date:ld(y,m,25), desc:'Monthly Salary — Employer Inc.',ref:'SAL-'+m,createdAt:Date.now()-5*864e5},
    {id:uid(),type:'expense',amount:8000, category:'🏠 Housing',     accountId:accBDO,  date:ld(y,m,1),  desc:'House Rent - February',ref:'',createdAt:Date.now()-27*864e5},
    {id:uid(),type:'expense',amount:2500, category:'🍔 Food',        accountId:accGCash,date:prev(2),     desc:'Groceries - SM Supermarket',ref:'GR-001',createdAt:Date.now()-2*864e5},
    {id:uid(),type:'expense',amount:850,  category:'🍔 Food',        accountId:accGCash,date:prev(3),     desc:'Jollibee - Family Meal',ref:'JB-456',createdAt:Date.now()-3*864e5},
    {id:uid(),type:'expense',amount:299,  category:'🎬 Entertainment',accountId:accGCash,date:ld(y,m,5),  desc:'Netflix Subscription',ref:'NF-AUTO',createdAt:Date.now()-22*864e5},
    {id:uid(),type:'expense',amount:1200, category:'🚌 Transport',   accountId:accCash, date:prev(4),     desc:'Grab rides — weekly',ref:'',createdAt:Date.now()-4*864e5},
    {id:uid(),type:'expense',amount:650,  category:'🍔 Food',        accountId:accCash, date:prev(6),     desc:'Mang Inasal',ref:'',createdAt:Date.now()-6*864e5},
    {id:uid(),type:'expense',amount:3500, category:'💳 Bills',       accountId:accBDO,  date:prev(8),     desc:'Payment: BDO Credit Card',ref:'CC-MIN-002',payableId:pyCC,createdAt:Date.now()-8*864e5},
    {id:uid(),type:'expense',amount:500,  category:'💊 Health',      accountId:accGCash,date:prev(9),     desc:'Mercury Drug',ref:'',createdAt:Date.now()-9*864e5},
    {id:uid(),type:'expense',amount:1800, category:'🛒 Shopping',    accountId:accGCash,date:prev(10),    desc:'Shopee Order - Clothes',ref:'SPE-002',createdAt:Date.now()-10*864e5},
    {id:uid(),type:'transfer',amount:5000,category:'💸 Transfer',    accountId:accBDO,  date:prev(12),    desc:'Transfer to GCash',toAccountId:accGCash,ref:'',createdAt:Date.now()-12*864e5},
    {id:uid(),type:'expense',amount:900,  category:'💳 Bills',       accountId:accGCash,date:prev(20),    desc:'Payment: Home Credit',ref:'HC-001',payableId:pyHP,createdAt:Date.now()-20*864e5},
    // Last month
    {id:uid(),type:'income', amount:45000,category:'💼 Salary',      accountId:accBDO,  date:ld(y,m-1,25),desc:'Monthly Salary',ref:'',createdAt:Date.now()-32*864e5},
    {id:uid(),type:'expense',amount:8000, category:'🏠 Housing',     accountId:accBDO,  date:ld(y,m-1,1), desc:'House Rent',ref:'',createdAt:Date.now()-58*864e5},
    {id:uid(),type:'expense',amount:5000, category:'💳 Bills',       accountId:accBDO,  date:prev(45),    desc:'Payment: BDO Personal Loan',ref:'AUTO-001',payableId:pyLoan,createdAt:Date.now()-45*864e5},
    {id:uid(),type:'expense',amount:3500, category:'💳 Bills',       accountId:accBDO,  date:prev(30),    desc:'Payment: BDO Credit Card',ref:'CC-MIN-001',payableId:pyCC,createdAt:Date.now()-30*864e5},
    {id:uid(),type:'expense',amount:2200, category:'🍔 Food',        accountId:accGCash,date:ld(y,m-1,18),desc:'Groceries',ref:'',createdAt:Date.now()-39*864e5},
    {id:uid(),type:'expense',amount:1500, category:'🛒 Shopping',    accountId:accMaya, date:ld(y,m-1,12),desc:'Lazada purchase',ref:'LZD-003',createdAt:Date.now()-45*864e5},
    // Advance payment transactions matching payable records
    {id:uid(),type:'expense',amount:15000,category:'💳 Bills',       accountId:accBDO,  date:prev(5),     desc:'Payment: BDO Personal Loan — Paid for '+new Date(y,m,15).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+' to '+new Date(y,m+2,15).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),ref:'ADVANCE-003',payableId:pyLoan,createdAt:Date.now()-5*864e5},
    {id:uid(),type:'expense',amount:600,  category:'💳 Bills',       accountId:accGCash,date:prev(5),     desc:'Payment: Home Credit',ref:'HC-ADV',payableId:pyHP,createdAt:Date.now()-5*864e5},
    {id:uid(),type:'expense',amount:5000, category:'💳 Bills',       accountId:accBDO,  date:prev(15),    desc:'Payment: BDO Personal Loan',ref:'AUTO-002',payableId:pyLoan,createdAt:Date.now()-15*864e5},
  ];

  const planned = [
    {id:uid(),type:'expense',amount:5000, category:'💳 Bills',       accountId:accBDO,  date:ld(y,m,15),  desc:'BDO Personal Loan',   status:'pending',originalDate:ld(y,m,15),  payableId:pyLoan,createdAt:Date.now()-60*864e5},
    {id:uid(),type:'expense',amount:3500, category:'💳 Bills',       accountId:accBDO,  date:ld(y,m,20),  desc:'BDO Credit Card',     status:'pending',originalDate:ld(y,m,20),  payableId:pyCC, createdAt:Date.now()-90*864e5},
    {id:uid(),type:'expense',amount:900,  category:'💳 Bills',       accountId:accGCash,date:ld(y,m,24),  desc:'Home Credit',         status:'pending',originalDate:ld(y,m,24),  payableId:pyHP, createdAt:Date.now()-60*864e5},
    {id:uid(),type:'expense',amount:2500, category:'🛒 Shopping',    accountId:accGCash,date:next(5),      desc:'Birthday gift shopping',status:'pending',originalDate:next(5),  createdAt:Date.now()},
    {id:uid(),type:'income', amount:5000, category:'💰 Freelance',   accountId:accMaya, date:next(10),     desc:'Web design project payment',status:'pending',originalDate:next(10),createdAt:Date.now()},
    {id:uid(),type:'expense',amount:1500, category:'🏥 Healthcare',  accountId:accGCash,date:next(3),      desc:'Annual checkup',      status:'pending',originalDate:next(3),    createdAt:Date.now()},
    {id:uid(),type:'expense',amount:18000,category:'✈️ Travel',      accountId:accBDO,  date:next(45),     desc:'Palawan trip deposit',status:'pending',originalDate:next(45),   createdAt:Date.now()},
  ];

  // Add goal fund transactions
  transactions.push(
    {id:uid(),type:'income',amount:12500,category:'🎯 Goal Deposit',accountId:accBDO,  date:prev(30),desc:'Goal: Palawan Vacation',goalId:goalVac,  ref:'',createdAt:Date.now()-30*864e5},
    {id:uid(),type:'income',amount:31000,category:'🎯 Goal Deposit',accountId:accMaya, date:prev(45),desc:'Goal: New iPhone 16',   goalId:goalPhone,ref:'',createdAt:Date.now()-45*864e5},
    {id:uid(),type:'income',amount:85000,category:'🎯 Goal Deposit',accountId:accBDO,  date:prev(90),desc:'Goal: Emergency Fund',  goalId:goalEF,   ref:'',createdAt:Date.now()-90*864e5},
  );

  const logs = [
    {id:uid(),action:'created',desc:'Demo data loaded for QA testing',entityId:'demo',entityType:'system',createdAt:Date.now()},
  ];

  return {accounts, payables, goals, recurring, budgets, transactions, planned, logs};
}

let _preDemo = null; // stores real user data while demo is active

function enableDemoMode(){
  if(db.settings.demoMode){showToast('Demo mode already active','warn');return;}
  showConfirm('Load Demo Data?','Your current data will be hidden (not deleted). You can restore it anytime from Settings.',()=>{
    // Save real user data
    _preDemo = JSON.parse(JSON.stringify(db));
    localStorage.setItem('finflow_pre_demo', JSON.stringify(_preDemo));
    // Load demo data
    const demo = buildDemoData();
    db.accounts     = demo.accounts;
    db.transactions = demo.transactions;
    db.payables     = demo.payables;
    db.goals        = demo.goals;
    db.recurring    = demo.recurring;
    db.budgets      = demo.budgets;
    db.planned      = demo.planned;
    db.logs         = demo.logs;
    db.settings.demoMode = true;
    saveDB();
    applyDueRecurring();
    saveDB();
    _updateDemoUI(true);
    renderHome();
    showToast('🧪 Demo data loaded! Explore all features freely.','success');
  });
}

function disableDemoMode(){
  if(!db.settings.demoMode){showToast('Demo mode is not active','warn');return;}
  showConfirm('Restore Your Data?','Demo data will be removed and your original data restored.',()=>{
    // Try restoring from memory first, then localStorage
    const saved = _preDemo || JSON.parse(localStorage.getItem('finflow_pre_demo')||'null');
    if(saved){
      Object.assign(db, saved);
      _preDemo = null;
      localStorage.removeItem('finflow_pre_demo');
    } else {
      // No backup found — just clear demo data
      db.accounts=[]; db.transactions=[]; db.payables=[]; db.goals=[];
      db.recurring=[]; db.budgets=[]; db.planned=[]; db.logs=[];
    }
    db.settings.demoMode = false;
    saveDB();
    _updateDemoUI(false);
    renderHome();
    showToast('✅ Your data has been restored!','success');
  });
}

function _updateDemoUI(isDemo){
  const onBtn  = document.getElementById('demo-on-btn');
  const offBtn = document.getElementById('demo-off-btn');
  const status = document.getElementById('demo-data-status');
  const indicator = document.getElementById('demo-mode-indicator');
  if(onBtn)  onBtn.style.display  = isDemo ? 'none'  : '';
  if(offBtn) offBtn.style.display = isDemo ? ''      : 'none';
  if(status) status.textContent   = isDemo ? '🟢 Demo mode is ACTIVE' : 'For QA, UI/UX review & feature testing';
  if(indicator) indicator.style.display = isDemo ? '' : 'none';
}

// ═══════════════════════════════════════════════════════════════════

// ===== INIT =====
loadDB();
initTheme();
cleanDismissedAlerts();
applyDueRecurring(); // auto-apply any due recurring transactions
saveDB(); // save any auto-applied transactions
// Restore demo mode UI if app was reloaded during demo
if(db.settings.demoMode) _updateDemoUI(true);
// FEATURE 4: Restore silence delay setting on app load
if(db.settings.vaiSilenceDelay!==undefined) _voiceEngine.silenceDelay = db.settings.vaiSilenceDelay>0 ? db.settings.vaiSilenceDelay : 500;
// Initialize mic enabled state (default: true)
if(db.settings.micEnabled === undefined) db.settings.micEnabled = true;
updateOverdueBadge();
updatePayablesBadge();
updateRecurringBadge();
checkDuePlanned();
loadPrivacyToggles();
updateEyeBtn();
const savedCurrEl=document.querySelector(`#currency-select option[value="${db.settings.currency||'₱|PHP'}"]`);
if(savedCurrEl)document.getElementById('currency-display').textContent=savedCurrEl.textContent;
// Export modal live preview
document.getElementById('export-period')?.addEventListener('change',updateExportPreview);
document.getElementById('export-type')?.addEventListener('change',updateExportPreview);
renderHome();
// Initialize Lucide icons
setTimeout(()=>{ if(typeof lucide !== 'undefined') lucide.createIcons(); }, 100);
setTimeout(checkOnboarding,600);
setTimeout(checkPatchBadge,800);
setTimeout(maybeAutoGenerateBudgetForCurrentMonth,1200);
renderVAISettingsSummary();
</script>
</body>
</html>
